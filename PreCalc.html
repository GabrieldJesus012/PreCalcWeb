<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Calculador Precat√≥rios</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíºPreCalc</h1>
            <p>Sistema de C√°lculo de Precat√≥rios</p>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="showTab('tab1')">üìÖ Informa√ß√µes Gerais</button>
                <button class="tab-button" onclick="showTab('tab2')">üí∞ Informa√ß√µes Financeiras</button>
                <button class="tab-button" onclick="showTab('tab3')">üè¶ Dedu√ß√µes Legais</button>
                <button class="tab-button" onclick="showTab('tab4')">üë©‚Äçüíº Dedu√ß√µes Acess√≥rias</button>
                <button class="tab-button" onclick="showTab('tab5')">üë• Herdeiros</button>
                <button class="tab-button" onclick="showTab('tab6')">üîÑ Cess√µes de Cr√©dito</button>
                <button class="tab-button" onclick="showTab('tab7')">üìä Resultados</button>
            </div>

            <!-- Tab 1: Informa√ß√µes Gerais -->
            <div id="tab1" class="tab-content active">
                <form id="calculatorForm" class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Informa√ß√µes Gerais</h3>
                        <div class="input-group">
                            <label>Processo:</label>
                            <input type="text" id="numprocesso" placeholder="N√∫mero do processo">
                        </div>
                        <div class="input-group">
                            <label>Benefici√°rio Principal:</label>
                            <input type="text" id="beneficiario" placeholder="Nome do benefici√°rio principal">
                        </div>
                        <div class="input-group">
                            <label>Devedor:</label>
                            <input type="text" id="credor" placeholder="Nome do Devedor">
                        </div>
                        <h3>‚öñÔ∏è Configura√ß√µes do Processo</h3>
                        <div class="input-group">
                            <label>Natureza da A√ß√£o:</label>
                            <select id="natureza">
                                <option value="alimentar">Alimentar</option>
                                <option value="comum">Comum</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tipo de C√°lculo:</label>
                            <select id="tipoCalculo">
                                <option value="ordem">Ordem</option>
                                <option value="preferencia">Prefer√™ncia</option>
                                <option value="acordo">Acordo</option>
                            </select>
                        </div>
                        <div class="input-group" id="tetoPreferencia" style="display: none;">
                            <label>Teto de Prefer√™ncia (R$):</label>
                            <input type="number" id="tetoPreferenciaPrincipal" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group" id="percentualAcordo" style="display: none;">
                            <label>% do Des√°gio (ex: 0.2 para 20%):</label>
                            <input type="number" id="percentualAcordoValor" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tab 2: Informa√ß√µes Financeiras -->
            <div id="tab2" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Datas-base de c√°lculos</h3>
                        <div class="input-group">
                            <label>Ano do Or√ßamento:</label>
                            <input type="number" id="anoOrcamento" placeholder="Ano do Or√ßamento">
                        </div>
                        <h3>üìÖ Inf. do C√°lculo Homologado</h3>
                        <div class="input-group">
                            <label>M√™s Base:</label>
                            <select id="mesBase">
                                <option value="janeiro">Janeiro</option>
                                <option value="fevereiro">Fevereiro</option>
                                <option value="mar√ßo">Mar√ßo</option>
                                <option value="abril">Abril</option>
                                <option value="maio">Maio</option>
                                <option value="junho">Junho</option>
                                <option value="julho">Julho</option>
                                <option value="agosto">Agosto</option>
                                <option value="setembro">Setembro</option>
                                <option value="outubro">Outubro</option>
                                <option value="novembro">Novembro</option>
                                <option value="dezembro">Dezembro</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Ano Base:</label>
                            <input type="number" id="anoBase" placeholder="Ano Base">
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>üí∞ Informa√ß√µes Financeiras</h3>
                        <div class="input-group">
                            <label>Valor Principal (R$):</label>
                            <input type="number" id="valorPrincipal" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <label>Valor dos Juros (R$):</label>
                            <input type="number" id="valorJuros" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <label>Valor Selic (R$):</label>
                            <input type="number" id="valorSelic" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <label>RRA:</label>
                            <input type="number" id="rra" value="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Dedu√ß√µes Legais -->
            <div id="tab3" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üè¶ Impostos e Contribui√ß√µes</h3>
                        <div class="input-group">
                            <label>Incid√™ncia de IR:</label>
                            <select id="incidenciaIR">
                                <option value="sim">Sim</option>
                                <option value="nao">N√£o</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Incid√™ncia de Previd√™ncia:</label>
                            <select id="incidenciaPrevidencia">
                                <option value="sim">Sim</option>
                                <option value="nao">N√£o</option>
                            </select>
                        </div>
                        <div class="input-group" id="tipoPrevidenciaDiv" style="display: none;">
                            <label>Tipo de Previd√™ncia:</label>
                            <select id="tipoPrevidencia">
                                <option value="inss">INSS</option>
                                <option value="fixa">Al√≠quota Fixa</option>
                            </select>
                        </div>
                        <div class="input-group" id="aliquotaFixaDiv" style="display: none;">
                            <label>Al√≠quota Fixa (ex: 0.14 para 14%):</label>
                            <input type="number" id="aliquotaFixa" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Dedu√ß√µes Acess√≥rias (Honor√°rios) -->
            <div id="tab4" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë©‚Äçüíº Honor√°rios Contratuais</h3>
                        <div class="input-group">
                            <label>Quantidade de Advogados:</label>
                            <input type="number" id="quantAdvogados" value="0" min="0">
                        </div>
                        <div id="advogadosContainer"></div>
                        <h3>ü§ù Sindicatos</h3>
                        <div class="input-group">
                            <label>Quantidade de Sindicatos:</label>
                            <input type="number" id="quantSindicatos" value="0" min="0">
                        </div>
                        <div id="sindicatosContainer"></div>
                    </div>
                    
                </div>
            </div>

            <!-- Tab 5: Herdeiros  -->
            <div id="tab5" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë• Herdeiros</h3>
                        <div class="input-group">
                            <label>Quantidade de Herdeiros:</label>
                            <input type="number" id="quantHerdeiros" value="0" min="0">
                        </div>
                        <div id="herdeirosContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Cess√£o  -->
            <div id="tab6" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üîÑ Cess√µes</h3>
                        <div class="input-group">
                            <label>Quantidade de Cess√µes:</label>
                            <input type="number" id="quantCessoes" value="0" min="0">
                        </div>
                        <div id="cessaoContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Resultados -->
            <div id="tab7" class="tab-content">
                <div id="results" class="results">
                    <div class="section-title">Resultados dos C√°lculos</div>
                    <div id="resultadosContent">
                        <p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="btn-container">
            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar Formul√°rio</button>
            <button type="button" class="btn" onclick="calcular()">üßÆ Calcular Valores</button>
        </div>
    </div>

    <script>
        function showTab(tabId) {
            const allTabs = document.querySelectorAll('.tab-content');
            const allButtons = document.querySelectorAll('.tab-button');
            
            allTabs.forEach(tab => {
                if (tab.id === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            allButtons.forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`showTab('${tabId}')`)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function mostrarOcultar(elementId, mostrar) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = mostrar ? 'block' : 'none';
            }
        }

        // Event listeners
        document.getElementById('tipoCalculo').addEventListener('change', function() {
            const tipo = this.value;
            const natureza = document.getElementById('natureza').value;
            
            mostrarOcultar('tetoPreferencia', tipo === 'preferencia' && natureza === 'alimentar');
            mostrarOcultar('percentualAcordo', tipo === 'acordo');
        });

        document.getElementById('natureza').addEventListener('change', function() {
            const natureza = this.value;
            const tipo = document.getElementById('tipoCalculo').value;
            mostrarOcultar('tetoPreferencia', tipo === 'preferencia' && natureza === 'alimentar');
        });

        document.getElementById('incidenciaPrevidencia').addEventListener('change', function() {
            const incidencia = this.value;
            
            if (incidencia === 'sim') {
                mostrarOcultar('tipoPrevidenciaDiv', true);
                const tipoPrevidencia = document.getElementById('tipoPrevidencia').value;
                mostrarOcultar('aliquotaFixaDiv', tipoPrevidencia === 'fixa');
            } else {
                mostrarOcultar('tipoPrevidenciaDiv', false);
                mostrarOcultar('aliquotaFixaDiv', false);
            }
        });

        document.getElementById('tipoPrevidencia').addEventListener('change', function() {
            const tipo = this.value;
            const incidencia = document.getElementById('incidenciaPrevidencia').value;
            
            mostrarOcultar('aliquotaFixaDiv', tipo === 'fixa' && incidencia === 'sim');
        });

        // Inicializa√ß√£o dos campos na carga da p√°gina
        window.addEventListener('load', function() {
            document.getElementById('tipoCalculo').dispatchEvent(new Event('change'));
            document.getElementById('natureza').dispatchEvent(new Event('change'));
            document.getElementById('incidenciaPrevidencia').dispatchEvent(new Event('change'));
            document.getElementById('tipoPrevidencia').dispatchEvent(new Event('change'));
        });

        const CessaoCache = {
            container: null,
            beneficiario: null,
            quantAdvogados: null,
            quantHerdeiros: null,
            quantSindicatos: null,
            quantCessoes: null,
            
            init() {
                this.container = document.getElementById('cessaoContainer');
                this.beneficiario = document.getElementById('beneficiario');
                this.quantAdvogados = document.getElementById('quantAdvogados');
                this.quantHerdeiros = document.getElementById('quantHerdeiros');  
                this.quantSindicatos = document.getElementById('quantSindicatos');
                this.quantCessoes = document.getElementById('quantCessoes');
            },
            
            getQuantidades() {
                return {
                    advogados: parseInt(this.quantAdvogados?.value) || 0,
                    herdeiros: parseInt(this.quantHerdeiros?.value) || 0,
                    sindicatos: parseInt(this.quantSindicatos?.value) || 0,
                    cessoes: parseInt(this.quantCessoes?.value) || 0,
                };
            }
        };

        function criarCessoes(quant) {
            if (!CessaoCache.container) CessaoCache.init();
            
            CessaoCache.container.innerHTML = '';
            
            const { advogados, herdeiros, sindicatos } = CessaoCache.getQuantidades();
            const opcoesTipo = criarOpcoesTipoCessao(advogados, herdeiros, sindicatos);
            const temUnicaOpcao = opcoesTipo.split('<option').length === 3; // 1 vazia + 1 real + split extra
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < quant; i++) {
                const cessaoDiv = criarElementoCessao(i, opcoesTipo);
                fragment.appendChild(cessaoDiv);
                
                if (temUnicaOpcao) {
                    setTimeout(() => {
                        const select = document.getElementById(`cessaoTipo${i}`);
                        if (select) {
                            select.value = 'cessaobenPrincipal';
                            atualizarCedentes(i);
                        }
                    }, 0);
                }
            }
            
            CessaoCache.container.appendChild(fragment);
            
            setTimeout(() => {
                for (let i = 0; i < quant; i++) {
                    const cessaoTipo = document.getElementById(`cessaoTipo${i}`);
                    const cedenteSelect = document.getElementById(`cedenteNome${i}`);
                    
                    if (cessaoTipo?.value && cedenteSelect?.value === '') {
                        atualizarCedentes(i);
                    }
                }
            }, 10);
        }

        function criarElementoCessao(index, opcoesTipo) {
            const cessaoDiv = document.createElement('div');
            cessaoDiv.className = 'advogado-item';
            
            cessaoDiv.innerHTML = `
                <div class="advogado-header">Cession√°rio ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Tipo de Cess√£o:</label>
                        <select id="cessaoTipo${index}" onchange="atualizarCedentes(${index})">
                            ${opcoesTipo}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cedente ${index + 1}:</label>
                        <select id="cedenteNome${index}">
                            <option value="">Selecione primeiro o tipo de cess√£o</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cession√°rio ${index + 1}:</label>
                        <input type="text" id="cessionarioNome${index}" placeholder="Nome do Cession√°rio">
                    </div>
                    <div class="input-group">
                        <label>Percentual Cedido (ex: 0.1 para 10%):</label>
                        <input type="number" id="cessaoPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                </div>
            `;
            
            return cessaoDiv;
        }

        function atualizarOpcoesCessao() {
            if (!CessaoCache.container) CessaoCache.init();
            
            const { cessoes } = CessaoCache.getQuantidades();
            
            if (cessoes > 0) {
                criarCessoes(cessoes);
            }
            
            requestAnimationFrame(() => {
                atualizarTodosCedentes();
            });
        }

        function criarOpcoesTipoCessao(quantAdvogados, quantHerdeiros, quantSindicatos) {
            if (quantAdvogados === undefined) {
                const quantidades = CessaoCache.getQuantidades();
                quantAdvogados = quantidades.advogados;
                quantHerdeiros = quantidades.herdeiros;
                quantSindicatos = quantidades.sindicatos;
            }
            
            const opcoes = ['<option value="cessaobenPrincipal">Do Benefici√°rio Principal</option>'];
            
            if (quantAdvogados > 0) {
                opcoes.push('<option value="cessaoAdv">Do Advogado</option>');
            }
            if (quantHerdeiros > 0) {
                opcoes.push('<option value="cessaoherdeiro">Do Herdeiro</option>');
            }
            if (quantSindicatos > 0) {
                opcoes.push('<option value="cessaoSindicato">Do Sindicato</option>');
            }
            
            return opcoes.join('');
        }

        function criarOpcoesCedente(tipoCessao, index) {
            const campobeneficiario = document.getElementById('beneficiario')?.value.trim();
            const beneficiarioPrincipal = campobeneficiario || 'Benefici√°rio Principal';
            const { advogados, herdeiros, sindicatos } = CessaoCache.getQuantidades();
            const opcoes = ['<option value="">Selecione o cedente</option>'];
            
            switch(tipoCessao) {
                case 'cessaobenPrincipal':
                    opcoes.push(`<option value="${beneficiarioPrincipal}">${beneficiarioPrincipal}</option>`);
                    break;
                    
                case 'cessaoAdv':
                    for (let i = 0; i < advogados; i++) {
                        const nomeAdv = document.getElementById(`advNome${i}`)?.value.trim() || `Advogado ${i + 1}`;
                        opcoes.push(`<option value="${nomeAdv}">${nomeAdv}</option>`);
                    }
                    break;
                    
                case 'cessaoherdeiro':
                    if (herdeiros > 0) {
                        for (let i = 0; i < herdeiros; i++) {
                            const nomeHerd = document.getElementById(`herdNome${i}`)?.value.trim() || `Herdeiro ${i + 1}`;
                            opcoes.push(`<option value="${nomeHerd}">${nomeHerd}</option>`);
                        }
                    } else {
                        opcoes.push(`<option value="${beneficiarioPrincipal}">${beneficiarioPrincipal}</option>`);
                    }
                    break;
                    
                case 'cessaoSindicato':
                    for (let i = 0; i < sindicatos; i++) {
                        const nomeSind = document.getElementById(`sindNome${i}`)?.value.trim() || `Sindicato ${i + 1}`;
                        opcoes.push(`<option value="${nomeSind}">${nomeSind}</option>`);
                    }
                    break;
            }
            
            return opcoes.join('');
        }

        function atualizarCedentes(index) {
            const tipoCessao = document.getElementById(`cessaoTipo${index}`)?.value;
            const cedenteSelect = document.getElementById(`cedenteNome${index}`);
            
            if (tipoCessao && cedenteSelect) {
                const novasOpcoes = criarOpcoesCedente(tipoCessao, index);
                cedenteSelect.innerHTML = novasOpcoes;
                
                const opcoes = cedenteSelect.querySelectorAll('option');
                if (opcoes.length === 2) { // 1 vazia + 1 v√°lida
                    cedenteSelect.selectedIndex = 1; 
                }
            }
        }

        function atualizarTodosCedentes() {
            const { cessoes } = CessaoCache.getQuantidades();
            
            for (let i = 0; i < cessoes; i++) {
                const cessaoTipoElement = document.getElementById(`cessaoTipo${i}`);
                if (cessaoTipoElement?.value) {
                    atualizarCedentes(i);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            CessaoCache.init();
        });
        
        const FormCache = {
            advogadosContainer: null,
            sindicatosContainer: null,
            herdeirosContainer: null,
            quantAdvogados: null,
            quantSindicatos: null,
            quantHerdeiros: null,
            quantCessoes: null,
            tipoCalculo: null,
            beneficiario: null,
            calculatorForm: null,
            
            init() {
                this.advogadosContainer = document.getElementById('advogadosContainer');
                this.sindicatosContainer = document.getElementById('sindicatosContainer');
                this.herdeirosContainer = document.getElementById('herdeirosContainer');
                this.quantAdvogados = document.getElementById('quantAdvogados');
                this.quantSindicatos = document.getElementById('quantSindicatos');
                this.quantHerdeiros = document.getElementById('quantHerdeiros');
                this.quantCessoes = document.getElementById('quantCessoes');
                this.tipoCalculo = document.getElementById('tipoCalculo');
                this.beneficiario = document.getElementById('beneficiario');
                this.calculatorForm = document.getElementById('calculatorForm');
            }
        };

        // Fun√ß√£o gen√©rica para criar elementos (DRY principle)
        function criarElementosFormulario(config) {
            const { container, quantidade, criarElementoFn, callback } = config;
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (quantidade <= 0) {
                callback && callback();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < quantidade; i++) {
                const elemento = criarElementoFn(i);
                fragment.appendChild(elemento);
            }
            
            container.appendChild(fragment);
            callback && callback();
        }

        function criarElementoAdvogado(index) {
            const advDiv = document.createElement('div');
            advDiv.className = 'advogado-item';
            advDiv.innerHTML = `
                <div class="advogado-header">Advogado ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="advNome${index}" placeholder="Nome do advogado">
                    </div>
                    <div class="input-group">
                        <label>Tipo:</label>
                        <select id="advTipo${index}">
                            <option value="PF">Pessoa F√≠sica</option>
                            <option value="PJ">Pessoa Jur√≠dica</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="advPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                </div>
            `;
            
            const nomeInput = advDiv.querySelector(`#advNome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            return advDiv;
        }

        function criarElementoSindicato(index) {
            const sindDiv = document.createElement('div');
            sindDiv.className = 'advogado-item';
            sindDiv.innerHTML = `
                <div class="advogado-header">Sindicato ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="sindNome${index}" placeholder="Nome do sindicato">
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="sindPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label>Tributa√ß√£o:</label>
                        <select id="sindTrib${index}">
                            <option value="nao">Sem Tributa√ß√£o do IR</option>
                            <option value="lei">Art. 27, da Lei n¬∫ 10.833/03</option>
                            <option value="fixa">Al√≠quota Fixa</option>
                        </select>
                    </div>
                    <div class="input-group" id="aliquotaSindContainer${index}" style="display: none;">
                        <label>Al√≠quota Fixa (ex: 0.015 para 1,5%):</label>
                        <input type="number" id="aliquotaSind${index}" step="0.001" min="0" max="1" placeholder="0.000">
                    </div>
                </div>
            `;
            
            const nomeInput = sindDiv.querySelector(`#sindNome${index}`);
            const tribSelect = sindDiv.querySelector(`#sindTrib${index}`);
            
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            if (tribSelect) {
                tribSelect.addEventListener('change', () => toggleAliquotaSindicato(index));
            }
            
            return sindDiv;
        }

        function criarElementoHerdeiro(index) {
            const tipoCalculo = FormCache.tipoCalculo?.value;
            const mostraPreferencia = tipoCalculo === 'preferencia';
            
            const herdDiv = document.createElement('div');
            herdDiv.className = 'advogado-item';
            
            let htmlHerdeiro = `
                <div class="advogado-header">Herdeiro ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="herdNome${index}" placeholder="Nome do herdeiro">
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="herdPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>`;
            
            if (mostraPreferencia) {
                htmlHerdeiro += `
                    <div class="input-group">
                        <label>Tem direito √† prefer√™ncia?</label>
                        <select id="herdPreferencia${index}">
                            <option value="sim">Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>`;
            }
            
            htmlHerdeiro += `</div>`;
            herdDiv.innerHTML = htmlHerdeiro;
            
            // Event listener otimizado (sem inline)
            const nomeInput = herdDiv.querySelector(`#herdNome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            return herdDiv;
        }

        function initializeFormEventListeners() {
            // Advogados
            FormCache.quantAdvogados?.addEventListener('change', function() {
                const quant = parseInt(this.value) || 0;
                criarElementosFormulario({
                    container: FormCache.advogadosContainer,
                    quantidade: quant,
                    criarElementoFn: criarElementoAdvogado,
                    callback: atualizarOpcoesCessao
                });
            });

            // Sindicatos
            FormCache.quantSindicatos?.addEventListener('change', function() {
                const quant = parseInt(this.value) || 0;
                criarElementosFormulario({
                    container: FormCache.sindicatosContainer,
                    quantidade: quant,
                    criarElementoFn: criarElementoSindicato,
                    callback: atualizarOpcoesCessao
                });
            });

            // Herdeiros
            FormCache.quantHerdeiros?.addEventListener('change', function() {
                const quant = parseInt(this.value) || 0;
                criarElementosFormulario({
                    container: FormCache.herdeirosContainer,
                    quantidade: quant,
                    criarElementoFn: criarElementoHerdeiro,
                    callback: atualizarOpcoesCessao
                });
            });

            // Cess√µes
            FormCache.quantCessoes?.addEventListener('change', function() {
                const quant = parseInt(this.value) || 0;
                criarCessoes(quant);
            });

            // Tipo de c√°lculo (para atualizar herdeiros)
            FormCache.tipoCalculo?.addEventListener('change', function() {
                const quantHerdeiros = parseInt(FormCache.quantHerdeiros?.value) || 0;
                if (quantHerdeiros > 0) {
                    // Recriar herdeiros com campos de prefer√™ncia atualizados
                    FormCache.quantHerdeiros.dispatchEvent(new Event('change'));
                }
            });

            // Benefici√°rio
            FormCache.beneficiario?.addEventListener('change', atualizarOpcoesCessao);
        }

        // Fun√ß√£o toggleAliquotaSindicato OTIMIZADA (usando cache impl√≠cito)
        function toggleAliquotaSindicato(index) {
            const selectTrib = document.getElementById(`sindTrib${index}`);
            const aliquotaContainer = document.getElementById(`aliquotaSindContainer${index}`);
            
            if (!selectTrib || !aliquotaContainer) return;
            
            const mostrarAliquota = selectTrib.value === 'fixa';
            
            aliquotaContainer.style.display = mostrarAliquota ? 'block' : 'none';
            
            // Limpar valor quando ocultar
            if (!mostrarAliquota) {
                const aliquotaInput = document.getElementById(`aliquotaSind${index}`);
                if (aliquotaInput) {
                    aliquotaInput.value = '';
                }
            }
        }

        // Fun√ß√£o herdeirTemPreferencia OTIMIZADA
        function herdeirTemPreferencia(nomeHerdeiro) {
            const quantHerdeiros = parseInt(FormCache.quantHerdeiros?.value) || 0;
            
            for (let i = 0; i < quantHerdeiros; i++) {
                const nomeElement = document.getElementById(`herdNome${i}`);
                if (nomeElement?.value === nomeHerdeiro) {
                    const preferenciaElement = document.getElementById(`herdPreferencia${i}`);
                    return preferenciaElement?.value === 'sim';
                }
            }
            return false;
        }

        function limparFormulario() {
            FormCache.calculatorForm?.reset();
            
            const containersConfig = [
                { element: FormCache.quantAdvogados, container: FormCache.advogadosContainer },
                { element: FormCache.quantHerdeiros, container: FormCache.herdeirosContainer },
                { element: FormCache.quantSindicatos, container: FormCache.sindicatosContainer },
                { element: FormCache.quantCessoes, container: document.getElementById('cessaoContainer') }
            ];
            
            containersConfig.forEach(({ element, container }) => {
                if (element) element.value = 0;
                if (container) container.innerHTML = '';
            });
            
            const resultadosContent = document.getElementById('resultadosContent');
            if (resultadosContent) {
                resultadosContent.innerHTML = '<p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>';
            }
            
            showTab('tab1');
        }

        document.addEventListener('DOMContentLoaded', function() {
            FormCache.init();
            initializeFormEventListeners();
        });
        
        // Configura√ß√µes e dados simulados
        const meses = {
            "janeiro": 1, "fevereiro": 2, "mar√ßo": 3, "abril": 4,
            "maio": 5, "junho": 6, "julho": 7, "agosto": 8,
            "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12
        };

        const indicesCNJ = {
            "julho-1968":2.3766255,
            "agosto-1968":2.3244716,
            "setembro-1968":2.2827271,
            "outubro-1968":2.25106,
            "novembro-1968":2.217677,
            "dezembro-1968":2.1821434,
            "janeiro-1969":2.1410981,
            "fevereiro-1969":2.1027271,
            "mar√ßo-1969":2.066267,
            "abril-1969":2.0375611,
            "maio-1969":2.0064697,
            "junho-1969":1.9819624,
            "julho-1969":1.9555362,
            "agosto-1969":1.942091,
            "setembro-1969":1.9278542,
            "outubro-1969":1.9104688,
            "novembro-1969":1.8798598,
            "dezembro-1969":1.8412823,
            "janeiro-1970":1.800848,
            "fevereiro-1970":1.7613375,
            "mar√ßo-1970":1.7266451,
            "abril-1970":1.7073184,
            "maio-1970":1.6917904,
            "junho-1970":1.6761739,
            "julho-1970":1.6507773,
            "agosto-1970":1.6362565,
            "setembro-1970":1.6209546,
            "outubro-1970":1.6018885,
            "novembro-1970":1.5721689,
            "dezembro-1970":1.5394815,
            "janeiro-1971":1.5099171,
            "fevereiro-1971":1.4826188,
            "mar√ßo-1971":1.4632754,
            "abril-1971":1.4488205,
            "maio-1971":1.4322237,
            "junho-1971":1.4120702,
            "julho-1971":1.3846389,
            "agosto-1971":1.3575278,
            "setembro-1971":1.329601,
            "outubro-1971":1.301244,
            "novembro-1971":1.275563,
            "dezembro-1971":1.2549928,
            "janeiro-1972":1.239693,
            "fevereiro-1972":1.2249585,
            "mar√ßo-1972":1.2088431,
            "abril-1972":1.1952032,
            "maio-1972":1.1794914,
            "junho-1972":1.1599378,
            "julho-1972":1.1394877,
            "agosto-1972":1.1233748,
            "setembro-1972":1.1140215,
            "outubro-1972":1.1061046,
            "novembro-1972":1.0956172,
            "dezembro-1972":1.0884246,
            "janeiro-1973":1.0761382,
            "fevereiro-1973":1.0656129,
            "mar√ßo-1973":1.0545619,
            "abril-1973":1.0420264,
            "maio-1973":1.0302028,
            "junho-1973":1.0172858,
            "julho-1973":1.0061466,
            "agosto-1973":0.9972007,
            "setembro-1973":0.9889252,
            "outubro-1973":0.9794005,
            "novembro-1973":0.9727795,
            "dezembro-1973":0.9645367,
            "janeiro-1974":0.9459925,
            "fevereiro-1974":0.9361227,
            "mar√ßo-1974":0.9223112,
            "abril-1974":0.9108553,
            "maio-1974":0.8961917,
            "junho-1974":0.8775275,
            "julho-1974":0.8492863,
            "agosto-1974":0.8135031,
            "setembro-1974":0.7764805,
            "outubro-1974":0.7484388,
            "novembro-1974":0.7326216,
            "dezembro-1974":0.7235169,
            "janeiro-1975":0.7143679,
            "fevereiro-1975":0.7036899,
            "mar√ßo-1975":0.6921938,
            "abril-1975":0.6794291,
            "maio-1975":0.666136,
            "junho-1975":0.6511219,
            "julho-1975":0.6394392,
            "agosto-1975":0.6286861,
            "setembro-1975":0.6190415,
            "outubro-1975":0.6067296,
            "novembro-1975":0.5938325,
            "dezembro-1975":0.5824938,
            "janeiro-1976":0.5719658,
            "fevereiro-1976":0.5611914,
            "mar√ßo-1976":0.5489126,
            "abril-1976":0.5361777,
            "maio-1976":0.5229782,
            "junho-1976":0.5078638,
            "julho-1976":0.4933112,
            "agosto-1976":0.4810212,
            "setembro-1976":0.4679752,
            "outubro-1976":0.4530738,
            "novembro-1976":0.4373045,
            "dezembro-1976":0.4244541,
            "janeiro-1977":0.4152786,
            "fevereiro-1977":0.4082102,
            "mar√ßo-1977":0.400325,
            "abril-1977":0.3914485,
            "maio-1977":0.3804735,
            "junho-1977":0.3686124,
            "julho-1977":0.3567162,
            "agosto-1977":0.3474371,
            "setembro-1977":0.3404576,
            "outubro-1977":0.3357513,
            "novembro-1977":0.331159,
            "dezembro-1977":0.3262852,
            "janeiro-1978":0.3200147,
            "fevereiro-1978":0.3134001,
            "mar√ßo-1978":0.3063011,
            "abril-1978":0.2986019,
            "maio-1978":0.2901279,
            "junho-1978":0.2815487,
            "julho-1978":0.2733153,
            "agosto-1978":0.2651989,
            "setembro-1978":0.25803,
            "outubro-1978":0.251462,
            "novembro-1978":0.2456308,
            "dezembro-1978":0.2394985,
            "janeiro-1979":0.2333575,
            "fevereiro-1979":0.2282044,
            "mar√ßo-1979":0.2230193,
            "abril-1979":0.2175856,
            "maio-1979":0.2097292,
            "junho-1979":0.2020075,
            "julho-1979":0.1955035,
            "agosto-1979":0.190327,
            "setembro-1979":0.1850037,
            "outubro-1979":0.1778589,
            "novembro-1979":0.170058,
            "dezembro-1979":0.1627145,
            "janeiro-1980":0.1563371,
            "fevereiro-1980":0.1500323,
            "mar√ßo-1980":0.1446787,
            "abril-1980":0.1395176,
            "maio-1980":0.134541,
            "junho-1980":0.1301177,
            "julho-1980":0.1260823,
            "agosto-1980":0.1221721,
            "setembro-1980":0.1183831,
            "outubro-1980":0.1149345,
            "novembro-1980":0.1113712,
            "dezembro-1980":0.1079184,
            "janeiro-1981":0.1032714,
            "fevereiro-1981":0.0983531,
            "mar√ßo-1981":0.0923506,
            "abril-1981":0.0868771,
            "maio-1981":0.0819597,
            "junho-1981":0.0773206,
            "julho-1981":0.072944,
            "agosto-1981":0.0688153,
            "setembro-1981":0.0650428,
            "outubro-1981":0.061535,
            "novembro-1981":0.0582165,
            "dezembro-1981":0.0551816,
            "janeiro-1982":0.0524539,
            "fevereiro-1982":0.0499561,
            "mar√ßo-1982":0.0475773,
            "abril-1982":0.0453117,
            "maio-1982":0.0429495,
            "junho-1982":0.0407105,
            "julho-1982":0.0385881,
            "agosto-1982":0.036404,
            "setembro-1982":0.0340224,
            "outubro-1982":0.0317967,
            "novembro-1982":0.0297165,
            "dezembro-1982":0.0279028,
            "janeiro-1983":0.0261998,
            "fevereiro-1983":0.0247168,
            "mar√ßo-1983":0.0231648,
            "abril-1983":0.0212521,
            "maio-1983":0.0194973,
            "junho-1983":0.0180531,
            "julho-1983":0.0167468,
            "agosto-1983":0.0153641,
            "setembro-1983":0.0141604,
            "outubro-1983":0.0129319,
            "novembro-1983":0.0117884,
            "dezembro-1983":0.0108749,
            "janeiro-1984":0.0101068,
            "fevereiro-1984":0.0092048,
            "mar√ßo-1984":0.0081966,
            "abril-1984":0.0074514,
            "maio-1984":0.0068425,
            "junho-1984":0.0062832,
            "julho-1984":0.0057539,
            "agosto-1984":0.0052166,
            "setembro-1984":0.0047166,
            "outubro-1984":0.0042684,
            "novembro-1984":0.0037908,
            "dezembro-1984":0.0034493,
            "janeiro-1985":0.0031216,
            "fevereiro-1985":0.0027722,
            "mar√ßo-1985":0.0025157,
            "abril-1985":0.0022322,
            "maio-1985":0.001996,
            "junho-1985":0.0018145,
            "julho-1985":0.0016615,
            "agosto-1985":0.0015439,
            "setembro-1985":0.0014272,
            "outubro-1985":0.0013082,
            "novembro-1985":0.0012001,
            "dezembro-1985":0.00108,
            "janeiro-1986":0.0009528,
            "fevereiro-1986":0.0008197,
            "mar√ßo-1986":0.7167849,
            "abril-1986":0.7175942,
            "maio-1986":0.7120335,
            "junho-1986":0.7021997,
            "julho-1986":0.6933895,
            "agosto-1986":0.6852283,
            "setembro-1986":0.6739057,
            "outubro-1986":0.6624906,
            "novembro-1986":0.6501229,
            "dezembro-1986":0.6294125,
            "janeiro-1987":0.5867511,
            "fevereiro-1987":0.5022781,
            "mar√ßo-1987":0.4199434,
            "abril-1987":0.3667159,
            "maio-1987":0.3031719,
            "junho-1987":0.2455992,
            "julho-1987":0.2080982,
            "agosto-1987":0.201938,
            "setembro-1987":0.1898626,
            "outubro-1987":0.1796563,
            "novembro-1987":0.1645506,
            "dezembro-1987":0.1458267,
            "janeiro-1988":0.1277614,
            "fevereiro-1988":0.1096562,
            "mar√ßo-1988":0.0929596,
            "abril-1988":0.0801306,
            "maio-1988":0.0671787,
            "junho-1988":0.0570374,
            "julho-1988":0.0477181,
            "agosto-1988":0.03847,
            "setembro-1988":0.0318829,
            "outubro-1988":0.02571,
            "novembro-1988":0.0202043,
            "dezembro-1988":0.0159189,
            "janeiro-1989":12.3603833,
            "fevereiro-1989":8.6605825,
            "mar√ßo-1989":7.863249,
            "abril-1989":7.4118151,
            "maio-1989":6.9071782,
            "junho-1989":6.2828366,
            "julho-1989":5.0329457,
            "agosto-1989":3.9086105,
            "setembro-1989":3.0220826,
            "outubro-1989":2.2229176,
            "novembro-1989":1.6152449,
            "dezembro-1989":1.1421578,
            "janeiro-1990":0.7438344,
            "fevereiro-1990":0.4764825,
            "mar√ßo-1990":0.2757736,
            "abril-1990":0.1496168,
            "maio-1990":0.1033265,
            "junho-1990":0.095788,
            "julho-1990":0.0874377,
            "agosto-1990":0.0774333,
            "setembro-1990":0.0691184,
            "outubro-1990":0.0612969,
            "novembro-1990":0.053675,
            "dezembro-1990":0.0464397,
            "janeiro-1991":0.0392559,
            "fevereiro-1991":0.0327378,
            "mar√ßo-1991":0.0268629,
            "abril-1991":0.0240298,
            "maio-1991":0.0228833,
            "junho-1991":0.0214504,
            "julho-1991":0.0193544,
            "agosto-1991":0.0172591,
            "setembro-1991":0.0149274,
            "outubro-1991":0.0129108,
            "novembro-1991":0.010663,
            "dezembro-1991":0.0084306,
            "janeiro-1992":0.0068,
            "fevereiro-1992":0.005414,
            "mar√ßo-1992":0.0042934,
            "abril-1992":0.0035183,
            "maio-1992":0.0029361,
            "junho-1992":0.0023784,
            "julho-1992":0.0019294,
            "agosto-1992":0.0015944,
            "setembro-1992":0.0012948,
            "outubro-1992":0.0010499,
            "novembro-1992":0.0008367,
            "dezembro-1992":0.0006764,
            "janeiro-1993":0.0005477,
            "fevereiro-1993":0.000423,
            "mar√ßo-1993":0.0003338,
            "abril-1993":0.000265,
            "maio-1993":0.0002081,
            "junho-1993":0.0001616,
            "julho-1993":0.000124,
            "agosto-1993":0.0948816,
            "setembro-1993":0.0718836,
            "outubro-1993":0.0534912,
            "novembro-1993":0.0395748,
            "dezembro-1993":0.0295551,
            "janeiro-1994":0.0216221,
            "fevereiro-1994":0.0155364,
            "mar√ßo-1994":0.0111214,
            "abril-1994":0.007743,
            "maio-1994":0.0054818,
            "junho-1994":0.0038013,
            "julho-1994":7.2267421,
            "agosto-1994":6.8685226,
            "setembro-1994":6.5409759,
            "outubro-1994":6.4362456,
            "novembro-1994":6.3160917,
            "dezembro-1994":6.1347593,
            "janeiro-1995":5.9996804,
            "fevereiro-1995":5.9996804,
            "mar√ßo-1995":5.9996804,
            "abril-1995":5.7498707,
            "maio-1995":5.7498707,
            "junho-1995":5.7498707,
            "julho-1995":5.3675089,
            "agosto-1995":5.3675089,
            "setembro-1995":5.3675089,
            "outubro-1995":5.1056133,
            "novembro-1995":5.1056133,
            "dezembro-1995":5.1056133,
            "janeiro-1996":4.8992201,
            "fevereiro-1996":4.8992201,
            "mar√ßo-1996":4.8992201,
            "abril-1996":4.8992201,
            "maio-1996":4.8992201,
            "junho-1996":4.8992201,
            "julho-1996":4.5891079,
            "agosto-1996":4.5891079,
            "setembro-1996":4.5891079,
            "outubro-1996":4.5891079,
            "novembro-1996":4.5891079,
            "dezembro-1996":4.5891079,
            "janeiro-1997":4.4576018,
            "fevereiro-1997":4.4576018,
            "mar√ßo-1997":4.4576018,
            "abril-1997":4.4576018,
            "maio-1997":4.4576018,
            "junho-1997":4.4576018,
            "julho-1997":4.4576018,
            "agosto-1997":4.4576018,
            "setembro-1997":4.4576018,
            "outubro-1997":4.4576018,
            "novembro-1997":4.4576018,
            "dezembro-1997":4.4576018,
            "janeiro-1998":4.2243094,
            "fevereiro-1998":4.2243094,
            "mar√ßo-1998":4.2243094,
            "abril-1998":4.2243094,
            "maio-1998":4.2243094,
            "junho-1998":4.2243094,
            "julho-1998":4.2243094,
            "agosto-1998":4.2243094,
            "setembro-1998":4.2243094,
            "outubro-1998":4.2243094,
            "novembro-1998":4.2243094,
            "dezembro-1998":4.2243094,
            "janeiro-1999":4.1555616,
            "fevereiro-1999":4.1555616,
            "mar√ßo-1999":4.1555616,
            "abril-1999":4.1555616,
            "maio-1999":4.1555616,
            "junho-1999":4.1555616,
            "julho-1999":4.1555616,
            "agosto-1999":4.1555616,
            "setembro-1999":4.1555616,
            "outubro-1999":4.1555616,
            "novembro-1999":4.1555616,
            "dezembro-1999":4.1555616,
            "janeiro-2000":3.8154156,
            "fevereiro-2000":3.8154156,
            "mar√ßo-2000":3.8154156,
            "abril-2000":3.8154156,
            "maio-2000":3.8154156,
            "junho-2000":3.8154156,
            "julho-2000":3.8154156,
            "agosto-2000":3.8154156,
            "setembro-2000":3.8154156,
            "outubro-2000":3.8154156,
            "novembro-2000":3.8154156,
            "dezembro-2000":3.8154156,
            "janeiro-2001":3.5982417,
            "fevereiro-2001":3.5757147,
            "mar√ßo-2001":3.557925,
            "abril-2001":3.5451624,
            "maio-2001":3.5275248,
            "junho-2001":3.5103242,
            "julho-2001":3.4970355,
            "agosto-2001":3.4644695,
            "setembro-2001":3.4240655,
            "outubro-2001":3.4111033,
            "novembro-2001":3.3985288,
            "dezembro-2001":3.3652132,
            "janeiro-2002":3.3468057,
            "fevereiro-2002":3.3261834,
            "mar√ßo-2002":3.3116123,
            "abril-2002":3.2984186,
            "maio-2002":3.2728901,
            "junho-2002":3.2592014,
            "julho-2002":3.2484814,
            "agosto-2002":3.2236593,
            "setembro-2002":3.1917418,
            "outubro-2002":3.172075,
            "novembro-2002":3.1437809,
            "dezembro-2002":3.0797227,
            "janeiro-2003":2.9885713,
            "fevereiro-2003":2.9305465,
            "mar√ßo-2003":2.8677429,
            "abril-2003":2.8354191,
            "maio-2003":2.8034597,
            "junho-2003":2.7798311,
            "julho-2003":2.7737289,
            "agosto-2003":2.7787306,
            "setembro-2003":2.7712483,
            "outubro-2003":2.7555417,
            "novembro-2003":2.7374743,
            "dezembro-2003":2.7328285,
            "janeiro-2004":2.7203151,
            "fevereiro-2004":2.7019419,
            "mar√ßo-2004":2.6778413,
            "abril-2004":2.6671726,
            "maio-2004":2.6615833,
            "junho-2004":2.6472879,
            "julho-2004":2.6325457,
            "agosto-2004":2.6082886,
            "setembro-2004":2.5878446,
            "outubro-2004":2.575226,
            "novembro-2004":2.5670116,
            "dezembro-2004":2.5509407,
            "janeiro-2005":2.5296912,
            "fevereiro-2005":2.5126055,
            "mar√ßo-2005":2.4941488,
            "abril-2005":2.4854498,
            "maio-2005":2.4671925,
            "junho-2005":2.4468834,
            "julho-2005":2.4439507,
            "agosto-2005":2.4412653,
            "setembro-2005":2.4344488,
            "outubro-2005":2.4305599,
            "novembro-2005":2.4170246,
            "dezembro-2005":2.3983177,
            "janeiro-2006":2.3892386,
            "fevereiro-2006":2.3771153,
            "mar√ßo-2006":2.3648182,
            "abril-2006":2.3561007,
            "maio-2006":2.3521021,
            "junho-2006":2.3457685,
            "julho-2006":2.3492925,
            "agosto-2006":2.3497624,
            "setembro-2006":2.3453063,
            "outubro-2006":2.3441343,
            "novembro-2006":2.3373559,
            "dezembro-2006":2.3287396,
            "janeiro-2007":2.3206174,
            "fevereiro-2007":2.3086127,
            "mar√ßo-2007":2.2980417,
            "abril-2007":2.2886582,
            "maio-2007":2.2836342,
            "junho-2007":2.2777121,
            "julho-2007":2.2711259,
            "agosto-2007":2.2656882,
            "setembro-2007":2.2562121,
            "outubro-2007":2.249688,
            "novembro-2007":2.2443017,
            "dezembro-2007":2.2391516,
            "janeiro-2008":2.2235865,
            "fevereiro-2008":2.2081296,
            "mar√ßo-2008":2.1940875,
            "abril-2008":2.1890526,
            "maio-2008":2.176213,
            "junho-2008":2.1640941,
            "julho-2008":2.1447909,
            "agosto-2008":2.1313634,
            "setembro-2008":2.1239296,
            "outubro-2008":2.1184217,
            "novembro-2008":2.1120854,
            "dezembro-2008":2.1017867,
            "janeiro-2009":2.0957091,
            "fevereiro-2009":2.0873597,
            "mar√ßo-2009":2.0742917,
            "abril-2009":2.0720124,
            "maio-2009":2.06458,
            "junho-2009":2.0524704,
            "julho-2009":2.0447005,
            "agosto-2009":2.0402121,
            "setembro-2009":2.0355303,
            "outubro-2009":2.0316702,
            "novembro-2009":2.0280197,
            "dezembro-2009":2.0191355,
            "janeiro-2010":2.0114919,
            "fevereiro-2010":2.0010862,
            "mar√ßo-2010":1.9824512,
            "abril-2010":1.9716073,
            "maio-2010":1.9621888,
            "junho-2010":1.9499044,
            "julho-2010":1.9462066,
            "agosto-2010":1.9479598,
            "setembro-2010":1.9489343,
            "outubro-2010":1.9429112,
            "novembro-2010":1.9309394,
            "dezembro-2010":1.9144749,
            "janeiro-2011":1.9013556,
            "fevereiro-2011":1.8870143,
            "mar√ßo-2011":1.8688861,
            "abril-2011":1.8577396,
            "maio-2011":1.8435443,
            "junho-2011":1.8307292,
            "julho-2011":1.8265282,
            "agosto-2011":1.8247035,
            "setembro-2011":1.8197901,
            "outubro-2011":1.8101961,
            "novembro-2011":1.802625,
            "dezembro-2011":1.7943709,
            "janeiro-2012":1.7843784,
            "fevereiro-2012":1.7728548,
            "mar√ßo-2012":1.7635083,
            "abril-2012":1.7591105,
            "maio-2012":1.7515787,
            "junho-2012":1.742691,
            "julho-2012":1.7395598,
            "agosto-2012":1.7338381,
            "setembro-2012":1.7271024,
            "outubro-2012":1.7188519,
            "novembro-2012":1.7077515,
            "dezembro-2012":1.6985792,
            "janeiro-2013":1.6869393,
            "fevereiro-2013":1.6722237,
            "mar√ßo-2013":1.6609294,
            "abril-2013":1.6528305,
            "maio-2013":1.6444439,
            "junho-2013":1.6369141,
            "julho-2013":1.6307174,
            "agosto-2013":1.6295766,
            "setembro-2013":1.6269735,
            "outubro-2013":1.6225925,
            "novembro-2013":1.6148413,
            "dezembro-2013":1.6056888,
            "janeiro-2014":1.5937358,
            "fevereiro-2014":1.5831288,
            "mar√ßo-2014":1.572124,
            "abril-2014":1.5607306,
            "maio-2014":1.5486512,
            "junho-2014":1.5397208,
            "julho-2014":1.532518,
            "agosto-2014":1.5299171,
            "setembro-2014":1.5277782,
            "outubro-2014":1.521843,
            "novembro-2014":1.5145731,
            "dezembro-2014":1.5088395,
            "janeiro-2015":1.4970131,
            "fevereiro-2015":1.4838072,
            "mar√ßo-2015":1.4643316,
            "abril-2015":1.4463963,
            "maio-2015":1.4310837,
            "junho-2015":1.4225484,
            "julho-2015":1.4086032,
            "agosto-2015":1.4003412,
            "setembro-2015":1.3943455,
            "outubro-2015":1.3889287,
            "novembro-2015":1.3798219,
            "dezembro-2015":1.3681922,
            "janeiro-2016":1.3522358,
            "fevereiro-2016":1.3399087,
            "mar√ßo-2016":1.3211484,
            "abril-2016":1.3154918,
            "maio-2016":1.3088168,
            "junho-2016":1.2976569,
            "julho-2016":1.292487,
            "agosto-2016":1.2855451,
            "setembro-2016":1.279786,
            "outubro-2016":1.2768493,
            "novembro-2016":1.2744279,
            "dezembro-2016":1.2711229,
            "janeiro-2017":1.2687124,
            "fevereiro-2017":1.2647915,
            "mar√ßo-2017":1.2579983,
            "abril-2017":1.2561142,
            "maio-2017":1.2534819,
            "junho-2017":1.2504807,
            "julho-2017":1.2484831,
            "agosto-2017":1.2507344,
            "setembro-2017":1.2463721,
            "outubro-2017":1.2450026,
            "novembro-2017":1.240784,
            "dezembro-2017":1.2368261,
            "janeiro-2018":1.2325123,
            "fevereiro-2018":1.2277242,
            "mar√ßo-2018":1.2230765,
            "abril-2018":1.2218547,
            "maio-2018":1.2192942,
            "junho-2018":1.2175895,
            "julho-2018":1.2042227,
            "agosto-2018":1.1965646,
            "setembro-2018":1.1950111,
            "outubro-2018":1.1939366,
            "novembro-2018":1.1870517,
            "dezembro-2018":1.1848006,
            "janeiro-2019":1.1866993,
            "fevereiro-2019":1.1831498,
            "mar√ßo-2019":1.1791408,
            "abril-2019":1.1728076,
            "maio-2019":1.1644237,
            "junho-2019":1.1603625,
            "julho-2019":1.1596667,
            "agosto-2019":1.1586239,
            "setembro-2019":1.1576978,
            "outubro-2019":1.1566568,
            "novembro-2019":1.1556167,
            "dezembro-2019":1.1540011,
            "janeiro-2020":1.14201,
            "fevereiro-2020":1.1339589,
            "mar√ßo-2020":1.1314697,
            "abril-2020":1.1312434,
            "maio-2020":1.1313565,
            "junho-2020":1.1380712,
            "julho-2020":1.1378436,
            "agosto-2020":1.1344403,
            "setembro-2020":1.1318371,
            "outubro-2020":1.1267666,
            "novembro-2020":1.1162736,
            "dezembro-2020":1.1073045,
            "janeiro-2021":1.0956901,
            "fevereiro-2021":1.0872099,
            "mar√ßo-2021":1.0820162,
            "abril-2021":1.0720462,
            "maio-2021":1.0656523,
            "junho-2021":1.060984,
            "julho-2021":1.0522503,
            "agosto-2021":1.0447282,
            "setembro-2021":1.0355122,
            "outubro-2021":1.0238404,
            "novembro-2021":1.0117,
            "dezembro-2021":1
        };
        
        const periodosJuros = [
            [10, 1964, 12, 2002, 0.5, 0.5],
            [1, 2003, 6, 2009, 0.5, 1.0],
            [7, 2009, 5, 2012, 0.5, 0.5],
            [6, 2012, 6, 2012, 0.4828, 0.4828],
            [7, 2012, 7, 2012, 0.4973, 0.4973],
            [8, 2012, 8, 2012, 0.4675, 0.4675],
            [9, 2012, 10, 2012, 0.4273, 0.4273],
            [11, 2012, 4, 2013, 0.4134, 0.4134],
            [5, 2013, 5, 2013, 0.4273, 0.4273],
            [6, 2013, 6, 2013, 0.4551, 0.4551],
            [7, 2013, 7, 2013, 0.4761, 0.4761],
            [8, 2013, 8, 2013, 0.4828, 0.4828],
            [9, 2013, 9, 2017, 0.5, 0.5],
            [10, 2017, 10, 2017, 0.4690, 0.4690],
            [11, 2017, 12, 2017, 0.4273, 0.4273],
            [1, 2018, 2, 2018, 0.3994, 0.3994],
            [3, 2018, 3, 2018, 0.3855, 0.3855],
            [4, 2018, 7, 2019, 0.3715, 0.3715],
            [8, 2019, 9, 2019, 0.3434, 0.3434],
            [10, 2019, 10, 2019, 0.3153, 0.3153],
            [11, 2019, 12, 2019, 0.2871, 0.2871],
            [1, 2020, 2, 2020, 0.2588, 0.2588],
            [3, 2020, 3, 2020, 0.2446, 0.2446],
            [4, 2020, 5, 2020, 0.2162, 0.2162],
            [6, 2020, 6, 2020, 0.1733, 0.1733],
            [7, 2020, 8, 2020, 0.1303, 0.1303],
            [9, 2020, 3, 2021, 0.1159, 0.1159],
            [4, 2021, 5, 2021, 0.1590, 0.1590],
            [6, 2021, 6, 2021, 0.2019, 0.2019],
            [7, 2021, 8, 2021, 0.2446, 0.2446],
            [9, 2021, 9, 2021, 0.3012, 0.3012],
            [10, 2021, 10, 2021, 0.3575, 0.3575],
            [11, 2021, 11, 2021, 0.4412, 0.4412]
        ];

        // Fun√ß√£o para obter o √≠ndice CNJ
        function obterIndiceCNJ(mesBase, anoBase) {
            const numeroMesBase = meses[mesBase.toLowerCase()];
            // Se o per√≠odo base √© ap√≥s dezembro de 2021, n√£o h√° corre√ß√£o
            if (anoBase > 2021 || (anoBase === 2021 && numeroMesBase > 12)) {
                return 1.0000;
            }
            
            const chave = `${mesBase.toLowerCase()}-${anoBase}`;
            return indicesCNJ[chave] || 1.0000;
        }

        function calcularPeriodoGraca(anoOrcamento) {
            let inicioGraca;
            if (anoOrcamento <= 2022) {
                // Julho do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 6, 1); // M√™s 6 = Julho (0-based)
            } else {
                // Abril do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 3, 1); // M√™s 3 = Abril
            }
            // Fim do per√≠odo: 31 de Dezembro do ano do or√ßamento
            const fimGraca = new Date(anoOrcamento, 11, 31); // M√™s 11 = Dezembro
            return { inicioGraca, fimGraca };
        }
        
        function criarDataBase(mesBase, anoBase) {
            const numeroMes = meses[mesBase.toLowerCase()];
            return new Date(anoBase, numeroMes - 1, 1);
        }

        //para juros mora
        function obterTaxaJuros(mes, ano, natureza) {
            const dataConsulta = new Date(ano, mes - 1, 1);
            for (const periodo of periodosJuros) {
                const [mesInicio, anoInicio, mesFim, anoFim, juroAlimentar, juroComum] = periodo;
                const dataInicio = new Date(anoInicio, mesInicio - 1, 1);
                const dataFim = new Date(anoFim, mesFim - 1, 1);
                if (dataConsulta >= dataInicio && dataConsulta <= dataFim) {
                    return natureza === 'alimentar' ? juroAlimentar : juroComum;
                }
            }
            return 0;
        }
        
        //para juros mora
        function estaNoPeriodoGraca(data, inicioGraca, fimGraca) {
            return data >= inicioGraca && data <= fimGraca;
        }

        //para juros mora
        function gerarMesesEntreDatas(dataInicio, dataFim) {
            const meses = [];
            const atual = new Date(dataInicio);
            while (atual <= dataFim) {
                meses.push({
                    mes: atual.getMonth() + 1,
                    ano: atual.getFullYear(),
                    data: new Date(atual)
                });
                atual.setMonth(atual.getMonth() + 1);
            }
            return meses;
        }

        //para juros mora
        function calcularSomaJurosMora(mesBase, anoBase, natureza, inicioGraca = null, fimGraca = null) {
            const dataBase = criarDataBase(mesBase, anoBase);
            const dataLimite = new Date(2021, 10, 1); // Novembro/2021 (m√™s 10)
            if (dataBase > dataLimite) {
                return 0; // Fora do per√≠odo, sem juros
            }
            const mesesCalculo = gerarMesesEntreDatas(dataBase, dataLimite);
            let somaJuros = 0;
            for (const mesInfo of mesesCalculo) {
                const { mes, ano, data } = mesInfo;
                const estaGraca = inicioGraca && fimGraca && estaNoPeriodoGraca(data, inicioGraca, fimGraca);
                if (estaGraca) continue;
                const taxa = obterTaxaJuros(mes, ano, natureza);
                somaJuros += taxa;
            }
            return somaJuros;
        }

        async function calcularSelic(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const hoje = new Date();
                const primeiroDiaMesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                const urlselic = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                const response = await fetch(urlselic);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosselic = await response.json();
                // Fun√ß√£o para converter string de data da API em Date
                function strParaData(dataStr) {
                    const [dia, mes, ano] = dataStr.split('/');
                    return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                }
                // Aplica SELIC antes do in√≠cio da gra√ßa
                let selicAntesGraca = [];
                let periodoAntesGraca = '';
                if (dataBase < inicioGraca) {
                    const dadosAntesGraca = dadosselic.filter(item => {
                        const dataItem = strParaData(item.data);
                        return dataBase <= dataItem && dataItem < inicioGraca;
                    });
                    selicAntesGraca = dadosAntesGraca.map(item => parseFloat(item.valor.replace(',', '.')));
                    // Definir per√≠odo antes da gra√ßa
                    if (dadosAntesGraca.length > 0) {
                        const primeiraData = dadosAntesGraca[0].data;
                        const ultimaData = dadosAntesGraca[dadosAntesGraca.length - 1].data;
                        periodoAntesGraca = `${primeiraData} a ${ultimaData}`;
                    }
                }
                // CORRE√á√ÉO: Aplica SELIC ap√≥s o fim da gra√ßa, MAS S√ì A PARTIR DA DATA BASE
                let dadosAposGraca = [];
                if (dataBase > fimGraca) {
                    // Se dataBase √© ap√≥s a gra√ßa, aplica SELIC da dataBase at√© hoje
                    dadosAposGraca = dadosselic.filter(item => {
                        const dataItem = strParaData(item.data);
                        return dataItem >= dataBase; // A partir da data base
                    });
                } else {
                    // Se dataBase √© antes/durante a gra√ßa, aplica SELIC ap√≥s a gra√ßa at√© hoje
                    dadosAposGraca = dadosselic.filter(item => {
                        const dataItem = strParaData(item.data);
                        return dataItem > fimGraca; // Ap√≥s o fim da gra√ßa
                    });
                }

                const selicAposGraca = dadosAposGraca.map(item => parseFloat(item.valor.replace(',', '.')));
                // Definir per√≠odo ap√≥s a gra√ßa
                let periodoAposGraca = '';
                if (dadosAposGraca.length > 0) {
                    const primeiraData = dadosAposGraca[0].data;
                    const ultimaData = dadosAposGraca[dadosAposGraca.length - 1].data;
                    periodoAposGraca = `${primeiraData} a ${ultimaData}`;
                }
                // Soma da SELIC
                const somaSelicAntes = selicAntesGraca.reduce((sum, val) => sum + val, 0);
                const somaSelicApos = selicAposGraca.reduce((sum, val) => sum + val, 0);
                const somaSelic = somaSelicAntes + somaSelicApos;
                const indiceselic = 1 + (somaSelic / 100);
                const indiceSelicAntes = somaSelicAntes > 0 ? 1 + (somaSelicAntes / 100) : 1.0;
                const indiceSelicApos = somaSelicApos > 0 ? 1 + (somaSelicApos / 100) : 1.0;
                return {
                    indiceselic,
                    indiceSelicAntes,
                    indiceSelicApos,
                    periodoAntesGraca,
                    periodoAposGraca,
                    temSelicAntes: selicAntesGraca.length > 0,
                    temSelicApos: selicAposGraca.length > 0
                };
            } catch (error) {
                console.error(`Erro ao obter dados da SELIC: ${error}`);
                return {
                    indiceselic: 1.00,
                    indiceSelicAntes: 1.00,
                    indiceSelicApos: 1.00,
                    periodoAntesGraca: '',
                    periodoAposGraca: '',
                    temSelicAntes: false,
                    temSelicApos: false
                };
            }
        }

        // Fun√ß√£o para calcular IPCA-e acumulado
        async function calcularIpca(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const hoje = new Date();
                const primeiroDiaMesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                const urlipca = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.10764/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                const response = await fetch(urlipca);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosipca = await response.json();
                
                // Fun√ß√£o para converter string de data da API em Date
                function strParaData(dataStr) {
                    const [dia, mes, ano] = dataStr.split('/');
                    return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                }
                
                // CORRE√á√ÉO: IPCA s√≥ deve ser aplicado DURANTE o per√≠odo de gra√ßa
                // E APENAS se a data base estiver ANTES ou DURANTE a gra√ßa
                let ipcaGraca = [];
                
                if (dataBase <= fimGraca) {
                    // Determina o in√≠cio efetivo: o maior entre dataBase e inicioGraca
                    const inicioEfetivo = dataBase > inicioGraca ? dataBase : inicioGraca;
                    
                    ipcaGraca = dadosipca
                        .filter(item => {
                            const dataItem = strParaData(item.data);
                            return inicioEfetivo <= dataItem && dataItem <= fimGraca;
                        })
                        .map(item => parseFloat(item.valor.replace(',', '.')));
                }
                // Se dataBase > fimGraca, n√£o aplica IPCA (ipcaGraca fica vazio)
                
                // Fator acumulado IPCA
                let indiceipca = 1.0;
                for (const valor of ipcaGraca) {
                    indiceipca *= 1 + (valor / 100);
                }
                
                return indiceipca;
            } catch (error) {
                console.error(`Erro ao obter dados do IPCA: ${error}`);
                return 1.0; // Valor padr√£o em caso de erro
            }
        }

        const ColetaCache = {
            elementos: null,
            
            init() {
                // Cache TODOS os elementos de uma vez s√≥
                this.elementos = {
                    // Dados b√°sicos
                    numprocesso: document.getElementById('numprocesso'),
                    anoOrcamento: document.getElementById('anoOrcamento'),
                    beneficiario: document.getElementById('beneficiario'),
                    credor: document.getElementById('credor'),
                    mesBase: document.getElementById('mesBase'),
                    anoBase: document.getElementById('anoBase'),
                    valorPrincipal: document.getElementById('valorPrincipal'),
                    valorJuros: document.getElementById('valorJuros'),
                    rra: document.getElementById('rra'),
                    natureza: document.getElementById('natureza'),
                    tipoCalculo: document.getElementById('tipoCalculo'),
                    incidenciaIR: document.getElementById('incidenciaIR'),
                    incidenciaPrevidencia: document.getElementById('incidenciaPrevidencia'),
                    tipoPrevidencia: document.getElementById('tipoPrevidencia'),
                    aliquotaFixa: document.getElementById('aliquotaFixa'),
                    
                    // Quantidades
                    quantAdvogados: document.getElementById('quantAdvogados'),
                    quantHerdeiros: document.getElementById('quantHerdeiros'),
                    quantSindicatos: document.getElementById('quantSindicatos'),
                    quantCessoes: document.getElementById('quantCessoes'),
                    
                    // Campos condicionais
                    tetoPreferenciaPrincipal: document.getElementById('tetoPreferenciaPrincipal'),
                    percentualAcordoValor: document.getElementById('percentualAcordoValor')
                };
            },
            
            // Fun√ß√£o helper para obter valor com fallback
            getValue(elementId, defaultValue = '', parser = null) {
                const element = this.elementos[elementId];
                if (!element) return defaultValue;
                
                const value = element.value;
                if (!value && defaultValue !== '') return defaultValue;
                
                return parser ? parser(value) || defaultValue : value;
            }
        };

        // Fun√ß√£o calcular OTIMIZADA
        async function calcular() {
            // Inicializar cache se necess√°rio
            if (!ColetaCache.elementos) {
                ColetaCache.init();
            }
            
            // Coletar e validar dados
            const dados = coletarDados();
            const erros = validarDados(dados);
            
            if (erros.length > 0) {
                alert("Erros encontrados:\n" + erros.join("\n"));
                return;
            }
            
            const resultados = await calcularValores(dados);
            exibirResultados(resultados, dados)
        }

        // Fun√ß√£o coletarDados OTIMIZADA
        function coletarDados() {
            const cache = ColetaCache;
            
            // Coleta b√°sica otimizada (usando cache)
            const dados = {
                numProcesso: cache.getValue('numprocesso', 'Processo'),
                anoOrcamento: cache.getValue('anoOrcamento', 2026, parseInt),
                beneficiario: cache.getValue('beneficiario', 'Beneficiario'),
                credor: cache.getValue('credor', 'Devedor'),
                mesBase: cache.getValue('mesBase'),
                anoBase: cache.getValue('anoBase', 0, parseInt),
                valorPrincipal: cache.getValue('valorPrincipal', 0, parseFloat),
                valorJuros: cache.getValue('valorJuros', 0, parseFloat),
                rra: cache.getValue('rra', 0, parseFloat),
                natureza: cache.getValue('natureza'),
                tipoCalculo: cache.getValue('tipoCalculo'),
                incidenciaIR: cache.getValue('incidenciaIR') === 'sim',
                incidenciaPrevidencia: cache.getValue('incidenciaPrevidencia') === 'sim',
                tipoPrevidencia: cache.getValue('tipoPrevidencia'),
                aliquotaFixa: cache.getValue('aliquotaFixa', 0, parseFloat),
                
                // Quantidades
                quantAdvogados: cache.getValue('quantAdvogados', 0, parseInt),
                quantHerdeiros: cache.getValue('quantHerdeiros', 0, parseInt),
                quantSindicatos: cache.getValue('quantSindicatos', 0, parseInt),
                quantCessoes: cache.getValue('quantCessoes', 0, parseInt),
                
                // Arrays que ser√£o preenchidos
                advogados: [],
                herdeiros: [],
                sindicatos: [],
                cessoes: []
            };
            
            // C√°lculo derivado
            dados.valorTotal = dados.valorPrincipal + dados.valorJuros;
            
            // Campos condicionais otimizados
            if (dados.tipoCalculo === 'preferencia') {
                dados.tetoPreferencia = cache.getValue('tetoPreferenciaPrincipal', 0, parseFloat);
            }
            if (dados.tipoCalculo === 'acordo') {
                dados.percentualAcordo = cache.getValue('percentualAcordoValor', 0, parseFloat);
            }
            
            // Coletar dados complexos usando fun√ß√µes otimizadas
            coletarAdvogados(dados);
            coletarHerdeiros(dados);
            coletarSindicatos(dados);
            coletarCessoes(dados);
            
            return dados;
        }

        // Fun√ß√£o otimizada para coletar advogados
        function coletarAdvogados(dados) {
            for (let i = 0; i < dados.quantAdvogados; i++) {
                const nome = document.getElementById(`advNome${i}`)?.value || '';
                const tipo = document.getElementById(`advTipo${i}`)?.value || '';
                const percentual = parseFloat(document.getElementById(`advPercentual${i}`)?.value) || 0;
                
                dados.advogados.push({ nome, tipo, percentual });
            }
        }

        // Fun√ß√£o otimizada para coletar herdeiros
        function coletarHerdeiros(dados) {
            for (let i = 0; i < dados.quantHerdeiros; i++) {
                const nomeElement = document.getElementById(`herdNome${i}`);
                const percentualElement = document.getElementById(`herdPercentual${i}`);
                const preferenciaElement = document.getElementById(`herdPreferencia${i}`);
                
                // Early continue se elementos essenciais n√£o existem
                if (!nomeElement || !percentualElement) continue;
                
                dados.herdeiros.push({
                    nome: nomeElement.value || `Herdeiro ${i + 1}`,
                    percentual: parseFloat(percentualElement.value) || 0,
                    temPreferencia: preferenciaElement?.value === 'sim'
                });
            }
        }

        // Fun√ß√£o otimizada para coletar sindicatos
        function coletarSindicatos(dados) {
            for (let i = 0; i < dados.quantSindicatos; i++) {
                const nomeElement = document.getElementById(`sindNome${i}`);
                const percentualElement = document.getElementById(`sindPercentual${i}`);
                const tributacaoElement = document.getElementById(`sindTrib${i}`);
                
                // Early continue se elementos essenciais n√£o existem
                if (!nomeElement || !percentualElement || !tributacaoElement) continue;
                
                const tributacao = tributacaoElement.value;
                
                // L√≥gica otimizada para al√≠quota
                let aliquotaFixa = 0;
                if (tributacao === 'nao') {
                    aliquotaFixa = 1; // 100% - sem tributa√ß√£o
                } else if (tributacao === 'lei') {
                    aliquotaFixa = 0.03; // 3% - Art. 27, da Lei n¬∫ 10.833/03
                } else if (tributacao === 'fixa') {
                    const aliquotaElement = document.getElementById(`aliquotaSind${i}`);
                    aliquotaFixa = parseFloat(aliquotaElement?.value) || 0;
                }
                
                dados.sindicatos.push({
                    nome: nomeElement.value || `Sindicato ${i + 1}`,
                    percentual: parseFloat(percentualElement.value) || 0,
                    tributacao,
                    aliquotaTributacao: aliquotaFixa
                });
            }
        }

        // Fun√ß√£o otimizada para coletar cess√µes
        function coletarCessoes(dados) {
            for (let i = 0; i < dados.quantCessoes; i++) {
                const tipoElement = document.getElementById(`cessaoTipo${i}`);
                const cedenteElement = document.getElementById(`cedenteNome${i}`);
                const cessionarioElement = document.getElementById(`cessionarioNome${i}`);
                const percentualElement = document.getElementById(`cessaoPercentual${i}`);
                
                // Early continue se elementos essenciais n√£o existem
                if (!tipoElement || !cedenteElement || !cessionarioElement || !percentualElement) continue;
                
                const tipo = tipoElement.value;
                const cedente = cedenteElement.value;
                
                // S√≥ processar se dados b√°sicos est√£o preenchidos
                if (tipo && cedente) {
                    dados.cessoes.push({
                        tipo,
                        cedente,
                        cessionario: cessionarioElement.value || `Cession√°rio ${i + 1}`,
                        percentual: parseFloat(percentualElement.value) || 0
                    });
                }
            }
        }

        // Fun√ß√£o validarDados OTIMIZADA
        function validarDados(dados) {
            const erros = [];
            
            // Validar herdeiros (otimizado)
            if (dados.herdeiros.length > 0) {
                const somaHerdeiros = dados.herdeiros.reduce((sum, h) => sum + h.percentual, 0);
                if (Math.abs(somaHerdeiros - 1.0) > 0.001) {
                    erros.push(`A soma dos percentuais dos herdeiros deve ser 100% (atual: ${(somaHerdeiros * 100).toFixed(1)}%)`);
                }
            }
            
            // Validar cess√µes (otimizado)
            validarCessoes(dados, erros);
            
            return erros;
        }

        // Fun√ß√£o separada para validar cess√µes (mais limpa)
        function validarCessoes(dados, erros) {
            // Criar maps para busca otimizada (O(1) ao inv√©s de O(n))
            const advogadosMap = new Map(dados.advogados.map(adv => [adv.nome, true]));
            const herdeirosMap = new Map(dados.herdeiros.map(h => [h.nome, true]));
            const sindicatosMap = new Map(dados.sindicatos.map(s => [s.nome, true]));
            
            // Normalizar nome do benefici√°rio uma vez s√≥
            const beneficiarioNorm = dados.beneficiario.trim();
            
            dados.cessoes.forEach((cessao, i) => {
                // Validar percentual
                if (cessao.percentual > 1.0) {
                    erros.push(`Cess√£o ${i + 1}: Percentual n√£o pode ser maior que 100%`);
                }
                
                // Validar exist√™ncia do cedente (otimizado com maps)
                let cedenteExiste = false;
                const cedenteNorm = cessao.cedente.trim();
                
                switch (cessao.tipo) {
                    case 'cessaobenPrincipal':
                        cedenteExiste = cedenteNorm === beneficiarioNorm || cedenteNorm === 'Benefici√°rio Principal';
                        break;
                    case 'cessaoAdv':
                        cedenteExiste = advogadosMap.has(cessao.cedente);
                        break;
                    case 'cessaoHerdeiro':
                    case 'cessaoherdeiro':
                        cedenteExiste = herdeirosMap.has(cessao.cedente);
                        break;
                    case 'cessaoSindicato':
                        cedenteExiste = sindicatosMap.has(cessao.cedente);
                        break;
                }
                
                if (!cedenteExiste) {
                    erros.push(`Cess√£o ${i + 1}: Cedente "${cessao.cedente}" n√£o encontrado`);
                }
            });
        }

        // Inicializar cache quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            ColetaCache.init();
        });

        async function calcularValores(dados) {
            //datas
            const dataBase = criarDataBase(dados.mesBase, dados.anoBase);
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);

            //indices
            const indicesCNJ = obterIndiceCNJ(dados.mesBase, dados.anoBase); // CNJ
            const dadosSelic = await calcularSelic(dataBase, inicioGraca, fimGraca);// SELIC
            const indiceipca = await calcularIpca(dataBase, inicioGraca, fimGraca); // IPCA
            const jurosmora = calcularSomaJurosMora(dados.mesBase, dados.anoBase, dados.natureza, inicioGraca, fimGraca)/100;; // Juros de Mora

            // C√°lculos b√°sicos
            const indiceprinc = indicesCNJ * dadosSelic.indiceselic * indiceipca;
            const indicejur = dadosSelic.indiceselic * indiceipca;

            //jurosmora
            const valorjurosmora = dados.valorPrincipal * indicesCNJ * jurosmora;
            const juros = valorjurosmora + (dados.valorJuros * indicesCNJ);

            //valores atualizaco
            const valorprincatt = dados.valorPrincipal * indiceprinc;
            const valorjurosatt = juros * indicejur;
            const valortotatt = valorprincatt + valorjurosatt;

            //percentuais
            const percentualprinc = valorprincatt / valortotatt;
            const percentualjur = valorjurosatt / valortotatt;
            const indiceTotal = valortotatt / (dados.valorPrincipal + dados.valorJuros);

            // Detalhamento financeiro
            const detalhamento = calcularGlobal(dados, valortotatt, percentualprinc, percentualjur);

            return {
                //atualizacao
                valorprincatt,
                valorjurosatt,
                valortotatt,

                //calculo do beneficiario principal
                ...detalhamento,

                // √çndices para exibi√ß√£o
                indicesCNJ,
                dadosSelic,
                indiceipca,
                indiceTotal,
                jurosmora,
                //percentuais
                percentualprinc,
                percentualjur
            };
        }

        function calcularGlobal(dados, valortotatt, percentualprinc, percentualjur) {
            // Valor base conforme tipo de c√°lculo
            let valorBase = valortotatt;
            if (dados.tipoCalculo === 'preferencia' && dados.natureza === 'alimentar') {
                valorBase = Math.min(valortotatt, dados.tetoPreferencia);
            } else if (dados.tipoCalculo === 'acordo') {
                valorBase = valortotatt * (1 - dados.percentualAcordo);
            }

            // Composi√ß√£o inicial
            let principal = valorBase * percentualprinc;
            const jurosBase = valorBase * percentualjur;

            // RRA
            let rrapagamento = dados.rra !== 0 ? Math.round((valorBase * dados.rra) / valortotatt) : 0;

            // ========== CESS√ïES DO BENEFICI√ÅRIO PRINCIPAL ==========
            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            
            const cessoesBeneficiario = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaobenPrincipal'
            ) || [];

            let valorBaseParaHonorarios = valorBase;
            let valorBeneficiarioQueRecebeEfetivamente = valorBase;

            //verificar se h√° cess√µes do benefici√°rio
            if (cessoesBeneficiario.length > 0) {
                // Cess√£o √© sobre o valor TOTAL da d√≠vida, n√£o sobre o valor limitado
                const percentualBeneficiarioFinal = 1.0 - cessoesBeneficiario.reduce((total, cessao) => total + cessao.percentual, 0);
                
                // Calcular quanto o benefici√°rio tem direito na d√≠vida total (SEM descontar honor√°rios ainda)
                const direitoBeneficiarioTotal = valortotatt * percentualBeneficiarioFinal;
                
                // O que o benefici√°rio recebe efetivamente (limitado pelo teto se for prefer√™ncia)
                valorBeneficiarioQueRecebeEfetivamente = isPreferenciasParcial ? 
                    Math.min(direitoBeneficiarioTotal, valorBase) : direitoBeneficiarioTotal;
                
                // Base para honor√°rios
                if (isPreferenciasParcial) {
                    valorBaseParaHonorarios = valorBeneficiarioQueRecebeEfetivamente;
                } else {
                    valorBaseParaHonorarios = valorBase;
                }
            }

            // Honor√°rios
            const resultadoHonorarios = calcularHonorarios(dados, valorBaseParaHonorarios, valortotatt);
            const { honorarios, valorHonorarioTotal } = resultadoHonorarios;

            // Sindicatos 
            const resultadoSindicatos = calcularSindicatos(dados, valorBaseParaHonorarios, valortotatt);
            const { sindicatos, valorSindicatoTotal } = resultadoSindicatos;

            const valorSindicatoParaDescontar = isPreferenciasParcial ? 0 : valorSindicatoTotal;
            const valorBeneficiarioBruto = valorBase - valorHonorarioTotal - valorSindicatoParaDescontar;

            // REC√ÅLCULO PARA PREFER√äNCIA PARCIAL
            if (isPreferenciasParcial) {
                const valorPrincipalBeneficiario = valorBeneficiarioQueRecebeEfetivamente * percentualprinc;
                principal = valorPrincipalBeneficiario;
                
                // Para RRA: garantir que seja pelo menos 1 se havia RRA original
                if (dados.rra !== 0) {
                    const rraCalculado = Math.round((valorBeneficiarioQueRecebeEfetivamente * dados.rra) / valortotatt);
                    rrapagamento = Math.max(1, rraCalculado); 
                } else {
                    rrapagamento = 0;
                }
            }else if (cessoesBeneficiario.length > 0 && dados.tipoCalculo !== 'ordem') {
                // ORDEM COM CESS√ïES: Principal baseado no valor que o benefici√°rio receber√°
                const valorPrincipalBeneficiario = valorBeneficiarioQueRecebeEfetivamente * percentualprinc;
                principal = valorPrincipalBeneficiario;
                
                // Para RRA
                if (dados.rra !== 0) {
                    const rraCalculado = Math.round((valorBeneficiarioQueRecebeEfetivamente * dados.rra) / valortotatt);
                    rrapagamento = Math.max(1, rraCalculado); 
                } else {
                    rrapagamento = 0;
                }
            }

            const resultadoPrevidencia = calcularPrevidenciaIsolada(dados, principal, rrapagamento);
            let valorPrevidencia = resultadoPrevidencia.valorPrevidencia;
            let aliquotaEfetiva = resultadoPrevidencia.aliquotaEfetiva;

            const resultadoIR = calcularIRIsolado(dados, valortotatt, valorBase, principal, valorPrevidencia, rrapagamento);
            let {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                baseIRRRA,
                valorIRUnitario
            } = resultadoIR;

            const resultadoCessoes = calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR);
            let {
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            } = resultadoCessoes;

            return {
                valorBase,
                principal,
                jurosBase,
                rrapagamento,

                honorarios,
                valorHonorarioTotal,

                sindicatos,
                valorSindicatoTotal,

                valorPrevidencia,
                aliquotaEfetiva,
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                baseIRRRA,
                valorIRUnitario,

                valorBeneficiarioBruto: resultadoCessoes.valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioCalculadas,
                cessoesBeneficiarioFinais,
                isPreferenciasParcial
            };
        }

        function calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR) {
            const valorBeneficiarioBruto = valorBase - valorHonorarioTotal - valorSindicatoParaDescontar;
            const cessoesBeneficiario = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaobenPrincipal'
            ) || [];

            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            
            // Valores padr√£o (casos sem cess√µes)
            let valorCessoesBeneficiario = 0;
            let cessoesBeneficiarioCalculadas = [];
            let percentualBeneficiarioFinal = 1.0;
            let valorBeneficiarioAposCessoes = valorBeneficiarioBruto;
            let valorPrevidenciaBeneficiario = valorPrevidencia;
            let valorIRBeneficiario = valorIR;
            let valorBeneficiarioFinal = valorBeneficiarioBruto - valorPrevidencia - valorIR;
            let cessoesBeneficiarioFinais = [];

            // Early return se n√£o h√° cess√µes
            if (cessoesBeneficiario.length === 0) {
                return {
                    valorBeneficiarioBruto,
                    valorCessoesBeneficiario,
                    cessoesBeneficiarioCalculadas,
                    percentualBeneficiarioFinal,
                    valorBeneficiarioAposCessoes,
                    valorPrevidenciaBeneficiario,
                    valorIRBeneficiario,
                    valorBeneficiarioFinal,
                    cessoesBeneficiarioFinais
                };
            }

            // OTIMIZA√á√ÉO: C√°lculos que ser√£o reutilizados (cache)
            const totalPercentualCessoes = cessoesBeneficiario.reduce((total, cessao) => total + cessao.percentual, 0);
            percentualBeneficiarioFinal = 1.0 - totalPercentualCessoes;
            
            // Cache c√°lculo pesado dos advogados (usado m√∫ltiplas vezes)
            const percentualAdvogados = dados.advogados.length > 0 ? 
                dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0) : 0;
            const valortotattSemAdvogados = valortotatt - (valortotatt * percentualAdvogados);

            if (isPreferenciasParcial) {
                // PREFER√äNCIA PARCIAL
                const parteBeneficiarioNaDividaTotal = valortotattSemAdvogados * percentualBeneficiarioFinal;
                const maxQueBeneficiarioPodeReceber = Math.min(parteBeneficiarioNaDividaTotal, valorBeneficiarioBruto);
                
                cessoesBeneficiarioCalculadas = [];
                cessoesBeneficiarioFinais = [];
                
                for (const cessao of cessoesBeneficiario) {
                    const parteCessionarioNaDividaTotal = valortotattSemAdvogados * cessao.percentual;
                    
                    const cessaoCalculada = {
                        tipo: cessao.tipo,
                        cedente: cessao.cedente,
                        cessionario: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: 0,
                        valorSaldoDevedor: parteCessionarioNaDividaTotal,
                        observacao: 'Aguarda pagamento - sem direito √† prefer√™ncia'
                    };
                    
                    const cessaoFinal = {
                        ...cessaoCalculada,
                        previdenciaCessao: 0,
                        irCessao: 0,
                        valorLiquido: 0
                    };
                    
                    cessoesBeneficiarioCalculadas.push(cessaoCalculada);
                    cessoesBeneficiarioFinais.push(cessaoFinal);
                }

                valorCessoesBeneficiario = 0; 
                valorBeneficiarioAposCessoes = maxQueBeneficiarioPodeReceber;
                
                // Previd√™ncia e IR aplicados sobre o valor recalculado
                valorPrevidenciaBeneficiario = valorPrevidencia;
                valorIRBeneficiario = valorIR;
                valorBeneficiarioFinal = maxQueBeneficiarioPodeReceber - valorPrevidenciaBeneficiario - valorIRBeneficiario;
                
            } else {
                // PREFER√äNCIA TOTAL OU OUTROS TIPOS 
                const valorPrevidenciaPorPercentual = valorPrevidencia; 
                const valorIRPorPercentual = valorIR; 
                
                // Reset valor total de cess√µes
                valorCessoesBeneficiario = 0;
                
                // OTIMIZA√á√ÉO: Um loop s√≥ para ambos arrays
                cessoesBeneficiarioCalculadas = [];
                cessoesBeneficiarioFinais = [];
                
                for (const cessao of cessoesBeneficiario) {
                    const valorBrutoCessao = valorBeneficiarioBruto * cessao.percentual;
                    valorCessoesBeneficiario += valorBrutoCessao;
                    
                    const cessaoCalculada = {
                        tipo: cessao.tipo,
                        cedente: cessao.cedente,
                        cessionario: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao
                    };
                    
                    // C√°lculos para cess√£o final
                    const previdenciaCessao = valorPrevidenciaPorPercentual * cessao.percentual;
                    const irCessao = valorIRPorPercentual * cessao.percentual;
                    const valorLiquidoCessao = valorBrutoCessao - previdenciaCessao - irCessao;
                    
                    const cessaoFinal = {
                        ...cessaoCalculada,
                        previdenciaCessao,
                        irCessao,
                        valorLiquido: valorLiquidoCessao
                    };
                    
                    cessoesBeneficiarioCalculadas.push(cessaoCalculada);
                    cessoesBeneficiarioFinais.push(cessaoFinal);
                }
                
                valorBeneficiarioAposCessoes = valorBeneficiarioBruto * percentualBeneficiarioFinal;
                valorPrevidenciaBeneficiario = valorPrevidencia * percentualBeneficiarioFinal;
                valorIRBeneficiario = valorIR * percentualBeneficiarioFinal;
                valorBeneficiarioFinal = valorBeneficiarioAposCessoes - valorPrevidenciaBeneficiario - valorIRBeneficiario;
            }

            return {
                valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            };
        }


        function calcularHonorarios(dados, valorBase, valortotatt) {
            let valorHonorarioTotal = 0;
            const honorarios = dados.advogados.map(adv => {
                const percentualTotalAdvogado = adv.percentual;
                const valorBrutoTotal = valorBase * percentualTotalAdvogado;
                
                // Verificar se o advogado fez cess√£o
                const cessaoAdv = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoAdv' && cessao.cedente === adv.nome
                );
                
                // Calcular percentual total cedido pelo advogado
                let percentualCessionarioAdv = cessaoAdv.reduce((total, cessao) => total + cessao.percentual, 0);
                const percentualAdvogado = Math.max(0, percentualTotalAdvogado - percentualCessionarioAdv);

                const valorBrutoAdvogado = valorBase * Math.max(0, percentualAdvogado);
                const valorBrutoCessionario = valorBase * percentualCessionarioAdv;

                let irAdvogado = 0;
                if (adv.tipo === 'PF') {
                    irAdvogado = calcularIR(valorBrutoAdvogado); 
                } else {
                    irAdvogado = valorBrutoAdvogado * 0.015; 
                }

                let irCessionarioAdv = 0;
                if (adv.tipo === 'PF') {
                    irCessionarioAdv = calcularIR(valorBrutoCessionario); 
                } else {
                    irCessionarioAdv = valorBrutoCessionario * 0.015; 
                }

                const valorLiquidoAdvogado = valorBrutoAdvogado - irAdvogado;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioAdv;

                const cessionarios = cessaoAdv.map(cessao => {
                    const valorBrutoCessao = valorBase * cessao.percentual;
                    const irCessao = adv.tipo === 'PF' ? calcularIR(valorBrutoCessao) : valorBrutoCessao * 0.015;
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });

                // Dados totais dos cession√°rios (para compatibilidade)
                const valorBruto = valorBrutoTotal;
                const ir = irAdvogado + irCessionarioAdv;
                const valorLiquido = valorLiquidoAdvogado + valorLiquidoCessionario;

                // Ajuste para valorHonorarioTotal
                let valorParaDescontar = valorBrutoAdvogado;
                if (dados.tipoCalculo === 'preferencia' && valorBase < valortotatt) {
                    // Prefer√™ncia parcial: s√≥ advogado recebe, cession√°rio aguarda
                    valorParaDescontar = valorBrutoAdvogado;
                } else {
                    // Ordem comum ou prefer√™ncia total: todos recebem
                    valorParaDescontar = valorBrutoTotal;
                }
                valorHonorarioTotal += valorParaDescontar;

                // Compatibilidade com c√≥digo antigo
                const primeiraCessao = cessaoAdv.length > 0 ? cessaoAdv[0] : null;

                return {
                    ...adv,
                    valorBruto,
                    ir,
                    valorLiquido,
                    // Dados do advogado
                    percentualAdvogado,
                    valorBrutoAdvogado,
                    irAdvogado,
                    valorLiquidoAdvogado,
                    // Dados totais dos cession√°rios
                    percentualCessionarioAdv,
                    valorBrutoCessionario,
                    irCessionarioAdv,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesAdv: cessaoAdv,
                    // Compatibilidade
                    cessao: primeiraCessao,
                    nomeCessionario: primeiraCessao ? primeiraCessao.cessionario : null
                };
            });

            return { honorarios, valorHonorarioTotal };
        }

        function calcularSindicatos(dados, valorBase, valortotatt) {
            let valorSindicatoTotal = 0;
            
            // Verificar se √© prefer√™ncia parcial (n√£o paga sindicatos)
            const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            
            const sindicatos = dados.sindicatos.map(sind => {
                const percentualTotalSindicato = sind.percentual;
                
                // DIFEREN√áA PRINCIPAL: Sindicato sempre calcula sobre valor total da d√≠vida
                const valorBrutoTotal = valortotatt * percentualTotalSindicato;
                
                // Verificar se o sindicato fez cess√£o
                const cessaoSind = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoSindicato' && cessao.cedente === sind.nome
                ) || [];
                
                // Calcular percentual total cedido pelo sindicato
                let percentualCessionarioSind = cessaoSind.reduce((total, cessao) => total + cessao.percentual, 0);
                const percentualSindicato = Math.max(0, percentualTotalSindicato - percentualCessionarioSind);

                const valorBrutoSindicato = valorBrutoTotal * percentualSindicato; 

                const valorBrutoCessionario = valorBrutoTotal * percentualCessionarioSind; 

                let irSindicato = 0;
                let irCessionarioSind = 0;
                
                if (sind.tributacao === 'nao') {
                    // Sem tributa√ß√£o (aliquotaTributacao = 1)
                    irSindicato = 0;
                    irCessionarioSind = 0;
                } else if (sind.tributacao === 'lei') {
                    // Art. 27, Lei 10.833/03 (aliquotaTributacao = 0.03)
                    irSindicato = valorBrutoSindicato * 0.03;
                    irCessionarioSind = valorBrutoCessionario * 0.03;
                } else if (sind.tributacao === 'fixa') {
                    // Al√≠quota fixa personalizada
                    irSindicato = valorBrutoSindicato * sind.aliquotaTributacao;
                    irCessionarioSind = valorBrutoCessionario * sind.aliquotaTributacao;
                }

                const valorLiquidoSindicato = valorBrutoSindicato - irSindicato;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioSind;

                // Detalhes dos cession√°rios
                const cessionarios = cessaoSind.map(cessao => {
                    const valorBrutoCessao = valorBrutoTotal * cessao.percentual; 
                    let irCessao = 0;
                    
                    if (sind.tributacao === 'nao') {
                        irCessao = 0;
                    } else if (sind.tributacao === 'lei') {
                        irCessao = valorBrutoCessao * 0.03;
                    } else if (sind.tributacao === 'fixa') {
                        irCessao = valorBrutoCessao * sind.aliquotaTributacao;
                    }
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });

                // Definir valores efetivos baseado na prefer√™ncia parcial
                if (!isPreferenciaParcial) {
                    // Ordem comum ou prefer√™ncia total: sindicatos recebem normalmente
                    valorSindicatoTotal += valorBrutoTotal;
                }

                return {
                    ...sind,
                    valorBruto: valorBrutoTotal,
                    ir: irSindicato + irCessionarioSind,
                    valorLiquido: valorLiquidoSindicato + valorLiquidoCessionario,
                    
                    // Dados do sindicato
                    percentualSindicato,
                    valorBrutoSindicato,
                    irSindicato,
                    valorLiquidoSindicato,
                    
                    // Dados totais dos cession√°rios
                    percentualCessionarioSind,
                    valorBrutoCessionario,
                    irCessionarioSind,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesSind: cessaoSind,
                    
                    // Flag de controle
                    podeReceber: !isPreferenciaParcial
                };
            });

            return { 
                sindicatos, 
                valorSindicatoTotal
            };
        }

        function calcularIRIsolado(dados, valortotatt, valorBase, principalBase, valorPrevidencia, rrapagamentoRecalculado) {
            let valorIR = 0;
            let aliquotaIR = 0;
            let baseIRHonora = 0;
            let baseIRSindi = 0;
            let baseIRPrev = 0;
            let baseIRRRA = 0;
            let valorIRUnitario = 0;

            if (dados.incidenciaIR && rrapagamentoRecalculado !== 0) {
                let percentualTotalAdv = 0;
                let percentualTotalSind = 0;
                if (dados.tipoCalculo === 'preferencia' && valorBase < valortotatt) {
                    // PREFER√äNCIA PARCIAL: S√≥ desconta honor√°rios que s√£o pagos (advogados)
                    percentualTotalAdv = dados.advogados.reduce((sum, adv) => {
                        const cessaoAdv = dados.cessoes?.filter(cessao => 
                            cessao.tipo === 'cessaoAdv' && cessao.cedente === adv.nome
                        ) || [];
                        const percentualCessionarioAdv = cessaoAdv.reduce((total, cessao) => total + cessao.percentual, 0);
                        const percentualAdvogado = Math.max(0, adv.percentual - percentualCessionarioAdv);
                        return sum + percentualAdvogado; // S√≥ a parte do advogado
                    }, 0);
                    percentualTotalSind = 0;
                } else {
                    // PREFER√äNCIA TOTAL OU ORDEM COMUM: Desconta todos os honor√°rios
                    percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                    percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
                }
                
                const baseIR = (principalBase - (principalBase * percentualTotalAdv) - (principalBase * percentualTotalSind) - valorPrevidencia) / rrapagamentoRecalculado;
                valorIRUnitario = calcularIR(baseIR);
                valorIR = valorIRUnitario * rrapagamentoRecalculado;
                aliquotaIR = obterAliquotaIR(baseIR);

                baseIRHonora = principalBase - (principalBase * percentualTotalAdv);
                baseIRSindi = baseIRHonora - (principalBase * percentualTotalSind);
                baseIRPrev = baseIRHonora - valorPrevidencia;
                baseIRRRA = baseIRPrev / rrapagamentoRecalculado;
            }

            return {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                baseIRRRA,
                valorIRUnitario
            };
        }

        function calcularIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return (valorBruto * 0.075) - 182.16;
            else if (valorBruto <= 3751.05) return (valorBruto * 0.15) - 394.16;
            else if (valorBruto <= 4664.68) return (valorBruto * 0.225) - 675.49;
            else return (valorBruto * 0.275) - 908.73;
        }

        function obterAliquotaIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return 0.075;
            else if (valorBruto <= 3751.05) return 0.15;
            else if (valorBruto <= 4664.68) return 0.225;
            else return 0.275;
        }

        function calcularPrevidenciaIsolada(dados, principalBase, rrapagamento) {
            let valorPrevidencia = 0;
            let aliquotaEfetiva = 0;
            
            if (dados.incidenciaPrevidencia) {
                if (dados.tipoPrevidencia === 'fixa') {
                    valorPrevidencia = principalBase * dados.aliquotaFixa;
                    aliquotaEfetiva = dados.aliquotaFixa;
                } else {
                    const base = rrapagamento === 0 ? principalBase : principalBase / rrapagamento;
                    const resultadoINSS = calcularINSS(base);
                    valorPrevidencia = resultadoINSS * (rrapagamento || 1);
                    aliquotaEfetiva = resultadoINSS / base;
                }
            }
            
            return { valorPrevidencia, aliquotaEfetiva };
        }

        function calcularINSS(base) {
            if (base <= 1518.00) return base * 0.075;
            else if (base <= 2793.88) return 1518 * 0.075 + (base - 1518) * 0.09;
            else if (base <= 4190.83) return 1518 * 0.075 + 1275.88 * 0.09 + (base - 2793.88) * 0.12;
            else if (base <= 8157.41) return 1518 * 0.075 + 1275.88 * 0.09 + 1396.95 * 0.12 + (base - 4190.83) * 0.14;
            else return 951.63; // Teto
        }

        function exibirResultados(resultados, dados) {
            const container = document.getElementById('resultadosContent');
            const dataAtual = obterDataAtual();
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);
            
            const html = `
                ${gerarCabecalhoProcesso(dados, resultados, dataAtual)}
                ${gerarDemonstrativoValores(dados, resultados, dataAtual)}
                ${gerarIndicesUtilizados(dados, resultados, inicioGraca, fimGraca)}
                ${gerarCalculosPrincipal(dados, resultados, inicioGraca, fimGraca)}
                ${gerarCalculosJuros(dados, resultados, inicioGraca, fimGraca)}
                ${gerarResumoCalculos(resultados)}
                ${gerarSecaoSindicatos(resultados)}
                ${gerarSecaoCessoesSindicatos(resultados, dados)}
                ${gerarSecaoHonorarios(resultados, dados)}
                ${gerarSecaoCessoesBeneficiario(resultados, dados)}
                ${gerarSecaoCessoesAdvogados(resultados, dados)}
                ${gerarSecaoDeducoes(resultados, dados)}
                ${gerarSecoesPagamentos(resultados, dados)}
                ${gerarBotaoImprimir()}
            `;
            
            container.innerHTML = html;
            showTab('tab7');
        }

        function obterDataAtual() {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function formatarData(data) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                        'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return `${meses[data.getMonth()]}/${data.getFullYear()}`;
        }

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function gerarCabecalhoProcesso(dados, resultados, dataAtual) {
            const secaoRRA = dados.rra && resultados.rrapagamento !== 0 
                ? `<tr><td>Rendimentos Recebidos Acumuladamente Total (RRA):</td><td>${dados.rra} meses</td></tr>`
                : '';
            
            return `
                <div class="table-container">
                    <h3>üìã Identifica√ß√£o do Processo</h3>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Informa√ß√£o</th></tr>
                        <tr><td>N√∫mero do Processo</td><td>${dados.numProcesso || 'N√£o informado'}</td></tr>
                        <tr><td>Benefici√°rio Principal</td><td>${dados.beneficiario || 'N√£o informado'}</td></tr>
                        <tr><td>Devedor</td><td>${dados.credor || 'N√£o informado'}</td></tr>
                        <tr><td>Natureza do Processo</td><td>${dados.natureza === 'alimentar' ? '‚öñÔ∏è Alimentar' : '‚öñÔ∏è Comum'}</td></tr>
                        ${secaoRRA}
                        <tr><td>Ano do or√ßamento do Precat√≥rio:</td><td>${dados.anoOrcamento || 'N√£o informado'}</td></tr>
                        <tr><td>Data-base do c√°lculo homologado na execu√ß√£o:</td><td>${dados.mesBase || 'N√£o informado'}/${dados.anoBase || 'N√£o informado'}</td></tr>
                    </table>
                </div>
            `;
        }

        function gerarDemonstrativoValores(dados, resultados, dataAtual) {
            const indiceTotal = isNaN(resultados.indiceTotal) ? '1' : resultados.indiceTotal.toFixed(6);
            
            return `
                <div class="table-container">
                    <h3>üí∞ Demonstrativo de Valores - Hist√≥rico vs. Atual</h3>
                    <table>
                        <tr>
                            <th>Componente</th>
                            <th>Valor Hist√≥rico (${dados.mesBase || 'N√£o informado'}/${dados.anoBase || 'N√£o informado'})</th>
                            <th>Corre√ß√£o Aplicada*</th>
                            <th>Valor Atualizado (${dataAtual})</th>
                        </tr>
                        <tr>
                            <td>Principal</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal)}</td>
                            <td>${indiceTotal}</td>
                            <td>R$ ${formatarMoeda(resultados.valorprincatt)}</td>
                        </tr>
                        <tr>
                            <td>Juros</td>
                            <td>R$ ${formatarMoeda(dados.valorJuros)}</td>
                            <td>${indiceTotal}</td>
                            <td>R$ ${formatarMoeda(resultados.valorjurosatt)}</td>
                        </tr>
                        <tr class="highlight">
                            <td><strong>Total Atualizado</strong></td>
                            <td><strong>R$ ${formatarMoeda(dados.valorTotal)}</strong></td>
                            <td><strong>-</strong></td>
                            <td><strong>R$ ${formatarMoeda(resultados.valortotatt)}</strong></td>
                        </tr>
                    </table>
                </div>
                <div class="success-box" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                    *Atualiza√ß√£o Monet√°ria conforme Resolu√ß√£o CNJ n¬∫ 303/2019, com √≠ndices de corre√ß√£o monet√°ria, conforme caput do Art.21- A - <strong>Per√≠odo de Corre√ß√£o</strong>: Os valores foram atualizados desde a base <strong>${dados.mesBase || 'N√£o informado'}/${dados.anoBase || 'N√£o informado'}</strong> at√© <strong>${dataAtual}</strong>.
                </div>
            `;
        }

        function gerarIndicesUtilizados(dados, resultados, inicioGraca, fimGraca) {
            const inicioGracaFormatado = formatarData(inicioGraca);
            const fimGracaFormatado = formatarData(fimGraca);
            
            let linhasSelicHTML = '';
            if (resultados.dadosSelic.temSelicAntes) {
                linhasSelicHTML += `
                <tr>
                    <td>SELIC Antes da Gra√ßa</td>
                    <td>${resultados.dadosSelic.indiceSelicAntes.toFixed(6)}</td>
                    <td>${resultados.dadosSelic.periodoAntesGraca}</td>
                </tr>`;
            }
            if (resultados.dadosSelic.temSelicApos) {
                linhasSelicHTML += `
                <tr>
                    <td>SELIC Ap√≥s a Gra√ßa</td>
                    <td>${resultados.dadosSelic.indiceSelicApos.toFixed(6)}</td>
                    <td>${resultados.dadosSelic.periodoAposGraca}</td>
                </tr>`;
            }
            linhasSelicHTML += `
            <tr class="selic-acumulada">
                <td>SELIC Acumulada</td>
                <td>${resultados.dadosSelic.indiceselic.toFixed(6)}</td>
                <td>Total dos per√≠odos aplic√°veis</td>
            </tr>`;
            
            return `
                <div class="table-container">
                    <h3>üìä √çndices Utilizados</h3>
                    <table>
                        <tr><th>√çndice</th><th>Valor</th><th>Per√≠odo/Observa√ß√£o</th></tr>
                        <tr><td>√çndice CNJ</td><td>${resultados.indicesCNJ.toFixed(6)}</td><td>${dados.mesBase}/${dados.anoBase}</td></tr>
                        ${linhasSelicHTML}
                        <tr><td>IPCA-e Acumulado</td><td>${resultados.indiceipca.toFixed(6)}</td><td>Per√≠odo de Gra√ßa: ${inicioGracaFormatado} - ${fimGracaFormatado}</td></tr>
                        <tr><td>Juros de Mora</td><td>${resultados.jurosmora.toFixed(6)}</td><td>Natureza: ${dados.natureza}</td></tr>
                    </table>
                </div>
            `;
        }

        function gerarCalculosPrincipal(dados, resultados, inicioGraca, fimGraca) {
            const inicioGracaFormatado = formatarData(inicioGraca);
            const fimGracaFormatado = formatarData(fimGraca);
            
            return `
                <div class="table-container">
                    <h3>üí∞ Atualiza√ß√£o do Principal - Passo a Passo</h3>
                    <table>
                        <tr><th>Etapa</th><th>C√°lculo</th><th>Valor</th></tr>
                        <tr>
                            <td>1. Valor Original</td>
                            <td>Principal Homologado</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal)}</td>
                        </tr>
                        <tr>
                            <td>2. Corre√ß√£o CNJ</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal)} √ó ${resultados.indicesCNJ.toFixed(6)}</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal * resultados.indicesCNJ)}</td>
                        </tr>
                        <tr>
                            <td>3. Aplica√ß√£o IPCA (gra√ßa - ${inicioGracaFormatado} - ${fimGracaFormatado})</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal * resultados.indicesCNJ)} √ó ${resultados.indiceipca.toFixed(6)}</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal * resultados.indicesCNJ * resultados.indiceipca)}</td>
                        </tr>
                        <tr>
                            <td>4. Aplica√ß√£o SELIC (excluido a gra√ßa)</td>
                            <td>R$ ${formatarMoeda(dados.valorPrincipal * resultados.indicesCNJ * resultados.indiceipca)} √ó ${resultados.dadosSelic.indiceselic.toFixed(6)}</td>
                            <td><strong>R$ ${formatarMoeda(resultados.valorprincatt)}</strong></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function gerarCalculosJuros(dados, resultados, inicioGraca, fimGraca) {
            const inicioGracaFormatado = formatarData(inicioGraca);
            const fimGracaFormatado = formatarData(fimGraca);
            
            const jurosOriginaisCNJ = dados.valorJuros * resultados.indicesCNJ;
            const jurosMora = dados.valorPrincipal * resultados.indicesCNJ * resultados.jurosmora;
            const totalJuros = jurosOriginaisCNJ + jurosMora;
            const totalJurosIPCA = totalJuros * resultados.indiceipca;
            
            return `
                <div class="table-container">
                    <h3>‚öñÔ∏è Atualiza√ß√£o dos Juros - Passo a Passo</h3>
                    <table>
                        <tr><th>Etapa</th><th>C√°lculo</th><th>Valor</th></tr>
                        <tr><td>1. Juros Originais</td><td>Juros Homologado</td><td>R$ ${formatarMoeda(dados.valorJuros)}</td></tr>
                        <tr><td>2. Corre√ß√£o CNJ</td><td>R$ ${formatarMoeda(dados.valorJuros)} √ó ${resultados.indicesCNJ.toFixed(6)}</td><td>R$ ${formatarMoeda(jurosOriginaisCNJ)}</td></tr>
                        <tr><td>3. Juros de Mora</td><td>Principal CNJ √ó ${(resultados.jurosmora * 100).toFixed(4)}%*</td><td>R$ ${formatarMoeda(jurosMora)}</td></tr>
                        <tr><td>4. Total Juros (CNJ + Mora)</td><td>R$ ${formatarMoeda(jurosOriginaisCNJ)} + R$ ${formatarMoeda(jurosMora)}</td><td>R$ ${formatarMoeda(totalJuros)}</td></tr>
                        <tr><td>5. Aplica√ß√£o IPCA (gra√ßa - ${inicioGracaFormatado} - ${fimGracaFormatado})</td><td>R$ ${formatarMoeda(totalJuros)} √ó ${resultados.indiceipca.toFixed(6)}</td><td>R$ ${formatarMoeda(totalJurosIPCA)}</td></tr>
                        <tr><td>6. Aplica√ß√£o SELIC (excluido a gra√ßa)</td><td>R$ ${formatarMoeda(totalJurosIPCA)} √ó ${resultados.dadosSelic.indiceselic.toFixed(6)}</td><td><strong>R$ ${formatarMoeda(resultados.valorjurosatt)}</strong></td></tr>
                    </table>
                </div>
                <div class="success-box" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                    *Juros calculados de forma simples, conforme art. 1¬∫ da Lei n¬∫ 12.703/2012; art. 1¬∫, "F", da Lei n¬∫ 9.494/1997; art. 100, ¬ß 12¬∫ da CF/88, Art.22 da Resolu√ß√£o 303 do CNJ e SV n¬∫ 17 do STF.
                </div>
            `;
        }

        function gerarResumoCalculos(resultados) {
            return `
                <div class="table-container">
                    <h3>üìà Resumo dos C√°lculos</h3>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Valor</th><th>%</th></tr>
                        <tr><td>Valor Principal Atualizado</td><td>R$ ${formatarMoeda(resultados.valorprincatt)}</td><td>${(resultados.percentualprinc * 100).toFixed(4)}%</td></tr>
                        <tr><td>Valor Juros Atualizado</td><td>R$ ${formatarMoeda(resultados.valorjurosatt)}</td><td>${(resultados.percentualjur * 100).toFixed(4)}%</td></tr>
                        <tr class="highlight"><td>Total Atualizado</td><td>R$ ${formatarMoeda(resultados.valortotatt)}</td><td>${((resultados.percentualprinc + resultados.percentualjur) * 100).toFixed(2)}%</td></tr>
                        <tr class="highlight"><td>Valor Base para C√°lculo</td><td>R$ ${formatarMoeda(resultados.valorBase)}</td><td>${((resultados.valorBase / resultados.valortotatt) * 100).toFixed(2)}%</td></tr>
                    </table>
                </div>
            `;
        }

        function gerarSecaoSindicatos(resultados) {
            if (!resultados.sindicatos || resultados.sindicatos.length === 0) return '';
            
            const linhasSindicatos = resultados.sindicatos.map(s => `
                <tr>
                    <td>${s.nome}</td>
                    <td>R$ ${formatarMoeda(resultados.valortotatt)}</td>
                    <td>${(s.percentual * 100).toFixed(2)}%</td>
                    <td>R$ ${formatarMoeda(s.valorBruto)}</td>
                </tr>
            `).join('');
            
            const totalSindicatos = resultados.sindicatos.reduce((total, s) => total + s.valorBruto, 0);
            
            return `
                <div class="table-container">
                    <h3>üèõÔ∏è Sindicatos</h3>
                    <table>
                        <tr><th>Nome Sindicato</th><th>Base de C√°lculo</th><th>Percentual</th><th>Valor Bruto</th></tr>
                        ${linhasSindicatos}
                        <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                            <td colspan="3"><strong>TOTAL SINDICATOS</strong></td>
                            <td><strong>R$ ${formatarMoeda(totalSindicatos)}</strong></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function gerarSecaoCessoesSindicatos(resultados, dados) {
            const ehPreferenciaParcial = dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt;
            if (ehPreferenciaParcial || !resultados.sindicatos) return '';
            
            const sindicatosComCessao = resultados.sindicatos.filter(sind => 
                sind.cessoesSind && sind.cessoesSind.length > 0
            );
            
            if (sindicatosComCessao.length === 0) return '';
            
            const secoesSindicatos = sindicatosComCessao.map(sind => {
                const cessionarios = sind.cessionarios ? sind.cessionarios.map(cessionario => `
                    <tr>
                        <td>${cessionario.nome} (cession√°rio)</td>
                        <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(cessionario.valorBruto)}</td>
                    </tr>
                `).join('') : '';
                
                return `
                    <div style="margin-bottom: 20px;">
                        <h4>üîÑ Cess√£o de Sindicato: ${sind.nome}</h4>
                        <p><strong>Valor do Direito do Sindicato:</strong> R$ ${formatarMoeda(sind.valorBruto)}</p>
                        <p><strong>Cedido:</strong> ${(sind.percentualCessionarioSind * 100).toFixed(2)}% para ${sind.cessoesSind.length} cession√°rio${sind.cessoesSind.length > 1 ? 's' : ''}</p>
                        
                        <table>
                            <tr><th>Recebedor</th><th>Percentual</th><th>Valor Bruto</th></tr>
                            <tr style="background-color: #f8f9fa;">
                                <td><strong>${sind.nome} (fica com)</strong></td>
                                <td>${(sind.percentualSindicato * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(sind.valorBrutoSindicato)}</td>
                            </tr>
                            ${cessionarios}
                            <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td>TOTAL</td>
                                <td>100.00%</td>
                                <td>R$ ${formatarMoeda(sind.valorBruto)}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="table-container">
                    <h3>üîÑ Cess√µes de Sindicatos</h3>
                    ${secoesSindicatos}
                </div>
            `;
        }

        function gerarSecaoHonorarios(resultados, dados) {
            if (!resultados.honorarios || resultados.honorarios.length === 0) return '';
            
            // Se√ß√£o de honor√°rios totais (para prefer√™ncia parcial)
            let secaoHonorariosTotais = '';
            
            // Se√ß√£o de honor√°rios originais
            const tituloSecao = dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt 
                ? 'üë©‚Äçüíº Advogados - Honor√°rios da Prefer√™ncia' 
                : 'üë©‚Äçüíº Advogados';
            
            // Calcular base real
            let baseCalculoRealHonorarios = resultados.valorBase;
            const cessoesBeneficiario = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaobenPrincipal'
            ) || [];
            
            if (cessoesBeneficiario.length > 0) {
                const percentualBeneficiarioFinal = 1.0 - cessoesBeneficiario.reduce((total, cessao) => total + cessao.percentual, 0);
                const direitoBeneficiarioTotal = resultados.valortotatt * percentualBeneficiarioFinal;
                const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt;
                
                if (isPreferenciasParcial) {
                    baseCalculoRealHonorarios = Math.min(direitoBeneficiarioTotal, resultados.valorBase);
                }
            }
            
            let descricaoBase = '';
            if (dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt) {
                if (baseCalculoRealHonorarios !== resultados.valorBase) {
                    descricaoBase = `<p style="color: #155724; font-style: italic;">
                        Valores calculados sobre base efetiva: R$ ${formatarMoeda(baseCalculoRealHonorarios)} 
                        <span style="color: #856404;">(ajustada por cess√µes - teto original: R$ ${formatarMoeda(resultados.valorBase)})</span>
                    </p>`;
                } else {
                    descricaoBase = `<p style="color: #155724; font-style: italic;">
                        Valores calculados sobre a prefer√™ncia: R$ ${formatarMoeda(resultados.valorBase)}
                    </p>`;
                }
            } else if (baseCalculoRealHonorarios !== resultados.valorBase) {
                descricaoBase = `<p style="color: #155724; font-style: italic;">
                    Valores calculados sobre base efetiva: R$ ${formatarMoeda(baseCalculoRealHonorarios)} 
                    <span style="color: #856404;">(ajustada por cess√µes)</span>
                </p>`;
            }
            
            const secaoHonorariosOriginal = `
            <div class="table-container">
                <h3>üìÑ‚ûñ Dedu√ß√µes Acess√≥rias</h3>
                <h3>${tituloSecao}</h3>
                ${descricaoBase}
                <table>
                    <tr><th>Nome Advogado</th><th>PF/PJ</th><th>Base de C√°lculo</th><th>Percentual</th><th>Valor Bruto</th></tr>
                    ${resultados.honorarios.map(h => `
                    <tr>
                        <td>${h.nome}</td>
                        <td>${h.tipo}</td>
                        <td>R$ ${formatarMoeda(baseCalculoRealHonorarios)}</td>
                        <td>${(h.percentual * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(h.valorBruto)}</td>
                    </tr>
                    `).join('')}
                    <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                        <td colspan="3"><strong>TOTAL HONOR√ÅRIOS</strong></td>
                        <td><strong>${(resultados.honorarios.reduce((total, h) => total + h.percentual, 0) * 100).toFixed(2)}%</strong></td>
                        <td><strong>R$ ${formatarMoeda(resultados.honorarios.reduce((total, h) => total + h.valorBruto, 0))}</strong></td>
                    </tr>
                </table>
            </div>`;
            
            return secaoHonorariosTotais + secaoHonorariosOriginal;
        }

        function gerarSecaoCessoesBeneficiario(resultados, dados) {
            if (!resultados.cessoesBeneficiarioCalculadas || resultados.cessoesBeneficiarioCalculadas.length === 0) return '';
            
            const dividaTotalAtualizada = resultados.valortotatt;
            const percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            const percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            const dividaSemHonorarios = dividaTotalAtualizada * (1 - percentualTotalAdv - percentualTotalSind);
            
            const parteBeneficiario = dividaSemHonorarios * resultados.percentualBeneficiarioFinal;
            const beneficiarioRecebe = resultados.valorBeneficiarioAposCessoes;
            const beneficiarioAguarda = Math.max(0, parteBeneficiario - beneficiarioRecebe);
            
            const listaCessionarios = resultados.cessoesBeneficiarioCalculadas.map(cessao => 
                `${cessao.cessionario} (${(cessao.percentual * 100).toFixed(1)}%)`
            ).join(', ');
            
            const totalCedido = resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) => 
                total + cessao.percentual, 0
            );
            
            const linhasCessionarios = resultados.cessoesBeneficiarioCalculadas.map(cessao => {
                const parteCessionario = dividaSemHonorarios * cessao.percentual;
                const cessionarioRecebe = resultados.isPreferenciasParcial ? 0 : cessao.valorBruto;
                const cessionarioAguarda = resultados.isPreferenciasParcial ? parteCessionario : 0;
                
                return `
                <tr>
                    <td>${cessao.cessionario}</td>
                    <td>${(cessao.percentual * 100).toFixed(2)}%</td>
                    <td>R$ ${formatarMoeda(parteCessionario)}</td>
                    <td>R$ ${formatarMoeda(cessionarioRecebe)}</td>
                    <td>R$ ${formatarMoeda(cessionarioAguarda)}</td>
                </tr>
                `;
            }).join('');
            
            const totalRecebe = beneficiarioRecebe + resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) => {
                const cessionarioRecebe = resultados.isPreferenciasParcial ? 0 : cessao.valorBruto;
                return total + cessionarioRecebe;
            }, 0);
            
            const totalAguarda = beneficiarioAguarda + resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) => {
                const parteCessionario = dividaSemHonorarios * cessao.percentual;
                const cessionarioAguarda = resultados.isPreferenciasParcial ? parteCessionario : 0;
                return total + cessionarioAguarda;
            }, 0);
            
            const alertBox = resultados.isPreferenciasParcial ? `
                <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    <strong>‚ÑπÔ∏è Prefer√™ncia Parcial:</strong><br>
                    ‚Ä¢ <strong>Teto da prefer√™ncia:</strong> R$ ${formatarMoeda(resultados.valorBase)}<br>
                    ‚Ä¢ <strong>Pagamento imediato:</strong> R$ ${formatarMoeda(beneficiarioRecebe)} (s√≥ para o benefici√°rio)<br>
                    ‚Ä¢ <strong>Saldo devedor total:</strong> R$ ${formatarMoeda(totalAguarda)}
                </div>
            ` : `
                <div class="success-box" style="margin-top: 10px; padding: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                    <strong>‚úÖ Pagamento Integral:</strong> Todos os benefici√°rios recebem integralmente.
                </div>
            `;
            
            return `
                <div class="table-container">
                    <h3>üîÑ Cess√µes do Benefici√°rio Principal</h3>
                    <div style="margin-bottom: 20px;">
                        <h4>Cess√£o do Benefici√°rio: ${dados.beneficiario}</h4>
                        <p><strong>Tipo de C√°lculo:</strong> ${dados.tipoCalculo} ${dados.tipoCalculo === 'preferencia' ? '(preferencial)' : '(ordem comum)'}</p>
                        <p><strong>D√≠vida Total:</strong> R$ ${formatarMoeda(dividaTotalAtualizada)}</p>
                        <p><strong>Total Cedido:</strong> ${(totalCedido * 100).toFixed(1)}% para: ${listaCessionarios}</p>
                        
                        <table>
                            <tr>
                                <th>Benefici√°rio</th>
                                <th>Percentual</th>
                                <th>Valor Total</th>
                                <th>Recebe Agora</th>
                                <th>Aguarda Ordem</th>
                            </tr>
                            ${resultados.percentualBeneficiarioFinal > 0 ? `
                            <tr>
                                <td>${dados.beneficiario}</td>
                                <td>${(resultados.percentualBeneficiarioFinal * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(parteBeneficiario)}</td>
                                <td>R$ ${formatarMoeda(beneficiarioRecebe)}</td>
                                <td>R$ ${formatarMoeda(beneficiarioAguarda)}</td>
                            </tr>
                            ` : `
                            <tr style="background-color: #f8f9fa;">
                                <td><em>${dados.beneficiario} (cedeu tudo)</em></td>
                                <td>0.00%</td>
                                <td>R$ 0,00</td>
                                <td>R$ 0,00</td>
                                <td>R$ 0,00</td>
                            </tr>
                            `}
                            ${linhasCessionarios}
                            <tr class="highlight" style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td>TOTAL</td>
                                <td>100.00%</td>
                                <td>R$ ${formatarMoeda(dividaSemHonorarios)}</td>
                                <td>R$ ${formatarMoeda(totalRecebe)}</td>
                                <td>R$ ${formatarMoeda(totalAguarda)}</td>
                            </tr>
                        </table>
                        <div style="padding: 8px; margin: 10px 0; font-size: 0.85em; color: #666; font-style: italic;">
                            <strong>üìù Observa√ß√£o:</strong> Os valores apresentados j√° est√£o l√≠quidos das dedu√ß√µes acess√≥rias. 
                            Ainda devem ser calculados os descontos legais sobre os valores a receber.
                        </div>
                    </div>
                    ${alertBox}
                </div>
            `;
        }

        function gerarSecaoCessoesAdvogados(resultados, dados) {
            const advogadosComCessao = resultados.honorarios.filter(adv => 
                adv.cessoesAdv && adv.cessoesAdv.length > 0
            );
            
            if (advogadosComCessao.length === 0) return '';
            
            // Se√ß√£o de cess√µes totais (para prefer√™ncia parcial)
            let secaoCessoesAdvTotais = '';
            if (!(dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt)) {
                const secoesCessoes = advogadosComCessao.map(adv => {
                    const valorBrutoTotalAdv = resultados.valortotatt * adv.percentual;
                    const valorBrutoTotalAdvogado = resultados.valortotatt * adv.percentualAdvogado;
                    const cessionariosTotais = adv.cessionarios ? adv.cessionarios.map(cessionario => ({
                        ...cessionario,
                        valorBrutoTotal: resultados.valortotatt * cessionario.percentual
                    })) : [];
                    
                    return `
                        <div style="margin-bottom: 20px;">
                            <h4>üîÑ Cess√£o de Honor√°rios: ${adv.nome}</h4>
                            <p><strong>Valor do Honor√°rio:</strong> R$ ${formatarMoeda(valorBrutoTotalAdv)}</p>
                            <p><strong>Cedido:</strong> ${(adv.percentualCessionarioAdv * 100).toFixed(2)}% para ${adv.cessoesAdv.length} cession√°rio${adv.cessoesAdv.length > 1 ? 's' : ''}</p>
                            <p style="color: #856404; font-weight: bold;">‚ö†Ô∏è Valores totais do direito (n√£o pagos integralmente na prefer√™ncia)</p>
                            
                            <table>
                                <tr><th>Recebedor</th><th>Percentual</th><th>Valor Bruto Total</th></tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td><strong>${adv.nome} (fica com)</strong></td>
                                    <td>${(adv.percentualAdvogado * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(valorBrutoTotalAdvogado)}</td>
                                </tr>
                                ${cessionariosTotais.map(cessionario => `
                                <tr>
                                    <td>${cessionario.nome} (cession√°rio)</td>
                                    <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(cessionario.valorBrutoTotal)}</td>
                                </tr>
                                `).join('')}
                                <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                    <td>TOTAL</td>
                                    <td>-%</td>
                                    <td>R$ ${formatarMoeda(valorBrutoTotalAdv)}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                }).join('');
                
                secaoCessoesAdvTotais = `
                    <div class="table-container">
                        <h3>üîÑ Cess√µes de Honor√°rios</h3>
                        <p style="color: #856404; font-style: italic;">Cess√µes calculadas sobre o valor total (base: R$ ${formatarMoeda(resultados.valortotatt)})</p>
                        ${secoesCessoes}
                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff; font-size: 0.9em;">
                            <strong>üí° Explica√ß√£o das Cess√µes:</strong><br>
                            ‚Ä¢ <strong>Cess√µes da Prefer√™ncia:</strong> Calculadas sobre R$ ${formatarMoeda(resultados.valorBase)} (apenas advogados recebem agora)<br>
                            ‚Ä¢ <strong>Cess√µes Totais:</strong> Calculadas sobre R$ ${formatarMoeda(resultados.valortotatt)}
                        </div>
                    </div>
                `;
            }
            
            // Se√ß√£o de cess√µes principais
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const isPreferenciaParcial = isPreferencia && resultados.valorBase < resultados.valortotatt;
            const isPreferenciaTotal = isPreferencia && resultados.valorBase >= resultados.valortotatt;
            
            const tituloCessoes = isPreferenciaParcial 
                ? 'üîÑ Cess√µes de Honor√°rios - Valores da Prefer√™ncia' 
                : 'üîÑ Cess√µes de Honor√°rios';
            
            const descricaoBaseCessoes = isPreferenciaParcial
                ? `<p style="color: #155724; font-style: italic;">Cess√µes calculadas sobre a prefer√™ncia (base: R$ ${formatarMoeda(resultados.valorBase)})</p>`
                : '';
            
            const secoesCessoesAdvogados = advogadosComCessao.map(adv => {
                const cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => `
                    <tr>
                        <td>${cessionario.nome} (cession√°rio)</td>
                        <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(cessionario.valorBruto)}</td>
                    </tr>
                `).join('') : '';
                
                return `
                    <div style="margin-bottom: 20px;">
                        <h4>Cess√£o de Honor√°rios: ${adv.nome}</h4>
                        <p><strong>Valor Base do Honor√°rio:</strong> R$ ${formatarMoeda(adv.valorBruto)}</p>
                        <p><strong>Cedido:</strong> ${(adv.percentualCessionarioAdv * 100).toFixed(2)}% para ${adv.cessoesAdv.length} cession√°rio${adv.cessoesAdv.length > 1 ? 's' : ''}</p>
                        ${isPreferenciaParcial ? `<p style="color: #856404; font-weight: bold;">‚ö†Ô∏è Prefer√™ncia Parcial: Cession√°rios aguardam ordem cronol√≥gica</p>` : ''}
                        ${isPreferenciaTotal ? `<p style="color: #155724; font-weight: bold;">‚úÖ Prefer√™ncia Total: Todos recebem integralmente</p>` : ''}
                        
                        <table>
                            <tr><th>Recebedor</th><th>Percentual</th><th>Valor Bruto</th></tr>
                            <tr style="background-color: #f8f9fa;">
                                <td><strong>${adv.nome} (fica com)</strong></td>
                                <td>${(adv.percentualAdvogado * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(adv.valorBrutoAdvogado)}</td>
                            </tr>
                            ${cessionarios}
                            <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td>TOTAL</td>
                                <td>-%</td>
                                <td>R$ ${formatarMoeda(adv.valorBruto)}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }).join('');
            
            const alertaPreferencia = isPreferenciaParcial ? `
                <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    <strong>‚ö†Ô∏è Prefer√™ncia Parcial de Honor√°rios:</strong><br>
                    ‚Ä¢ <strong>Advogados</strong> t√™m direito √† prefer√™ncia e recebem sua parte agora<br>
                    ‚Ä¢ <strong>Cession√°rios</strong> n√£o t√™m direito √† prefer√™ncia (Art. 42. Resolu√ß√£o CNJ 303/19.) e aguardam pagamento na ordem cronol√≥gica<br>
                    ‚Ä¢ <strong>Total pago agora (prefer√™ncia)</strong>: R$ ${formatarMoeda(advogadosComCessao.reduce((total, adv) => total + adv.valorBrutoAdvogado, 0))}<br>
                </div>
            ` : '';
            
            const alertaSucesso = isPreferenciaTotal ? `
                <div class="success-box" style="margin-top: 10px; padding: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                    <strong>‚úÖ Prefer√™ncia Total de Honor√°rios:</strong><br>
                    ‚Ä¢ O teto da prefer√™ncia cobre todo o precat√≥rio<br>
                    ‚Ä¢ <strong>Advogados e cession√°rios</strong> recebem integralmente<br>
                </div>
            ` : '';
            
            const secaoCessoesAdv = `
                <div class="table-container">
                    <h3>${tituloCessoes}</h3>
                    ${descricaoBaseCessoes}
                    ${secoesCessoesAdvogados}
                    ${alertaPreferencia}
                    ${alertaSucesso}
                </div>
            `;
            
            return secaoCessoesAdvTotais + secaoCessoesAdv;
        }

        function gerarSecaoDeducoes(resultados, dados) {
            const temPrevidencia = dados.incidenciaPrevidencia;
            const temIR = dados.incidenciaIR && resultados.rrapagamento !== 0;
            const temCessoes = resultados.cessoesBeneficiarioCalculadas && resultados.cessoesBeneficiarioCalculadas.length > 0;
            
            if (!temPrevidencia && !temIR) return '';
            
            let secaoPrevidencia = '';
            if (temPrevidencia) {
                if (dados.tipoPrevidencia === 'fixa') {
                    secaoPrevidencia = gerarDetalhePrevidenciaFixa(resultados, dados, temCessoes);
                } else {
                    secaoPrevidencia = gerarDetalhePrevidenciaINSS(resultados, dados, temCessoes);
                }
            }
            
            let secaoIR = '';
            if (temIR) {
                secaoIR = gerarDetalheIR(resultados, dados, temPrevidencia, temCessoes);
            }
            
            return `
                <div class="table-container">
                    <h3>üè¶ Dedu√ß√µes Legais</h3>
                    ${secaoPrevidencia}
                    ${secaoIR}
                </div>
            `;
        }

        function gerarDetalhePrevidenciaFixa(resultados, dados, temCessoes) {
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o por Cess√µes:</th>
                </tr>
                ${resultados.valorPrevidenciaBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorPrevidenciaBeneficiario)}</td>
                </tr>
                ` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.previdenciaCessao > 0 ? `
                    <tr>
                        <th>${cessao.cessionario}:</th>
                        <td>R$ ${formatarMoeda(cessao.previdenciaCessao)}</td>
                    </tr>
                    ` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - Al√≠quota Fixa</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota Fixa:</th>
                        <td>${(dados.aliquotaFixa * 100).toFixed(2)}%</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor Previd√™ncia:</th>
                        <td><strong>R$ ${formatarMoeda(resultados.valorPrevidencia)}</strong></td>
                    </tr>
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaINSS(resultados, dados, temCessoes) {
            const base = resultados.rrapagamento === 0 ? resultados.principal : resultados.principal / resultados.rrapagamento;
            
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o por Cess√µes:</th>
                </tr>
                ${resultados.valorPrevidenciaBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorPrevidenciaBeneficiario)}</td>
                </tr>
                ` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.previdenciaCessao > 0 ? `
                    <tr>
                        <th>${cessao.cessionario}:</th>
                        <td>R$ ${formatarMoeda(cessao.previdenciaCessao)}</td>
                    </tr>
                    ` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - INSS</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    ${resultados.rrapagamento !== 0 ? `
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${Math.round(resultados.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(base)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>Al√≠quota Efetiva INSS:</th>
                        <td>${(resultados.aliquotaEfetiva * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(resultados.valorPrevidencia / (resultados.rrapagamento || 1))} ${base > 8157.41 ? '(TETO)' : ''}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor Previd√™ncia:</th>
                        <td><strong>R$ ${formatarMoeda(resultados.valorPrevidencia)}</strong></td>
                    </tr>
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalheIR(resultados, dados, temPrevidencia, temCessoes) {
            let percentualTotalAdv = 0;
            let percentualTotalSind = 0;
            
            if (dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt) {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => {
                    const cessaoAdv = dados.cessoes?.filter(cessao => 
                        cessao.tipo === 'cessaoAdv' && cessao.cedente === adv.nome
                    ) || [];
                    const percentualCessionarioAdv = cessaoAdv.reduce((total, cessao) => total + cessao.percentual, 0);
                    const percentualAdvogado = Math.max(0, adv.percentual - percentualCessionarioAdv);
                    return sum + percentualAdvogado;
                }, 0);
                percentualTotalSind = 0;
            } else {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            }
            
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o por Cess√µes:</th>
                </tr>
                ${resultados.valorIRBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorIRBeneficiario)}</td>
                </tr>
                ` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.irCessao > 0 ? `
                    <tr>
                        <th>${cessao.cessionario}:</th>
                        <td>R$ ${formatarMoeda(cessao.irCessao)}</td>
                    </tr>
                    ` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Imposto de Renda - MP N¬™ 1.294, de 11 de Abril de 2025</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem H.Contratuais (${(percentualTotalAdv * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRHonora)}</td>
                    </tr>
                    ${percentualTotalSind > 0 ? `
                    <tr>
                        <th>Base IR sem Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRSindi)}</td>
                    </tr>` : ''}
                    ${temPrevidencia ? `
                    <tr>
                        <th>Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(resultados.valorPrevidencia)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRPrev)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${Math.round(resultados.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base IR por RRA:</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRRRA)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota IR:</th>
                        <td>${(resultados.aliquotaIR * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <th>Valor IR Mensal:</th>
                        <td>R$ ${formatarMoeda(resultados.valorIRUnitario)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor IR Devido Total:</th>
                        <td><strong>R$ ${formatarMoeda(resultados.valorIR)}</strong></td>
                    </tr>
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarSecoesPagamentos(resultados, dados) {
            return `
                ${gerarPagamentoBeneficiario(resultados, dados)}
                ${gerarPagamentoCessionarios(resultados, dados)}
                ${gerarPagamentoSindicatos(resultados, dados)}
                ${gerarPagamentoCessionariosSindicatos(resultados, dados)}
                ${gerarPagamentoAdvogados(resultados, dados)}
                ${gerarPagamentoCessionariosAdvogados(resultados, dados)}
            `;
        }

        function gerarPagamentoBeneficiario(resultados, dados) {
            if (resultados.valorBeneficiarioFinal <= 0) return '';
            
            return `
                <div class="table-container">
                    <h3>üí∞ Pagamento Benefici√°rio - ${dados.beneficiario}</h3>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                        <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(resultados.valorBeneficiarioAposCessoes)}</td></tr>
                        <tr><td>Previd√™ncia</td><td>R$ ${formatarMoeda(resultados.valorPrevidenciaBeneficiario)}</td></tr>
                        <tr><td>Imposto de Renda</td><td>R$ ${formatarMoeda(resultados.valorIRBeneficiario)}</td></tr>
                        <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(resultados.valorBeneficiarioFinal)}</td></tr>
                    </table>
                </div>
            `;
        }

        function gerarPagamentoCessionarios(resultados, dados) {
            if (!resultados.cessoesBeneficiarioFinais) return '';
            
            const cessionariosComPagamento = resultados.cessoesBeneficiarioFinais.filter(cessao => 
                cessao.valorLiquido && cessao.valorLiquido > 0
            );
            
            if (cessionariosComPagamento.length === 0) return '';
            
            return cessionariosComPagamento.map(cessao => `
                <div class="table-container">
                    <h3>üí∞ Pagamento Cession√°rio - ${cessao.cessionario}</h3>
                    <p style="margin-bottom: 10px;"><strong>Cess√£o de:</strong> ${dados.beneficiario}</p>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                        <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(cessao.valorBruto)}</td></tr>
                        <tr><td>Previd√™ncia</td><td>R$ ${formatarMoeda(cessao.previdenciaCessao)}</td></tr>
                        <tr><td>Imposto de Renda</td><td>R$ ${formatarMoeda(cessao.irCessao)}</td></tr>
                        <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(cessao.valorLiquido)}</td></tr>
                    </table>
                </div>
            `).join('');
        }

        function gerarPagamentoSindicatos(resultados, dados) {
            if (!resultados.sindicatos) return '';
            
            const sindicatosParaPagar = resultados.sindicatos.filter(sind => 
                sind.podeReceber && sind.percentualSindicato > 0 && sind.valorBrutoSindicato > 0
            );
            
            if (sindicatosParaPagar.length === 0) return '';
            
            return sindicatosParaPagar.map(sind => {
                let descricaoTributacao = '';
                if (sind.tributacao === 'nao') {
                    descricaoTributacao = 'üè¶ Sem Tributa√ß√£o do IR';
                } else if (sind.tributacao === 'lei') {
                    descricaoTributacao = 'üè¶ Art. 27, da Lei n¬∫ 10.833/03';
                } else if (sind.tributacao === 'fixa') {
                    descricaoTributacao = `üè¶ Al√≠quota Fixa (${(sind.aliquotaTributacao * 100).toFixed(2)}%)`;
                }
                
                return `
                    <div class="table-container">
                        <h3>üèõÔ∏è Pagamento Sindicato - ${sind.nome}</h3>
                        <table>
                            <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                            <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(sind.valorBrutoSindicato)}</td></tr>
                            <tr><td>Imposto de Renda - ${descricaoTributacao}</td><td>R$ ${formatarMoeda(sind.irSindicato)}</td></tr>
                            <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(sind.valorLiquidoSindicato)}</td></tr>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function gerarPagamentoCessionariosSindicatos(resultados, dados) {
            if (!resultados.sindicatos) return '';
            
            const todosCessionariosSindicatos = [];
            resultados.sindicatos.forEach(sind => {
                if (sind.cessionarios && sind.cessionarios.length > 0 && sind.podeReceber) {
                    sind.cessionarios.forEach(cessionario => {
                        todosCessionariosSindicatos.push({
                            ...cessionario,
                            sindicatoOriginal: sind.nome,
                            tributacaoSindicato: sind.tributacao,
                            aliquotaTributacao: sind.aliquotaTributacao
                        });
                    });
                }
            });
            
            if (todosCessionariosSindicatos.length === 0) return '';
            
            return todosCessionariosSindicatos.map(cessionario => {
                let descricaoTributacao = '';
                if (cessionario.tributacaoSindicato === 'nao') {
                    descricaoTributacao = 'üè¶ Sem Tributa√ß√£o do IR';
                } else if (cessionario.tributacaoSindicato === 'lei') {
                    descricaoTributacao = 'üè¶ Art. 27, da Lei n¬∫ 10.833/03';
                } else if (cessionario.tributacaoSindicato === 'fixa') {
                    descricaoTributacao = `üè¶ Al√≠quota Fixa (${(cessionario.aliquotaTributacao * 100).toFixed(2)}%)`;
                }
                
                return `
                    <div class="table-container">
                        <h3>üîÑ Pagamento Cession√°rio Sindicato - ${cessionario.nome}</h3>
                        <p style="margin-bottom: 10px;"><strong>Cess√£o de:</strong> ${cessionario.sindicatoOriginal}</p>
                        <table>
                            <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                            <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(cessionario.valorBruto)}</td></tr>
                            <tr><td>Imposto de Renda - ${descricaoTributacao}</td><td>R$ ${formatarMoeda(cessionario.ir)}</td></tr>
                            <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(cessionario.valorLiquido)}</td></tr>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function gerarPagamentoAdvogados(resultados, dados) {
            const advogadosParaPagar = resultados.honorarios.filter(adv => 
                adv.percentualAdvogado > 0 && adv.valorBrutoAdvogado > 0
            );
            
            if (advogadosParaPagar.length === 0) return '';
            
            return advogadosParaPagar.map(adv => {
                const descricaoIR = adv.tipo === 'PF'
                    ? 'üè¶ MP N¬™ 1.294, de 11 de Abril de 2025'
                    : 'üè¶ DECRETO 9.580, art 714';
                
                return `
                    <div class="table-container">
                        <h3>üë©‚Äçüíº Pagamento Advogado - ${adv.nome} (${adv.tipo})</h3>
                        <table>
                            <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                            <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(adv.valorBrutoAdvogado)}</td></tr>
                            <tr><td>Imposto de Renda - ${descricaoIR}</td><td>R$ ${formatarMoeda(adv.irAdvogado)}</td></tr>
                            <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(adv.valorLiquidoAdvogado)}</td></tr>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function gerarPagamentoCessionariosAdvogados(resultados, dados) {
            const todosCessionarios = [];
            resultados.honorarios.forEach(adv => {
                if (adv.cessionarios && adv.cessionarios.length > 0) {
                    adv.cessionarios.forEach(cessionario => {
                        todosCessionarios.push({
                            ...cessionario,
                            advogadoOriginal: adv.nome,
                            tipoAdvogado: adv.tipo
                        });
                    });
                }
            });
            
            const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt;
            if (todosCessionarios.length === 0 || isPreferenciaParcial) return '';
            
            return todosCessionarios.map(cessionario => {
                const descricaoIR = cessionario.tipoAdvogado === 'PF'
                    ? 'üè¶ MP N¬™ 1.294, de 11 de Abril de 2025'
                    : 'üè¶ DECRETO 9.580, art 714';
                
                return `
                    <div class="table-container">
                        <h3>üîÑ Pagamento Cession√°rio - ${cessionario.nome}</h3>
                        <p style="margin-bottom: 10px;"><strong>Cess√£o de:</strong> ${cessionario.advogadoOriginal} (${cessionario.tipoAdvogado})</p>
                        <table>
                            <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
                            <tr><td>Valor Devido</td><td>R$ ${formatarMoeda(cessionario.valorBruto)}</td></tr>
                            <tr><td>Imposto de Renda - ${descricaoIR}</td><td>R$ ${formatarMoeda(cessionario.ir)}</td></tr>
                            <tr class="highlight"><td>Valor L√≠quido</td><td>R$ ${formatarMoeda(cessionario.valorLiquido)}</td></tr>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function gerarBotaoImprimir() {
            return `
                <div class="print-button-container" style="text-align: center; margin: 20px 0; display: block;">
                    <button onclick="window.print()" style="
                        background-color: #343A40;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        font-size: 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        transition: background-color 0.3s;
                    " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#343A40'">
                        üñ®Ô∏è Imprimir / Salvar PDF
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>