<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="/print.css" media="print">
    <link rel="shortcut icon" href="/assets/precalc2.ico" type="image/x-icon">
    <meta name="description" content="C√°lculos de Precat√≥rios.">
    <title>PreCalc Web</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PreCalc</h1>
            <p>Sistema de C√°lculo de Precat√≥rios</p>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="showTab('tab1')">üìÖ Informa√ß√µes Gerais</button>
                <button class="tab-button" onclick="showTab('tab2')">üí∞ Informa√ß√µes Financeiras</button>
                <button class="tab-button" onclick="showTab('tab8')">‚öñÔ∏è Sucumbencial</button>
                <button class="tab-button" onclick="showTab('tab3')">üë©‚Äçüíº Dedu√ß√µes Acess√≥rias</button>
                <button class="tab-button" onclick="showTab('tab4')">üë• Herdeiros</button>
                <button class="tab-button" onclick="showTab('tab5')">üîÑ Cess√µes de Cr√©dito</button>
                <button class="tab-button" id= "tabPagamento" onclick="showTab('tab9')" style="display: none;">üí≥ Pagamentos</button>
                <button class="tab-button" id="tabAcordo" onclick="showTab('tab6')" style="display: none;">ü§ù Ades√£o ao Acordo</button>
                <button class="tab-button" onclick="showTab('tab7')">üìä Resultados</button>
            </div>

            <!-- Tab 1: Informa√ß√µes Gerais -->
            <div id="tab1" class="tab-content active">
                <form id="calculatorForm" class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Informa√ß√µes Gerais</h3>
                        <div class="input-group">
                            <div class="label-with-button">
                                <label for="numprocesso">Processo:</label>
                                <button type="button" class="btn-sindifaz" onclick="configurarSindiFaz()" title="Preencher dados padr√£o do SindiFaz">
                                    SindiFaz
                                </button>
                            </div>
                            <input type="text" id="numprocesso" placeholder="N√∫mero do processo">
                        </div>
                        <div class="input-group">
                            <label for="beneficiario">Benefici√°rio Principal:</label>
                            <input type="text" id="beneficiario" placeholder="Nome do benefici√°rio principal">
                        </div>
                        <div class="input-group tipo-beneficiario" id="tipoBeneficiarioGroup">
                            <label>Tipo do Benefici√°rio:</label>
                            <select id="tipoBeneficiario">
                                <option value="pf">Pessoa F√≠sica (PF)</option>
                                <option value="pj">Pessoa Jur√≠dica (PJ)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="credor">Devedor:</label>
                            <input type="text" id="credor" placeholder="Nome do Devedor">
                        </div>
                        <h3>‚öñÔ∏è Configura√ß√µes do Processo</h3>
                        <div class="input-group">
                            <label for="natureza">Natureza da A√ß√£o:</label>
                            <select id="natureza" onchange="toggleTipoBeneficiario()">
                                <option value="alimentar">Alimentar</option>
                                <option value="comum">Comum</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="tipoCalculo">Tipo de C√°lculo:</label>
                            <select id="tipoCalculo">
                                <option value="ordem">Ordem</option>
                                <option value="preferencia">Prefer√™ncia</option>
                                <option value="acordo">Acordo</option>
                                <option value="parcial">Parcial</option>
                            </select>
                        </div>
                        <div class="input-group" id="perguntaPagamento" style="display: none;">
                            <label for="houvePagamento">Houve pagamento?</label>
                            <select id="houvePagamento">
                                <option value="nao">N√£o</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                        <div class="input-group" id="tetoPreferencia" style="display: none;">
                            <label>Teto de Prefer√™ncia (R$):</label>
                            <input type="number" id="tetoPreferenciaPrincipal" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group" id="percentualAcordo" style="display: none;">
                            <label>% do Des√°gio (ex: 0.4 para 40%):</label>
                            <input type="number" id="percentualAcordoValor" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                        <div class="input-group" id="saldoParcial" style="display: none;">
                            <label>Saldo Parcial (R$):</label>
                            <input type="number" id="saldoParcialValor" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tab 2: Informa√ß√µes Financeiras -->
            <div id="tab2" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Datas-base de c√°lculos</h3>
                        <div class="input-group">
                            <label for="dataatualizacao">Data de Atualiza√ß√£o:</label>
                            <input type="date" name="" id="dataatualizacao" style="margin-bottom:8px;" >
                            <label for="anoOrcamento">Ano do Or√ßamento:</label>
                            <input type="number" id="anoOrcamento" placeholder="Ano do Or√ßamento">
                        </div>
                        <h3>üí∞ Informa√ß√µes Financeiras</h3>
                            <div class="input-group">
                                <label for="descricaoPrincipal">Descri√ß√£o:</label>
                                <input type="text" id="descricaoPrincipal" placeholder="Ex: Sal√°rios">
                            </div>
                            <div class="input-group">
                                <label for="dataBase">Data Base:</label>
                                <input type="date" id="dataBase">
                            </div>
                            <div class="date-row" style="display: none;">
                                <div class="input-group">
                                    <label for="mesBase">M√™s Base:</label>
                                    <select id="mesBase">
                                        <option value="janeiro">Janeiro</option>
                                        <option value="fevereiro">Fevereiro</option>
                                        <option value="mar√ßo">Mar√ßo</option>
                                        <option value="abril">Abril</option>
                                        <option value="maio">Maio</option>
                                        <option value="junho">Junho</option>
                                        <option value="julho">Julho</option>
                                        <option value="agosto">Agosto</option>
                                        <option value="setembro">Setembro</option>
                                        <option value="outubro">Outubro</option>
                                        <option value="novembro">Novembro</option>
                                        <option value="dezembro">Dezembro</option>
                                    </select>
                                </div>
                                <div class="input-group" style="display: none;">
                                    <label for="anoBase">Ano Base:</label>
                                    <input type="number" id="anoBase" placeholder="Ano Base">
                                </div>
                            </div>
                            <div class="date-row">
                                <div class="input-group">
                                    <label for="valorPrincipal">Valor Principal (R$):</label>
                                    <input type="number" id="valorPrincipal" step="0.01" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label for="valorJuros">Valor dos Juros (R$):</label>
                                    <input type="number" id="valorJuros" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            <div class="valor-selic-group">
                                <label>Selic ("%"/ "R$"):</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="radio" id="selicValor" name="tipoSelic" value="valor" checked>
                                        <label for="selicValor">Valor em R$</label>
                                    </div>
                                    
                                    <div class="checkbox-item">
                                        <input type="radio" id="selicPercentual" name="tipoSelic" value="percentual">
                                        <label for="selicPercentual">Percentual (%)</label>
                                    </div>
                                </div>
                                
                                <div class="selic-inputs">
                                    <div class="input-group" id="campoValorSelic">
                                        <label for="valorSelic">Valor Selic (R$):</label>
                                        <input type="number" id="valorSelic" step="0.01" placeholder="0.00">
                                    </div>
                                    
                                    <div class="input-group" id="campoPercentualSelic" style="display: none;">
                                        <label for="percentualSelic">Percentual Selic (ex: 0.3 para 30%):</label>
                                        <input type="number" id="percentualSelic" step="0.01" placeholder="0.00">
                                    </div>

                                    <div class="input-group" id="campoMesReferencSelic">
                                        <label for="mesReferenciaSelic">Este valor SELIC refere-se ao:</label>
                                        <select id="mesReferenciaSelic">
                                            <option value="mesAnterior">M√™s Anterior ao m√™s base</option>
                                            <option value="mesmomesBase">M√™s base</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        <div class="input-group">
                            <label for="rra">RRA:</label>
                            <input type="number" id="rra" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label for="tipoUsoHonorario">Tipo de Uso para Honor√°rios:</label>
                            <select id="tipoUsoHonorario">
                                <option value="ambos" selected>Ambos (contratual e sucumbencial)</option>
                                <option value="contratual">Honor√°rio contratual apenas</option>
                                <option value="sucumbencial">Honor√°rio sucumbencial apenas</option>
                                <option value="nenhum">N√£o usado para honor√°rios</option>
                            </select>
                        </div>
                        <label>√çndices de Corre√ß√£o:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalCNJ" checked>
                                <label for="principalCNJ">CNJ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalSELIC" checked>
                                <label for="principalSELIC">SELIC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalIPCA" checked>
                                <label for="principalIPCA">IPCA</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalJurosMora" checked>
                                <label for="principalJurosMora">Juros de Mora</label>
                            </div>
                        </div>
                        <h3>üè¶ Impostos e Contribui√ß√µes</h3>
                        <div class="date-row">
                            <div class="input-group">
                                <label for="incidenciaIR">Incid√™ncia de IR:</label>
                                <select id="incidenciaIR">
                                    <option value="sim">Sim</option>
                                    <option value="nao">N√£o</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="incidenciaPrevidencia">Incid√™ncia de Previd√™ncia:</label>
                                <select id="incidenciaPrevidencia">
                                    <option value="sim">Sim</option>
                                    <option value="nao">N√£o</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group" id="tipoPrevidenciaDiv" style="display: none;">
                            <label for="tipoPrevidencia">Tipo de Previd√™ncia:</label>
                            <select id="tipoPrevidencia">
                                <option value="inss">INSS</option>
                                <option value="fixa">Al√≠quota Fixa</option>
                            </select>
                        </div>
                        <div class="input-group" id="aliquotaFixaDiv" style="display: none;">
                            <label for="aliquotaFixa">Al√≠quota Fixa (ex: 0.14 para 14%):</label>
                            <input type="number" id="aliquotaFixa" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                        <div style="text-align: center;">
                            <button class="btn-add" onclick="adicionarValorPrincipal()">
                                ‚ûï Adicionar Valor Principal
                            </button>
                        </div>
                        <div style="margin-top: 20px;">
                            <h3>üìã Valores Cadastrados</h3>
                            <div id="listaValoresPrincipais" class="lista-items">
                                <!-- Valores ser√£o adicionados aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Dedu√ß√µes Acess√≥rias (Honor√°rios) -->
            <div id="tab3" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë©‚Äçüíº Honor√°rios Contratuais</h3>
                        <div class="input-group">
                            <label for="quantAdvogados">Quantidade de Advogados:</label>
                            <input type="number" id="quantAdvogados" value="0" min="0">
                        </div>
                        <div id="advogadosContainer"></div>
                        <h3>ü§ù Sindicatos</h3>
                        <div class="input-group">
                            <label for="quantSindicatos">Quantidade de Sindicatos:</label>
                            <input type="number" id="quantSindicatos" value="0" min="0">
                        </div>
                        <div id="sindicatosContainer"></div>
                    </div>
                    
                </div>
            </div>

            <!-- Tab 4: Herdeiros  -->
            <div id="tab4" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë• Herdeiros</h3>
                        <div class="input-group">
                            <label for="quantHerdeiros">Quantidade de Herdeiros:</label>
                            <input type="number" id="quantHerdeiros" value="0" min="0">
                        </div>
                        <div id="herdeirosContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Cess√£o  -->
            <div id="tab5" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üîÑ Cess√µes</h3>
                        <div class="input-group">
                            <label for="quantCessoes">Quantidade de Cess√µes:</label>
                            <input type="number" id="quantCessoes" value="0" min="0">
                        </div>
                        <div id="cessaoContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Ades√£o ao Acordo (Nova Aba) -->
            <div id="tab6" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <div class="alerta-didatico">
                            <h4>‚ö†Ô∏è Importante</h4>
                            <p>Selecione abaixo apenas as pessoas/entidades que aderiram ao acordo. O c√°lculo ser√° realizado somente para os selecionados.</p>
                        </div>
                        
                        <h3>ü§ù Quem Aderiu ao Acordo?</h3>
                        <div id="acordoContainer">
                            <p class="loading">Preencha as abas anteriores para ver as op√ß√µes de ades√£o...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Resultados -->
            <div id="tab7" class="tab-content">
                <div id="results" class="results">
                    <div class="section-title">Resultados dos C√°lculos</div>
                    <div id="resultadosContent">
                        <p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 8: Honor√°rios Sucumbencial -->
        <div id="tab8" class="tab-content">
            <div class="form-section">
                <div class="form-group">
                    <h3>‚öñÔ∏è Honor√°rios Sucumbencial</h3>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">üéØ Controle de Cen√°rio</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="somenteHonorarioSucumbencial">
                            <label for="somenteHonorarioSucumbencial">
                                <strong>Apenas Honor√°rio Sucumbencial</strong> 
                            </label>
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; color: #6c757d;">
                            üí° Marque esta op√ß√£o quando o processo √© APENAS do(s) advogado(s) sucumbencial(is)
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="quantAdvogadosSucumbenciais">Quantidade de Advogados Sucumbenciais:</label>
                        <input type="number" id="quantAdvogadosSucumbenciais" value="0" min="0">
                    </div>
                    
                    <div id="advogadosSucumbenciaisContainer"></div>
                </div>
            </div>
        </div>  

        <!-- Tab 9: Pagamento -->
        <div id="tab9" class="tab-content">
            <div class="form-section">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üí≥ Configura√ß√£o dos Pagamentos</h3>
                        
                        <div class="input-group">
                            <label for="quantidadePagamentos">Quantos pagamentos ocorreram?</label>
                            <input type="number" id="quantidadePagamentos" min="0" value="0">
                        </div>

                        <div id="listaPagamentos"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="btn-container">
            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar Formul√°rio</button>
            <button type="button" class="btn" onclick="calcular()">üßÆ Calcular Valores</button>
        </div>
    </div>

    <script>
        // ====================================
        // CONTROLE DE ABAS E UTILIDADES
        // ====================================

        const $ = id => document.getElementById(id);

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('active', tab.id === tabId);
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                btn.classList.toggle('active', onclick && onclick.includes(`showTab('${tabId}')`));
            });

            if (tabId === 'tab6' && typeof atualizarAdesaoAcordo === 'function') {
                atualizarAdesaoAcordo();
            }
        }

        // ====================================
        // FUN√á√ïES DE VISIBILIDADE
        // ====================================

        function mostrarOcultar(elementId, mostrar) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = mostrar ? 'block' : 'none';
            }
        }

        function toggleDisplay(el, mostrar, tipo = 'block') {
            if (!el) return;
            el.style.display = mostrar ? tipo : 'none';
        }

        function toggleTipoBeneficiario() {
            const natureza = $('natureza').value;
            const grupo = $('tipoBeneficiarioGroup');
            grupo.classList.toggle('show', natureza === 'comum');
            if (natureza !== 'comum') $('tipoBeneficiario').value = 'pf';
        }

        function atualizarVisibilidadePreferencia() {
            const tipo = FormCache.tipoCalculo?.value;
            const quant = parseInt(FormCache.quantHerdeiros?.value) || 0;
            for (let i = 0; i < quant; i++) {
                toggleDisplay($(`herdPreferenciaContainer${i}`), tipo === 'preferencia', '');
            }
        }

        function atualizarVisibilidadePreferenciaSucumbencial() {
            const tipo = FormCache.tipoCalculo?.value;
            const quant = parseInt(FormCache.quantAdvogadosSucumbenciais?.value) || 0;
            for (let i = 0; i < quant; i++) {
                toggleDisplay($(`advSucPreferenciaContainer${i}`), tipo === 'preferencia');
            }
        }

        function toggleTipoPagamento(index) {
            const tipo = $(`pagTipoInformacao${index}`).value;
            document.querySelectorAll(`.pag-campo-total-${index}`).forEach(el =>
                toggleDisplay(el, tipo === 'total')
            );
            document.querySelectorAll(`.pag-campo-separado-${index}`).forEach(el =>
                toggleDisplay(el, tipo !== 'total')
            );
        }

        function toggleSelicPagamento(index) {
            const valor = $(`pagSelicValor${index}`);
            toggleDisplay($(`pagCampoValorSelic${index}`), valor?.checked);
            toggleDisplay($(`pagCampoPercentualSelic${index}`), !valor?.checked);
            if (valor?.checked) $(`pagPercentualSelic${index}`).value = '';
            else $(`pagValorSelic${index}`).value = '';
        }
        
        // ====================================
        // INICIALIZA√á√ÉO DE FORMUL√ÅRIOS
        // ====================================

        function initializeFormEventListeners() {
            const handlers = [
                ['quantAdvogados', criarElementoAdvogado, 'advogados'],
                ['quantAdvogadosSucumbenciais', criarElementoAdvogadoSucumbencial, 'advogadosSucumbenciais'],
                ['quantSindicatos', criarElementoSindicato, 'sindicatos'],
                ['quantHerdeiros', criarElementoHerdeiro, 'herdeiros']
            ];

            handlers.forEach(([campo, fn, tipo]) => {
                FormCache[campo]?.addEventListener('change', function() {
                    criarElementosFormulario({
                        container: FormCache[`${tipo}Container`],
                        quantidade: parseInt(this.value) || 0,
                        criarElementoFn: fn,
                        tipo,
                        callback: atualizarOpcoesCessao
                    });
                });
            });

            // Cess√µes
            FormCache.quantCessoes?.addEventListener('change', e =>
                criarCessoes(parseInt(e.target.value) || 0)
            );

            FormCache.quantidadePagamentos?.addEventListener('change', e => {
                criarElementosFormulario({
                    container: FormCache.pagamentosContainer,
                    quantidade: parseInt(e.target.value) || 0,
                    criarElementoFn: criarElementoPagamento,
                    tipo: 'pagamentos'
                });
            });

            FormCache.tipoCalculo?.addEventListener('change', function() {
                DadosFormulario.salvarHerdeiros();
                atualizarVisibilidadePreferencia();
                atualizarVisibilidadePreferenciaSucumbencial();
            });
            
            // Benefici√°rio
            FormCache.beneficiario?.addEventListener('change', atualizarOpcoesCessao);
        }

        // ====================================
        // CONFIGURA√á√ÉO DE EVENT LISTENERS
        // ====================================

        function configureEventListeners() {
            // Atualiza m√™s e ano a partir de dataBase
            $('dataBase')?.addEventListener('change', e => {
                const [ano, mes] = e.target.value.split('-');
                const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
                $('mesBase').value = meses[parseInt(mes) - 1] || '';
                $('anoBase').value = ano || '';
            });

            // Tipo de c√°lculo
            $('tipoCalculo')?.addEventListener('change', () => {
                const tipo = $('tipoCalculo').value;
                const natureza = $('natureza').value;

                toggleDisplay($('tetoPreferencia'), tipo === 'preferencia' && natureza === 'alimentar');
                toggleDisplay($('percentualAcordo'), tipo === 'acordo');
                toggleDisplay($('saldoParcial'), tipo === 'parcial');

                const permitePagamento = ['ordem','acordo'].includes(tipo);
                toggleDisplay($('perguntaPagamento'), permitePagamento);

                const houvePagamento = $('houvePagamento');
                if (!permitePagamento && houvePagamento) {
                    houvePagamento.value = 'nao';
                    toggleAbaPagamento();
                }

                if (houvePagamento && !houvePagamento.dataset.listenerAdded) {
                    houvePagamento.addEventListener('change', toggleAbaPagamento);
                    houvePagamento.dataset.listenerAdded = 'true';
                }

                toggleAbaAcordo();
            });

            // Natureza
            $('natureza')?.addEventListener('change', () => {
                const tipo = $('tipoCalculo').value;
                toggleDisplay($('tetoPreferencia'), tipo === 'preferencia' && $('natureza').value === 'alimentar');
            });

            // Incid√™ncia Previd√™ncia
            $('incidenciaPrevidencia')?.addEventListener('change', () => {
                const incidencia = $('incidenciaPrevidencia').value === 'sim';
                toggleDisplay($('tipoPrevidenciaDiv'), incidencia);
                toggleDisplay($('aliquotaFixaDiv'), incidencia && $('tipoPrevidencia').value === 'fixa');
            });

            $('tipoPrevidencia')?.addEventListener('change', () => {
                toggleDisplay($('aliquotaFixaDiv'), $('incidenciaPrevidencia').value === 'sim' && $('tipoPrevidencia').value === 'fixa');
            });

            // Honor√°rio sucumbencial
            $('somenteHonorarioSucumbencial')?.addEventListener('change', e => {
                if (e.target.checked && (parseInt($('quantAdvogadosSucumbenciais')?.value) || 0) === 0) {
                    alert('‚ö†Ô∏è Para marcar "Somente Honor√°rio Sucumbencial", voc√™ precisa ter pelo menos 1 Advogado Sucumbencial cadastrado.');
                    e.target.checked = false;
                }
            });
        }

        // ====================================
        // INICIALIZA√á√ÉO PRINCIPAL
        // ====================================

        document.addEventListener('DOMContentLoaded', function() {
            const anoAtual = new Date().getFullYear();
            $('anoBase').value = anoAtual;
            $('anoOrcamento').value = anoAtual;
            
            FormCache.init();
            CessaoCache.init();
            ColetaCache.init();
            initializeFormEventListeners();
            configureEventListeners();
            
            ['incidenciaPrevidencia','tipoPrevidencia','tipoCalculo','natureza'].forEach(id =>
                $(id)?.dispatchEvent(new Event('change'))
            );

            const selic = {
                valor: $('selicValor'),
                perc: $('selicPercentual'),
                campoValor: $('campoValorSelic'),
                campoPerc: $('campoPercentualSelic'),
                inputValor: $('valorSelic'),
                inputPerc: $('percentualSelic')
            };

            function alternarCamposSelic() {
                const usarValor = selic.valor.checked;
                toggleDisplay(selic.campoValor, usarValor);
                toggleDisplay(selic.campoPerc, !usarValor);
                if (usarValor) selic.inputPerc.value = '';
                else selic.inputValor.value = '';
            }

            selic.valor?.addEventListener('change', alternarCamposSelic);
            selic.perc?.addEventListener('change', alternarCamposSelic);
            alternarCamposSelic();
            toggleAbaAcordo();
            toggleAbaPagamento();
        });

        // ====================================
        // INICIALIZA√á√ÉO NA CARGA DA P√ÅGINA
        // ====================================

        window.addEventListener('load', () => {
            ['tipoCalculo','natureza','incidenciaPrevidencia','tipoPrevidencia'].forEach(id =>
                $(id)?.dispatchEvent(new Event('change'))
            );
            $('selicValor').checked = true;
            $('selicValor').dispatchEvent(new Event('change'));
            toggleAbaAcordo();
            toggleAbaPagamento();
        });

        // ====================================
        // Cadastro Valores Principais - informa√ß√µes financeiras
        // ====================================

        let valoresPrincipais = [];
        function adicionarValorPrincipal() {
            const mesBase = $('mesBase').value;
            const anoBase = $('anoBase').value;
            const valorPrincipal = parseFloat($('valorPrincipal').value) || 0;
            const valorJuros = parseFloat($('valorJuros').value) || 0;
            const rra = parseFloat($('rra').value) || 0;
            const descricao = $('descricaoPrincipal').value || 'Valor Principal';
            const tipoUsoHonorario = $('tipoUsoHonorario')?.value || 'ambos';

            const tipoSelic = document.querySelector('input[name="tipoSelic"]:checked')?.value;
            const valorSelic = parseFloat($('valorSelic').value) || 0;
            const percentualSelic = parseFloat($('percentualSelic').value) || 0;
            const mesReferenciaSelic = $('mesReferenciaSelic').value;

            if (!anoBase || (!valorPrincipal && !valorJuros)) {
                alert('Preencha o ano base e pelo menos um valor (principal, juros)');
                return;
            }

            const indices = { cnj: document.getElementById('principalCNJ').checked, selic: document.getElementById('principalSELIC').checked, ipca: document.getElementById('principalIPCA').checked, jurosMora: document.getElementById('principalJurosMora').checked };

            const tributacao = {
                ir: $('incidenciaIR').value === 'sim',
                previdencia: $('incidenciaPrevidencia').value === 'sim',
                tipoPrevidencia: $('tipoPrevidencia').value,
                aliquotaFixa: parseFloat($('aliquotaFixa').value) || 0,
                rra: parseFloat(rra) || 0
            };

            if (tributacao.previdencia) {
                const existeFixa = valoresPrincipais.some(item => item.tributacao.previdencia && item.tributacao.tipoPrevidencia === 'fixa');
                const existeINSS = valoresPrincipais.some(item => item.tributacao.previdencia && item.tributacao.tipoPrevidencia === 'inss');

                if ((existeFixa && tributacao.tipoPrevidencia === 'inss') ||
                    (existeINSS && tributacao.tipoPrevidencia === 'fixa')) {
                    alert('‚ùå Todos os itens devem seguir o mesmo padr√£o de previd√™ncia (fixa ou INSS).');
                    return;
                }
            }

            const valor = {
                id: Date.now(),
                mesBase,
                anoBase: parseInt(anoBase),
                valorPrincipal,
                valorJuros,
                tipoSelic,
                valorSelic: tipoSelic === 'valor' ? valorSelic : 0,
                percentualSelic: tipoSelic === 'percentual' ? percentualSelic : 0,
                mesReferenciaSelic,
                indices,
                tributacao,
                descricao,
                tipoUsoHonorario,
            };

            valoresPrincipais.push(valor);
            renderizarValoresPrincipais();
            limparFormularioPrincipal();

            alert("‚úÖ Valor cadastrado com sucesso!");

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====================================
        // // Renderizar valores principais
        // ====================================
        function renderizarValoresPrincipais() {
            const lista = document.getElementById('listaValoresPrincipais');
            lista.innerHTML = '';

            valoresPrincipais.forEach(valor => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                const indicesTexto = Object.entries(valor.indices)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => key.toUpperCase())
                    .join(', ');

                const tributacaoTexto = [];
                if (valor.tributacao.ir) tributacaoTexto.push('IR');
                if (valor.tributacao.previdencia) {
                    if (valor.tributacao.tipoPrevidencia === 'fixa') {
                        tributacaoTexto.push(`PREV: ${(valor.tributacao.aliquotaFixa * 100).toFixed(2)}%`);
                    } else {
                        tributacaoTexto.push('PREV: INSS');
                    }
                }
                if (valor.tributacao.rra > 0) tributacaoTexto.push(`RRA: ${valor.tributacao.rra}`);

                const tipoUsoTexto = {
                    'ambos': 'Ambos honor√°rios',
                    'contratual': 'S√≥ contratual', 
                    'sucumbencial': 'S√≥ sucumbencial',
                    'nenhum': 'Sem honor√°rios'
                }[valor.tipoUsoHonorario] || 'Ambos honor√°rios';

                let selicTexto = '';
                if (valor.tipoSelic === 'valor' && valor.valorSelic > 0) {
                    selicTexto = `R$ ${valor.valorSelic.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                } else if (valor.tipoSelic === 'percentual' && valor.percentualSelic > 0) {
                    selicTexto = `${(valor.percentualSelic * 100).toFixed(4)}%`;
                } else {
                    selicTexto = 'R$ 0,00';
                }

                div.innerHTML = `
                    <div class="item-header">
                        <strong>${valor.descricao}</strong>
                        <button class="btn-editar" onclick="editarValorPrincipal(${valor.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-remover" onclick="removerValorPrincipal(${valor.id})">üóëÔ∏è Remover</button>
                    </div>
                    <div class="item-info">
                        <span><strong>Base:</strong> ${valor.mesBase}/${valor.anoBase}</span>
                        <span><strong>Principal:</strong> R$ ${valor.valorPrincipal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span><strong>Juros:</strong> R$ ${valor.valorJuros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span><strong>Selic:</strong> ${selicTexto}</span>
                        <span><strong>Refere-se ao:</strong> ${valor.mesReferenciaSelic === 'mesAnterior' ? 'M√™s anterior' : 'Mesmo m√™s'}</span>
                        <span><strong>√çndices:</strong> ${indicesTexto}</span>
                        <span><strong>Tributa√ß√£o:</strong> ${tributacaoTexto.join(', ') || 'Nenhuma'}</span>
                        <span><strong>Uso:</strong> ${tipoUsoTexto}</span>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        // ====================================
        // Editar Valores
        // ====================================

        function editarValorPrincipal(id) {
            const valorParaEditar = valoresPrincipais.find(v => v.id === id);
            if (!valorParaEditar) {
                alert('Valor n√£o encontrado!');
                return;
            }
            $('descricaoPrincipal').value = valorParaEditar.descricao || '';
            $('mesBase').value = valorParaEditar.mesBase || '';
            $('anoBase').value = valorParaEditar.anoBase || '';
            $('valorPrincipal').value = valorParaEditar.valorPrincipal || '';
            $('valorJuros').value = valorParaEditar.valorJuros || '';
            $('rra').value = valorParaEditar.tributacao.rra || '';
            $('tipoUsoHonorario').value = valorParaEditar.tipoUsoHonorario || 'ambos';

            if (valorParaEditar.tipoSelic === 'valor') {
                $('selicValor').checked = true;
                $('valorSelic').value = valorParaEditar.valorSelic || '';
                $('percentualSelic').value = '';
            } else if (valorParaEditar.tipoSelic === 'percentual') {
                $('selicPercentual').checked = true;
                $('percentualSelic').value = valorParaEditar.percentualSelic || '';
                $('valorSelic').value = '';
            } else {
                $('selicValor').checked = true;
                $('valorSelic').value = '';
                $('percentualSelic').value = '';
            }

            $('mesReferenciaSelic').value = valorParaEditar.mesReferenciaSelic || 'mesAnterior';
            $('selicValor').dispatchEvent(new Event('change'));
            $('selicPercentual').dispatchEvent(new Event('change'));

            $('principalCNJ').checked = valorParaEditar.indices.cnj || false; 
            $('principalSELIC').checked = valorParaEditar.indices.selic || false; 
            $('principalIPCA').checked = valorParaEditar.indices.ipca || false; 
            $('principalJurosMora').checked = valorParaEditar.indices.jurosMora || false;

            const trib = valorParaEditar.tributacao || {};
            $('incidenciaIR').value = trib.ir ? 'sim' : 'nao';
            $('incidenciaPrevidencia').value = trib.previdencia ? 'sim' : 'nao';
            
            if (trib.previdencia) {
                $('tipoPrevidencia').value = trib.tipoPrevidencia || 'inss';
                $('aliquotaFixa').value = trib.tipoPrevidencia === 'fixa' ? trib.aliquotaFixa || '' : '';
            }

            $('incidenciaPrevidencia').dispatchEvent(new Event('change'));
            $('tipoPrevidencia').dispatchEvent(new Event('change'));

            // Remove valor antigo e re-renderiza lista
            valoresPrincipais = valoresPrincipais.filter(v => v.id !== id);
            renderizarValoresPrincipais();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====================================
        // Remover valores
        // ====================================
        function removerValorPrincipal(id) {
            valoresPrincipais = valoresPrincipais.filter(v => v.id !== id);
            renderizarValoresPrincipais();
        }

        // ====================================
        // Limpar formularios
        // ====================================

        function limparFormularioPrincipal() {
            $('valorPrincipal').value = '';
            $('valorJuros').value = '';
            $('valorSelic').value = '';
            $('percentualSelic').value = '';
            $('mesReferenciaSelic').value = 'mesAnterior';
            $('rra').value = '';
            $('descricaoPrincipal').value = ''; 
            $('tipoUsoHonorario').value = 'ambos';
            $('selicValor').checked = true;
            const eventoSelic = new Event('change');
            $('selicValor').dispatchEvent(eventoSelic);
        }

        // ====================================
        // Armazenamento
        // ====================================
        const DadosFormulario = {
            advogados: [],
            advogadosSucumbenciais: [],
            herdeiros: [],
            sindicatos: [],
            cessoes: [],
            pagamentos: [],
            
            salvar(tipo) {
                switch(tipo) {
                    case 'advogados':
                        this.salvarAdvogados();
                        break;
                    case 'advogadosSucumbenciais': 
                        this.salvarAdvogadosSucumbenciais();
                        break;
                    case 'herdeiros':
                        this.salvarHerdeiros();
                        break;
                    case 'sindicatos':
                        this.salvarSindicatos();
                        break;
                    case 'cessoes':
                        this.salvarCessoes();
                        break;
                    case 'pagamentos': 
                        this.salvarPagamentos();
                        break;
                    case 'todos':
                        this.salvarTodos();
                        break;
                }
            },
            
            salvarAdvogados() {
                this.advogados = [];
                const quantidade = parseInt(document.getElementById('quantAdvogados')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    this.advogados.push({
                        nome: document.getElementById(`advNome${i}`)?.value || '',
                        tipo: document.getElementById(`advTipo${i}`)?.value || 'PF',
                        incidenciaIR: document.getElementById(`advIncidenciaIR${i}`)?.value || 'sim', 
                        percentual: document.getElementById(`advPercentual${i}`)?.value || ''
                    });
                }
            },

            salvarAdvogadosSucumbenciais() {
                this.advogadosSucumbenciais = [];
                const quantidade = parseInt(document.getElementById('quantAdvogadosSucumbenciais')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    const dadosAdv = {
                        nome: document.getElementById(`advSucNome${i}`)?.value || '',
                        tipo: document.getElementById(`advSucTipo${i}`)?.value || 'PF',
                        incidenciaIR: document.getElementById(`advSucIncidenciaIR${i}`)?.value || 'sim',
                        tipoHonorario: document.getElementById(`advSucTipoHonorario${i}`)?.value || 'percentual',
                        preferencia: document.getElementById(`advSucTemPreferencia${i}`)?.value || 'nao'
                    };
                    
                    if (dadosAdv.tipoHonorario === 'percentual') {
                        dadosAdv.percentual = document.getElementById(`advSucPercentual${i}`)?.value || '';
                    }
                    // Se for valorPrincipal, n√£o precisa salvar nada extra (√© 100% dele)
                    
                    this.advogadosSucumbenciais.push(dadosAdv);
                }
            },
            
            salvarHerdeiros() {
                this.herdeiros = [];
                const quantidade = parseInt(document.getElementById('quantHerdeiros')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    this.herdeiros.push({
                        nome: document.getElementById(`herdNome${i}`)?.value || '',
                        percentual: document.getElementById(`herdPercentual${i}`)?.value || '',
                        preferencia: document.getElementById(`herdPreferencia${i}`)?.value || 'sim'
                    });
                }
            },
            
            salvarSindicatos() {
                this.sindicatos = [];
                const quantidade = parseInt(document.getElementById('quantSindicatos')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    this.sindicatos.push({
                        nome: document.getElementById(`sindNome${i}`)?.value || '',
                        percentual: document.getElementById(`sindPercentual${i}`)?.value || '',
                        tributacao: document.getElementById(`sindTrib${i}`)?.value || 'nao',
                        aliquota: document.getElementById(`aliquotaSind${i}`)?.value || ''
                    });
                }
            },
            
            salvarCessoes() {
                this.cessoes = [];
                const quantidade = parseInt(document.getElementById('quantCessoes')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    this.cessoes.push({
                        tipo: document.getElementById(`cessaoTipo${i}`)?.value || '',
                        cedente: document.getElementById(`cedenteNome${i}`)?.value || '',
                        cessionario: document.getElementById(`cessionarioNome${i}`)?.value || '',
                        percentual: document.getElementById(`cessaoPercentual${i}`)?.value || ''
                    });
                }
            },

            salvarPagamentos() {
                this.pagamentos = [];
                const quantidade = parseInt(document.getElementById('quantidadePagamentos')?.value) || 0;
                for (let i = 0; i < quantidade; i++) {
                    const tipoInformacao = document.getElementById(`pagTipoInformacao${i}`)?.value || 'total';

                    const selicValorRadio = document.getElementById(`pagSelicValor${i}`);
                    const tipoSelic = selicValorRadio && selicValorRadio.checked ? 'valor' : 'percentual';
                    
                    this.pagamentos.push({
                        beneficiario: document.getElementById(`pagBeneficiario${i}`)?.value || '',
                        dataBase: document.getElementById(`pagDataBase${i}`)?.value || '',
                        tipoInformacao: tipoInformacao,
                        valorTotal: document.getElementById(`pagValorTotal${i}`)?.value || '',
                        valorPrincipal: document.getElementById(`pagValorPrincipal${i}`)?.value || '',
                        valorJuros: document.getElementById(`pagValorJuros${i}`)?.value || '',
                        tipoSelic: tipoSelic,
                        valorSelic: document.getElementById(`pagValorSelic${i}`)?.value || '',
                        percentualSelic: document.getElementById(`pagPercentualSelic${i}`)?.value || '',
                        selicReferencia: document.getElementById(`pagMesReferenciaSelic${i}`)?.value || 'mesAnterior'
                    });
                }
            },
            
            salvarTodos() {
                this.salvarAdvogados();
                this.salvarAdvogadosSucumbenciais();
                this.salvarHerdeiros();
                this.salvarSindicatos();
                this.salvarCessoes();
                this.salvarPagamentos();
            },
            
            // Restaurar dados
            restaurarAdvogados() {
                const limite = Math.min(this.advogados.length, parseInt(document.getElementById('quantAdvogados')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const advNome = document.getElementById(`advNome${i}`);
                    const advTipo = document.getElementById(`advTipo${i}`);
                    const advIncidenciaIR = document.getElementById(`advIncidenciaIR${i}`);
                    const advPercentual = document.getElementById(`advPercentual${i}`);
                    
                    if (advNome) advNome.value = this.advogados[i].nome;
                    if (advTipo) advTipo.value = this.advogados[i].tipo;
                    if (advIncidenciaIR) advIncidenciaIR.value = this.advogados[i].incidenciaIR;
                    if (advPercentual) advPercentual.value = this.advogados[i].percentual;
                }
            },

            restaurarAdvogadosSucumbenciais() {
                const limite = Math.min(this.advogadosSucumbenciais.length, parseInt(document.getElementById('quantAdvogadosSucumbenciais')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const dados = this.advogadosSucumbenciais[i];

                    const nome = document.getElementById(`advSucNome${i}`);
                    const tipo = document.getElementById(`advSucTipo${i}`);
                    const incidenciaIR = document.getElementById(`advSucIncidenciaIR${i}`);
                    const tipoHonorario = document.getElementById(`advSucTipoHonorario${i}`);
                    const percentual = document.getElementById(`advSucPercentual${i}`);
                    const preferencia = document.getElementById(`advSucTemPreferencia${i}`);

                    if (nome) nome.value = dados.nome;
                    if (tipo) tipo.value = dados.tipo;
                    if (incidenciaIR) incidenciaIR.value = dados.incidenciaIR;
                    if (tipoHonorario) {
                        tipoHonorario.value = dados.tipoHonorario;
                        toggleCamposSucumbencial(i); 
                    }
                    // S√≥ restaura percentual se tiver (tipo percentual)
                    if (percentual && dados.percentual) percentual.value = dados.percentual;
                    if (preferencia) preferencia.value = dados.preferencia;
                }
            },
            
            restaurarHerdeiros() {
                const limite = Math.min(this.herdeiros.length, parseInt(document.getElementById('quantHerdeiros')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const herdNome = document.getElementById(`herdNome${i}`);
                    const herdPercentual = document.getElementById(`herdPercentual${i}`);
                    const herdPreferencia = document.getElementById(`herdPreferencia${i}`);
                    
                    if (herdNome) herdNome.value = this.herdeiros[i].nome;
                    if (herdPercentual) herdPercentual.value = this.herdeiros[i].percentual;
                    if (herdPreferencia) herdPreferencia.value = this.herdeiros[i].preferencia;
                }
            },
            
            restaurarSindicatos() {
                const limite = Math.min(this.sindicatos.length, parseInt(document.getElementById('quantSindicatos')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const sindNome = document.getElementById(`sindNome${i}`);
                    const sindPercentual = document.getElementById(`sindPercentual${i}`);
                    const sindTrib = document.getElementById(`sindTrib${i}`);
                    const aliquotaSind = document.getElementById(`aliquotaSind${i}`);
                    
                    if (sindNome) sindNome.value = this.sindicatos[i].nome;
                    if (sindPercentual) sindPercentual.value = this.sindicatos[i].percentual;
                    if (sindTrib) {
                        sindTrib.value = this.sindicatos[i].tributacao;
                        toggleAliquotaSindicato(i);
                    }
                    if (aliquotaSind && this.sindicatos[i].tributacao === 'fixa') {
                        aliquotaSind.value = this.sindicatos[i].aliquota;
                    }
                }
            },
            
            restaurarCessoes() {
                const limite = Math.min(this.cessoes.length, parseInt(document.getElementById('quantCessoes')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const cessaoTipo = document.getElementById(`cessaoTipo${i}`);
                    if (cessaoTipo && this.cessoes[i].tipo) {
                        cessaoTipo.value = this.cessoes[i].tipo;
                        atualizarCedentes(i);
                        
                        setTimeout(() => {
                            const cedenteNome = document.getElementById(`cedenteNome${i}`);
                            const cessionarioNome = document.getElementById(`cessionarioNome${i}`);
                            const cessaoPercentual = document.getElementById(`cessaoPercentual${i}`);
                            
                            if (cedenteNome) cedenteNome.value = this.cessoes[i].cedente;
                            if (cessionarioNome) cessionarioNome.value = this.cessoes[i].cessionario;
                            if (cessaoPercentual) cessaoPercentual.value = this.cessoes[i].percentual;
                        }, 50);
                    }
                }
            },

            restaurarPagamentos() {
                const limite = Math.min(this.pagamentos.length, parseInt(document.getElementById('quantidadePagamentos')?.value) || 0);
                for (let i = 0; i < limite; i++) {
                    const dados = this.pagamentos[i];

                    const beneficiario = document.getElementById(`pagBeneficiario${i}`);
                    const dataBase = document.getElementById(`pagDataBase${i}`);
                    const tipoInformacao = document.getElementById(`pagTipoInformacao${i}`);
                    const valorTotal = document.getElementById(`pagValorTotal${i}`);

                    const valorPrincipal = document.getElementById(`pagValorPrincipal${i}`);
                    const valorJuros = document.getElementById(`pagValorJuros${i}`);
                    const selicValorRadio = document.getElementById(`pagSelicValor${i}`);
                    const selicPercentualRadio = document.getElementById(`pagSelicPercentual${i}`);
                    const valorSelic = document.getElementById(`pagValorSelic${i}`);
                    const percentualSelic = document.getElementById(`pagPercentualSelic${i}`);
                    const selicReferencia = document.getElementById(`pagMesReferenciaSelic${i}`);

                    if (beneficiario) beneficiario.value = dados.beneficiario;
                    if (dataBase) dataBase.value = dados.dataBase;
                    if (tipoInformacao) tipoInformacao.value = dados.tipoInformacao || 'total';
                    if (dados.tipoInformacao === 'total') {
                        if (valorTotal) valorTotal.value = dados.valorTotal;
                    } else{
                        if (valorPrincipal) valorPrincipal.value = dados.valorPrincipal;
                        if (valorJuros) valorJuros.value = dados.valorJuros;
                        
                        if (dados.tipoSelic === 'valor') {
                            if (selicValorRadio) selicValorRadio.checked = true;
                            if (valorSelic) valorSelic.value = dados.valorSelic;
                        } else {
                            if (selicPercentualRadio) selicPercentualRadio.checked = true;
                            if (percentualSelic) percentualSelic.value = dados.percentualSelic;
                        }
                    }
                    
                    if (selicReferencia) selicReferencia.value = dados.selicReferencia;
                }
            }
        };
        
        const FormCache = {
            advogadosContainer: null,
            sindicatosContainer: null,
            herdeirosContainer: null,
            quantAdvogados: null,
            quantSindicatos: null,
            quantHerdeiros: null,
            quantCessoes: null,
            tipoCalculo: null,
            beneficiario: null,
            calculatorForm: null,

            advogadosSucumbenciaisContainer: null,
            quantAdvogadosSucumbenciais: null,
            somenteHonorarioSucumbencial: null,

            pagamentosContainer: null,
            quantidadePagamentos: null,
            
            init() {
                this.advogadosContainer = document.getElementById('advogadosContainer');
                this.sindicatosContainer = document.getElementById('sindicatosContainer');
                this.herdeirosContainer = document.getElementById('herdeirosContainer');
                this.quantAdvogados = document.getElementById('quantAdvogados');
                this.quantSindicatos = document.getElementById('quantSindicatos');
                this.quantHerdeiros = document.getElementById('quantHerdeiros');
                this.quantCessoes = document.getElementById('quantCessoes');
                this.tipoCalculo = document.getElementById('tipoCalculo');
                this.beneficiario = document.getElementById('beneficiario');
                this.calculatorForm = document.getElementById('calculatorForm');

                this.advogadosSucumbenciaisContainer = document.getElementById('advogadosSucumbenciaisContainer');
                this.quantAdvogadosSucumbenciais = document.getElementById('quantAdvogadosSucumbenciais');
                this.somenteHonorarioSucumbencial = document.getElementById('somenteHonorarioSucumbencial');

                this.pagamentosContainer = document.getElementById('listaPagamentos');
                this.quantidadePagamentos = document.getElementById('quantidadePagamentos');
            }
        };

        const ColetaCache = {
            elementos: null,
            
            init() {
                this.elementos = {
                    // Dados b√°sicos
                    numprocesso: document.getElementById('numprocesso'),
                    anoOrcamento: document.getElementById('anoOrcamento'),
                    beneficiario: document.getElementById('beneficiario'),
                    tipoBeneficiario: document.getElementById('tipoBeneficiario'),
                    credor: document.getElementById('credor'),
                    natureza: document.getElementById('natureza'),
                    tipoCalculo: document.getElementById('tipoCalculo'),                
                    
                    // Quantidades
                    quantAdvogados: document.getElementById('quantAdvogados'),
                    quantAdvogadosSucumbenciais: document.getElementById('quantAdvogadosSucumbenciais'),
                    quantHerdeiros: document.getElementById('quantHerdeiros'),
                    quantSindicatos: document.getElementById('quantSindicatos'),
                    quantCessoes: document.getElementById('quantCessoes'),
                    quantidadePagamentos: document.getElementById('quantidadePagamentos'), 
                    
                    // Campos condicionais
                    tetoPreferenciaPrincipal: document.getElementById('tetoPreferenciaPrincipal'),
                    percentualAcordoValor: document.getElementById('percentualAcordoValor'),
                    saldoParcialValor: document.getElementById('saldoParcialValor'),
                    somenteHonorarioSucumbencial: document.getElementById('somenteHonorarioSucumbencial'),
                    houvePagamento: document.getElementById('houvePagamento')
                };
            },
            
            getValue(elementId, defaultValue = '', parser = null) {
                const element = this.elementos[elementId];
                if (!element) return defaultValue;
                
                const value = element.value;
                if (!value && defaultValue !== '') return defaultValue;
                
                return parser ? parser(value) || defaultValue : value;
            }
        };

        function criarElementosFormulario(config) {
            const { container, quantidade, criarElementoFn, callback, tipo } = config;
            
            if (!container) return;
            
            if (tipo) {
                DadosFormulario.salvar(tipo);
            }
            
            container.innerHTML = '';
            
            if (quantidade <= 0) {
                callback && callback();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < quantidade; i++) {
                const elemento = criarElementoFn(i);
                fragment.appendChild(elemento);
            }
            
            container.appendChild(fragment);
            
            if (tipo) {
                setTimeout(() => {
                    switch(tipo) {
                        case 'advogados':
                            DadosFormulario.restaurarAdvogados();
                            break;
                        case 'herdeiros':
                            DadosFormulario.restaurarHerdeiros();
                            break;
                        case 'sindicatos':
                            DadosFormulario.restaurarSindicatos();
                            break;
                        case 'advogadosSucumbenciais':
                            DadosFormulario.restaurarAdvogadosSucumbenciais();
                            break;
                        case 'pagamentos': 
                            DadosFormulario.restaurarPagamentos();
                            const quantPag = parseInt(document.getElementById('quantidadePagamentos')?.value) || 0;
                            for (let i = 0; i < quantPag; i++) {
                                toggleTipoPagamento(i);
                            }
                            break;
                    }
                    callback && callback();
                }, 10);
            } else {
                callback && callback();
            }
        }

        function criarElementoAdvogadoSucumbencial(index) {
            const tipoCalculo = FormCache.tipoCalculo?.value;
            const mostraPreferencia = tipoCalculo === 'preferencia';
            
            const advDiv = document.createElement('div');
            advDiv.className = 'advogado-item';
            advDiv.innerHTML = `
                <div class="advogado-header">Advogado Sucumbencial ${index + 1}</div>
                <div class="advogado-row">
                    <!-- Nome -->
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="advSucNome${index}" placeholder="Nome do advogado">
                    </div>
                    
                    <!-- Tipo de Pessoa -->
                    <div class="input-group">
                        <label>Tipo:</label>
                        <select id="advSucTipo${index}">
                            <option value="PF">Pessoa F√≠sica</option>
                            <option value="PJ">Pessoa Jur√≠dica</option>
                        </select>
                    </div>

                    <!-- Incid√™ncia de IR -->
                    <div class="input-group">
                        <label>Incid√™ncia de IR:</label>
                        <select id="advSucIncidenciaIR${index}">
                            <option value="sim" selected>Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>
                    
                    <!-- Tipo de Honor√°rio -->
                    <div class="input-group">
                        <label>Tipo de Honor√°rio:</label>
                        <select id="advSucTipoHonorario${index}" onchange="toggleCamposSucumbencial(${index})">
                            <option value="percentual">Percentual</option>
                            <option value="valorPrincipal">Valor Principal Pr√≥prio</option>
                        </select>
                    </div>
                    
                    <!-- Campo Percentual (padr√£o vis√≠vel) -->
                    <div class="input-group" id="advSucPercentualContainer${index}">
                        <label>Percentual (ex: 0.3 para 30%):</label>
                        <input type="number" id="advSucPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                    
                    <!-- PREFER√äNCIA - igual aos herdeiros -->
                    <div class="input-group" style="${mostraPreferencia ? '' : 'display: none;'}" id="advSucPreferenciaContainer${index}">
                        <label>Tem Prefer√™ncia?</label>
                        <select id="advSucTemPreferencia${index}">
                            <option value="nao">N√£o</option>
                            <option value="sim">Sim</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Adicionar evento para atualizar cess√µes quando nome mudar
            const nomeInput = advDiv.querySelector(`#advSucNome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change',atualizarOpcoesCessao);
            }
            
            return advDiv;
        }

        function criarElementoAdvogado(index) {
            const advDiv = document.createElement('div');
            advDiv.className = 'advogado-item';
            advDiv.innerHTML = `
                <div class="advogado-header">Advogado ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="advNome${index}" placeholder="Nome do advogado">
                    </div>
                    <div class="input-group">
                        <label>Tipo:</label>
                        <select id="advTipo${index}">
                            <option value="PF">Pessoa F√≠sica</option>
                            <option value="PJ">Pessoa Jur√≠dica</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Incid√™ncia de IR:</label>
                        <select id="advIncidenciaIR${index}">
                            <option value="sim" selected>Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="advPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                </div>
            `;
            
            const nomeInput = advDiv.querySelector(`#advNome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            return advDiv;
        }

        function criarElementoSindicato(index) {
            const sindDiv = document.createElement('div');
            sindDiv.className = 'advogado-item';
            sindDiv.innerHTML = `
                <div class="advogado-header">Sindicato ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="sindNome${index}" placeholder="Nome do sindicato">
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="sindPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label>Tributa√ß√£o:</label>
                        <select id="sindTrib${index}">
                            <option value="nao">Sem Tributa√ß√£o do IR</option>
                            <option value="lei">Art. 27, da Lei n¬∫ 10.833/03</option>
                            <option value="fixa">Al√≠quota Fixa</option>
                        </select>
                    </div>
                    <div class="input-group" id="aliquotaSindContainer${index}" style="display: none;">
                        <label>Al√≠quota Fixa (ex: 0.015 para 1,5%):</label>
                        <input type="number" id="aliquotaSind${index}" step="0.001" min="0" max="1" placeholder="0.000">
                    </div>
                </div>
            `;
            
            const nomeInput = sindDiv.querySelector(`#sindNome${index}`);
            const tribSelect = sindDiv.querySelector(`#sindTrib${index}`);
            
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            if (tribSelect) {
                tribSelect.addEventListener('change', () => toggleAliquotaSindicato(index));
            }
            
            return sindDiv;
        }

        function criarElementoHerdeiro(index) {
            const tipoCalculo = FormCache.tipoCalculo?.value;
            const mostraPreferencia = tipoCalculo === 'preferencia';
            
            const herdDiv = document.createElement('div');
            herdDiv.className = 'advogado-item';
            
            let htmlHerdeiro = `
                <div class="advogado-header">Herdeiro ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Nome ${index + 1}:</label>
                        <input type="text" id="herdNome${index}" placeholder="Nome do herdeiro">
                    </div>
                    <div class="input-group">
                        <label>Percentual (ex: 0.1 para 10%):</label>
                        <input type="number" id="herdPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                    <div class="input-group" style="${mostraPreferencia ? '' : 'display: none;'}" id="herdPreferenciaContainer${index}">
                        <label>Tem direito √† prefer√™ncia?</label>
                        <select id="herdPreferencia${index}">
                            <option value="sim">Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>
                </div>`;
            
            herdDiv.innerHTML = htmlHerdeiro;
            
            const nomeInput = herdDiv.querySelector(`#herdNome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            return herdDiv;
        }

        function toggleAliquotaSindicato(index) {
            const selectTrib = document.getElementById(`sindTrib${index}`);
            const aliquotaContainer = document.getElementById(`aliquotaSindContainer${index}`);
            
            if (!selectTrib || !aliquotaContainer) return;
            
            const mostrarAliquota = selectTrib.value === 'fixa';
            
            aliquotaContainer.style.display = mostrarAliquota ? 'block' : 'none';
            
            // Limpar valor quando ocultar
            if (!mostrarAliquota) {
                const aliquotaInput = document.getElementById(`aliquotaSind${index}`);
                if (aliquotaInput) {
                    aliquotaInput.value = '';
                }
            }
        }

        function toggleCamposSucumbencial(index) {
            const tipoHonorario = document.getElementById(`advSucTipoHonorario${index}`);
            const percentualContainer = document.getElementById(`advSucPercentualContainer${index}`);
            
            if (!tipoHonorario) return;
            
            if (tipoHonorario.value === 'percentual') {
                if (percentualContainer) percentualContainer.style.display = 'block';
            } else if (tipoHonorario.value === 'valorPrincipal') {
                if (percentualContainer) percentualContainer.style.display = 'none';
            }
        }

        function criarElementoPagamento(index) {
            const pagDiv = document.createElement('div');
            pagDiv.className = 'advogado-item'; 
            pagDiv.innerHTML = `
                <div class="advogado-header">Pagamento ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Benefici√°rio:</label>
                        <select id="pagBeneficiario${index}">
                            <option value="">Selecione o benefici√°rio...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="pagDataBase${index}">Data do Pagamento:</label>
                        <input type="date" id="pagDataBase${index}">
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label for="pagTipoInformacao${index}">Tipo de Informa√ß√£o:</label>
                        <select id="pagTipoInformacao${index}" onchange="toggleTipoPagamento(${index})">
                            <option value="total">Informar apenas Valor Total pago</option>
                            <option value="separado">Informar Principal, Juros e SELIC separadamente</option>
                        </select>
                    </div>
                    <div class="input-group pag-campo-total-${index}" style="display: none; grid-column: span 2;">
                        <label>Valor Total Pago (R$):</label>
                        <input type="number" id="pagValorTotal${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="input-group pag-campo-total-${index}" style="display: none; grid-column: span 2; background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <small style="color: #1976d2;"><strong>‚ÑπÔ∏è C√°lculo Autom√°tico:</strong> O sistema calcular√° Principal, Juros e SELIC automaticamente.</small>
                    </div>
                    <div class="input-group pag-campo-separado-${index}">
                        <label>Valor Principal (R$):</label>
                        <input type="number" id="pagValorPrincipal${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="input-group pag-campo-separado-${index}">
                        <label>Valor Juros (R$):</label>
                        <input type="number" id="pagValorJuros${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="valor-selic-group pag-campo-separado-${index}">
                        <label>Selic ("%"/ "R$"):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" id="pagSelicValor${index}" name="tipoSelic${index}" value="valor" checked>
                                <label for="pagSelicValor${index}">Valor em R$</label>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="radio" id="pagSelicPercentual${index}" name="tipoSelic${index}" value="percentual">
                                <label for="pagSelicPercentual${index}">Percentual (%)</label>
                            </div>
                        </div>
                        
                        <div class="selic-inputs">
                            <div class="input-group" id="pagCampoValorSelic${index}">
                                <label for="pagValorSelic${index}">Valor Selic (R$):</label>
                                <input type="number" id="pagValorSelic${index}" step="0.01" placeholder="0.00">
                            </div>
                            
                            <div class="input-group" id="pagCampoPercentualSelic${index}" style="display: none;">
                                <label for="pagPercentualSelic${index}">Percentual Selic (ex: 0.3 para 30%):</label>
                                <input type="number" id="pagPercentualSelic${index}" step="0.01" placeholder="0.00">
                            </div>

                            <div class="input-group" id="pagCampoMesReferencSelic${index}">
                                <label for="pagMesReferenciaSelic${index}">Este valor SELIC refere-se ao:</label>
                                <select id="pagMesReferenciaSelic${index}">
                                    <option value="mesAnterior">M√™s Anterior ao m√™s base</option>
                                    <option value="mesmomesBase">M√™s base</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const valorRadio = pagDiv.querySelector(`#pagSelicValor${index}`);
            const percentualRadio = pagDiv.querySelector(`#pagSelicPercentual${index}`);
            
            valorRadio.addEventListener('change', () => toggleSelicPagamento(index));
            percentualRadio.addEventListener('change', () => toggleSelicPagamento(index));

            setTimeout(() => popularBeneficiariosPagamento(index), 10);
            
            return pagDiv;
        }

        function popularBeneficiariosPagamento(index) {
            const beneficiarioSelect = document.getElementById(`pagBeneficiario${index}`);
            if (!beneficiarioSelect) return;
            
            const valorAtual = beneficiarioSelect.value;
            
            beneficiarioSelect.innerHTML = '<option value="">Selecione o benefici√°rio...</option>';
            
            const { advogados, advogadosSucumbenciais, herdeiros, sindicatos } = CessaoCache.getQuantidades();
            
            // Benefici√°rio Principal
            const beneficiario = document.getElementById('beneficiario')?.value?.trim();
            if (beneficiario) {
                beneficiarioSelect.innerHTML += `<option value="${beneficiario}">${beneficiario} (Benefici√°rio Principal)</option>`;
            }
            
            // Advogados
            for (let i = 0; i < advogados; i++) {
                const nome = document.getElementById(`advNome${i}`)?.value?.trim();
                if (nome) {
                    beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (Advogado)</option>`;
                }
            }
            
            // Advogados Sucumbenciais
            for (let i = 0; i < advogadosSucumbenciais; i++) {
                const nome = document.getElementById(`advSucNome${i}`)?.value?.trim();
                if (nome) {
                    beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (Adv. Sucumbencial)</option>`;
                }
            }
            
            // Herdeiros
            for (let i = 0; i < herdeiros; i++) {
                const nome = document.getElementById(`herdNome${i}`)?.value?.trim();
                if (nome) {
                    beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (Herdeiro)</option>`;
                }
            }
            
            // Sindicatos
            for (let i = 0; i < sindicatos; i++) {
                const nome = document.getElementById(`sindNome${i}`)?.value?.trim();
                if (nome) {
                    beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (Sindicato)</option>`;
                }
            }
            
            // Cession√°rios 
            const quantCessoes = parseInt(document.getElementById('quantCessoes')?.value) || 0;
            for (let i = 0; i < quantCessoes; i++) {
                const nome = document.getElementById(`cessionarioNome${i}`)?.value?.trim();
                if (nome) {
                    beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (Cession√°rio)</option>`;
                }
            }
            
            // Restaurar valor se ainda existir
            if (valorAtual) {
                beneficiarioSelect.value = valorAtual;
            }
        }

        function limparFormulario() {
            // Limpar cache
            DadosFormulario.advogados = [];
            DadosFormulario.advogadosSucumbenciais = [];
            DadosFormulario.herdeiros = [];
            DadosFormulario.sindicatos = [];
            DadosFormulario.cessoes = [];
            DadosFormulario.pagamentos = [];

            valoresPrincipais = [];
            const listaValoresPrincipais = document.getElementById('listaValoresPrincipais');
            if (listaValoresPrincipais) {
                listaValoresPrincipais.innerHTML = '';
            }
            
            FormCache.calculatorForm?.reset();
            
            const containersConfig = [
                { element: FormCache.quantAdvogados, container: FormCache.advogadosContainer },
                { element: FormCache.quantAdvogadosSucumbenciais, container: FormCache.advogadosSucumbenciaisContainer },
                { element: FormCache.quantHerdeiros, container: FormCache.herdeirosContainer },
                { element: FormCache.quantSindicatos, container: FormCache.sindicatosContainer },
                { element: FormCache.quantCessoes, container: document.getElementById('cessaoContainer') },
                { element: FormCache.quantidadePagamentos, container: FormCache.pagamentosContainer }
            ];
            
            containersConfig.forEach(({ element, container }) => {
                if (element) element.value = 0;
                if (container) container.innerHTML = '';
            });
            
            const resultadosContent = document.getElementById('resultadosContent');
            if (resultadosContent) {
                resultadosContent.innerHTML = '<p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>';
            }

            document.getElementById('somenteHonorarioSucumbencial').checked = false;
            document.getElementById('houvePagamento').value = 'nao';

            // Limpar cache se necess√°rio
            if (ColetaCache.elementos) {
                ColetaCache.elementos.somenteHonorarioSucumbencial.checked = false;
                ColetaCache.elementos.houvePagamento.value = 'nao';
            }
            
            limparNotasExplicativas();

            showTab('tab1');
            toggleAbaAcordo();
            toggleAbaPagamento();

            document.getElementById('tipoCalculo').dispatchEvent(new Event('change'));
        }

        //CESSAO
        const CessaoCache = {
            container: null,
            beneficiario: null,
            quantAdvogados: null,
            quantAdvogadosSucumbenciais: null,
            quantHerdeiros: null,
            quantSindicatos: null,
            quantCessoes: null,
            
            init() {
                this.container = document.getElementById('cessaoContainer');
                this.beneficiario = document.getElementById('beneficiario');
                this.quantAdvogados = document.getElementById('quantAdvogados');
                this.quantAdvogadosSucumbenciais = document.getElementById('quantAdvogadosSucumbenciais');
                this.quantHerdeiros = document.getElementById('quantHerdeiros');  
                this.quantSindicatos = document.getElementById('quantSindicatos');
                this.quantCessoes = document.getElementById('quantCessoes');
            },
            
            getQuantidades() {
                return {
                    advogados: parseInt(this.quantAdvogados?.value) || 0,
                    advogadosSucumbenciais: parseInt(this.quantAdvogadosSucumbenciais?.value) || 0,
                    herdeiros: parseInt(this.quantHerdeiros?.value) || 0,
                    sindicatos: parseInt(this.quantSindicatos?.value) || 0,
                    cessoes: parseInt(this.quantCessoes?.value) || 0,
                };
            }
        };

        function criarCessoes(quant) {
            if (!CessaoCache.container) CessaoCache.init();
            
            DadosFormulario.salvarCessoes();
            
            CessaoCache.container.innerHTML = '';
            
            const { advogados,advogadosSucumbenciais, herdeiros, sindicatos } = CessaoCache.getQuantidades();
            const opcoesTipo = criarOpcoesTipoCessao(advogados,advogadosSucumbenciais, herdeiros, sindicatos);
            const temUnicaOpcao = opcoesTipo.split('<option').length === 3;
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < quant; i++) {
                const cessaoDiv = criarElementoCessao(i, opcoesTipo);
                fragment.appendChild(cessaoDiv);
            }
            
            CessaoCache.container.appendChild(fragment);
            
            setTimeout(() => {
                if (DadosFormulario.cessoes.length > 0) {
                    DadosFormulario.restaurarCessoes();
                }
                
                for (let i = 0; i < quant; i++) {
                    const cessaoTipo = document.getElementById(`cessaoTipo${i}`);
                    const cedenteSelect = document.getElementById(`cedenteNome${i}`);
                    
                    if (i >= DadosFormulario.cessoes.length) {
                        if (temUnicaOpcao && cessaoTipo) {
                            cessaoTipo.value = 'cessaobenPrincipal';
                            atualizarCedentes(i);
                        }
                    } 
                    else if (cessaoTipo?.value && cedenteSelect) {
                        if (!cedenteSelect.value || cedenteSelect.value === '' || 
                            cedenteSelect.options[cedenteSelect.selectedIndex]?.text.includes('Selecione')) {
                            atualizarCedentes(i);
                        }
                    }
                }
            }, 20);
        }

        function criarElementoCessao(index, opcoesTipo) {
            const cessaoDiv = document.createElement('div');
            cessaoDiv.className = 'advogado-item';
            
            cessaoDiv.innerHTML = `
                <div class="advogado-header">Cession√°rio ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Tipo de Cess√£o:</label>
                        <select id="cessaoTipo${index}" onchange="atualizarCedentes(${index})">
                            ${opcoesTipo}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cedente ${index + 1}:</label>
                        <select id="cedenteNome${index}">
                            <option value="">Selecione primeiro o tipo de cess√£o</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cession√°rio ${index + 1}:</label>
                        <input type="text" id="cessionarioNome${index}" placeholder="Nome do Cession√°rio">
                    </div>
                    <div class="input-group">
                        <label>Percentual Cedido (ex: 0.1 para 10%):</label>
                        <input type="number" id="cessaoPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                </div>
            `;
            
            return cessaoDiv;
        }

        function atualizarOpcoesCessao() {
            if (!CessaoCache.container) CessaoCache.init();
            
            const { cessoes } = CessaoCache.getQuantidades();
            
            // N√ÉO recriar cess√µes, apenas atualizar op√ß√µes
            if (cessoes > 0) {
                DadosFormulario.salvarCessoes();
                
                requestAnimationFrame(() => {
                    for (let i = 0; i < cessoes; i++) {
                        const cessaoTipo = document.getElementById(`cessaoTipo${i}`);
                        if (cessaoTipo?.value) {
                            const cedenteAtual = document.getElementById(`cedenteNome${i}`)?.value;
                            atualizarCedentes(i);
                            
                            // Restaurar cedente se ainda existir
                            setTimeout(() => {
                                const cedenteSelect = document.getElementById(`cedenteNome${i}`);
                                if (cedenteSelect && cedenteAtual) {
                                    const opcoes = Array.from(cedenteSelect.options);
                                    const opcaoExiste = opcoes.some(opt => opt.value === cedenteAtual);
                                    if (opcaoExiste) {
                                        cedenteSelect.value = cedenteAtual;
                                    }
                                }
                            }, 10);
                        }
                    }
                });
            }

            atualizarTodosBeneficiariosPagamentos();
        }

        function atualizarTodosBeneficiariosPagamentos() {
            const quantPagamentos = parseInt(document.getElementById('quantidadePagamentos')?.value) || 0;
            
            for (let i = 0; i < quantPagamentos; i++) {
                popularBeneficiariosPagamento(i);
            }
        }   

        function criarOpcoesTipoCessao(quantAdvogados,quantAdvogadosSucumbenciais, quantHerdeiros, quantSindicatos) {
            if (quantAdvogados === undefined) {
                const quantidades = CessaoCache.getQuantidades();
                quantAdvogados = quantidades.advogados;
                quantAdvogadosSucumbenciais = quantidades.advogadosSucumbenciais;
                quantHerdeiros = quantidades.herdeiros;
                quantSindicatos = quantidades.sindicatos;
            }
            
            const opcoes = ['<option value="cessaobenPrincipal">Do Benefici√°rio Principal</option>'];
            
            if (quantAdvogados > 0) {
                opcoes.push('<option value="cessaoAdv">Do Advogado</option>');
            }
            if (quantAdvogadosSucumbenciais > 0) {
                opcoes.push('<option value="cessaoAdvSuc">Do Advogado Sucumbencial</option>');
            }
            if (quantHerdeiros > 0) {
                opcoes.push('<option value="cessaoherdeiro">Do Herdeiro</option>');
            }
            if (quantSindicatos > 0) {
                opcoes.push('<option value="cessaoSindicato">Do Sindicato</option>');
            }
            
            return opcoes.join('');
        }

        function criarOpcoesCedente(tipoCessao, index) {
            const campobeneficiario = document.getElementById('beneficiario')?.value.trim();
            const beneficiarioPrincipal = campobeneficiario || 'Benefici√°rio Principal';
            const { advogados,advogadosSucumbenciais ,herdeiros, sindicatos } = CessaoCache.getQuantidades();
            const opcoes = ['<option value="">Selecione o cedente</option>'];
            
            switch(tipoCessao) {
                case 'cessaobenPrincipal':
                    opcoes.push(`<option value="${beneficiarioPrincipal}">${beneficiarioPrincipal}</option>`);
                    break;
                    
                case 'cessaoAdv':
                    for (let i = 0; i < advogados; i++) {
                        const nomeAdv = document.getElementById(`advNome${i}`)?.value.trim() || `Advogado ${i + 1}`;
                        opcoes.push(`<option value="${nomeAdv}">${nomeAdv}</option>`);
                    }
                    break;
                case 'cessaoAdvSuc':
                    for (let i = 0; i < advogadosSucumbenciais; i++) {
                        const nomeAdvSuc = document.getElementById(`advSucNome${i}`)?.value.trim() || `Adv. Sucumbencial ${i + 1}`;
                        opcoes.push(`<option value="${nomeAdvSuc}">${nomeAdvSuc}</option>`);
                    }
                    break;
                case 'cessaoherdeiro':
                    if (herdeiros > 0) {
                        for (let i = 0; i < herdeiros; i++) {
                            const nomeHerd = document.getElementById(`herdNome${i}`)?.value.trim() || `Herdeiro ${i + 1}`;
                            opcoes.push(`<option value="${nomeHerd}">${nomeHerd}</option>`);
                        }
                    } else {
                        opcoes.push(`<option value="${beneficiarioPrincipal}">${beneficiarioPrincipal}</option>`);
                    }
                    break;
                case 'cessaoSindicato':
                    for (let i = 0; i < sindicatos; i++) {
                        const nomeSind = document.getElementById(`sindNome${i}`)?.value.trim() || `Sindicato ${i + 1}`;
                        opcoes.push(`<option value="${nomeSind}">${nomeSind}</option>`);
                    }
                    break;
            }
            
            return opcoes.join('');
        }

        function atualizarCedentes(index) {
            const tipoCessao = document.getElementById(`cessaoTipo${index}`)?.value;
            const cedenteSelect = document.getElementById(`cedenteNome${index}`);
            
            if (tipoCessao && cedenteSelect) {
                const novasOpcoes = criarOpcoesCedente(tipoCessao, index);
                cedenteSelect.innerHTML = novasOpcoes;
                
                const opcoes = cedenteSelect.querySelectorAll('option');
                if (opcoes.length === 2) { // 1 vazia + 1 v√°lida
                    cedenteSelect.selectedIndex = 1; 
                }
            }
        }

        function atualizarTodosCedentes() {
            const { cessoes } = CessaoCache.getQuantidades();
            
            for (let i = 0; i < cessoes; i++) {
                const cessaoTipoElement = document.getElementById(`cessaoTipo${i}`);
                if (cessaoTipoElement?.value) {
                    atualizarCedentes(i);
                }
            }
        }

        //pagamentos
        function toggleAbaPagamento() {
            const houvePagamento = document.getElementById('houvePagamento').value;
            const tabPagamento = document.getElementById('tabPagamento');
            
            if (houvePagamento === 'sim') {
                tabPagamento.style.display = 'block';
            } else {
                tabPagamento.style.display = 'none';

                const quantPagamentos = document.getElementById('quantidadePagamentos');
                if (quantPagamentos && quantPagamentos.value !== '0') {
                    quantPagamentos.value = 0;
                    quantPagamentos.dispatchEvent(new Event('change'));
                }
                
                const abaPagamentoAtiva = document.getElementById('tab9');
                if (abaPagamentoAtiva && abaPagamentoAtiva.classList.contains('active')) {
                    showTab('tab1');
                }
            }
        }

        //acordo
        function toggleAbaAcordo() {
            const tipoCalculo = document.getElementById('tipoCalculo').value;
            const tabAcordo = document.getElementById('tabAcordo');
            const natureza = document.getElementById('natureza').value;
            
            mostrarOcultar('tetoPreferencia', tipoCalculo === 'preferencia' && natureza === 'alimentar');
            mostrarOcultar('percentualAcordo', tipoCalculo === 'acordo');

            if (tipoCalculo === 'acordo') {
                tabAcordo.style.display = 'block';
            } else {
                tabAcordo.style.display = 'none';
                const abaAcordoAtiva = document.getElementById('tab6');
                if (abaAcordoAtiva && abaAcordoAtiva.classList.contains('active')) {
                    showTab('tab1');
                }
            }
        }

        function atualizarAdesaoAcordo() {
            const container = document.getElementById('acordoContainer');
            if (!container) return;

            DadosFormulario.salvarTodos();

            const beneficiario = document.getElementById('beneficiario')?.value.trim() || 'Benefici√°rio Principal';
            const quantAdvogados = parseInt(document.getElementById('quantAdvogados')?.value) || 0;
            const quantAdvogadosSucumbenciais = parseInt(document.getElementById('quantAdvogadosSucumbenciais')?.value) || 0;
            const quantHerdeiros = parseInt(document.getElementById('quantHerdeiros')?.value) || 0;
            const quantSindicatos = parseInt(document.getElementById('quantSindicatos')?.value) || 0;
            const quantCessoes = parseInt(document.getElementById('quantCessoes')?.value) || 0;

            let html = '';

            // Benefici√°rio Principal - APENAS se N√ÉO houver herdeiros (pessoa ainda viva)
            if (quantHerdeiros === 0) {
                const percentualCedidoBeneficiario = calcularPercentualCedido('beneficiario', beneficiario);
                const percentualLiquidoBeneficiario = 100 - percentualCedidoBeneficiario;
                
                if (percentualLiquidoBeneficiario > 0) {
                    html += criarItemAcordo('beneficiario', beneficiario, 'Benefici√°rio Principal');
                }
            }

            // Advogados
            for (let i = 0; i < quantAdvogados; i++) {
                const nome = DadosFormulario.advogados[i]?.nome?.trim() || `Advogado ${i + 1}`;
                const percentualCedido = calcularPercentualCedido('advogado', nome);
                const percentualLiquido = 100 - percentualCedido;
                
                if (percentualLiquido > 0) {
                    html += criarItemAcordo(`advogado_${i}`, nome, 'Advogado Contratual');
                }
            }

            //sucumbenciais
            for (let i = 0; i < quantAdvogadosSucumbenciais; i++) {
                const nome = DadosFormulario.advogadosSucumbenciais[i]?.nome || `Adv. Sucumbencial ${i + 1}`;
                const tipoHonorario = DadosFormulario.advogadosSucumbenciais[i]?.tipoHonorario || 'percentual';
                const percentualCedido = calcularPercentualCedido('advogadoSucumbencial', nome);
                let percentualLiquido = 0;
                
                let descricaoHonorario = '';
                
                if (tipoHonorario === 'percentual') {
                    percentualLiquido = 100 - percentualCedido;
                } else if (tipoHonorario === 'valorPrincipal') {
                    percentualLiquido = 100 - percentualCedido; 
                }
                
                if (percentualLiquido > 0) {
                    html += criarItemAcordo(`advogadoSucumbencial_${i}`, nome, 'Adv. Sucumbencial');
                }
            }

            // Herdeiros
            for (let i = 0; i < quantHerdeiros; i++) {
                const nome = DadosFormulario.herdeiros[i]?.nome || `Herdeiro ${i + 1}`;
                const percentualCedido = calcularPercentualCedido('herdeiro', nome);
                const percentualLiquido = 100 - percentualCedido;
                
                if (percentualLiquido > 0) {
                    html += criarItemAcordo(`herdeiro_${i}`, nome, 'Herdeiro');
                }
            }

            // Sindicatos
            for (let i = 0; i < quantSindicatos; i++) {
                const nome = DadosFormulario.sindicatos[i]?.nome || `Sindicato ${i + 1}`;
                const percentualCedido = calcularPercentualCedido('sindicato', nome);
                const percentualLiquido = 100 - percentualCedido;
                
                if (percentualLiquido > 0) {
                    html += criarItemAcordo(`sindicato_${i}`, nome, 'Sindicato');
                }
            }

            // Cession√°rios
            for (let i = 0; i < quantCessoes; i++) {
                const cessao = DadosFormulario.cessoes[i];
                if (cessao?.cessionario?.trim()) {
                    const nomeCessionario = cessao.cessionario.trim();
                    const nomeCedente = cessao.cedente?.trim() || 'Desconhecido';
                    
                    let tipoTexto = '';
                    switch(cessao.tipo) {
                        case 'cessaobenPrincipal':
                            tipoTexto = `Cession√°rio do ${nomeCedente}`;
                            break;
                        case 'cessaoAdv':
                            tipoTexto = `Cession√°rio do Advogado ${nomeCedente}`;
                            break;
                        case 'cessaoAdvSuc':
                            tipoTexto = `Cession√°rio do Advogado Sucumbencial ${nomeCedente}`;
                            break;
                        case 'cessaoherdeiro':
                            tipoTexto = `Cession√°rio do Herdeiro ${nomeCedente}`;
                            break;
                        case 'cessaoSindicato':
                            tipoTexto = `Cession√°rio do Sindicato ${nomeCedente}`;
                            break;
                        default:
                            tipoTexto = `Cession√°rio de ${nomeCedente}`;
                    }
                    
                    html += criarItemAcordo(`cessionario_${i}`, nomeCessionario, tipoTexto);
                }
            }

            if (html === '') {
                html = '<p class="loading">Nenhuma pessoa/entidade cadastrada para aderir ao acordo.</p>';
            }

            container.innerHTML = html;
        }

        function calcularPercentualCedido(tipoCedente, nomeCedente) {
            let totalCedido = 0;
            const quantCessoes = parseInt(document.getElementById('quantCessoes')?.value) || 0;
            
            let percentualOriginal = 0;
            
            switch(tipoCedente) {
                case 'beneficiario':
                    percentualOriginal = 1.0; 
                    break;
                    
                case 'advogado':
                    const quantAdvogados = parseInt(document.getElementById('quantAdvogados')?.value) || 0;
                    for (let i = 0; i < quantAdvogados; i++) {
                        const nomeAdv = DadosFormulario.advogados[i]?.nome?.trim();
                        if (nomeAdv === nomeCedente) {
                            percentualOriginal = parseFloat(DadosFormulario.advogados[i]?.percentual || '0');
                            break;
                        }
                    }
                    break;
                    
                case 'advogadoSucumbencial':
                    const quantAdvSuc = parseInt(document.getElementById('quantAdvSuc')?.value) || 0;
                    for (let i = 0; i < quantAdvSuc; i++) {
                        const nomeAdvSuc = DadosFormulario.advogadosSucumbenciais[i]?.nome?.trim();
                        if (nomeAdvSuc === nomeCedente) {
                            percentualOriginal = parseFloat(DadosFormulario.advogadosSucumbenciais[i]?.percentual || '0');
                            break;
                        }
                    }
                    break;
                    
                case 'herdeiro':
                    const quantHerdeiros = parseInt(document.getElementById('quantHerdeiros')?.value) || 0;
                    for (let i = 0; i < quantHerdeiros; i++) {
                        const nomeHerd = DadosFormulario.herdeiros[i]?.nome?.trim();
                        if (nomeHerd === nomeCedente) {
                            percentualOriginal = parseFloat(DadosFormulario.herdeiros[i]?.percentual || '0');
                            break;
                        }
                    }
                    break;
                    
                case 'sindicato':
                    const quantSindicatos = parseInt(document.getElementById('quantSindicatos')?.value) || 0;
                    for (let i = 0; i < quantSindicatos; i++) {
                        const nomeSind = DadosFormulario.sindicatos[i]?.nome?.trim();
                        if (nomeSind === nomeCedente) {
                            percentualOriginal = parseFloat(DadosFormulario.sindicatos[i]?.percentual || '0');
                            break;
                        }
                    }
                    break;
            }
            
            // 2. SEGUNDO: Calcular quanto foi cedido (em rela√ß√£o ao que tinha)
            for (let i = 0; i < quantCessoes; i++) {
                const cedente = DadosFormulario.cessoes[i]?.cedente;
                const percentualCessao = parseFloat(DadosFormulario.cessoes[i]?.percentual || '0');
                const tipoCessao = DadosFormulario.cessoes[i]?.tipo;
                
                let isCedenteCorreto = false;
                
                switch(tipoCedente) {
                    case 'beneficiario':
                        isCedenteCorreto = (tipoCessao === 'cessaobenPrincipal' && cedente === nomeCedente);
                        break;
                    case 'advogado':
                        isCedenteCorreto = (tipoCessao === 'cessaoAdv' && cedente === nomeCedente);
                        break;
                    case 'advogadoSucumbencial':
                        isCedenteCorreto = (tipoCessao === 'cessaoAdvSuc' && cedente === nomeCedente);
                        break;
                    case 'herdeiro':
                        isCedenteCorreto = (tipoCessao === 'cessaoherdeiro' && cedente === nomeCedente);
                        break;
                    case 'sindicato':
                        isCedenteCorreto = (tipoCessao === 'cessaoSindicato' && cedente === nomeCedente);
                        break;
                }
                
                if (isCedenteCorreto) {
                    totalCedido += (percentualCessao * 100); 
                }
            }
            
            return Math.min(totalCedido, 100);
        }

        function criarItemAcordo(id, nome, tipo) {
            return `
                <div class="acordo-item" id="acordo_${id}">
                    <input type="checkbox" class="acordo-checkbox" id="check_${id}" onchange="toggleAcordoItem('${id}')">
                    <div class="acordo-info">
                        <div class="acordo-name">${nome}</div>
                        <div class="acordo-details">${tipo}</div>
                    </div>
                </div>
            `;
        }

        function toggleAcordoItem(id) {
            const checkbox = document.getElementById(`check_${id}`);
            const item = document.getElementById(`acordo_${id}`);
            
            if (checkbox && item) {
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            }
        }

        function obterAdesaoAcordo() {
            const adesoes = {
                beneficiario: false,
                advogados: [],
                advogadosSucumbenciais: [],
                herdeiros: [],
                sindicatos: [],
                cessionarios: []
            };

            // Verificar benefici√°rio
            const checkBeneficiario = document.getElementById('check_beneficiario');
            if (checkBeneficiario?.checked) {
                adesoes.beneficiario = true;
            }

            // Verificar advogados
            const quantAdvogados = parseInt(document.getElementById('quantAdvogados')?.value) || 0;
            for (let i = 0; i < quantAdvogados; i++) {
                const check = document.getElementById(`check_advogado_${i}`);
                if (check?.checked) {
                    adesoes.advogados.push(i);
                }
            }

            //Verificar advogados sucumb
            const quantAdvogadosSucumbenciais = parseInt(document.getElementById('quantAdvogadosSucumbenciais')?.value) || 0;
            for (let i = 0; i < quantAdvogadosSucumbenciais; i++) {
                const check = document.getElementById(`check_advogadoSucumbencial_${i}`);
                if (check?.checked) {
                    adesoes.advogadosSucumbenciais.push(i); 
                }
            }

            // Verificar herdeiros
            const quantHerdeiros = parseInt(document.getElementById('quantHerdeiros')?.value) || 0;
            for (let i = 0; i < quantHerdeiros; i++) {
                const check = document.getElementById(`check_herdeiro_${i}`);
                if (check?.checked) {
                    adesoes.herdeiros.push(i);
                }
            }

            // Verificar sindicatos
            const quantSindicatos = parseInt(document.getElementById('quantSindicatos')?.value) || 0;
            for (let i = 0; i < quantSindicatos; i++) {
                const check = document.getElementById(`check_sindicato_${i}`);
                if (check?.checked) {
                    adesoes.sindicatos.push(i);
                }
            }

            // Verificar cession√°rios
            const quantCessoes = parseInt(document.getElementById('quantCessoes')?.value) || 0;
            for (let i = 0; i < quantCessoes; i++) {
                const check = document.getElementById(`check_cessionario_${i}`);
                if (check?.checked) {
                    adesoes.cessionarios.push(i);
                }
            }

            return adesoes;
        }
        
        const meses = {
            "janeiro": 1, "fevereiro": 2, "mar√ßo": 3, "abril": 4,
            "maio": 5, "junho": 6, "julho": 7, "agosto": 8,
            "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12
        };

        // √çndices CNJ
        const indicesCNJ = {
            // 1968-1969
            "julho-1968":2.3766255,"agosto-1968":2.3244716,"setembro-1968":2.2827271,"outubro-1968":2.25106,"novembro-1968":2.217677,"dezembro-1968":2.1821434,
            "janeiro-1969":2.1410981,"fevereiro-1969":2.1027271,"mar√ßo-1969":2.066267,"abril-1969":2.0375611,"maio-1969":2.0064697,"junho-1969":1.9819624,
            "julho-1969":1.9555362,"agosto-1969":1.942091,"setembro-1969":1.9278542,"outubro-1969":1.9104688,"novembro-1969":1.8798598,"dezembro-1969":1.8412823,
            
            // 1970-1971
            "janeiro-1970":1.800848,"fevereiro-1970":1.7613375,"mar√ßo-1970":1.7266451,"abril-1970":1.7073184,"maio-1970":1.6917904,"junho-1970":1.6761739,
            "julho-1970":1.6507773,"agosto-1970":1.6362565,"setembro-1970":1.6209546,"outubro-1970":1.6018885,"novembro-1970":1.5721689,"dezembro-1970":1.5394815,
            "janeiro-1971":1.5099171,"fevereiro-1971":1.4826188,"mar√ßo-1971":1.4632754,"abril-1971":1.4488205,"maio-1971":1.4322237,"junho-1971":1.4120702,
            "julho-1971":1.3846389,"agosto-1971":1.3575278,"setembro-1971":1.329601,"outubro-1971":1.301244,"novembro-1971":1.275563,"dezembro-1971":1.2549928,
            
            // 1972-1973
            "janeiro-1972":1.239693,"fevereiro-1972":1.2249585,"mar√ßo-1972":1.2088431,"abril-1972":1.1952032,"maio-1972":1.1794914,"junho-1972":1.1599378,
            "julho-1972":1.1394877,"agosto-1972":1.1233748,"setembro-1972":1.1140215,"outubro-1972":1.1061046,"novembro-1972":1.0956172,"dezembro-1972":1.0884246,
            "janeiro-1973":1.0761382,"fevereiro-1973":1.0656129,"mar√ßo-1973":1.0545619,"abril-1973":1.0420264,"maio-1973":1.0302028,"junho-1973":1.0172858,
            "julho-1973":1.0061466,"agosto-1973":0.9972007,"setembro-1973":0.9889252,"outubro-1973":0.9794005,"novembro-1973":0.9727795,"dezembro-1973":0.9645367,
            
            // 1974-1975
            "janeiro-1974":0.9459925,"fevereiro-1974":0.9361227,"mar√ßo-1974":0.9223112,"abril-1974":0.9108553,"maio-1974":0.8961917,"junho-1974":0.8775275,
            "julho-1974":0.8492863,"agosto-1974":0.8135031,"setembro-1974":0.7764805,"outubro-1974":0.7484388,"novembro-1974":0.7326216,"dezembro-1974":0.7235169,
            "janeiro-1975":0.7143679,"fevereiro-1975":0.7036899,"mar√ßo-1975":0.6921938,"abril-1975":0.6794291,"maio-1975":0.666136,"junho-1975":0.6511219,
            "julho-1975":0.6394392,"agosto-1975":0.6286861,"setembro-1975":0.6190415,"outubro-1975":0.6067296,"novembro-1975":0.5938325,"dezembro-1975":0.5824938,
            
            // 1976-1977
            "janeiro-1976":0.5719658,"fevereiro-1976":0.5611914,"mar√ßo-1976":0.5489126,"abril-1976":0.5361777,"maio-1976":0.5229782,"junho-1976":0.5078638,
            "julho-1976":0.4933112,"agosto-1976":0.4810212,"setembro-1976":0.4679752,"outubro-1976":0.4530738,"novembro-1976":0.4373045,"dezembro-1976":0.4244541,
            "janeiro-1977":0.4152786,"fevereiro-1977":0.4082102,"mar√ßo-1977":0.400325,"abril-1977":0.3914485,"maio-1977":0.3804735,"junho-1977":0.3686124,
            "julho-1977":0.3567162,"agosto-1977":0.3474371,"setembro-1977":0.3404576,"outubro-1977":0.3357513,"novembro-1977":0.331159,"dezembro-1977":0.3262852,
            
            // 1978-1979
            "janeiro-1978":0.3200147,"fevereiro-1978":0.3134001,"mar√ßo-1978":0.3063011,"abril-1978":0.2986019,"maio-1978":0.2901279,"junho-1978":0.2815487,
            "julho-1978":0.2733153,"agosto-1978":0.2651989,"setembro-1978":0.25803,"outubro-1978":0.251462,"novembro-1978":0.2456308,"dezembro-1978":0.2394985,
            "janeiro-1979":0.2333575,"fevereiro-1979":0.2282044,"mar√ßo-1979":0.2230193,"abril-1979":0.2175856,"maio-1979":0.2097292,"junho-1979":0.2020075,
            "julho-1979":0.1955035,"agosto-1979":0.190327,"setembro-1979":0.1850037,"outubro-1979":0.1778589,"novembro-1979":0.170058,"dezembro-1979":0.1627145,
            
            // 1980-1981
            "janeiro-1980":0.1563371,"fevereiro-1980":0.1500323,"mar√ßo-1980":0.1446787,"abril-1980":0.1395176,"maio-1980":0.134541,"junho-1980":0.1301177,
            "julho-1980":0.1260823,"agosto-1980":0.1221721,"setembro-1980":0.1183831,"outubro-1980":0.1149345,"novembro-1980":0.1113712,"dezembro-1980":0.1079184,
            "janeiro-1981":0.1032714,"fevereiro-1981":0.0983531,"mar√ßo-1981":0.0923506,"abril-1981":0.0868771,"maio-1981":0.0819597,"junho-1981":0.0773206,
            "julho-1981":0.072944,"agosto-1981":0.0688153,"setembro-1981":0.0650428,"outubro-1981":0.061535,"novembro-1981":0.0582165,"dezembro-1981":0.0551816,
            
            // 1982-1983
            "janeiro-1982":0.0524539,"fevereiro-1982":0.0499561,"mar√ßo-1982":0.0475773,"abril-1982":0.0453117,"maio-1982":0.0429495,"junho-1982":0.0407105,
            "julho-1982":0.0385881,"agosto-1982":0.036404,"setembro-1982":0.0340224,"outubro-1982":0.0317967,"novembro-1982":0.0297165,"dezembro-1982":0.0279028,
            "janeiro-1983":0.0261998,"fevereiro-1983":0.0247168,"mar√ßo-1983":0.0231648,"abril-1983":0.0212521,"maio-1983":0.0194973,"junho-1983":0.0180531,
            "julho-1983":0.0167468,"agosto-1983":0.0153641,"setembro-1983":0.0141604,"outubro-1983":0.0129319,"novembro-1983":0.0117884,"dezembro-1983":0.0108749,
            
            // 1984-1985
            "janeiro-1984":0.0101068,"fevereiro-1984":0.0092048,"mar√ßo-1984":0.0081966,"abril-1984":0.0074514,"maio-1984":0.0068425,"junho-1984":0.0062832,
            "julho-1984":0.0057539,"agosto-1984":0.0052166,"setembro-1984":0.0047166,"outubro-1984":0.0042684,"novembro-1984":0.0037908,"dezembro-1984":0.0034493,
            "janeiro-1985":0.0031216,"fevereiro-1985":0.0027722,"mar√ßo-1985":0.0025157,"abril-1985":0.0022322,"maio-1985":0.001996,"junho-1985":0.0018145,
            "julho-1985":0.0016615,"agosto-1985":0.0015439,"setembro-1985":0.0014272,"outubro-1985":0.0013082,"novembro-1985":0.0012001,"dezembro-1985":0.00108,
            
            // 1986-1987
            "janeiro-1986":0.0009528,"fevereiro-1986":0.0008197,"mar√ßo-1986":0.7167849,"abril-1986":0.7175942,"maio-1986":0.7120335,"junho-1986":0.7021997,
            "julho-1986":0.6933895,"agosto-1986":0.6852283,"setembro-1986":0.6739057,"outubro-1986":0.6624906,"novembro-1986":0.6501229,"dezembro-1986":0.6294125,
            "janeiro-1987":0.5867511,"fevereiro-1987":0.5022781,"mar√ßo-1987":0.4199434,"abril-1987":0.3667159,"maio-1987":0.3031719,"junho-1987":0.2455992,
            "julho-1987":0.2080982,"agosto-1987":0.201938,"setembro-1987":0.1898626,"outubro-1987":0.1796563,"novembro-1987":0.1645506,"dezembro-1987":0.1458267,
            
            // 1988-1989
            "janeiro-1988":0.1277614,"fevereiro-1988":0.1096562,"mar√ßo-1988":0.0929596,"abril-1988":0.0801306,"maio-1988":0.0671787,"junho-1988":0.0570374,
            "julho-1988":0.0477181,"agosto-1988":0.03847,"setembro-1988":0.0318829,"outubro-1988":0.02571,"novembro-1988":0.0202043,"dezembro-1988":0.0159189,
            "janeiro-1989":12.3603833,"fevereiro-1989":8.6605825,"mar√ßo-1989":7.863249,"abril-1989":7.4118151,"maio-1989":6.9071782,"junho-1989":6.2828366,
            "julho-1989":5.0329457,"agosto-1989":3.9086105,"setembro-1989":3.0220826,"outubro-1989":2.2229176,"novembro-1989":1.6152449,"dezembro-1989":1.1421578,
            
            // 1990-1991
            "janeiro-1990":0.7438344,"fevereiro-1990":0.4764825,"mar√ßo-1990":0.2757736,"abril-1990":0.1496168,"maio-1990":0.1033265,"junho-1990":0.095788,
            "julho-1990":0.0874377,"agosto-1990":0.0774333,"setembro-1990":0.0691184,"outubro-1990":0.0612969,"novembro-1990":0.053675,"dezembro-1990":0.0464397,
            "janeiro-1991":0.0392559,"fevereiro-1991":0.0327378,"mar√ßo-1991":0.0268629,"abril-1991":0.0240298,"maio-1991":0.0228833,"junho-1991":0.0214504,
            "julho-1991":0.0193544,"agosto-1991":0.0172591,"setembro-1991":0.0149274,"outubro-1991":0.0129108,"novembro-1991":0.010663,"dezembro-1991":0.0084306,
            
            // 1992-1993
            "janeiro-1992":0.0068,"fevereiro-1992":0.005414,"mar√ßo-1992":0.0042934,"abril-1992":0.0035183,"maio-1992":0.0029361,"junho-1992":0.0023784,
            "julho-1992":0.0019294,"agosto-1992":0.0015944,"setembro-1992":0.0012948,"outubro-1992":0.0010499,"novembro-1992":0.0008367,"dezembro-1992":0.0006764,
            "janeiro-1993":0.0005477,"fevereiro-1993":0.000423,"mar√ßo-1993":0.0003338,"abril-1993":0.000265,"maio-1993":0.0002081,"junho-1993":0.0001616,
            "julho-1993":0.000124,"agosto-1993":0.0948816,"setembro-1993":0.0718836,"outubro-1993":0.0534912,"novembro-1993":0.0395748,"dezembro-1993":0.0295551,
            
            // 1994-1995
            "janeiro-1994":0.0216221,"fevereiro-1994":0.0155364,"mar√ßo-1994":0.0111214,"abril-1994":0.007743,"maio-1994":0.0054818,"junho-1994":0.0038013,
            "julho-1994":7.2267421,"agosto-1994":6.8685226,"setembro-1994":6.5409759,"outubro-1994":6.4362456,"novembro-1994":6.3160917,"dezembro-1994":6.1347593,
            "janeiro-1995":5.9996804,"fevereiro-1995":5.9996804,"mar√ßo-1995":5.9996804,"abril-1995":5.7498707,"maio-1995":5.7498707,"junho-1995":5.7498707,
            "julho-1995":5.3675089,"agosto-1995":5.3675089,"setembro-1995":5.3675089,"outubro-1995":5.1056133,"novembro-1995":5.1056133,"dezembro-1995":5.1056133,
            
            // 1996-1997
            "janeiro-1996":4.8992201,"fevereiro-1996":4.8992201,"mar√ßo-1996":4.8992201,"abril-1996":4.8992201,"maio-1996":4.8992201,"junho-1996":4.8992201,
            "julho-1996":4.5891079,"agosto-1996":4.5891079,"setembro-1996":4.5891079,"outubro-1996":4.5891079,"novembro-1996":4.5891079,"dezembro-1996":4.5891079,
            "janeiro-1997":4.4576018,"fevereiro-1997":4.4576018,"mar√ßo-1997":4.4576018,"abril-1997":4.4576018,"maio-1997":4.4576018,"junho-1997":4.4576018,
            "julho-1997":4.4576018,"agosto-1997":4.4576018,"setembro-1997":4.4576018,"outubro-1997":4.4576018,"novembro-1997":4.4576018,"dezembro-1997":4.4576018,
            
            // 1998-1999
            "janeiro-1998":4.2243094,"fevereiro-1998":4.2243094,"mar√ßo-1998":4.2243094,"abril-1998":4.2243094,"maio-1998":4.2243094,"junho-1998":4.2243094,
            "julho-1998":4.2243094,"agosto-1998":4.2243094,"setembro-1998":4.2243094,"outubro-1998":4.2243094,"novembro-1998":4.2243094,"dezembro-1998":4.2243094,
            "janeiro-1999":4.1555616,"fevereiro-1999":4.1555616,"mar√ßo-1999":4.1555616,"abril-1999":4.1555616,"maio-1999":4.1555616,"junho-1999":4.1555616,
            "julho-1999":4.1555616,"agosto-1999":4.1555616,"setembro-1999":4.1555616,"outubro-1999":4.1555616,"novembro-1999":4.1555616,"dezembro-1999":4.1555616,
            
            // 2000-2001
            "janeiro-2000":3.8154156,"fevereiro-2000":3.8154156,"mar√ßo-2000":3.8154156,"abril-2000":3.8154156,"maio-2000":3.8154156,"junho-2000":3.8154156,
            "julho-2000":3.8154156,"agosto-2000":3.8154156,"setembro-2000":3.8154156,"outubro-2000":3.8154156,"novembro-2000":3.8154156,"dezembro-2000":3.8154156,
            "janeiro-2001":3.5982417,"fevereiro-2001":3.5757147,"mar√ßo-2001":3.557925,"abril-2001":3.5451624,"maio-2001":3.5275248,"junho-2001":3.5103242,
            "julho-2001":3.4970355,"agosto-2001":3.4644695,"setembro-2001":3.4240655,"outubro-2001":3.4111033,"novembro-2001":3.3985288,"dezembro-2001":3.3652132,
            
            // 2002-2003
            "janeiro-2002":3.3468057,"fevereiro-2002":3.3261834,"mar√ßo-2002":3.3116123,"abril-2002":3.2984186,"maio-2002":3.2728901,"junho-2002":3.2592014,
            "julho-2002":3.2484814,"agosto-2002":3.2236593,"setembro-2002":3.1917418,"outubro-2002":3.172075,"novembro-2002":3.1437809,"dezembro-2002":3.0797227,
            "janeiro-2003":2.9885713,"fevereiro-2003":2.9305465,"mar√ßo-2003":2.8677429,"abril-2003":2.8354191,"maio-2003":2.8034597,"junho-2003":2.7798311,
            "julho-2003":2.7737289,"agosto-2003":2.7787306,"setembro-2003":2.7712483,"outubro-2003":2.7555417,"novembro-2003":2.7374743,"dezembro-2003":2.7328285,
            
            // 2004-2005
            "janeiro-2004":2.7203151,"fevereiro-2004":2.7019419,"mar√ßo-2004":2.6778413,"abril-2004":2.6671726,"maio-2004":2.6615833,"junho-2004":2.6472879,
            "julho-2004":2.6325457,"agosto-2004":2.6082886,"setembro-2004":2.5878446,"outubro-2004":2.575226,"novembro-2004":2.5670116,"dezembro-2004":2.5509407,
            "janeiro-2005":2.5296912,"fevereiro-2005":2.5126055,"mar√ßo-2005":2.4941488,"abril-2005":2.4854498,"maio-2005":2.4671925,"junho-2005":2.4468834,
            "julho-2005":2.4439507,"agosto-2005":2.4412653,"setembro-2005":2.4344488,"outubro-2005":2.4305599,"novembro-2005":2.4170246,"dezembro-2005":2.3983177,
            
            // 2006-2007
            "janeiro-2006":2.3892386,"fevereiro-2006":2.3771153,"mar√ßo-2006":2.3648182,"abril-2006":2.3561007,"maio-2006":2.3521021,"junho-2006":2.3457685,
            "julho-2006":2.3492925,"agosto-2006":2.3497624,"setembro-2006":2.3453063,"outubro-2006":2.3441343,"novembro-2006":2.3373559,"dezembro-2006":2.3287396,
            "janeiro-2007":2.3206174,"fevereiro-2007":2.3086127,"mar√ßo-2007":2.2980417,"abril-2007":2.2886582,"maio-2007":2.2836342,"junho-2007":2.2777121,
            "julho-2007":2.2711259,"agosto-2007":2.2656882,"setembro-2007":2.2562121,"outubro-2007":2.249688,"novembro-2007":2.2443017,"dezembro-2007":2.2391516,
            
            // 2008-2009
            "janeiro-2008":2.2235865,"fevereiro-2008":2.2081296,"mar√ßo-2008":2.1940875,"abril-2008":2.1890526,"maio-2008":2.176213,"junho-2008":2.1640941,
            "julho-2008":2.1447909,"agosto-2008":2.1313634,"setembro-2008":2.1239296,"outubro-2008":2.1184217,"novembro-2008":2.1120854,"dezembro-2008":2.1017867,
            "janeiro-2009":2.0957091,"fevereiro-2009":2.0873597,"mar√ßo-2009":2.0742917,"abril-2009":2.0720124,"maio-2009":2.06458,"junho-2009":2.0524704,
            "julho-2009":2.0447005,"agosto-2009":2.0402121,"setembro-2009":2.0355303,"outubro-2009":2.0316702,"novembro-2009":2.0280197,"dezembro-2009":2.0191355,
            
            // 2010-2011
            "janeiro-2010":2.0114919,"fevereiro-2010":2.0010862,"mar√ßo-2010":1.9824512,"abril-2010":1.9716073,"maio-2010":1.9621888,"junho-2010":1.9499044,
            "julho-2010":1.9462066,"agosto-2010":1.9479598,"setembro-2010":1.9489343,"outubro-2010":1.9429112,"novembro-2010":1.9309394,"dezembro-2010":1.9144749,
            "janeiro-2011":1.9013556,"fevereiro-2011":1.8870143,"mar√ßo-2011":1.8688861,"abril-2011":1.8577396,"maio-2011":1.8435443,"junho-2011":1.8307292,
            "julho-2011":1.8265282,"agosto-2011":1.8247035,"setembro-2011":1.8197901,"outubro-2011":1.8101961,"novembro-2011":1.802625,"dezembro-2011":1.7943709,
            
            // 2012-2013
            "janeiro-2012":1.7843784,"fevereiro-2012":1.7728548,"mar√ßo-2012":1.7635083,"abril-2012":1.7591105,"maio-2012":1.7515787,"junho-2012":1.742691,
            "julho-2012":1.7395598,"agosto-2012":1.7338381,"setembro-2012":1.7271024,"outubro-2012":1.7188519,"novembro-2012":1.7077515,"dezembro-2012":1.6985792,
            "janeiro-2013":1.6869393,"fevereiro-2013":1.6722237,"mar√ßo-2013":1.6609294,"abril-2013":1.6528305,"maio-2013":1.6444439,"junho-2013":1.6369141,
            "julho-2013":1.6307174,"agosto-2013":1.6295766,"setembro-2013":1.6269735,"outubro-2013":1.6225925,"novembro-2013":1.6148413,"dezembro-2013":1.6056888,
            
            // 2014-2015
            "janeiro-2014":1.5937358,"fevereiro-2014":1.5831288,"mar√ßo-2014":1.572124,"abril-2014":1.5607306,"maio-2014":1.5486512,"junho-2014":1.5397208,
            "julho-2014":1.532518,"agosto-2014":1.5299171,"setembro-2014":1.5277782,"outubro-2014":1.521843,"novembro-2014":1.5145731,"dezembro-2014":1.5088395,
            "janeiro-2015":1.4970131,"fevereiro-2015":1.4838072,"mar√ßo-2015":1.4643316,"abril-2015":1.4463963,"maio-2015":1.4310837,"junho-2015":1.4225484,
            "julho-2015":1.4086032,"agosto-2015":1.4003412,"setembro-2015":1.3943455,"outubro-2015":1.3889287,"novembro-2015":1.3798219,"dezembro-2015":1.3681922,
            
            // 2016-2017
            "janeiro-2016":1.3522358,"fevereiro-2016":1.3399087,"mar√ßo-2016":1.3211484,"abril-2016":1.3154918,"maio-2016":1.3088168,"junho-2016":1.2976569,
            "julho-2016":1.292487,"agosto-2016":1.2855451,"setembro-2016":1.279786,"outubro-2016":1.2768493,"novembro-2016":1.2744279,"dezembro-2016":1.2711229,
            "janeiro-2017":1.2687124,"fevereiro-2017":1.2647915,"mar√ßo-2017":1.2579983,"abril-2017":1.2561142,"maio-2017":1.2534819,"junho-2017":1.2504807,
            "julho-2017":1.2484831,"agosto-2017":1.2507344,"setembro-2017":1.2463721,"outubro-2017":1.2450026,"novembro-2017":1.240784,"dezembro-2017":1.2368261,
            
            // 2018-2019
            "janeiro-2018":1.2325123,"fevereiro-2018":1.2277242,"mar√ßo-2018":1.2230765,"abril-2018":1.2218547,"maio-2018":1.2192942,"junho-2018":1.2175895,
            "julho-2018":1.2042227,"agosto-2018":1.1965646,"setembro-2018":1.1950111,"outubro-2018":1.1939366,"novembro-2018":1.1870517,"dezembro-2018":1.1848006,
            "janeiro-2019":1.1866993,"fevereiro-2019":1.1831498,"mar√ßo-2019":1.1791408,"abril-2019":1.1728076,"maio-2019":1.1644237,"junho-2019":1.1603625,
            "julho-2019":1.1596667,"agosto-2019":1.1586239,"setembro-2019":1.1576978,"outubro-2019":1.1566568,"novembro-2019":1.1556167,"dezembro-2019":1.1540011,
            
            // 2020-2021
            "janeiro-2020":1.14201,"fevereiro-2020":1.1339589,"mar√ßo-2020":1.1314697,"abril-2020":1.1312434,"maio-2020":1.1313565,"junho-2020":1.1380712,
            "julho-2020":1.1378436,"agosto-2020":1.1344403,"setembro-2020":1.1318371,"outubro-2020":1.1267666,"novembro-2020":1.1162736,"dezembro-2020":1.1073045,
            "janeiro-2021":1.0956901,"fevereiro-2021":1.0872099,"mar√ßo-2021":1.0820162,"abril-2021":1.0720462,"maio-2021":1.0656523,"junho-2021":1.060984,
            "julho-2021":1.0522503,"agosto-2021":1.0447282,"setembro-2021":1.0355122,"outubro-2021":1.0238404,"novembro-2021":1.0117,"dezembro-2021":1
        };

        function obterIndiceCNJ(mesBase, anoBase) {
            const numeroMesBase = meses[mesBase.toLowerCase()];
            // Se o per√≠odo base √© ap√≥s dezembro de 2021, n√£o h√° corre√ß√£o
            if (anoBase > 2021 || (anoBase === 2021 && numeroMesBase > 12)) {
                return 1.0000;
            }
            
            const chave = `${mesBase.toLowerCase()}-${anoBase}`;
            return indicesCNJ[chave] || 1.0000;
        }
        
        const periodosJuros = [
            [10, 1964, 12, 2002, 0.5, 0.5],
            [1, 2003, 6, 2009, 0.5, 1.0],
            [7, 2009, 5, 2012, 0.5, 0.5],
            [6, 2012, 6, 2012, 0.4828, 0.4828],
            [7, 2012, 7, 2012, 0.4973, 0.4973],
            [8, 2012, 8, 2012, 0.4675, 0.4675],
            [9, 2012, 10, 2012, 0.4273, 0.4273],
            [11, 2012, 4, 2013, 0.4134, 0.4134],
            [5, 2013, 5, 2013, 0.4273, 0.4273],
            [6, 2013, 6, 2013, 0.4551, 0.4551],
            [7, 2013, 7, 2013, 0.4761, 0.4761],
            [8, 2013, 8, 2013, 0.4828, 0.4828],
            [9, 2013, 9, 2017, 0.5, 0.5],
            [10, 2017, 10, 2017, 0.4690, 0.4690],
            [11, 2017, 12, 2017, 0.4273, 0.4273],
            [1, 2018, 2, 2018, 0.3994, 0.3994],
            [3, 2018, 3, 2018, 0.3855, 0.3855],
            [4, 2018, 7, 2019, 0.3715, 0.3715],
            [8, 2019, 9, 2019, 0.3434, 0.3434],
            [10, 2019, 10, 2019, 0.3153, 0.3153],
            [11, 2019, 12, 2019, 0.2871, 0.2871],
            [1, 2020, 2, 2020, 0.2588, 0.2588],
            [3, 2020, 3, 2020, 0.2446, 0.2446],
            [4, 2020, 5, 2020, 0.2162, 0.2162],
            [6, 2020, 6, 2020, 0.1733, 0.1733],
            [7, 2020, 8, 2020, 0.1303, 0.1303],
            [9, 2020, 3, 2021, 0.1159, 0.1159],
            [4, 2021, 5, 2021, 0.1590, 0.1590],
            [6, 2021, 6, 2021, 0.2019, 0.2019],
            [7, 2021, 8, 2021, 0.2446, 0.2446],
            [9, 2021, 9, 2021, 0.3012, 0.3012],
            [10, 2021, 10, 2021, 0.3575, 0.3575],
            [11, 2021, 11, 2021, 0.4412, 0.4412]
        ];

        function calcularPeriodoGraca(anoOrcamento) {
            let inicioGraca;
            if (anoOrcamento <= 2022) {
                // Julho do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 6, 1); // M√™s 6 = Julho (0-based)
            } else {
                // Abril do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 3, 1); // M√™s 3 = Abril
            }
            // Fim do per√≠odo: 31 de Dezembro do ano do or√ßamento
            const fimGraca = new Date(anoOrcamento, 11, 31); // M√™s 11 = Dezembro
            return { inicioGraca, fimGraca };
        }
        
        function criarDataBase(mesBase, anoBase) {
            const numeroMes = meses[mesBase.toLowerCase()];
            return new Date(anoBase, numeroMes - 1, 1);
        }

        //para juros mora
        function obterTaxaJuros(mes, ano, natureza) {
            const dataConsulta = new Date(ano, mes - 1, 1);
            for (const periodo of periodosJuros) {
                const [mesInicio, anoInicio, mesFim, anoFim, juroAlimentar, juroComum] = periodo;
                const dataInicio = new Date(anoInicio, mesInicio - 1, 1);
                const dataFim = new Date(anoFim, mesFim - 1, 1);
                if (dataConsulta >= dataInicio && dataConsulta <= dataFim) {
                    return natureza === 'alimentar' ? juroAlimentar : juroComum;
                }
            }
            return 0;
        }
        
        //para juros mora
        function estaNoPeriodoGraca(data, inicioGraca, fimGraca) {
            return data >= inicioGraca && data <= fimGraca;
        }

        //para juros mora
        function gerarMesesEntreDatas(dataInicio, dataFim) {
            const meses = [];
            const atual = new Date(dataInicio);
            while (atual <= dataFim) {
                meses.push({
                    mes: atual.getMonth() + 1,
                    ano: atual.getFullYear(),
                    data: new Date(atual)
                });
                atual.setMonth(atual.getMonth() + 1);
            }
            return meses;
        }

        //para juros mora
        function calcularSomaJurosMora(mesBase, anoBase, natureza, inicioGraca = null, fimGraca = null) {
            const dataBase = criarDataBase(mesBase, anoBase);
            const dataLimite = new Date(2021, 10, 1); // Novembro/2021 (m√™s 10)
            if (dataBase > dataLimite) {
                return 0; // Fora do per√≠odo, sem juros
            }
            const mesesCalculo = gerarMesesEntreDatas(dataBase, dataLimite);
            let somaJuros = 0;
            for (const mesInfo of mesesCalculo) {
                const { mes, ano, data } = mesInfo;
                const estaGraca = inicioGraca && fimGraca && estaNoPeriodoGraca(data, inicioGraca, fimGraca);
                if (estaGraca) continue;
                const taxa = obterTaxaJuros(mes, ano, natureza);
                somaJuros += taxa;
            }
            return somaJuros;
        }

        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById("dataatualizacao").value = hoje;

        async function calcularSelic(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataReferencia = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));

                const primeiroDiaMesAtual = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                const urlselic = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                
                const response = await fetch(urlselic);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosselic = await response.json();
                
                return processarDadosSelic(dadosselic, dataBase, inicioGraca, fimGraca);
                
            } catch (error) {
                console.error(`Erro ao obter dados da SELIC: ${error}`);
                console.log('A API do Banco Central est√° indispon√≠vel. Ser√° necess√°rio inserir os valores manualmente.');
                
                // Solicita valores manuais
                return await solicitarValoresManuais(dataBase, inicioGraca, fimGraca);
            }
        }

        async function solicitarValoresManuais(dataBase, inicioGraca, fimGraca) {
            try {
                let indiceSelicAntes = 1.0;
                let indiceSelicApos = 1.0;
                let temSelicAntes = false;
                let temSelicApos = false;
                let periodoAntesGraca = '';
                let periodoAposGraca = '';
                
                // Data de in√≠cio da aplica√ß√£o da SELIC (dezembro/2021) - igual √† API
                const inicioSelicPrec = new Date(2021, 11, 1); // dezembro/2021
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const hoje = new Date(dataAtualizacaoInput);
                
                // Verifica se precisa de SELIC antes da gra√ßa
                if (dataBase < inicioGraca) {
                    // S√≥ pede se houver per√≠odo v√°lido (>= dez/2021 e < in√≠cio gra√ßa)
                    const dataInicioEfetivo = dataBase > inicioSelicPrec ? dataBase : inicioSelicPrec;
                    
                    if (dataInicioEfetivo < inicioGraca) {
                        const valorAntes = prompt(
                            `Digite o √≠ndice SELIC ANTES da gra√ßa (per√≠odo de ${dataInicioEfetivo.toLocaleDateString('pt-BR')} a ${inicioGraca.toLocaleDateString('pt-BR')}):\n` +
                            `Formato: 1,XXXX ou 1.XXXX (exemplo: 1.4273 para 42,73% acumulado)`
                        );
                        
                        if (valorAntes) {
                            const valorNormalizado = valorAntes.replace(',', '.');
                            if (!isNaN(parseFloat(valorNormalizado))) {
                                indiceSelicAntes = parseFloat(valorNormalizado);
                                temSelicAntes = true;
                                periodoAntesGraca = `${dataInicioEfetivo.toLocaleDateString('pt-BR')} a ${inicioGraca.toLocaleDateString('pt-BR')} (manual)`;
                            }
                        }
                    }
                }
                
                // Verifica se precisa de SELIC ap√≥s a gra√ßa
                if (dataBase > fimGraca) {
                    // Se dataBase √© ap√≥s a gra√ßa, aplica SELIC da dataBase (se >= dez/2021) at√© hoje
                    const dataInicioEfetivo = dataBase > inicioSelicPrec ? dataBase : inicioSelicPrec;
                    if (dataInicioEfetivo < hoje) {
                        const valorApos = prompt(
                            `Digite o √≠ndice SELIC AP√ìS a gra√ßa (per√≠odo de ${dataInicioEfetivo.toLocaleDateString('pt-BR')} at√© hoje):\n` +
                            `Formato: 1,XXXX ou 1.XXXX (exemplo: 1.4273 para 42,73% acumulado)`
                        );
                        
                        if (valorApos) {
                            const valorNormalizado = valorApos.replace(',', '.');
                            if (!isNaN(parseFloat(valorNormalizado))) {
                                indiceSelicApos = parseFloat(valorNormalizado);
                                temSelicApos = true;
                                periodoAposGraca = `${dataInicioEfetivo.toLocaleDateString('pt-BR')} at√© hoje (manual)`;
                            }
                        }
                    }
                } else if (fimGraca < hoje) {
                    // Se dataBase √© antes/durante a gra√ßa, aplica SELIC ap√≥s a gra√ßa at√© hoje
                    const dataInicioEfetivo = fimGraca > inicioSelicPrec ? fimGraca : inicioSelicPrec;
                    const valorApos = prompt(
                        `Digite o √≠ndice SELIC AP√ìS a gra√ßa (per√≠odo de ${dataInicioEfetivo.toLocaleDateString('pt-BR')} at√© hoje):\n` +
                        `Formato: 1,XXXX ou 1.XXXX (exemplo: 1.4273 para 42,73% acumulado)`
                    );
                    
                    if (valorApos) {
                        const valorNormalizado = valorApos.replace(',', '.');
                        if (!isNaN(parseFloat(valorNormalizado))) {
                            indiceSelicApos = parseFloat(valorNormalizado);
                            temSelicApos = true;
                            periodoAposGraca = `${dataInicioEfetivo.toLocaleDateString('pt-BR')} at√© hoje (manual)`;
                        }
                    }
                }
                
                // Calcula √≠ndice total
                const indiceselic = indiceSelicAntes * indiceSelicApos;
                
                return {
                    indiceselic,
                    indiceSelicAntes,
                    indiceSelicApos,
                    periodoAntesGraca,
                    periodoAposGraca,
                    temSelicAntes,
                    temSelicApos
                };
                
            } catch (error) {
                console.error('Erro ao processar valores manuais:', error);
                return {
                    indiceselic: 1.00,
                    indiceSelicAntes: 1.00,
                    indiceSelicApos: 1.00,
                    periodoAntesGraca: '',
                    periodoAposGraca: '',
                    temSelicAntes: false,
                    temSelicApos: false
                };
            }
        }

        function processarDadosSelic(dadosselic, dataBase, inicioGraca, fimGraca) {
            // Fun√ß√£o para converter string de data da API em Date
            function strParaData(dataStr) {
                const [dia, mes, ano] = dataStr.split('/');
                return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            }
            
            // Aplica SELIC antes do in√≠cio da gra√ßa
            let selicAntesGraca = [];
            let periodoAntesGraca = '';
            if (dataBase < inicioGraca) {
                const dadosAntesGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataBase <= dataItem && dataItem < inicioGraca;
                });
                selicAntesGraca = dadosAntesGraca.map(item => parseFloat(item.valor.replace(',', '.')));
                
                // Definir per√≠odo antes da gra√ßa
                if (dadosAntesGraca.length > 0) {
                    const primeiraData = dadosAntesGraca[0].data;
                    const ultimaData = dadosAntesGraca[dadosAntesGraca.length - 1].data;
                    periodoAntesGraca = `${primeiraData} a ${ultimaData}`;
                }
            }
            
            let dadosAposGraca = [];
            if (dataBase > fimGraca) {
                // Se dataBase √© ap√≥s a gra√ßa, aplica SELIC da dataBase at√© hoje
                dadosAposGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataItem >= dataBase;
                });
            } else {
                // Se dataBase √© antes/durante a gra√ßa, aplica SELIC ap√≥s a gra√ßa at√© hoje
                dadosAposGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataItem > fimGraca;
                });
            }
            
            const selicAposGraca = dadosAposGraca.map(item => parseFloat(item.valor.replace(',', '.')));
            
            // Definir per√≠odo ap√≥s a gra√ßa
            let periodoAposGraca = '';
            if (dadosAposGraca.length > 0) {
                const primeiraData = dadosAposGraca[0].data;
                const ultimaData = dadosAposGraca[dadosAposGraca.length - 1].data;
                periodoAposGraca = `${primeiraData} a ${ultimaData}`;
            }
            
            // Soma da SELIC
            const somaSelicAntes = selicAntesGraca.reduce((sum, val) => sum + val, 0);
            const somaSelicApos = selicAposGraca.reduce((sum, val) => sum + val, 0);
            const somaSelic = somaSelicAntes + somaSelicApos;
            const indiceselic = 1 + (somaSelic / 100);
            const indiceSelicAntes = somaSelicAntes > 0 ? 1 + (somaSelicAntes / 100) : 1.0;
            const indiceSelicApos = somaSelicApos > 0 ? 1 + (somaSelicApos / 100) : 1.0;
            
            return {
                indiceselic,
                indiceSelicAntes,
                indiceSelicApos,
                periodoAntesGraca,
                periodoAposGraca,
                temSelicAntes: selicAntesGraca.length > 0,
                temSelicApos: selicAposGraca.length > 0
            };
        }

        // Fun√ß√£o para calcular IPCA-e acumulado
        async function calcularIpca(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataReferencia = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));

                const primeiroDiaMesAtual = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                const urlipca = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.10764/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                //7478 - ipca 10764 - IPCA.E
                const response = await fetch(urlipca);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosipca = await response.json();
                
                return processarDadosIpca(dadosipca, dataBase, inicioGraca, fimGraca);
                
            } catch (error) {
                console.error(`Erro ao obter dados do IPCA: ${error}`);
                console.log('A API do Banco Central est√° indispon√≠vel. Ser√° necess√°rio inserir o valor do IPCA manualmente.');
                
                // Solicita valor manual
                return await solicitarIpcaManual(dataBase, inicioGraca, fimGraca);
            }
        }

        async function solicitarIpcaManual(dataBase, inicioGraca, fimGraca) {
            try {
                let indiceipca = 1.0;
                
                // Data de in√≠cio da aplica√ß√£o do IPCA (dezembro/2021) - igual √† API
                const inicioIPCAPrec = new Date(2021, 11, 1); // dezembro/2021
                
                // Verifica se precisa de IPCA durante a gra√ßa
                if (dataBase <= fimGraca) {
                    // Determina o in√≠cio efetivo: o maior entre dataBase, inicioGraca e dez/2021
                    let inicioEfetivo = dataBase > inicioGraca ? dataBase : inicioGraca;
                    if (inicioEfetivo < inicioIPCAPrec) {
                        inicioEfetivo = inicioIPCAPrec;
                    }
                    
                    // S√≥ pergunta se h√° per√≠odo v√°lido para aplicar IPCA
                    if (inicioEfetivo <= fimGraca) {
                        const valorIpca = prompt(
                            `Digite o √≠ndice IPCA DURANTE a gra√ßa (per√≠odo de ${inicioEfetivo.toLocaleDateString('pt-BR')} a ${fimGraca.toLocaleDateString('pt-BR')}):\n` +
                            `Formato: 1,XXXX ou 1.XXXX (exemplo: 1,1250 ou 1.1250 para 12,50% acumulado)`
                        );
                        
                        if (valorIpca) {
                            // Normaliza v√≠rgula para ponto
                            const valorNormalizado = valorIpca.replace(',', '.');
                            if (!isNaN(parseFloat(valorNormalizado))) {
                                indiceipca = parseFloat(valorNormalizado);
                            }
                        }
                    }
                }
                // Se dataBase > fimGraca, n√£o aplica IPCA (mant√©m 1.0)
                
                return indiceipca;
                
            } catch (error) {
                console.error('Erro ao processar valor manual do IPCA:', error);
                return 1.0;
            }
        }

        function processarDadosIpca(dadosipca, dataBase, inicioGraca, fimGraca) {
            // Fun√ß√£o para converter string de data da API em Date
            function strParaData(dataStr) {
                const [dia, mes, ano] = dataStr.split('/');
                return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            }
            
            let ipcaGraca = [];
            
            if (dataBase <= fimGraca) {
                // Determina o in√≠cio efetivo: o maior entre dataBase e inicioGraca
                const inicioEfetivo = dataBase > inicioGraca ? dataBase : inicioGraca;
                
                ipcaGraca = dadosipca
                    .filter(item => {
                        const dataItem = strParaData(item.data);
                        return inicioEfetivo <= dataItem && dataItem <= fimGraca;
                    })
                    .map(item => parseFloat(item.valor.replace(',', '.')));
            }
            // Se dataBase > fimGraca, n√£o aplica IPCA (ipcaGraca fica vazio)
            
            let indiceipca = 1.0;
            for (const valor of ipcaGraca) {
                indiceipca *= 1 + (valor / 100);
            }
            
            return indiceipca;
        }

        function coletarDados() {
            const cache = ColetaCache;
            
            const dados = {
                numProcesso: cache.getValue('numprocesso', 'Processo'),
                anoOrcamento: cache.getValue('anoOrcamento', 2026, parseInt),
                beneficiario: cache.getValue('beneficiario', 'Beneficiario'),
                tipoBeneficiario: cache.getValue('tipoBeneficiario', 'pf'),
                credor: cache.getValue('credor', 'Devedor'),
                natureza: cache.getValue('natureza'),
                tipoCalculo: cache.getValue('tipoCalculo'),

                somenteHonorarioSucumbencial: document.getElementById('somenteHonorarioSucumbencial')?.checked || false,
                
                valoresPrincipais: valoresPrincipais.map(valor => ({
                    ...valor,
                    valorPrincipal: parseFloat(valor.valorPrincipal) || 0,
                    valorJuros: parseFloat(valor.valorJuros) || 0,
                    valorSelic: parseFloat(valor.valorSelic) || 0,
                    percentualSelic: parseFloat(valor.percentualSelic) || 0,
                    tipoSelic: valor.tipoSelic || 'valor',
                    tributacao: {
                        ...valor.tributacao,
                        rra: parseFloat(valor.tributacao.rra) || 0,
                        aliquotaFixa: parseFloat(valor.tributacao.aliquotaFixa) || 0
                    }
                })),
                
                // Quantidades
                quantAdvogados: cache.getValue('quantAdvogados', 0, parseInt),
                quantAdvogadosSucumbenciais: cache.getValue('quantAdvogadosSucumbenciais', 0, parseInt), 
                quantHerdeiros: cache.getValue('quantHerdeiros', 0, parseInt),
                quantSindicatos: cache.getValue('quantSindicatos', 0, parseInt),
                quantCessoes: cache.getValue('quantCessoes', 0, parseInt),
                quantidadePagamentos: cache.getValue('quantidadePagamentos', 0, parseInt), 
                
                advogados: [],
                herdeiros: [],
                sindicatos: [],
                cessoes: [],
                pagamentos: []
            };
            
            dados.valorTotal = dados.valorPrincipal + dados.valorJuros;
            
            if (dados.tipoCalculo === 'preferencia') {
                dados.tetoPreferencia = cache.getValue('tetoPreferenciaPrincipal', 0, parseFloat);
            }
            if (dados.tipoCalculo === 'acordo') {
                dados.percentualAcordo = cache.getValue('percentualAcordoValor', 0, parseFloat);
            }
            if (dados.tipoCalculo === 'parcial') { 
                dados.saldoParcial = cache.getValue('saldoParcialValor', 0, parseFloat);
            }
            
            coletarAdvogados(dados);
            coletarHonorarioSucumbencial(dados);
            coletarHerdeiros(dados);
            coletarSindicatos(dados);
            coletarCessoes(dados);
            coletarPagamentos(dados);
            
            return dados;
        }

        function coletarAdvogados(dados) {
            for (let i = 0; i < dados.quantAdvogados; i++) {
                const nome = document.getElementById(`advNome${i}`)?.value || '';
                const tipo = document.getElementById(`advTipo${i}`)?.value || '';
                const incidenciaIRElement = document.getElementById(`advIncidenciaIR${i}`); 
                const percentual = parseFloat(document.getElementById(`advPercentual${i}`)?.value) || 0;
                
                dados.advogados.push({ nome, tipo,incidenciaIR: incidenciaIRElement?.value === 'sim', percentual });
            }
        }

        function coletarHonorarioSucumbencial(dados) {
            const quantAdvogados = parseInt(document.getElementById('quantAdvogadosSucumbenciais')?.value) || 0;
            const somenteHonorarioSucumbencial = document.getElementById('somenteHonorarioSucumbencial')?.checked || false;
            
            dados.honorarioSucumbencial = {
                somenteHonorarioSucumbencial: somenteHonorarioSucumbencial,
                advogados: []
            };
            
            for (let i = 0; i < quantAdvogados; i++) {
                const nomeElement = document.getElementById(`advSucNome${i}`);
                const tipoElement = document.getElementById(`advSucTipo${i}`);
                const incidenciaIRElement = document.getElementById(`advSucIncidenciaIR${i}`);
                const tipoHonorarioElement = document.getElementById(`advSucTipoHonorario${i}`);
                const percentualElement = document.getElementById(`advSucPercentual${i}`);
                const preferenciaElement = document.getElementById(`advSucTemPreferencia${i}`);
                
                if (!nomeElement || !tipoElement || !tipoHonorarioElement) continue;
                
                const advogado = {
                    nome: nomeElement.value || `Advogado Sucumbencial ${i + 1}`,
                    tipo: tipoElement.value || 'PF',
                    incidenciaIR: incidenciaIRElement?.value === 'sim',
                    tipoHonorario: tipoHonorarioElement.value || 'percentual',
                    preferencia: preferenciaElement?.value === 'sim'
                };
                
                // Adicionar campo espec√≠fico baseado no tipo
                if (advogado.tipoHonorario === 'percentual') {
                    advogado.percentual = parseFloat(percentualElement?.value) || 0;
                }
                
                dados.honorarioSucumbencial.advogados.push(advogado);
            }
        }

        function coletarHerdeiros(dados) {
            for (let i = 0; i < dados.quantHerdeiros; i++) {
                const nomeElement = document.getElementById(`herdNome${i}`);
                const percentualElement = document.getElementById(`herdPercentual${i}`);
                const preferenciaElement = document.getElementById(`herdPreferencia${i}`);
                
                if (!nomeElement || !percentualElement) continue;
                
                dados.herdeiros.push({
                    nome: nomeElement.value || `Herdeiro ${i + 1}`,
                    percentual: parseFloat(percentualElement.value) || 0,
                    temPreferencia: preferenciaElement?.value === 'sim'
                });
            }
        }

        function coletarSindicatos(dados) {
            for (let i = 0; i < dados.quantSindicatos; i++) {
                const nomeElement = document.getElementById(`sindNome${i}`);
                const percentualElement = document.getElementById(`sindPercentual${i}`);
                const tributacaoElement = document.getElementById(`sindTrib${i}`);
                
                if (!nomeElement || !percentualElement || !tributacaoElement) continue;
                
                const tributacao = tributacaoElement.value;
                
                let aliquotaFixa = 0;
                if (tributacao === 'nao') {
                    aliquotaFixa = 1; // 100% - sem tributa√ß√£o
                } else if (tributacao === 'lei') {
                    aliquotaFixa = 0.03; // 3% - Art. 27, da Lei n¬∫ 10.833/03
                } else if (tributacao === 'fixa') {
                    const aliquotaElement = document.getElementById(`aliquotaSind${i}`);
                    aliquotaFixa = parseFloat(aliquotaElement?.value) || 0;
                }
                
                dados.sindicatos.push({
                    nome: nomeElement.value || `Sindicato ${i + 1}`,
                    percentual: parseFloat(percentualElement.value) || 0,
                    tributacao,
                    aliquotaTributacao: aliquotaFixa
                });
            }
        }

        function coletarCessoes(dados) {
            for (let i = 0; i < dados.quantCessoes; i++) {
                const tipoElement = document.getElementById(`cessaoTipo${i}`);
                const cedenteElement = document.getElementById(`cedenteNome${i}`);
                const cessionarioElement = document.getElementById(`cessionarioNome${i}`);
                const percentualElement = document.getElementById(`cessaoPercentual${i}`);
                
                if (!tipoElement || !cedenteElement || !cessionarioElement || !percentualElement) continue;
                
                const tipo = tipoElement.value;
                const cedente = cedenteElement.value;
                
                if (tipo && cedente) {
                    dados.cessoes.push({
                        tipo,
                        cedente,
                        cessionario: cessionarioElement.value || `Cession√°rio ${i + 1}`,
                        percentual: parseFloat(percentualElement.value) || 0
                    });
                }
            }
        }

        function coletarPagamentos(dados) {
            const quantidade = parseInt(document.getElementById('quantidadePagamentos')?.value) || 0;
            dados.pagamentos = [];
            
            for (let i = 0; i < quantidade; i++) {
                const beneficiario = document.getElementById(`pagBeneficiario${i}`)?.value?.trim();
                const dataBase = document.getElementById(`pagDataBase${i}`)?.value;
                
                const tipoInformacao = document.getElementById(`pagTipoInformacao${i}`)?.value || 'separado';
                
                if (!beneficiario || !dataBase) continue;
                
                const pagamento = {
                    beneficiario: beneficiario,
                    dataBase: dataBase,
                    tipoInformacao: tipoInformacao
                };
                
                if (tipoInformacao === 'total') {
                    const valorTotal = document.getElementById(`pagValorTotal${i}`)?.value;
                    
                    if (!valorTotal || parseFloat(valorTotal) <= 0) continue;
                    
                    pagamento.valorTotal = parseFloat(valorTotal);                    
                } else {
                    const valorPrincipal = document.getElementById(`pagValorPrincipal${i}`)?.value;
                    const valorJuros = document.getElementById(`pagValorJuros${i}`)?.value;
                    
                    if (!valorPrincipal && !valorJuros) continue;
                    
                    pagamento.valorPrincipal = parseFloat(valorPrincipal) || 0;
                    pagamento.valorJuros = parseFloat(valorJuros) || 0;
                    
                    const selicValorRadio = document.getElementById(`pagSelicValor${i}`);
                    const tipoSelic = selicValorRadio && selicValorRadio.checked ? 'valor' : 'percentual';
                    
                    const valorSelic = document.getElementById(`pagValorSelic${i}`)?.value;
                    const percentualSelic = document.getElementById(`pagPercentualSelic${i}`)?.value;
                    const selicReferencia = document.getElementById(`pagMesReferenciaSelic${i}`)?.value;
                    
                    pagamento.tipoSelic = tipoSelic;
                    pagamento.valorSelic = parseFloat(valorSelic) || 0;
                    pagamento.percentualSelic = parseFloat(percentualSelic) || 0;
                    pagamento.selicReferencia = selicReferencia || 'mesAnterior';
                }
                
                dados.pagamentos.push(pagamento);
            }
            
            dados.quantidadePagamentos = dados.pagamentos.length; 
        }

        function validarDados(dados) {
            const erros = [];
            
            if (dados.herdeiros.length > 0) {
                const somaHerdeiros = dados.herdeiros.reduce((sum, h) => sum + h.percentual, 0);
                if (Math.abs(somaHerdeiros - 1.0) > 0.001) {
                    erros.push(`A soma dos percentuais dos herdeiros deve ser 100% (atual: ${(somaHerdeiros * 100).toFixed(2)}%)`);
                }
            }

            if (dados.tipoCalculo === 'acordo') {
                const adesoes = obterAdesaoAcordo();
                
                // Verificar se pelo menos algu√©m aderiu
                const temAdesao = adesoes.beneficiario || 
                                adesoes.advogados.length > 0 || 
                                adesoes.advogadosSucumbenciais.length > 0 || 
                                adesoes.herdeiros.length > 0 || 
                                adesoes.sindicatos.length > 0 || 
                                adesoes.cessionarios.length > 0;
                
                if (!temAdesao) {
                    erros.push("Para c√°lculo de acordo, pelo menos 1 pessoa/entidade deve aderir ao acordo. V√° para a aba 'Ades√£o ao Acordo' e selecione quem aderiu.");
                }
            }
            
            validarCessoes(dados, erros);
            
            return erros;
        }

        function validarCessoes(dados, erros) {
            const advogadosMap = new Map(dados.advogados.map(adv => [adv.nome, true]));
            const advogadosSucumbenciaisMap = new Map(dados.honorarioSucumbencial?.advogados.map(adv => [adv.nome, true]) || []); 
            const herdeirosMap = new Map(dados.herdeiros.map(h => [h.nome, true]));
            const sindicatosMap = new Map(dados.sindicatos.map(s => [s.nome, true]));
            
            const beneficiarioNorm = dados.beneficiario.trim();
            
            dados.cessoes.forEach((cessao, i) => {
                if (cessao.percentual > 1.0) {
                    erros.push(`Cess√£o ${i + 1}: Percentual n√£o pode ser maior que 100%`);
                }
                
                let cedenteExiste = false;
                const cedenteNorm = cessao.cedente.trim();
                
                switch (cessao.tipo) {
                    case 'cessaobenPrincipal':
                        cedenteExiste = cedenteNorm === beneficiarioNorm || cedenteNorm === 'Benefici√°rio Principal';
                        break;
                    case 'cessaoAdv':
                        cedenteExiste = advogadosMap.has(cessao.cedente);
                        break;
                    case 'cessaoAdvSuc':
                        cedenteExiste = advogadosSucumbenciaisMap.has(cessao.cedente);
                        break;
                    case 'cessaoherdeiro':
                        cedenteExiste = herdeirosMap.has(cessao.cedente);
                        break;
                    case 'cessaoSindicato':
                        cedenteExiste = sindicatosMap.has(cessao.cedente);
                        break;
                }
                
                if (!cedenteExiste) {
                    erros.push(`Cess√£o ${i + 1}: Cedente "${cessao.cedente}" n√£o encontrado`);
                }
            });
        }

        //Calculos:
        async function calcular() {
            if (!ColetaCache.elementos) {
                ColetaCache.init();
            }

            if (!valoresPrincipais || valoresPrincipais.length === 0) {
                alert("‚ö†Ô∏è Voc√™ precisa adicionar pelo menos um Valor Principal antes de calcular!");
                return;
            }
            
            const dados = coletarDados();
            const erros = validarDados(dados);
            
            if (erros.length > 0) {
                alert("Erros encontrados:\n" + erros.join("\n"));
                return;
            }
            
            const resultados = await calcularValores(dados);
            exibirResultados(resultados, dados)
        }

        async function calcularItemPrincipal(item, dados) {
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);
            
            // Data base espec√≠fica do item
            const dataBase = criarDataBase(item.mesBase, item.anoBase);
            
            let indicesCNJ = 1;
            let dadosSelic = { indiceselic: 1 };
            let indiceipca = 1;
            let jurosmora = 0;
            
            if (item.indices.cnj) {
                indicesCNJ = obterIndiceCNJ(item.mesBase, item.anoBase);
            } 
            
            if (item.indices.selic) {
                const temSelicInformado = (item.tipoSelic === 'valor' && item.valorSelic > 0) || 
                (item.tipoSelic === 'percentual' && item.percentualSelic > 0);
                
                let dataInicioSelic = dataBase;

                if (temSelicInformado) {
                    dataInicioSelic = new Date(dataBase);
                    if (item.mesReferenciaSelic === 'mesAnterior') {
                        // SELIC informado √© do m√™s anterior, ent√£o come√ßar da pr√≥pria data base
                        dataInicioSelic = new Date(dataBase);
                    } else {
                        // SELIC informado √© do mesmo m√™s da data base, ent√£o come√ßar do m√™s seguinte
                        dataInicioSelic = new Date(dataBase);
                        dataInicioSelic.setMonth(dataInicioSelic.getMonth() + 1);
                    }
                }

                dadosSelic = await calcularSelic(dataInicioSelic, inicioGraca, fimGraca);

                let percentualSelicAdicional = 0;

                if (item.tipoSelic === 'valor' && item.valorSelic > 0) {
                    // Se informou valor em R$, calcular o percentual
                    const totalBase = item.valorPrincipal + item.valorJuros;
                    if (totalBase > 0) {
                        percentualSelicAdicional = item.valorSelic / totalBase;
                    }
                } else if (item.tipoSelic === 'percentual' && item.percentualSelic > 0) {
                    percentualSelicAdicional = item.percentualSelic;
                }
                
                if (percentualSelicAdicional > 0) {
                    const percentualSelicOriginal = dadosSelic.indiceselic - 1;
                    
                    const percentualSelicTotal = percentualSelicOriginal + percentualSelicAdicional;
                    
                    dadosSelic.indiceselic = 1 + percentualSelicTotal;
                }
            } 
            
            if (item.indices.ipca) {
                indiceipca = await calcularIpca(dataBase, inicioGraca, fimGraca);
            } 
            
            if (item.indices.jurosMora) {
                jurosmora = calcularSomaJurosMora(item.mesBase, item.anoBase, dados.natureza, inicioGraca, fimGraca) / 100;
            } 
            
            // C√°lculos dos √≠ndices compostos
            const indiceprinc = indicesCNJ * dadosSelic.indiceselic * indiceipca;
            const indicejur = dadosSelic.indiceselic * indiceipca;
            
            // C√°lculo de juros de mora
            const valorjurosmora = item.valorPrincipal * indicesCNJ * jurosmora;
            const jurosItem = valorjurosmora + (item.valorJuros * indicesCNJ);
            
            // Valores atualizados
            const valorPrincipalAtualizado = item.valorPrincipal * indiceprinc;
            const valorJurosAtualizado = jurosItem * indicejur;
            const valorTotalItem = valorPrincipalAtualizado + valorJurosAtualizado;
            
            const resultado = {
                id: item.id,
                descricao: item.descricao,
                valorOriginal: {
                    principal: item.valorPrincipal,
                    juros: item.valorJuros,
                    total: item.valorPrincipal + item.valorJuros
                },
                valorAtualizado: {
                    principal: valorPrincipalAtualizado,
                    juros: valorJurosAtualizado,
                    total: valorTotalItem
                },
                indices: {
                    cnj: indicesCNJ,
                    selic: dadosSelic.indiceselic,
                    ipca: indiceipca,
                    jurosMora: jurosmora,
                    indicePrincipal: indiceprinc,
                    indiceJuros: indicejur
                },
                tributacao: item.tributacao,
                jurosMoraCalculado: valorjurosmora
            };
            
            return resultado;
        }

        function totalizarTributacao(itensCalculados) {            
            const totais = {
                valorPrincipalTotal: 0,
                valorJurosTotal: 0,
                valorGeralTotal: 0,
                rraTotal: 0,
                
                // Tributa√ß√£o IR
                principalTributadoIR: 0,
                jurosTributadoIR: 0,
                isentoIR: 0,
                
                // Tributa√ß√£o Previd√™ncia
                principalTributadoPrevidencia: 0,
                jurosTributadoPrevidencia: 0,
                isentoPrevidencia: 0
            };
            
            for (const item of itensCalculados) {                
                // Totais gerais
                totais.valorPrincipalTotal += item.valorAtualizado.principal;
                totais.valorJurosTotal += item.valorAtualizado.juros;
                totais.valorGeralTotal += item.valorAtualizado.total;
                totais.rraTotal += item.tributacao.rra || 0;
                
                // Tributa√ß√£o IR
                if (item.tributacao.ir) {
                    totais.principalTributadoIR += item.valorAtualizado.principal;
                    totais.jurosTributadoIR += item.valorAtualizado.juros;
                } else {
                    totais.isentoIR += item.valorAtualizado.total;
                }
                
                // Tributa√ß√£o Previd√™ncia
                if (item.tributacao.previdencia) {
                    totais.principalTributadoPrevidencia += item.valorAtualizado.principal;
                    totais.jurosTributadoPrevidencia += item.valorAtualizado.juros;
                } else {
                    totais.isentoPrevidencia += item.valorAtualizado.total;
                }
            }
            
            return totais;
        }

        async function calcularPagamentos(dados) {
            if (!dados.pagamentos || dados.pagamentos.length === 0) {
                return [];
            }
            
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);
            
            const pagamentosCalculados = [];
            
            for (let i = 0; i < dados.pagamentos.length; i++) {
                const pagamento = dados.pagamentos[i];
                
                try {
                    if (pagamento.tipoInformacao === 'total') {                        
                        const componentes = await calcularComponentesPagamentoTotal(dados, pagamento);
                        
                        if (!componentes) {
                            console.error(`‚ùå Erro ao calcular componentes do pagamento ${i + 1}`);
                            continue;
                        }
                        
                        // Adicionar componentes ao pagamento
                        pagamento.valorPrincipal = componentes.valorPrincipal;
                        pagamento.valorJuros = componentes.valorJuros;
                        pagamento.tipoSelic = componentes.tipoSelic;
                        pagamento.percentualSelic = componentes.percentualSelic;
                        pagamento.valorSelic = componentes.valorSelic;
                        pagamento.selicReferencia = componentes.selicReferencia;
                        pagamento.percentualSelicOriginal = componentes.percentualSelicOriginal;
                    }
                    
                    const [ano, mes, dia] = pagamento.dataBase.split('-');
                    const anoBase = parseInt(ano);
                    const mesNumero = parseInt(mes);
                    const mesesNomes = ['', 'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 
                                    'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                    const mesBase = mesesNomes[mesNumero];

                    const dataBase = criarDataBase(mesBase, anoBase);
                    
                    let indicesCNJ = 1;
                    let dadosSelic = { indiceselic: 1 };
                    let indiceipca = 1;
                    let jurosmora = 0;
                    
                    // 1. CNJ sempre aplicar
                    indicesCNJ = obterIndiceCNJ(mesBase, anoBase);
                    
                    // 2. SELIC 
                    const temSelicInformado = (pagamento.tipoSelic === 'valor' && pagamento.valorSelic > 0) || 
                        (pagamento.tipoSelic === 'percentual' && pagamento.percentualSelic > 0);
                    
                    let dataInicioSelic = dataBase;
                    
                    if (temSelicInformado) {
                        dataInicioSelic = new Date(dataBase);
                        if (pagamento.selicReferencia === 'mesAnterior') {
                            // SELIC informado √© do m√™s anterior, ent√£o come√ßar da pr√≥pria data base
                            dataInicioSelic = new Date(dataBase);
                        } else {
                            // SELIC informado √© do mesmo m√™s da data base, ent√£o come√ßar do m√™s seguinte
                            dataInicioSelic = new Date(dataBase);
                            dataInicioSelic.setMonth(dataInicioSelic.getMonth() + 1);
                        }
                    }
                    
                    dadosSelic = await calcularSelic(dataInicioSelic, inicioGraca, fimGraca);
                    
                    let percentualSelicAdicional = 0;
                    
                    if (pagamento.tipoSelic === 'valor' && pagamento.valorSelic > 0) {
                        // Se informou valor em R$, calcular o percentual
                        const totalBase = pagamento.valorPrincipal + pagamento.valorJuros;
                        if (totalBase > 0) {
                            percentualSelicAdicional = pagamento.valorSelic / totalBase;
                        }
                    } else if (pagamento.tipoSelic === 'percentual' && pagamento.percentualSelic > 0) {
                        percentualSelicAdicional = pagamento.percentualSelic;
                    }
                    
                    if (percentualSelicAdicional > 0) {
                        const percentualSelicOriginal = dadosSelic.indiceselic - 1;
                        const percentualSelicTotal = percentualSelicOriginal + percentualSelicAdicional;
                        dadosSelic.indiceselic = 1 + percentualSelicTotal;
                    }
                    
                    // 3. IPCA sempre aplicar
                    indiceipca = await calcularIpca(dataBase, inicioGraca, fimGraca);
                    
                    // 4. Juros de mora sempre aplicar
                    jurosmora = calcularSomaJurosMora(mesBase, anoBase, dados.natureza, inicioGraca, fimGraca) / 100;
                    
                    // C√°lculos dos √≠ndices compostos
                    const indiceprinc = indicesCNJ * dadosSelic.indiceselic * indiceipca;
                    const indicejur = dadosSelic.indiceselic * indiceipca;
                    
                    // C√°lculo de juros de mora
                    const valorjurosmora = pagamento.valorPrincipal * indicesCNJ * jurosmora;
                    const jurosItem = valorjurosmora + (pagamento.valorJuros * indicesCNJ);
                    
                    // Valores atualizados
                    const valorPrincipalAtualizado = pagamento.valorPrincipal * indiceprinc;
                    const valorJurosAtualizado = jurosItem * indicejur;
                    const valorTotalItem = valorPrincipalAtualizado + valorJurosAtualizado;
                    
                    const resultado = {
                        beneficiario: pagamento.beneficiario,
                        dataBase: pagamento.dataBase,
                        valorOriginal: {
                            principal: pagamento.valorPrincipal,
                            juros: pagamento.valorJuros,
                            total: pagamento.valorPrincipal + pagamento.valorJuros
                        },
                        valorAtualizado: {
                            principal: valorPrincipalAtualizado,
                            juros: valorJurosAtualizado,
                            total: valorTotalItem
                        },
                        indices: {
                            cnj: indicesCNJ,
                            selic: dadosSelic.indiceselic,
                            ipca: indiceipca,
                            jurosMora: jurosmora,
                            indicePrincipal: indiceprinc,
                            indiceJuros: indicejur
                        },
                        jurosMoraCalculado: valorjurosmora,
                        selicReferencia: pagamento.selicReferencia,
                        tipoSelic: pagamento.tipoSelic
                    };
                    
                    pagamentosCalculados.push(resultado);
                    
                } catch (error) {
                    console.error(`Erro ao calcular pagamento ${i + 1}:`, error);
                }
            }
            
            return pagamentosCalculados;
        }

        async function calcularComponentesPagamentoTotal(dados, pagamento) {           
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);
            
            // Salvar a data atual do campo
            const dataOriginal = document.getElementById("dataatualizacao").value;
            
            try {
                // TEMPORARIAMENTE alterar a data para a data do pagamento
                document.getElementById("dataatualizacao").value = pagamento.dataBase;
                
                // Calcular cada item at√© a data do pagamento
                let valorPrincipalAtualizado = 0;
                let valorJurosAtualizado = 0;
                let percentualSelicAcumulado = 0;
                
                for (const item of dados.valoresPrincipais) {
                    const itemCalculado = await calcularItemPrincipal(item, dados);
                    valorPrincipalAtualizado += itemCalculado.valorAtualizado.principal;
                    valorJurosAtualizado += itemCalculado.valorAtualizado.juros;
                    
                    // Pegar o percentual de SELIC do item
                    if (item.indices.selic && itemCalculado.indices.selic) {
                        percentualSelicAcumulado = itemCalculado.indices.selic - 1;
                    }
                }
                
                const totalAtualizado = valorPrincipalAtualizado + valorJurosAtualizado;
                
                // Calcular propor√ß√£o do pagamento sobre o total atualizado
                const proporcao = pagamento.valorTotal / totalAtualizado;
                
                // Aplicar propor√ß√£o para descobrir quanto foi pago de cada
                const principalPago = valorPrincipalAtualizado * proporcao;
                const jurosPago = valorJurosAtualizado * proporcao;
                
                // Remover a SELIC desses valores pagos
                const indiceSelic = 1 + percentualSelicAcumulado;
                const principalSemSelic = principalPago / indiceSelic;
                const jurosSemSelic = jurosPago / indiceSelic;
                const selicPaga = (principalPago - principalSemSelic) + (jurosPago - jurosSemSelic);
                
                return {
                    valorPrincipal: principalSemSelic,
                    valorJuros: jurosSemSelic,
                    percentualSelicOriginal: percentualSelicAcumulado,
                    tipoSelic: 'percentual',
                    percentualSelic: percentualSelicAcumulado,
                    valorSelic: 0,
                    selicReferencia: 'mesAnterior'
                };
                
            } finally {
                // RESTAURAR a data original do campo
                document.getElementById("dataatualizacao").value = dataOriginal;
            }
        }

        async function calcularValores(dados) {
            if (!dados.valoresPrincipais || dados.valoresPrincipais.length === 0) {
                console.error('‚ùå Erro: Nenhum valor principal encontrado!');
                return null;
            }

            let valoresParaProcessar = dados.valoresPrincipais;
            
            const itensCalculados = [];
            
            //total
            for (let i = 0; i < valoresParaProcessar.length; i++) {
                const item =valoresParaProcessar[i];
                
                try {
                    const itemCalculado = await calcularItemPrincipal(item, dados);
                    itensCalculados.push(itemCalculado);
                } catch (error) {
                    console.error(`‚ùå Erro ao calcular item ${item.descricao}:`, error);
                    throw error;
                }
            }
            
            const totais = totalizarTributacao(itensCalculados);

            const totaisPorTipo = {
                contratual: 0,
                sucumbencial: 0,
                nenhum: 0,
                total: totais.valorGeralTotal
            };

            // Mapear itens calculados com itens originais
            valoresParaProcessar.forEach((itemOriginal, index) => {
                const itemCalculado = itensCalculados[index];
                if (itemCalculado) {
                    const valorAtualizado = itemCalculado.valorAtualizado.total;
                    
                    if (itemOriginal.tipoUsoHonorario === 'contratual') {
                        totaisPorTipo.contratual += valorAtualizado;
                    } else if (itemOriginal.tipoUsoHonorario === 'sucumbencial') {
                        totaisPorTipo.sucumbencial += valorAtualizado;
                    } else if (itemOriginal.tipoUsoHonorario === 'ambos') {
                        totaisPorTipo.contratual += valorAtualizado;
                        totaisPorTipo.sucumbencial += valorAtualizado;
                    } else if (itemOriginal.tipoUsoHonorario === 'nenhum') {
                        totaisPorTipo.nenhum += valorAtualizado;
                    }
                }
            });
            
            const percentualprinc = totais.valorPrincipalTotal / totais.valorGeralTotal;
            const percentualjur = totais.valorJurosTotal / totais.valorGeralTotal;
            
            const valorOriginalTotal = itensCalculados.reduce((sum, item) => 
                sum + item.valorOriginal.total, 0);
            const indiceTotal = totais.valorGeralTotal / valorOriginalTotal;
            
            const percentualPrincipalTributadoIR = (totais.principalTributadoIR / totais.valorGeralTotal) * 100;
            const percentualJurosTributadoIR = (totais.jurosTributadoIR / totais.valorGeralTotal) * 100;
            const percentualIsentoIR = (totais.isentoIR / totais.valorGeralTotal) * 100;
            
            const dadosParaDetalhamento = {
                ...dados,
                valorPrincipal: totais.valorPrincipalTotal,
                valorJuros: totais.valorJurosTotal,
                rra: totais.rraTotal,

                incidenciaIR: dados.valoresPrincipais.some(item => item.tributacao?.ir === true),
                incidenciaPrevidencia: dados.valoresPrincipais.some(item => item.tributacao?.previdencia === true),

                tributacaoIR: {
                    principalTributado: totais.principalTributadoIR,
                    jurosTributado: totais.jurosTributadoIR,
                    isento: totais.isentoIR,
                    percentuais: {
                        principalTributado: percentualPrincipalTributadoIR,
                        jurosTributado: percentualJurosTributadoIR,
                        isento: percentualIsentoIR
                    }
                },
                tributacaoPrevidencia: {
                    principalTributado: totais.principalTributadoPrevidencia,
                    jurosTributado: totais.jurosTributadoPrevidencia,
                    isento: totais.isentoPrevidencia
                },
                totaisPorTipo
            };
            
            const detalhamento = calcularGlobal(dadosParaDetalhamento, totais.valorGeralTotal, percentualprinc, percentualjur,totaisPorTipo);
            
            const honorariosSucumbenciais = calcularHonorariosSucumbenciais(dadosParaDetalhamento, totais.valorGeralTotal, totaisPorTipo);

            const herdeiros = calcularHerdeiros(dadosParaDetalhamento, totais.valorGeralTotal, totais.valorPrincipalTotal, totais.valorJurosTotal, detalhamento,totaisPorTipo);

            const pagamentosCalculados = await calcularPagamentos(dados);

            const totalPagamentos = pagamentosCalculados.reduce((total, pag) => 
                total + pag.valorAtualizado.total, 0
            );
            
            const resultadoFinal = {
                valorprincatt: totais.valorPrincipalTotal,
                valorjurosatt: totais.valorJurosTotal,
                valortotatt: totais.valorGeralTotal,
                
                tributacaoIR: {
                    principalTributado: totais.principalTributadoIR,
                    jurosTributado: totais.jurosTributadoIR,
                    isento: totais.isentoIR,
                    percentuais: {
                        principalTributado: percentualPrincipalTributadoIR,
                        jurosTributado: percentualJurosTributadoIR,
                        isento: percentualIsentoIR
                    }
                },
                
                tributacaoPrevidencia: {
                    principalTributado: totais.principalTributadoPrevidencia,
                    jurosTributado: totais.jurosTributadoPrevidencia,
                    isento: totais.isentoPrevidencia
                },
                
                rraTotal: totais.rraTotal,
                
                itensCalculados,
                
                ...detalhamento,
                
                herdeiros,
                temHerdeiros: herdeiros.length > 0,

                honorariosSucumbenciais,

                pagamentos: pagamentosCalculados,
                totalPagamentos: totalPagamentos,
                
                indiceTotal,
                percentualprinc,
                percentualjur,
                
                valorOriginalTotal,

                totaisPorTipo
            };
            
            const saldosFinais = calcularSaldoFinalComPagamentos(resultadoFinal, pagamentosCalculados, dados);
            resultadoFinal.saldosFinais = saldosFinais;

            return resultadoFinal;
        }

        function calcularGlobal(dados, valortotatt, percentualprinc, percentualjur,totaisPorTipo = null) {
            let valorBase = valortotatt;

            if (dados.tipoCalculo === 'preferencia' && dados.natureza === 'alimentar') {
                valorBase = Math.min(valortotatt, dados.tetoPreferencia);
            } else if (dados.tipoCalculo === 'parcial') {
                if (dados.honorarioSucumbencial && dados.honorarioSucumbencial.advogados && dados.honorarioSucumbencial.advogados.length > 0) {
                    const dadosTemporarios = {...dados, tipoCalculo: 'ordem'};
                    const resultadoSucumbencial = calcularHonorariosSucumbenciais(dadosTemporarios, valortotatt,totaisPorTipo);
                    const valorTotalSucumbencial = resultadoSucumbencial.valorHonorarioTotal;
                    const totalGeral = valortotatt + valorTotalSucumbencial;
                    const proporcaoPrecatorio = valortotatt / totalGeral;
                    valorBase = dados.saldoParcial * proporcaoPrecatorio;
                } else {
                    // Sem sucumbencial - l√≥gica original
                    valorBase = Math.min(valortotatt, dados.saldoParcial);
                }
            }

            let principal, jurosBase;
            
            if (dados.tributacaoIR && dados.tributacaoPrevidencia) {
                const percentualPrincipalTributadoIR = dados.tributacaoIR.percentuais?.principalTributado || 0;
                const percentualJurosTributadoIR = dados.tributacaoIR.percentuais?.jurosTributado || 0;
                
                principal = valorBase * (percentualPrincipalTributadoIR / 100);
                jurosBase = valorBase * (percentualJurosTributadoIR / 100);
            } else {
                principal = valorBase * percentualprinc;
                jurosBase = valorBase * percentualjur;
            }

            let rrapagamento = dados.rra !== 0 ? arredondarRRA((valorBase * dados.rra) / valortotatt) : 0;
            
            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const isParcial = dados.tipoCalculo === 'parcial';

            // CESS√ïES DO BENEFICI√ÅRIO PRINCIPAL PARA BASE H.
            const cessoesBeneficiario = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaobenPrincipal'
            ) || [];

            let valorBaseParaHonorarios = valorBase;
            let valorBeneficiarioQueRecebeEfetivamente = valorBase;

            if (cessoesBeneficiario.length > 0) {
                const percentualBeneficiarioFinal = 1.0 - cessoesBeneficiario.reduce((total, cessao) => total + cessao.percentual, 0);
                
                const direitoBeneficiarioTotal = valortotatt * percentualBeneficiarioFinal;
                
                valorBeneficiarioQueRecebeEfetivamente = isPreferenciasParcial ? 
                    Math.min(direitoBeneficiarioTotal, valorBase) : direitoBeneficiarioTotal;

                if (isPreferenciasParcial) {
                    valorBaseParaHonorarios = valorBeneficiarioQueRecebeEfetivamente;
                }else if (isParcial) {
                    valorBaseParaHonorarios = valorBase; 
                }else {
                    valorBaseParaHonorarios = valorBase;
                }
            }

            // Honor√°rios
            const resultadoHonorarios = calcularHonorarios(dados, valorBaseParaHonorarios, valortotatt,dados.totaisPorTipo);
            const { honorarios, valorHonorarioTotal } = resultadoHonorarios;
            
            // Sindicatos 
            const resultadoSindicatos = calcularSindicatos(dados, valorBaseParaHonorarios, valortotatt);
            const { sindicatos, valorSindicatoTotal } = resultadoSindicatos;

            const valorSindicatoParaDescontar = isPreferencia ? 0 : valorSindicatoTotal;

            const valorBeneficiarioBruto = valorBase - valorHonorarioTotal - valorSindicatoParaDescontar;

            // REC√ÅLCULO PARA PREFER√äNCIA E PARCIAL 
            if (isPreferenciasParcial) {
                if (dados.tributacaoIR) {
                    const percentualPrincipalTributadoIR = dados.tributacaoIR.percentuais?.principalTributado || 0;
                    principal = valorBeneficiarioQueRecebeEfetivamente * (percentualPrincipalTributadoIR / 100);
                } else {
                    principal = valorBeneficiarioQueRecebeEfetivamente * percentualprinc;
                }
                
                if (dados.rra !== 0) {
                    const rraCalculado = arredondarRRA((valorBeneficiarioQueRecebeEfetivamente * dados.rra) / valortotatt);
                    rrapagamento = Math.max(1, rraCalculado); 
                } else {
                    rrapagamento = 0;
                }
            } else if (isParcial) {
                if (dados.tributacaoIR) {
                    const principalTributadoTotal = dados.tributacaoIR.principalTributado;
                    const proporcaoParcial = valorBase / valortotatt;
                    principal = principalTributadoTotal * proporcaoParcial;
                    
                    const jurosTributadoTotal = dados.tributacaoIR.jurosTributado;
                    jurosBase = jurosTributadoTotal * proporcaoParcial;
                } else {
                    principal = valorBase * percentualprinc;
                    jurosBase = valorBase * percentualjur;
                }
                
                if (dados.rra !== 0) {
                    const proporcaoParcial = valorBase / valortotatt;
                    rrapagamento = dados.rra !== 0 ? arredondarRRA((valorBase * dados.rra) / valortotatt) : 0;
                } else {
                    rrapagamento = 0;
                }
            }

            // PREVID√äNCIA      
            const resultadoPrevidencia = calcularPrevidenciaIsolada(dados, principal, rrapagamento);
            let {
                valorPrevidencia,
                aliquotaEfetiva,
                valorDesagioPrevidencia,
                percentualDesagioPrevidencia
            } = resultadoPrevidencia;

            //Imposto de Renda
            const resultadoIR = calcularIRIsolado(dados, valortotatt, valorBase, principal, valorPrevidencia, rrapagamento);
            let {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                principalComDesagio,
                percentualDesagioIR,
                rraComDesagio,
                baseIRPrev,
                baseIRRRA,
                valorIRUnitario,
            } = resultadoIR;

            // Cess√µes
            const resultadoCessoes = calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR);
            let {
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            } = resultadoCessoes;

            return {
                valorBase,
                principal,
                jurosBase,
                rrapagamento,

                honorarios,
                valorHonorarioTotal,

                sindicatos,
                valorSindicatoTotal,

                valorPrevidencia,
                aliquotaEfetiva,
                valorDesagioPrevidencia,   
                percentualDesagioPrevidencia,

                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                principalComDesagio,
                percentualDesagioIR,
                rraComDesagio,
                baseIRRRA,
                valorIRUnitario,
                
                valorBeneficiarioBruto: resultadoCessoes.valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioCalculadas,
                cessoesBeneficiarioFinais,
                isPreferenciasParcial
            };
        }

        function calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR) {
            const valorBeneficiarioBruto = valorBase - valorHonorarioTotal - valorSindicatoParaDescontar;

            const cessoesBeneficiario = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaobenPrincipal'
            ) || [];

            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            const isParcial = dados.tipoCalculo === 'parcial';
            
            let valorCessoesBeneficiario = 0;
            let cessoesBeneficiarioCalculadas = [];
            let percentualBeneficiarioFinal = 1.0;
            let valorBeneficiarioAposCessoes = valorBeneficiarioBruto;
            let valorPrevidenciaBeneficiario = valorPrevidencia;
            let valorIRBeneficiario = valorIR;
            let valorBeneficiarioFinal = valorBeneficiarioBruto - valorPrevidencia - valorIR;
            let cessoesBeneficiarioFinais = [];

            if (cessoesBeneficiario.length === 0) {
                return {
                    valorBeneficiarioBruto,
                    valorCessoesBeneficiario,
                    cessoesBeneficiarioCalculadas,
                    percentualBeneficiarioFinal,
                    valorBeneficiarioAposCessoes,
                    valorPrevidenciaBeneficiario,
                    valorIRBeneficiario,
                    valorBeneficiarioFinal,
                    cessoesBeneficiarioFinais
                };
            }

            const totalPercentualCessoes = cessoesBeneficiario.reduce((total, cessao) => total + cessao.percentual, 0);
            percentualBeneficiarioFinal = 1.0 - totalPercentualCessoes;
            
            const percentualAdvogados = dados.advogados.length > 0 ? 
                dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0) : 0;
            const valortotattSemAdvogados = valortotatt - (valortotatt * percentualAdvogados);

            const deveReceberAgora = !isPreferenciasParcial;
            const valorPrevidenciaBase = deveReceberAgora ? valorPrevidencia : 0;
            const valorIRBase = deveReceberAgora ? valorIR : 0;

            cessoesBeneficiarioCalculadas = [];
            cessoesBeneficiarioFinais = [];

            for (const cessao of cessoesBeneficiario) {
                // Valor bruto da cess√£o
                const valorBrutoCessao = deveReceberAgora ? (valorBeneficiarioBruto * cessao.percentual) : 0;
                valorCessoesBeneficiario += valorBrutoCessao;
                
                const cessaoCalculada = {
                    tipo: cessao.tipo,
                    cedente: cessao.cedente,
                    cessionario: cessao.cessionario,
                    percentual: cessao.percentual,
                    valorBruto: valorBrutoCessao,
                    ...(isPreferenciasParcial && {
                        valorSaldoDevedor: valortotattSemAdvogados * cessao.percentual,
                        observacao: 'Aguarda pagamento - sem direito √† prefer√™ncia'
                    })
                };
                
                const previdenciaCessao = valorPrevidenciaBase * cessao.percentual;
                const irCessao = valorIRBase * cessao.percentual;
                const valorLiquidoCessao = valorBrutoCessao - previdenciaCessao - irCessao;
                
                const cessaoFinal = {
                    ...cessaoCalculada,
                    previdenciaCessao,
                    irCessao,
                    valorLiquido: valorLiquidoCessao
                };
                
                cessoesBeneficiarioCalculadas.push(cessaoCalculada);
                cessoesBeneficiarioFinais.push(cessaoFinal);
            }

            if (isPreferenciasParcial) {
                // PREFER√äNCIA PARCIAL: benefici√°rio limitado pelo teto
                const parteBeneficiarioNaDividaTotal = valortotattSemAdvogados * percentualBeneficiarioFinal;
                valorBeneficiarioAposCessoes = Math.min(parteBeneficiarioNaDividaTotal, valorBeneficiarioBruto);
                valorPrevidenciaBeneficiario = valorPrevidencia;
                valorIRBeneficiario = valorIR;
            } else {
                valorBeneficiarioAposCessoes = valorBeneficiarioBruto * percentualBeneficiarioFinal;
                valorPrevidenciaBeneficiario = valorPrevidencia * percentualBeneficiarioFinal;
                valorIRBeneficiario = valorIR * percentualBeneficiarioFinal;
            }

            valorBeneficiarioFinal = valorBeneficiarioAposCessoes - valorPrevidenciaBeneficiario - valorIRBeneficiario;

            return {
                valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            };
        }

        function calcularHonorarios(dados, valorBase, valortotatt, totaisPorTipo = null) {
            let valorHonorarioTotal = 0;
            const isAcordo = dados.tipoCalculo === 'acordo';
            const isParcial = dados.tipoCalculo === 'parcial';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let valorBaseContratual = valorBase;
            
            if (totaisPorTipo && totaisPorTipo.contratual > 0) {
                const proporcaoContratual = totaisPorTipo.contratual / totaisPorTipo.total;
                valorBaseContratual = valorBase * proporcaoContratual;
            } else {
                return { honorarios: [], valorHonorarioTotal: 0 };
            }
            
            const honorarios = dados.advogados.map(adv => {
                const percentualTotalAdvogado = adv.percentual;
                const valorBrutoTotal = valorBaseContratual * percentualTotalAdvogado;
                
                const cessaoAdv = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoAdv' && cessao.cedente === adv.nome
                );
                
                let percentualCessionarioAdv = cessaoAdv.reduce((total, cessao) => total + cessao.percentual, 0);
                let valorBrutoAdvogado, valorBrutoCessionario, percentualAdvogado;

                if (percentualCessionarioAdv >= 1.0) {
                    // Cess√£o de 100%: Calcular sobre o honor√°rio do advogado
                    valorBrutoAdvogado = 0;
                    valorBrutoCessionario = valorBrutoTotal; // Todo o honor√°rio vai para cession√°rio
                } else {
                    // Cess√£o parcial: Calcular sobre o precat√≥rio (l√≥gica original)
                    percentualAdvogado = Math.max(0, percentualTotalAdvogado - percentualCessionarioAdv);
                    valorBrutoAdvogado = valorBaseContratual * Math.max(0, percentualAdvogado);
                    valorBrutoCessionario = valorBaseContratual * percentualCessionarioAdv;
                }

                let valorParaIRAdvogado = valorBrutoAdvogado;
                let valorParaIRCessionario = valorBrutoCessionario;
                
                if (isAcordo) {
                    valorParaIRAdvogado = valorBrutoAdvogado * (1 - percentualDesagio);
                    valorParaIRCessionario = valorBrutoCessionario * (1 - percentualDesagio);
                }

                const calcularIRPessoa = (valor) => {
                    if (!adv.incidenciaIR || valor <= 0) return 0; 
                    return adv.tipo === 'PF' ? calcularIR(valor) : valor * 0.015;
                };

                let irAdvogado = calcularIRPessoa(valorParaIRAdvogado);

                let irCessionarioAdv = calcularIRPessoa(valorParaIRCessionario);

                const valorLiquidoAdvogado = valorBrutoAdvogado - irAdvogado;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioAdv;

                const cessionarios = cessaoAdv.map(cessao => {
                    let valorBrutoCessao;
                    if (percentualCessionarioAdv >= 1.0) {
                        valorBrutoCessao = valorBrutoTotal * cessao.percentual;
                    } else {
                        valorBrutoCessao = valorBaseContratual * cessao.percentual;
                    }

                    let valorParaIRCessao = valorBrutoCessao;
                    
                    if (isAcordo) {
                        valorParaIRCessao = valorBrutoCessao * (1 - percentualDesagio);
                    }
                    
                    const irCessao = adv.incidenciaIR ? 
                    (adv.tipo === 'PF' ? calcularIR(valorParaIRCessao) : valorParaIRCessao * 0.015) : 0;
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });

                const valorBruto = valorBrutoTotal;
                const ir = irAdvogado + irCessionarioAdv;
                const valorLiquido = valorLiquidoAdvogado + valorLiquidoCessionario;

                const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
                
                valorHonorarioTotal += valorBrutoTotal;

                return {
                    ...adv,
                    valorBruto,
                    ir,
                    valorLiquido,
                    // Dados do advogado
                    percentualAdvogado,
                    valorBrutoAdvogado,
                    irAdvogado,
                    valorLiquidoAdvogado,
                    // Dados totais dos cession√°rios
                    percentualCessionarioAdv,
                    valorBrutoCessionario,
                    irCessionarioAdv,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesAdv: cessaoAdv,
                };
            });

            return { honorarios, valorHonorarioTotal };
        }

        function calcularHonorariosSucumbenciais(dados, valorTotalDivida,totaisPorTipo = null) {
            if (!dados.honorarioSucumbencial || !dados.honorarioSucumbencial.advogados || dados.honorarioSucumbencial.advogados.length === 0) {
                return { 
                    honorarios: [], 
                    valorHonorarioTotal: 0,
                    valorBaseSucumbencial: 0,
                    temHonorariosSucumbenciais: false
                };
            }
            
            let valorBaseSucumbencial = 0;
            if (totaisPorTipo && totaisPorTipo.sucumbencial > 0) {
                valorBaseSucumbencial = totaisPorTipo.sucumbencial;
            }
            
            if (valorBaseSucumbencial <= 0) {
                return { 
                    honorarios: [], 
                    valorHonorarioTotal: 0,
                    valorBaseSucumbencial: 0,
                    temHonorariosSucumbenciais: false
                };
            }

            const percentualTotalSucumbencial = dados.honorarioSucumbencial.advogados.reduce((total, adv) => {
                if (adv.tipoHonorario === 'percentual') {
                    return total + adv.percentual;
                }
                return total;
            }, 0);

            if (dados.tipoCalculo === 'parcial') {
                if (dados.somenteHonorarioSucumbencial) {
                    const valorTotalSucumbencial = valorBaseSucumbencial * percentualTotalSucumbencial;
                    
                    if (dados.saldoParcial >= valorTotalSucumbencial) {
                        // N√£o ajusta - paga o valor total da sucumbencial
                    } else {
                        const fatorAjuste = dados.saldoParcial / valorTotalSucumbencial;
                        valorBaseSucumbencial = valorBaseSucumbencial * fatorAjuste;
                    }
                } else {
                    // L√≥gica para quando tem outras verbas al√©m da sucumbencial
                    const valorTotalSucumbencial = valorBaseSucumbencial * percentualTotalSucumbencial;

                    const valoresFiltrados = dados.valoresPrincipais?.filter(item => 
                        item.tipoUsoHonorario === 'sucumbencial' || item.tipoUsoHonorario === 'ambos'
                    ) || [];
                    
                    const valorOriginalSucumbencial = valoresFiltrados.reduce((sum, v) => 
                        sum + v.valorPrincipal + v.valorJuros, 0
                    );
                    
                    const valorOriginalTotal = dados.valoresPrincipais.reduce((sum, v) => 
                        sum + v.valorPrincipal + v.valorJuros, 0
                    );
                    
                    const proporcaoVerbaSucumbencial = valorOriginalSucumbencial / valorOriginalTotal;
                    const valorPrecatorioComSucumbencial = valorTotalDivida * proporcaoVerbaSucumbencial;
                    
                    const totalGeral = valorPrecatorioComSucumbencial + valorTotalSucumbencial;
                    const proporcaoSucumbencial = valorTotalSucumbencial / totalGeral;
                    const valorParcialSucumbencial = dados.saldoParcial * proporcaoSucumbencial;
                    
                    const fatorAjuste = valorParcialSucumbencial / valorTotalSucumbencial;
                    valorBaseSucumbencial = valorBaseSucumbencial * fatorAjuste;
                }
            }

            const sucumbencial = dados.honorarioSucumbencial;
            const isAcordo = dados.tipoCalculo === 'acordo';
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const tetoPreferencia = dados.tetoPreferencia || 0;
            const percentualDesagio = dados.percentualAcordo || 0;
            let valorHonorarioTotal = 0;
            
            const honorarios = sucumbencial.advogados.map((adv, index) => {
                // 1. HONOR√ÅRIO BRUTO
                let valorBrutoTotal = 0;
                if (adv.tipoHonorario === 'percentual') {
                    valorBrutoTotal = valorBaseSucumbencial * adv.percentual;
                } else if (adv.tipoHonorario === 'valorPrincipal') {
                    valorBrutoTotal = valorBaseSucumbencial;
                }
                
                // 2. CESS√ïES 
                const cessaoAdv = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoAdvSuc' && cessao.cedente === adv.nome
                ) || [];
                
                let percentualCessionarioAdv = cessaoAdv.reduce((total, cessao) => total + cessao.percentual, 0);
                const percentualAdvogado = Math.max(0, 1 - percentualCessionarioAdv);
                
                const valorAdvogadoAposCessoes = valorBrutoTotal * percentualAdvogado;
                const valorCessionariosTotal = valorBrutoTotal * percentualCessionarioAdv;
                
                // 3. PREFER√äNCIA 
                let valorFinalAdvogado = valorAdvogadoAposCessoes;
                let valorFinalCessionarios = valorCessionariosTotal;
                let valorFinalHonorario = valorBrutoTotal;
                
                if (isPreferencia && adv.preferencia) {
                    const honorarioCompletoNecessario = valorAdvogadoAposCessoes + valorCessionariosTotal;
                    
                    if (tetoPreferencia >= honorarioCompletoNecessario) {
                        valorFinalAdvogado = valorAdvogadoAposCessoes;
                        valorFinalCessionarios = valorCessionariosTotal;
                    } else {
                        // PREFER√äNCIA PARCIAL: s√≥ o advogado recebe (limitado ao teto)
                        valorFinalAdvogado = Math.min(valorAdvogadoAposCessoes, tetoPreferencia);
                        valorFinalCessionarios = 0; 
                    }
                    valorFinalHonorario = valorFinalAdvogado + valorFinalCessionarios;
                } else {
                    valorFinalHonorario = valorFinalAdvogado + valorFinalCessionarios;
                }
                
                let valorAdvogadoAposDesagio = valorFinalAdvogado;
                let valorCessionariosAposDesagio = valorFinalCessionarios;
                
                // 4. ACORDO
                if (isAcordo) {
                    valorAdvogadoAposDesagio = valorFinalAdvogado * (1 - percentualDesagio);
                    valorCessionariosAposDesagio = valorFinalCessionarios * (1 - percentualDesagio);
                }

                const calcularIRPessoa = (valor) => {
                    if (!adv.incidenciaIR || valor <= 0) return 0;
                    return adv.tipo === 'PF' ? calcularIR(valor) : valor * 0.015;
                };
                
                let irAdvogado = calcularIRPessoa(valorAdvogadoAposDesagio);
                
                let irCessionarioAdv = calcularIRPessoa(valorCessionariosAposDesagio);
                
                const cessionarios = cessaoAdv.map(cessao => {
                    const valorBrutoCessao = valorFinalHonorario * cessao.percentual;
                    
                    const valorAposDesagio = isAcordo ? 
                        valorBrutoCessao * (1 - percentualDesagio) : valorBrutoCessao;
                    
                    const irCessao = adv.incidenciaIR ? 
                        (adv.tipo === 'PF' ? calcularIR(valorAposDesagio) : valorAposDesagio * 0.015) : 0;
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        valorAposDesagio: valorAposDesagio,
                        ir: irCessao,
                        valorLiquido: valorAposDesagio - irCessao
                    };
                });
                
                const valorLiquidoAdvogado = valorAdvogadoAposDesagio - irAdvogado;
                const valorLiquidoCessionario = valorCessionariosAposDesagio - irCessionarioAdv;
                
                valorHonorarioTotal += valorFinalHonorario;
                
                return {
                    ...adv,
                    valorBruto: valorFinalHonorario,
                    ir: irAdvogado + irCessionarioAdv,
                    valorLiquido: valorLiquidoAdvogado + valorLiquidoCessionario,
                    // Dados do advogado
                    percentualAdvogado,
                    valorBrutoAdvogado: valorFinalAdvogado,
                    valorAdvogadoAposDesagio,
                    irAdvogado,
                    valorLiquidoAdvogado,
                    // Dados dos cession√°rios
                    percentualCessionarioAdv,
                    valorBrutoCessionario: valorFinalCessionarios,
                    valorCessionarioAposDesagio: valorCessionariosAposDesagio,
                    irCessionarioAdv,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesAdv: cessaoAdv,
                    temPreferencia: isPreferencia && adv.preferencia,
                    foiLimitadoPorPreferencia: isPreferencia && adv.preferencia && (tetoPreferencia < (valorAdvogadoAposCessoes + valorCessionariosTotal)),
                    temCessoes: cessaoAdv.length > 0
                };
            });
            
            return { 
                honorarios, 
                valorHonorarioTotal,
                valorBaseSucumbencial,
                temHonorariosSucumbenciais: true
            };
        }

        function calcularSindicatos(dados, valorBase, valortotatt) {
            let valorSindicatoTotal = 0;
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const isParcial = dados.tipoCalculo === 'parcial';

            const calcularIRSindicato = (valor, tributacao, aliquotaPersonalizada = 0) => {
                if (tributacao === 'nao') return 0;
                if (tributacao === 'lei') return valor * 0.03;
                if (tributacao === 'fixa') return valor * aliquotaPersonalizada;
                return 0;
            };
            
            const sindicatos = dados.sindicatos.map(sind => {
                const percentualTotalSindicato = sind.percentual;
                
                const valorBaseCalculo = isParcial ? valorBase : valortotatt;
                const valorBrutoTotal = valorBaseCalculo * percentualTotalSindicato;
                
                const cessaoSind = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoSindicato' && cessao.cedente === sind.nome
                ) || [];
                
                let percentualCessionarioSind = cessaoSind.reduce((total, cessao) => total + cessao.percentual, 0);
                const percentualSindicato = Math.max(0, percentualTotalSindicato - percentualCessionarioSind);

                const valorBrutoSindicato = valorBrutoTotal * percentualSindicato; 
                const valorBrutoCessionario = valorBrutoTotal * percentualCessionarioSind; 

                let valorParaIRSindicato = isAcordo ? valorBrutoSindicato * (1 - percentualDesagio) : valorBrutoSindicato;
                let valorParaIRCessionario = isAcordo ? valorBrutoCessionario * (1 - percentualDesagio) : valorBrutoCessionario;
                
                let irSindicato = calcularIRSindicato(valorParaIRSindicato, sind.tributacao, sind.aliquotaTributacao);
                let irCessionarioSind = calcularIRSindicato(valorParaIRCessionario, sind.tributacao, sind.aliquotaTributacao);
                
                const valorLiquidoSindicato = valorBrutoSindicato - irSindicato;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioSind;

                const cessionarios = cessaoSind.map(cessao => {
                    const valorBrutoCessao = valorBrutoTotal * cessao.percentual; 
                    let valorParaIRCessao = isAcordo ? valorBrutoCessao * (1 - percentualDesagio) : valorBrutoCessao;
                    
                    let irCessao = calcularIRSindicato(valorParaIRCessao, sind.tributacao, sind.aliquotaTributacao);
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });

                if (!isPreferencia) {
                    valorSindicatoTotal += valorBrutoTotal;
                }

                return {
                    ...sind,
                    valorBruto: valorBrutoTotal,
                    ir: irSindicato + irCessionarioSind,
                    valorLiquido: valorLiquidoSindicato + valorLiquidoCessionario,
                    
                    // Dados do sindicato
                    percentualSindicato,
                    valorBrutoSindicato,
                    irSindicato,
                    valorLiquidoSindicato,
                    
                    // Dados totais dos cession√°rios
                    percentualCessionarioSind,
                    valorBrutoCessionario,
                    irCessionarioSind,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesSind: cessaoSind,
                    
                    // Flag de controle
                    podeReceber: !isPreferencia
                };
            });

            return { 
                sindicatos, 
                valorSindicatoTotal
            };
        }

        //Herdeiros
        function calcularTotaisParaHerdeiros(dados, valortotatt, percentualprinc, percentualjur,totaisPorTipo = null) {
            const dadosOrdem = { ...dados, tipoCalculo: 'ordem' };
            return calcularGlobal(dadosOrdem, valortotatt, percentualprinc, percentualjur,totaisPorTipo);
        }

        function calcularHerdeiros(dados, valortotatt, valorprincatt, valorjurosatt, detalhamento,totaisPorTipo = null) {
            if (!dados.herdeiros || dados.herdeiros.length === 0) {
                return [];
            }

            const percentualprinc = valorprincatt / valortotatt;
            const percentualjur = valorjurosatt / valortotatt;
            const detalhamentoTotal = calcularTotaisParaHerdeiros(dados, valortotatt, percentualprinc, percentualjur,totaisPorTipo);

            const herdeirosCalculados = [];

            // Para cada herdeiro
            dados.herdeiros.forEach((herdeiro, index) => {
                const percentualHerdeiro = herdeiro.percentual;

                // 1. VALORES B√ÅSICOS DO HERDEIRO
                const valorTotalHerdeiro = valortotatt * percentualHerdeiro;
                const principalHerdeiro = valorprincatt * percentualHerdeiro;
                const jurosBaseHerdeiro = valorjurosatt * percentualHerdeiro;
                const rrapagamentoHerdeiro = dados.rra !== 0 ? arredondarRRA(dados.rra * percentualHerdeiro) : 0;

                // 2. CESS√ïES DO BENEFICI√ÅRIO PRINCIPAL
                const percentualBeneficiarioFinal = detalhamentoTotal.percentualBeneficiarioFinal;
                const valorDisponivelParaHerdeiros = valortotatt * percentualBeneficiarioFinal;
                const valorHerdeiroPoscessaoBeneficiario = valorDisponivelParaHerdeiros * percentualHerdeiro;

                // 3. CESS√ïES DO PR√ìPRIO HERDEIRO
                const cessoesHerdeiro = (dados.cessoes || []).filter(cessao => 
                    cessao.tipo === 'cessaoHerdeiro' && cessao.cedente === herdeiro.nome
                );

                let valorAposCessoesHerdeiro = valorHerdeiroPoscessaoBeneficiario;
                if (cessoesHerdeiro.length > 0) {
                    const percentualCedido = cessoesHerdeiro.reduce((total, cessao) => total + cessao.percentual, 0);
                    valorAposCessoesHerdeiro = valorHerdeiroPoscessaoBeneficiario * (1.0 - percentualCedido);
                }

                // 4. VALOR BASE CONFORME TIPO DE C√ÅLCULO
                let valorBaseHerdeiro = valorAposCessoesHerdeiro;
                
                if (dados.tipoCalculo === 'preferencia' && dados.natureza === 'alimentar' && herdeiro.temPreferencia) {
                    valorBaseHerdeiro = Math.min(valorAposCessoesHerdeiro, dados.tetoPreferencia);
                }else if (dados.tipoCalculo === 'parcial') {
                    const proporcaoParcial = dados.saldoParcial / valortotatt;
                    valorBaseHerdeiro = valorAposCessoesHerdeiro * proporcaoParcial;
                }

                // 5. COMPOSI√á√ÉO INICIAL - Usar percentuais tribut√°veis quando dispon√≠vel
                let principalHerdeiroBase, jurosBaseHerdeiroFinal;
                
                if (dados.tributacaoIR && dados.tributacaoPrevidencia) {
                    const percentualPrincipalTributado = dados.tributacaoIR.percentuais?.principalTributado || 0;
                    const percentualJurosTributado = dados.tributacaoIR.percentuais?.jurosTributado || 0;
                    
                    principalHerdeiroBase = valorBaseHerdeiro * (percentualPrincipalTributado / 100);
                    jurosBaseHerdeiroFinal = valorBaseHerdeiro * (percentualJurosTributado / 100);
                } else {
                    principalHerdeiroBase = valorBaseHerdeiro * percentualprinc;
                    jurosBaseHerdeiroFinal = valorBaseHerdeiro * percentualjur;
                }
                
                let rrapagamentoHerdeiroBase;
                if (dados.tipoCalculo === 'parcial') {
                    const proporcaoParcial = valorBaseHerdeiro / valorTotalHerdeiro;
                    rrapagamentoHerdeiroBase = dados.rra !== 0 ? arredondarRRA(dados.rra * percentualHerdeiro * proporcaoParcial) : 0;
                } else {
                    rrapagamentoHerdeiroBase = dados.rra !== 0 ? arredondarRRA(dados.rra * percentualHerdeiro) : 0;
                }

                // 6. VERIFICA√á√ïES
                const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBaseHerdeiro < valorTotalHerdeiro;
                const isPreferencia = dados.tipoCalculo === 'preferencia';
                const isParcial = dados.tipoCalculo === 'parcial';
                let valorBaseParaHonorarios = valorBaseHerdeiro;
                let valorHerdeiroQueRecebeEfetivamente = valorBaseHerdeiro;

                // 7. HONOR√ÅRIOS
                const resultadoHonorarios = calcularHonorarios(dados, valorBaseParaHonorarios, valorTotalHerdeiro,totaisPorTipo);
                const { honorarios: honorariosHerdeiro, valorHonorarioTotal: valorHonorarioTotalHerdeiro } = resultadoHonorarios;

                // 8. SINDICATOS
                const resultadoSindicatos = calcularSindicatos(dados, valorBaseParaHonorarios, valorTotalHerdeiro);
                const { sindicatos: sindicatosHerdeiro, valorSindicatoTotal: valorSindicatoTotalHerdeiro } = resultadoSindicatos;
                
                const valorSindicatoParaDescontar = isPreferencia ? 0 : valorSindicatoTotalHerdeiro;
                const valorBeneficiarioBrutoHerdeiro = valorBaseHerdeiro - valorHonorarioTotalHerdeiro - valorSindicatoParaDescontar;
                
                // 9. REC√ÅLCULO PARA PREFER√äNCIA PARCIAL - Usar percentuais tribut√°veis
                let principalHerdeiroEfetivo = principalHerdeiroBase;
                let rrapagamentoHerdeiroEfetivo = rrapagamentoHerdeiroBase;

                if (isPreferenciaParcial) {
                    if (dados.tributacaoIR) {
                        const percentualPrincipalTributado = dados.tributacaoIR.percentuais?.principalTributado || 0;
                        principalHerdeiroEfetivo = valorHerdeiroQueRecebeEfetivamente * (percentualPrincipalTributado / 100);
                    } else {
                        principalHerdeiroEfetivo = valorHerdeiroQueRecebeEfetivamente * percentualprinc;
                    }
                    
                    if (dados.rra !== 0) {
                        const rraCalculado = arredondarRRA((valorBaseHerdeiro * rrapagamentoHerdeiro)/ valorTotalHerdeiro);
                        rrapagamentoHerdeiroEfetivo = Math.max(1, rraCalculado);
                    } else {
                        rrapagamentoHerdeiroEfetivo = 0;
                    }
                } else if (isParcial) {
                    if (dados.tributacaoIR) {
                        const principalTributadoTotal = dados.tributacaoIR.principalTributado;
                        const jurosTributadoTotal = dados.tributacaoIR.jurosTributado;
                        
                        const proporcaoParcial = valorBaseHerdeiro / valorTotalHerdeiro;
                        
                        principalHerdeiroEfetivo = principalTributadoTotal * percentualHerdeiro * proporcaoParcial;
                        jurosBaseHerdeiroFinal = jurosTributadoTotal * percentualHerdeiro * proporcaoParcial;
                    } else {
                        principalHerdeiroEfetivo = valorBaseHerdeiro * percentualprinc;
                        jurosBaseHerdeiroFinal = valorBaseHerdeiro * percentualjur;
                    }
                    
                    if (dados.rra !== 0) {
                        const proporcaoParcial = valorBaseHerdeiro / valorTotalHerdeiro;
                        rrapagamentoHerdeiroEfetivo = arredondarRRA(dados.rra * percentualHerdeiro * proporcaoParcial);
                    } else {
                        rrapagamentoHerdeiroEfetivo = 0;
                    }
                }

                // 10. PREVID√äNCIA
                const resultadoPrevidencia = calcularPrevidenciaIsolada(dados, principalHerdeiroEfetivo, rrapagamentoHerdeiroEfetivo);
                const {
                    valorPrevidencia: valorPrevidenciaHerdeiro,
                    aliquotaEfetiva: aliquotaEfetivaHerdeiro,
                    valorDesagioPrevidencia: valorDesagioPrevidenciaHerdeiro,
                    percentualDesagioPrevidencia: percentualDesagioPrevidenciaHerdeiro
                } = resultadoPrevidencia;

                // 11. IR 
                const resultadoIR = calcularIRIsolado(
                    dados, 
                    valorTotalHerdeiro,
                    valorBaseHerdeiro,
                    principalHerdeiroEfetivo,
                    valorPrevidenciaHerdeiro,
                    rrapagamentoHerdeiroEfetivo  
                );
                
                const {
                    valorIR: valorIRHerdeiro,
                    aliquotaIR: aliquotaIRHerdeiro,
                    baseIRHonora: baseIRHonoraHerdeiro,
                    baseIRSindi: baseIRSindiHerdeiro,
                    baseIRPrev: baseIRPrevHerdeiro,
                    baseIRRRA: baseIRRRAHerdeiro,
                    valorIRUnitario: valorIRUnitarioHerdeiro,
                    principalComDesagio: principalComDesagioHerdeiro,
                    percentualDesagioIR: percentualDesagioIRHerdeiro,
                    rraComDesagio: rraComDesagioHerdeiro  
                } = resultadoIR;

                // 12. CESS√ïES FINAIS
                const resultadoCessoes = calcularCessoesHerdeiro(
                    dados, 
                    herdeiro,
                    valorBaseHerdeiro, 
                    valorTotalHerdeiro, 
                    valorHonorarioTotalHerdeiro, 
                    valorSindicatoParaDescontar, 
                    valorPrevidenciaHerdeiro, 
                    valorIRHerdeiro
                );
                
                const {
                    valorCessoesHerdeiro,
                    cessoesHerdeiroCalculadas,
                    percentualHerdeiroFinal,
                    valorHerdeiroAposCessoes,
                    valorPrevidenciaHerdeiroFinal,
                    valorIRHerdeiroFinal,
                    valorHerdeiroLiquido,
                    cessoesHerdeiroFinais
                } = resultadoCessoes;

                // 13. PREFER√äNCIA PARCIAL - SALDO DEVEDOR
                let valorHerdeiroRecebePorPreferencia = valorHerdeiroLiquido;
                let valorHerdeiroSaldoDevedor = 0;

                if (isPreferenciaParcial) {
                    valorHerdeiroRecebePorPreferencia = valorBaseHerdeiro - 
                        (valorPrevidenciaHerdeiroFinal + valorIRHerdeiroFinal + valorHonorarioTotalHerdeiro);
                    valorHerdeiroSaldoDevedor = valorHerdeiroPoscessaoBeneficiario - valorBaseHerdeiro;
                }
                
                // 14. MONTAR RESULTADO
                const herdeiroDados = {
                    ...herdeiro,
                    indice: index,
                    
                    // Valores originais
                    valorTotalOriginal: valorTotalHerdeiro,
                    principalOriginal: principalHerdeiro,
                    jurosOriginal: jurosBaseHerdeiro,
                    rrapagamentoOriginal: rrapagamentoHerdeiro,
                    
                    // Valores efetivos
                    valorTotal: valorBaseHerdeiro,
                    principal: principalHerdeiroEfetivo,
                    jurosBase: jurosBaseHerdeiroFinal,
                    rrapagamento: rrapagamentoHerdeiroEfetivo,  
                    rraComDesagio: rraComDesagioHerdeiro,      
                    
                    // Descontos
                    honorarios: honorariosHerdeiro,
                    valorHonorarioTotal: valorHonorarioTotalHerdeiro,
                    sindicatos: sindicatosHerdeiro,
                    valorSindicatoTotal: valorSindicatoTotalHerdeiro,
                    
                    // Tributos
                    valorPrevidencia: valorPrevidenciaHerdeiro,
                    aliquotaEfetiva: aliquotaEfetivaHerdeiro,
                    valorDesagioPrevidencia: valorDesagioPrevidenciaHerdeiro,
                    percentualDesagioPrevidencia: percentualDesagioPrevidenciaHerdeiro,
                    
                    valorIR: valorIRHerdeiro,
                    aliquotaIR: aliquotaIRHerdeiro,
                    baseIRHonora: baseIRHonoraHerdeiro,
                    baseIRSindi: baseIRSindiHerdeiro,
                    baseIRPrev: baseIRPrevHerdeiro,
                    baseIRRRA: baseIRRRAHerdeiro,
                    valorIRUnitario: valorIRUnitarioHerdeiro,
                    principalComDesagio: principalComDesagioHerdeiro,
                    percentualDesagioIR: percentualDesagioIRHerdeiro,
                    
                    valorPrevidenciaFinal: valorPrevidenciaHerdeiroFinal,
                    valorIRFinal: valorIRHerdeiroFinal,
                    
                    // Cess√µes
                    percentualBeneficiarioFinal: detalhamentoTotal.percentualBeneficiarioFinal,
                    valorAposCessoesBeneficiario: valorHerdeiroPoscessaoBeneficiario,
                    cessoesHerdeiro: cessoesHerdeiroFinais,
                    valorCessoesHerdeiro,
                    percentualHerdeiroFinal,
                    
                    // Valores finais
                    valorBruto: valorBeneficiarioBrutoHerdeiro,
                    valorFinalAposCessoes: valorHerdeiroAposCessoes,
                    valorLiquido: valorHerdeiroLiquido,
                    
                    // Prefer√™ncia
                    isPreferenciaParcial,
                    valorRecebePorPreferencia: valorHerdeiroRecebePorPreferencia,
                    valorSaldoDevedor: valorHerdeiroSaldoDevedor,
                    
                    // Flags
                    temCessoes: cessoesHerdeiro.length > 0,
                    temCessoesBeneficiario: detalhamentoTotal.percentualBeneficiarioFinal < 1.0
                };
                herdeirosCalculados.push(herdeiroDados);
            });
            return herdeirosCalculados;
        }

        function calcularCessoesHerdeiro(dados, herdeiro, valorBaseHerdeiro, valorTotalHerdeiro, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidenciaHerdeiro, valorIRHerdeiro) {
            const valorHerdeiroBruto = valorBaseHerdeiro - valorHonorarioTotal - valorSindicatoParaDescontar;

            const cessoesHerdeiro = dados.cessoes?.filter(cessao => 
                cessao.tipo === 'cessaoherdeiro' && cessao.cedente === herdeiro.nome
            ) || [];

            const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBaseHerdeiro < valorTotalHerdeiro;
            
            let valorCessoesHerdeiro = 0;
            let cessoesHerdeiroCalculadas = [];
            let percentualHerdeiroFinal = 1.0;
            let valorHerdeiroAposCessoes = valorHerdeiroBruto;
            let valorPrevidenciaHerdeiroFinal = valorPrevidenciaHerdeiro;
            let valorIRHerdeiroFinal = valorIRHerdeiro;
            let valorHerdeiroLiquido = valorHerdeiroBruto - valorPrevidenciaHerdeiro - valorIRHerdeiro;
            let cessoesHerdeiroFinais = [];

            if (cessoesHerdeiro.length === 0) {
                return {
                    valorHerdeiroBruto,
                    valorCessoesHerdeiro,
                    cessoesHerdeiroCalculadas,
                    percentualHerdeiroFinal,
                    valorHerdeiroAposCessoes,
                    valorPrevidenciaHerdeiroFinal,
                    valorIRHerdeiroFinal,
                    valorHerdeiroLiquido,
                    cessoesHerdeiroFinais
                };
            }

            const totalPercentualCessoes = cessoesHerdeiro.reduce((total, cessao) => total + cessao.percentual, 0);
            percentualHerdeiroFinal = 1.0 - totalPercentualCessoes;
            
            const percentualAdvogados = dados.advogados.length > 0 ? 
                dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0) : 0;
            const valorTotalSemAdvogados = valorTotalHerdeiro - (valorTotalHerdeiro * percentualAdvogados);

            if (isPreferenciaParcial) {
                const parteHerdeiroNaDividaTotal = valorTotalSemAdvogados * percentualHerdeiroFinal;
                const maxQueHerdeiroPodeReceber = Math.min(parteHerdeiroNaDividaTotal, valorHerdeiroBruto);
                
                cessoesHerdeiroCalculadas = [];
                cessoesHerdeiroFinais = [];
                
                for (const cessao of cessoesHerdeiro) {
                    const parteCessionarioNaDividaTotal = valorTotalSemAdvogados * cessao.percentual;
                    
                    const cessaoCalculada = {
                        tipo: cessao.tipo,
                        cedente: cessao.cedente,
                        cessionario: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: 0,
                        valorSaldoDevedor: parteCessionarioNaDividaTotal,
                        observacao: 'Aguarda pagamento - sem direito √† prefer√™ncia'
                    };
                    
                    const cessaoFinal = {
                        ...cessaoCalculada,
                        previdenciaCessao: 0,
                        irCessao: 0,
                        valorLiquido: 0
                    };
                    
                    cessoesHerdeiroCalculadas.push(cessaoCalculada);
                    cessoesHerdeiroFinais.push(cessaoFinal);
                }

                valorCessoesHerdeiro = 0; 
                valorHerdeiroAposCessoes = maxQueHerdeiroPodeReceber;
                
                valorPrevidenciaHerdeiroFinal = valorPrevidenciaHerdeiro;
                valorIRHerdeiroFinal = valorIRHerdeiro;
                valorHerdeiroLiquido = maxQueHerdeiroPodeReceber - valorPrevidenciaHerdeiroFinal - valorIRHerdeiroFinal;
                
            } else {
                const valorPrevidenciaPorPercentual = valorPrevidenciaHerdeiro; 
                const valorIRPorPercentual = valorIRHerdeiro; 
                
                valorCessoesHerdeiro = 0;
                
                cessoesHerdeiroCalculadas = [];
                cessoesHerdeiroFinais = [];
                
                for (const cessao of cessoesHerdeiro) {
                    const valorBrutoCessao = valorHerdeiroBruto * cessao.percentual;
                    valorCessoesHerdeiro += valorBrutoCessao;
                    
                    const cessaoCalculada = {
                        tipo: cessao.tipo,
                        cedente: cessao.cedente,
                        cessionario: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao
                    };
                    
                    const previdenciaCessao = valorPrevidenciaPorPercentual * cessao.percentual;
                    const irCessao = valorIRPorPercentual * cessao.percentual;
                    const valorLiquidoCessao = valorBrutoCessao - previdenciaCessao - irCessao;
                    
                    const cessaoFinal = {
                        ...cessaoCalculada,
                        previdenciaCessao,
                        irCessao,
                        valorLiquido: valorLiquidoCessao
                    };
                    
                    cessoesHerdeiroCalculadas.push(cessaoCalculada);
                    cessoesHerdeiroFinais.push(cessaoFinal);
                }
                
                valorHerdeiroAposCessoes = valorHerdeiroBruto * percentualHerdeiroFinal;
                valorPrevidenciaHerdeiroFinal = valorPrevidenciaHerdeiro * percentualHerdeiroFinal;
                valorIRHerdeiroFinal = valorIRHerdeiro * percentualHerdeiroFinal;
                valorHerdeiroLiquido = valorHerdeiroAposCessoes - valorPrevidenciaHerdeiroFinal - valorIRHerdeiroFinal;
            }

            return {
                valorHerdeiroBruto,
                valorCessoesHerdeiro,
                cessoesHerdeiroCalculadas,
                percentualHerdeiroFinal,
                valorHerdeiroAposCessoes,
                valorPrevidenciaHerdeiroFinal,
                valorIRHerdeiroFinal,
                valorHerdeiroLiquido,
                cessoesHerdeiroFinais
            };
        }

        function calcularSaldoFinalComPagamentos(resultados, pagamentosCalculados, dados) {
            if (!pagamentosCalculados || pagamentosCalculados.length === 0) {
                return null;
            }
            
            // 1. Mapear pagamentos por benefici√°rio
            const pagamentosPorBeneficiario = {};
            pagamentosCalculados.forEach(pag => {
                if (!pagamentosPorBeneficiario[pag.beneficiario]) {
                    pagamentosPorBeneficiario[pag.beneficiario] = { totalPago: 0 };
                }
                pagamentosPorBeneficiario[pag.beneficiario].totalPago += pag.valorAtualizado.total;
            });
                        
            // 2. Estrutura de saldos finais
            const saldosFinais = {
                beneficiarioPrincipal: null,
                advogados: [],
                advogadosSucumbenciais: [],
                sindicatos: [],
                herdeiros: [],
                cessionarios: [],
                totalGeralBruto: 0,
                totalGeralOriginal: 0
            };
            
            // 3. Identificar cess√µes de 100%
            const cessoes100 = {
                advogados: {},
                advogadosSucumbenciais: {},
                sindicatos: {},
                beneficiarioPrincipal: false
            };
            
            // Mapear cess√µes de advogados
            if (resultados.honorarios) {
                resultados.honorarios.forEach(adv => {
                    if (adv.cessionarios && adv.cessionarios.length > 0) {
                        const percentualCedido = adv.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                        if (percentualCedido >= 1.0) {
                            cessoes100.advogados[adv.nome] = adv.cessionarios;
                        }
                    }
                });
            }
            
            // Mapear cess√µes de advogados sucumbenciais
            if (resultados.honorariosSucumbenciais?.honorarios) {
                resultados.honorariosSucumbenciais.honorarios.forEach(advSuc => {
                    if (advSuc.cessionarios && advSuc.cessionarios.length > 0) {
                        const percentualCedido = advSuc.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                        if (percentualCedido >= 1.0) {
                            cessoes100.advogadosSucumbenciais[advSuc.nome] = advSuc.cessionarios;
                        }
                    }
                });
            }
            
            // Mapear cess√µes de sindicatos
            if (resultados.sindicatos) {
                resultados.sindicatos.forEach(sind => {
                    if (sind.cessionarios && sind.cessionarios.length > 0) {
                        const percentualCedido = sind.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                        if (percentualCedido >= 1.0) {
                            cessoes100.sindicatos[sind.nome] = sind.cessionarios;
                        }
                    }
                });
            }
            
            // Verificar cess√£o 100% do benefici√°rio principal
            if (resultados.cessoesBeneficiarioFinais && resultados.cessoesBeneficiarioFinais.length > 0) {
                const percentualCedidoBenef = resultados.cessoesBeneficiarioFinais.reduce((sum, c) => sum + c.percentual, 0);
                cessoes100.beneficiarioPrincipal = percentualCedidoBenef >= 1.0;
            }
            
            // 4. Benefici√°rio Principal ou Herdeiros
            const nomeBeneficiario = dados.beneficiario;
            const pagamentoBeneficiario = pagamentosPorBeneficiario[nomeBeneficiario]?.totalPago || 0;
            
            if (resultados.temHerdeiros && resultados.herdeiros && resultados.herdeiros.length > 0) {
                // TEM HERDEIROS: Dividir pagamento do benefici√°rio proporcionalmente
                resultados.herdeiros.forEach(herdeiro => {
                    const pagamentoDiretoHerdeiro = pagamentosPorBeneficiario[herdeiro.nome]?.totalPago || 0;
                    const pagamentoDoBeneficiarioParaHerdeiro = pagamentoBeneficiario * herdeiro.percentual;
                    const totalPagamentoHerdeiro = pagamentoDiretoHerdeiro + pagamentoDoBeneficiarioParaHerdeiro;
                    
                    const valorBruto = herdeiro.valorBruto || 0;
                    const saldoBruto = valorBruto - totalPagamentoHerdeiro;
                    
                    saldosFinais.herdeiros.push({
                        nome: herdeiro.nome,
                        valorBruto: valorBruto,
                        pagamento: totalPagamentoHerdeiro,
                        pagamentoDireto: pagamentoDiretoHerdeiro,
                        pagamentoDoBeneficiario: pagamentoDoBeneficiarioParaHerdeiro,
                        saldo: saldoBruto
                    });
                    
                    saldosFinais.totalGeralBruto += saldoBruto;
                    saldosFinais.totalGeralOriginal += valorBruto;
                });
            } else {
                // N√ÉO TEM HERDEIROS: Benefici√°rio Principal normal
                if (resultados.valorBeneficiarioAposCessoes && resultados.valorBeneficiarioAposCessoes > 0) {
                    const valorBruto = resultados.valorBeneficiarioAposCessoes;
                    const saldoBruto = valorBruto - pagamentoBeneficiario;
                    
                    saldosFinais.beneficiarioPrincipal = {
                        nome: nomeBeneficiario,
                        valorBruto: valorBruto,
                        pagamento: pagamentoBeneficiario,
                        saldo: saldoBruto
                    };
                    
                    saldosFinais.totalGeralBruto += saldoBruto;
                    saldosFinais.totalGeralOriginal += valorBruto;
                }
            }
            
            // 5. Advogados
            if (resultados.honorarios && resultados.honorarios.length > 0) {
                resultados.honorarios.forEach(adv => {
                    const pagamentoDireto = pagamentosPorBeneficiario[adv.nome]?.totalPago || 0;
                    const valorBruto = adv.valorBruto || adv.valorBrutoAdvogado || 0;
                    
                    // Se cess√£o √© 100%, N√ÉO mostrar advogado (pagamento vai para cession√°rio)
                    if (!cessoes100.advogados[adv.nome]) {
                        const saldoBruto = valorBruto - pagamentoDireto;
                        
                        saldosFinais.advogados.push({
                            nome: adv.nome,
                            tipo: adv.tipo,
                            valorBruto: valorBruto,
                            pagamento: pagamentoDireto,
                            saldo: saldoBruto
                        });
                        
                        saldosFinais.totalGeralBruto += saldoBruto;
                        saldosFinais.totalGeralOriginal += valorBruto;
                    }
                });
            }
            
            // 6. Advogados Sucumbenciais
            if (resultados.honorariosSucumbenciais?.honorarios) {
                resultados.honorariosSucumbenciais.honorarios.forEach(advSuc => {
                    const pagamentoDireto = pagamentosPorBeneficiario[advSuc.nome]?.totalPago || 0;
                    const valorBruto = advSuc.valorBruto || 0;
                    
                    // Se cess√£o √© 100%, N√ÉO mostrar advogado (pagamento vai para cession√°rio)
                    if (!cessoes100.advogadosSucumbenciais[advSuc.nome]) {
                        const saldoBruto = valorBruto - pagamentoDireto;
                        
                        saldosFinais.advogadosSucumbenciais.push({
                            nome: advSuc.nome,
                            tipo: advSuc.tipo,
                            valorBruto: valorBruto,
                            pagamento: pagamentoDireto,
                            saldo: saldoBruto
                        });
                        
                        saldosFinais.totalGeralBruto += saldoBruto;
                        saldosFinais.totalGeralOriginal += valorBruto;
                    }
                });
            }
            
            // 7. Sindicatos
            if (resultados.sindicatos && resultados.sindicatos.length > 0) {
                resultados.sindicatos.forEach(sind => {
                    const pagamentoDireto = pagamentosPorBeneficiario[sind.nome]?.totalPago || 0;
                    const valorBruto = sind.valorBrutoSindicato || 0;
                    
                    // Se cess√£o √© 100%, N√ÉO mostrar sindicato (pagamento vai para cession√°rio)
                    if (!cessoes100.sindicatos[sind.nome]) {
                        const saldoBruto = valorBruto - pagamentoDireto;
                        
                        saldosFinais.sindicatos.push({
                            nome: sind.nome,
                            valorBruto: valorBruto,
                            pagamento: pagamentoDireto,
                            saldo: saldoBruto
                        });
                        
                        saldosFinais.totalGeralBruto += saldoBruto;
                        saldosFinais.totalGeralOriginal += valorBruto;
                    }
                });
            }
            
            // 8. Cession√°rios do Benefici√°rio Principal
            if (resultados.cessoesBeneficiarioFinais && resultados.cessoesBeneficiarioFinais.length > 0) {
                resultados.cessoesBeneficiarioFinais.forEach(cess => {
                    const pagamentoDireto = pagamentosPorBeneficiario[cess.cessionario]?.totalPago || 0;
                    const valorBruto = cess.valorBruto || 0;
                    
                    let pagamentoTotal = pagamentoDireto;
                    
                    // Se cess√£o √© 100%, redirecionar pagamento do benefici√°rio
                    if (cessoes100.beneficiarioPrincipal) {
                        const pagamentoDoBeneficiario = pagamentoBeneficiario * cess.percentual;
                        pagamentoTotal += pagamentoDoBeneficiario;
                    }
                    
                    const saldoBruto = valorBruto - pagamentoTotal;
                    
                    saldosFinais.cessionarios.push({
                        nome: cess.cessionario,
                        tipo: 'Cession√°rio do Benefici√°rio',
                        valorBruto: valorBruto,
                        pagamento: pagamentoTotal,
                        pagamentoDireto: pagamentoDireto,
                        saldo: saldoBruto
                    });
                    
                    saldosFinais.totalGeralBruto += saldoBruto;
                    saldosFinais.totalGeralOriginal += valorBruto;
                });
            }

            // 9. Cession√°rios dos Herdeiros
            if (resultados.temHerdeiros && resultados.herdeiros && resultados.herdeiros.length > 0) {
                resultados.herdeiros.forEach(herdeiro => {
                    if (herdeiro.cessoesHerdeiroFinais && herdeiro.cessoesHerdeiroFinais.length > 0) {
                        herdeiro.cessoesHerdeiroFinais.forEach(cess => {
                            const pagamentoDireto = pagamentosPorBeneficiario[cess.cessionario]?.totalPago || 0;
                            const valorBruto = cess.valorBruto || 0;
                            const saldoBruto = valorBruto - pagamentoDireto;
                            
                            saldosFinais.cessionarios.push({
                                nome: cess.cessionario,
                                cedente: herdeiro.nome,
                                tipo: 'Cession√°rio de Herdeiro',
                                valorBruto: valorBruto,
                                pagamento: pagamentoDireto,
                                saldo: saldoBruto
                            });
                            
                            saldosFinais.totalGeralBruto += saldoBruto;
                            saldosFinais.totalGeralOriginal += valorBruto;
                        });
                    }
                });
            }

            // 10. Cession√°rios dos Advogados
            if (resultados.honorarios && resultados.honorarios.length > 0) {
                resultados.honorarios.forEach(adv => {
                    if (adv.cessionarios && adv.cessionarios.length > 0) {
                        const pagamentoCedente = pagamentosPorBeneficiario[adv.nome]?.totalPago || 0;
                        const cedeu100 = cessoes100.advogados[adv.nome];
                        
                        adv.cessionarios.forEach(cess => {
                            const pagamentoDireto = pagamentosPorBeneficiario[cess.nome]?.totalPago || 0;
                            const valorBruto = cess.valorBruto || 0;
                            
                            let pagamentoTotal = pagamentoDireto;
                            
                            // Se cess√£o √© 100%, redirecionar pagamento do cedente
                            if (cedeu100) {
                                const pagamentoDoCedente = pagamentoCedente * cess.percentual;
                                pagamentoTotal += pagamentoDoCedente;
                            }
                            
                            const saldoBruto = valorBruto - pagamentoTotal;
                            
                            saldosFinais.cessionarios.push({
                                nome: cess.nome,
                                cedente: adv.nome,
                                tipo: 'Cession√°rio de Advogado',
                                valorBruto: valorBruto,
                                pagamento: pagamentoTotal,
                                pagamentoDireto: pagamentoDireto,
                                saldo: saldoBruto
                            });
                            
                            saldosFinais.totalGeralBruto += saldoBruto;
                            saldosFinais.totalGeralOriginal += valorBruto;
                        });
                    }
                });
            }

            // 11. Cession√°rios dos Advogados Sucumbenciais
            if (resultados.honorariosSucumbenciais?.honorarios) {
                resultados.honorariosSucumbenciais.honorarios.forEach(advSuc => {
                    if (advSuc.cessionarios && advSuc.cessionarios.length > 0) {
                        const pagamentoCedente = pagamentosPorBeneficiario[advSuc.nome]?.totalPago || 0;
                        const cedeu100 = cessoes100.advogadosSucumbenciais[advSuc.nome];
                        
                        advSuc.cessionarios.forEach(cess => {
                            const pagamentoDireto = pagamentosPorBeneficiario[cess.nome]?.totalPago || 0;
                            const valorBruto = cess.valorBruto || 0;
                            
                            let pagamentoTotal = pagamentoDireto;
                            
                            // Se cess√£o √© 100%, redirecionar pagamento do cedente
                            if (cedeu100) {
                                const pagamentoDoCedente = pagamentoCedente * cess.percentual;
                                pagamentoTotal += pagamentoDoCedente;
                            }
                            
                            const saldoBruto = valorBruto - pagamentoTotal;
                            
                            saldosFinais.cessionarios.push({
                                nome: cess.nome,
                                cedente: advSuc.nome,
                                tipo: 'Cession√°rio de Adv. Sucumbencial',
                                valorBruto: valorBruto,
                                pagamento: pagamentoTotal,
                                pagamentoDireto: pagamentoDireto,
                                saldo: saldoBruto
                            });
                            
                            saldosFinais.totalGeralBruto += saldoBruto;
                            saldosFinais.totalGeralOriginal += valorBruto;
                        });
                    }
                });
            }

            // 12. Cession√°rios dos Sindicatos
            if (resultados.sindicatos && resultados.sindicatos.length > 0) {
                resultados.sindicatos.forEach(sind => {
                    if (sind.cessionarios && sind.cessionarios.length > 0) {
                        const pagamentoCedente = pagamentosPorBeneficiario[sind.nome]?.totalPago || 0;
                        const cedeu100 = cessoes100.sindicatos[sind.nome];
                        
                        sind.cessionarios.forEach(cess => {
                            const pagamentoDireto = pagamentosPorBeneficiario[cess.nome]?.totalPago || 0;
                            const valorBruto = cess.valorBruto || 0;
                            
                            let pagamentoTotal = pagamentoDireto;
                            
                            // Se cess√£o √© 100%, redirecionar pagamento do cedente
                            if (cedeu100) {
                                const pagamentoDoCedente = pagamentoCedente * cess.percentual;
                                pagamentoTotal += pagamentoDoCedente;
                            }
                            
                            const saldoBruto = valorBruto - pagamentoTotal;
                            
                            saldosFinais.cessionarios.push({
                                nome: cess.nome,
                                cedente: sind.nome,
                                tipo: 'Cession√°rio de Sindicato',
                                valorBruto: valorBruto,
                                pagamento: pagamentoTotal,
                                pagamentoDireto: pagamentoDireto,
                                saldo: saldoBruto
                            });
                            
                            saldosFinais.totalGeralBruto += saldoBruto;
                            saldosFinais.totalGeralOriginal += valorBruto;
                        });
                    }
                });
            }
            
            // 13. Calcular Principal e Juros do TOTAL (SEM honor√°rios sucumbenciais)
            let totalSemHonorariosSucumbenciais = saldosFinais.totalGeralBruto;

            // Subtrair honor√°rios sucumbenciais
            if (saldosFinais.advogadosSucumbenciais && saldosFinais.advogadosSucumbenciais.length > 0) {
                const totalHonorariosSucumbenciais = saldosFinais.advogadosSucumbenciais.reduce((sum, adv) => sum + adv.saldo, 0);
                totalSemHonorariosSucumbenciais -= totalHonorariosSucumbenciais;
            }

            // Subtrair cession√°rios de honor√°rios sucumbenciais
            if (saldosFinais.cessionarios && saldosFinais.cessionarios.length > 0) {
                const totalCessionariosSucumbenciais = saldosFinais.cessionarios
                    .filter(c => c.tipo === 'Cession√°rio de Adv. Sucumbencial')
                    .reduce((sum, c) => sum + c.saldo, 0);
                totalSemHonorariosSucumbenciais -= totalCessionariosSucumbenciais;
            }

            // Salvar total sem honor√°rios sucumbenciais
            saldosFinais.totalSemHonorariosSucumbenciais = totalSemHonorariosSucumbenciais;

            saldosFinais.principalTotal = totalSemHonorariosSucumbenciais * (resultados.percentualprinc || 0.5);
            saldosFinais.jurosTotal = totalSemHonorariosSucumbenciais * (resultados.percentualjur || 0.5);

            // 14. RRA ajustado (baseado no total SEM honor√°rios sucumbenciais)
            const rraOriginal = resultados.rrapagamento || resultados.rraTotal || 0;

            // Calcular valor original sem honor√°rios sucumbenciais
            let totalOriginalSemHonorariosSucumbenciais = saldosFinais.totalGeralOriginal;
            if (saldosFinais.advogadosSucumbenciais && saldosFinais.advogadosSucumbenciais.length > 0) {
                const totalOriginalHonSuc = saldosFinais.advogadosSucumbenciais.reduce((sum, adv) => sum + adv.valorBruto, 0);
                totalOriginalSemHonorariosSucumbenciais -= totalOriginalHonSuc;
            }
            if (saldosFinais.cessionarios && saldosFinais.cessionarios.length > 0) {
                const totalOriginalCessSuc = saldosFinais.cessionarios
                    .filter(c => c.tipo === 'Cession√°rio de Adv. Sucumbencial')
                    .reduce((sum, c) => sum + c.valorBruto, 0);
                totalOriginalSemHonorariosSucumbenciais -= totalOriginalCessSuc;
            }

            const proporcao = totalOriginalSemHonorariosSucumbenciais > 0 ? 
                (totalSemHonorariosSucumbenciais / totalOriginalSemHonorariosSucumbenciais) : 0;

            saldosFinais.rraOriginal = rraOriginal;
            saldosFinais.rraAjustado = rraOriginal > 0 ? Math.max(1, arredondarRRA(proporcao * rraOriginal)) : 0;

            // 15. IR e Previd√™ncia recalculados (sobre o total SEM honor√°rios sucumbenciais)
            const resultadoPrevidencia = calcularPrevidenciaIsolada(dados, saldosFinais.principalTotal, saldosFinais.rraAjustado);
            saldosFinais.previdenciaTotal = resultadoPrevidencia.valorPrevidencia;
            saldosFinais.aliquotaEfetiva = resultadoPrevidencia.aliquotaEfetiva;
            saldosFinais.valorDesagioPrevidencia = resultadoPrevidencia.valorDesagioPrevidencia;
            saldosFinais.percentualDesagioPrevidencia = resultadoPrevidencia.percentualDesagioPrevidencia;

            const resultadoIR = calcularIRIsolado(dados, totalSemHonorariosSucumbenciais, totalSemHonorariosSucumbenciais, saldosFinais.principalTotal, saldosFinais.previdenciaTotal, saldosFinais.rraAjustado);
            saldosFinais.irTotal = resultadoIR.valorIR;
            saldosFinais.aliquotaIR = resultadoIR.aliquotaIR;
            saldosFinais.baseIRHonora = resultadoIR.baseIRHonora;
            saldosFinais.baseIRSindi = resultadoIR.baseIRSindi;
            saldosFinais.baseIRPrev = resultadoIR.baseIRPrev;
            saldosFinais.baseIRRRA = resultadoIR.baseIRRRA;
            saldosFinais.valorIRUnitario = resultadoIR.valorIRUnitario;
            saldosFinais.principalComDesagio = resultadoIR.principalComDesagio;
            saldosFinais.percentualDesagioIR = resultadoIR.percentualDesagioIR;
            saldosFinais.rraComDesagio = resultadoIR.rraComDesagio;

            saldosFinais.totalLiquido = totalSemHonorariosSucumbenciais - saldosFinais.previdenciaTotal - saldosFinais.irTotal;

            return saldosFinais;
        }

        function ajustarResultadosComPagamentos(resultados, dados) {
            if (!resultados.saldosFinais) {
                return resultados;
            }
            
            const saldos = resultados.saldosFinais;
            const resultadosAjustados = JSON.parse(JSON.stringify(resultados));
            
            if (saldos.totalGeralBruto > 0 && saldos.totalGeralOriginal > 0) {
                // Usar o total SEM honor√°rios sucumbenciais para os c√°lculos principais
                const totalParaCalculo = saldos.totalSemHonorariosSucumbenciais || saldos.totalGeralBruto;
                
                // Ajustar valores globais USANDO os valores j√° calculados
                resultadosAjustados.principal = saldos.principalTotal;
                resultadosAjustados.valorBase = totalParaCalculo;
                resultadosAjustados.valortotatt = totalParaCalculo;
                resultadosAjustados.rrapagamento = saldos.rraAjustado || saldos.rraOriginal;
                
                // USAR Previd√™ncia j√° calculada (N√ÉO recalcular)
                resultadosAjustados.valorPrevidencia = saldos.previdenciaTotal;
                resultadosAjustados.aliquotaEfetiva = saldos.aliquotaEfetiva;
                resultadosAjustados.valorDesagioPrevidencia = saldos.valorDesagioPrevidencia;
                resultadosAjustados.percentualDesagioPrevidencia = saldos.percentualDesagioPrevidencia;
                
                // USAR IR j√° calculado (N√ÉO recalcular)
                resultadosAjustados.valorIR = saldos.irTotal;
                resultadosAjustados.aliquotaIR = saldos.aliquotaIR;
                resultadosAjustados.baseIRHonora = saldos.baseIRHonora;
                resultadosAjustados.baseIRSindi = saldos.baseIRSindi;
                resultadosAjustados.baseIRPrev = saldos.baseIRPrev;
                resultadosAjustados.baseIRRRA = saldos.baseIRRRA;
                resultadosAjustados.valorIRUnitario = saldos.valorIRUnitario;
                resultadosAjustados.principalComDesagio = saldos.principalComDesagio;
                resultadosAjustados.percentualDesagioIR = saldos.percentualDesagioIR;
                resultadosAjustados.rraComDesagio = saldos.rraComDesagio;
                
                // Ajustar Benefici√°rio Principal
                if (saldos.beneficiarioPrincipal && saldos.beneficiarioPrincipal.saldo > 0) {
                    resultadosAjustados.valorBeneficiarioAposCessoes = saldos.beneficiarioPrincipal.saldo;
                    
                    // Distribuir proporcionalmente IR e Previd√™ncia para o benefici√°rio
                    if (totalParaCalculo > 0) {
                        const proporcaoBenef = saldos.beneficiarioPrincipal.saldo / totalParaCalculo;
                        resultadosAjustados.valorPrevidenciaBeneficiario = saldos.previdenciaTotal * proporcaoBenef;
                        resultadosAjustados.valorIRBeneficiario = saldos.irTotal * proporcaoBenef;
                        resultadosAjustados.valorBeneficiarioFinal = saldos.beneficiarioPrincipal.saldo - 
                            resultadosAjustados.valorPrevidenciaBeneficiario - 
                            resultadosAjustados.valorIRBeneficiario;
                    }
                }

                // Ajustar Advogados
                if (saldos.advogados && saldos.advogados.length > 0 && resultadosAjustados.honorarios) {
                    resultadosAjustados.honorarios = resultadosAjustados.honorarios.map(adv => {
                        const saldoAdv = saldos.advogados.find(a => a.nome === adv.nome);
                        
                        if (!saldoAdv || saldoAdv.saldo <= 0) {
                            return adv;
                        }
                        
                        // RECALCULAR IR respeitando incidenciaIR
                        let novoIR = 0;
                        if (adv.incidenciaIR && saldoAdv.saldo > 0) {
                            novoIR = adv.tipo === 'PF' ? calcularIR(saldoAdv.saldo) : saldoAdv.saldo * 0.015;
                        }
                        
                        return {
                            ...adv,
                            valorBrutoAdvogado: saldoAdv.saldo,
                            irAdvogado: novoIR,
                            valorLiquidoAdvogado: saldoAdv.saldo - novoIR
                        };
                    });
                }

                // Ajustar Advogados Sucumbenciais
                if (saldos.advogadosSucumbenciais && saldos.advogadosSucumbenciais.length > 0 && 
                    resultadosAjustados.honorariosSucumbenciais?.honorarios) {
                    resultadosAjustados.honorariosSucumbenciais.honorarios = resultadosAjustados.honorariosSucumbenciais.honorarios.map(advSuc => {
                        const saldoAdvSuc = saldos.advogadosSucumbenciais.find(a => a.nome === advSuc.nome);
                        
                        if (!saldoAdvSuc || saldoAdvSuc.saldo <= 0) {
                            return advSuc;
                        }
                        
                        // RECALCULAR IR respeitando incidenciaIR
                        let novoIR = 0;
                        if (advSuc.incidenciaIR && saldoAdvSuc.saldo > 0) {
                            novoIR = advSuc.tipo === 'PF' ? calcularIR(saldoAdvSuc.saldo) : saldoAdvSuc.saldo * 0.015;
                        }
                        
                        return {
                            ...advSuc,
                            valorBrutoAdvogado: saldoAdvSuc.saldo,
                            irAdvogado: novoIR,
                            valorLiquidoAdvogado: saldoAdvSuc.saldo - novoIR
                        };
                    });
                }

                // Ajustar Sindicatos
                if (saldos.sindicatos && saldos.sindicatos.length > 0 && resultadosAjustados.sindicatos) {
                    resultadosAjustados.sindicatos = resultadosAjustados.sindicatos.map(sind => {
                        const saldoSind = saldos.sindicatos.find(s => s.nome === sind.nome);
                        
                        if (!saldoSind || saldoSind.saldo <= 0) {
                            return sind;
                        }
                        
                        // RECALCULAR IR do sindicato (usar a l√≥gica original)
                        let novoIR = 0;
                        if (sind.tipoTributacao === 'pj') {
                            novoIR = saldoSind.saldo * 0.015; // PJ: 1,5%
                        } else if (sind.aliquotaFixaIR) {
                            novoIR = saldoSind.saldo * sind.aliquotaFixaIR; // Al√≠quota fixa
                        } else {
                            novoIR = saldoSind.saldo * 0.015; // Padr√£o: 1,5%
                        }
                        
                        return {
                            ...sind,
                            valorBrutoSindicato: saldoSind.saldo,
                            irSindicato: novoIR,
                            valorLiquidoSindicato: saldoSind.saldo - novoIR
                        };
                    });
                }
                
                // Ajustar Herdeiros
                if (saldos.herdeiros && saldos.herdeiros.length > 0 && resultadosAjustados.herdeiros) {
                    resultadosAjustados.herdeiros = resultadosAjustados.herdeiros.map((herd, index) => {
                        const saldoHerd = saldos.herdeiros[index];
                        
                        if (!saldoHerd || saldoHerd.saldo <= 0) {
                            return herd;
                        }
                        
                        const proporcaoHerd = saldoHerd.saldo / saldoHerd.valorBruto;
                        
                        const herdAjustado = {
                            ...herd,
                            principal: herd.principal * proporcaoHerd,
                            valorTotal: saldoHerd.saldo,
                            valorBruto: saldoHerd.saldo,
                            valorLiquido: herd.valorLiquido ? herd.valorLiquido * proporcaoHerd : saldoHerd.saldo
                        };
                        
                        if (dados.incidenciaPrevidencia || 
                            (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.previdencia))) {
                            
                            const resultadoPrevHerd = calcularPrevidenciaIsolada(
                                dados,
                                herdAjustado.principal,
                                herd.rrapagamento
                            );
                            
                            herdAjustado.valorPrevidencia = resultadoPrevHerd.valorPrevidencia;
                            herdAjustado.aliquotaEfetiva = resultadoPrevHerd.aliquotaEfetiva;
                            herdAjustado.valorDesagioPrevidencia = resultadoPrevHerd.valorDesagioPrevidencia;
                            herdAjustado.percentualDesagioPrevidencia = resultadoPrevHerd.percentualDesagioPrevidencia;
                        }
                        
                        if (temIR && herd.rrapagamento !== 0) {
                            const resultadoIRHerd = calcularIRIsolado(
                                dados,
                                herdAjustado.valorTotal,
                                herdAjustado.valorTotal,
                                herdAjustado.principal,
                                herdAjustado.valorPrevidencia,
                                herd.rrapagamento
                            );
                            
                            herdAjustado.valorIR = resultadoIRHerd.valorIR;
                            herdAjustado.aliquotaIR = resultadoIRHerd.aliquotaIR;
                            herdAjustado.baseIRHonora = resultadoIRHerd.baseIRHonora;
                            herdAjustado.baseIRSindi = resultadoIRHerd.baseIRSindi;
                            herdAjustado.baseIRPrev = resultadoIRHerd.baseIRPrev;
                            herdAjustado.baseIRRRA = resultadoIRHerd.baseIRRRA;
                            herdAjustado.valorIRUnitario = resultadoIRHerd.valorIRUnitario;
                        }
                        
                        return herdAjustado;
                    });
                }

                if (saldos.cessionarios && saldos.cessionarios.length > 0) {
                    // Cession√°rios do Benefici√°rio
                    if (resultadosAjustados.cessoesBeneficiarioFinais) {
                        resultadosAjustados.cessoesBeneficiarioFinais = resultadosAjustados.cessoesBeneficiarioFinais.map(cess => {
                            const saldoCess = saldos.cessionarios.find(c => 
                                c.nome === cess.cessionario && 
                                c.tipo === 'Cession√°rio do Benefici√°rio'
                            );
                            
                            if (!saldoCess || saldoCess.saldo <= 0) {
                                return cess; // N√£o teve pagamento, mant√©m original
                            }
                            
                            // RECALCULAR Previd√™ncia sobre o novo valor
                            const principalCess = saldoCess.saldo * (resultados.percentualprinc || 0.5);
                            const rraCess = resultadosAjustados.rrapagamento || resultados.rrapagamento;
                            
                            const resultadoPrevCess = calcularPrevidenciaIsolada(dados, principalCess, rraCess);
                            const novaPrevidencia = resultadoPrevCess.valorPrevidencia;
                            
                            // RECALCULAR IR sobre o novo valor
                            const temIR = dados.incidenciaIR || 
                                (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.ir === true));
                            
                            let novoIR = 0;
                            if (temIR && rraCess !== 0) {
                                const resultadoIRCess = calcularIRIsolado(
                                    dados,
                                    saldoCess.saldo,
                                    saldoCess.saldo,
                                    principalCess,
                                    novaPrevidencia,
                                    rraCess
                                );
                                novoIR = resultadoIRCess.valorIR;
                            }
                            
                            return {
                                ...cess,
                                valorBruto: saldoCess.saldo,
                                previdenciaCessao: novaPrevidencia,
                                irCessao: novoIR,
                                valorLiquido: saldoCess.saldo - novaPrevidencia - novoIR
                            };
                        });
                    }
                    
                    // Cession√°rios de Advogados
                    if (resultadosAjustados.honorarios) {
                        resultadosAjustados.honorarios = resultadosAjustados.honorarios.map(adv => {
                            if (!adv.cessionarios || adv.cessionarios.length === 0) {
                                return adv;
                            }
                            
                            return {
                                ...adv,
                                cessionarios: adv.cessionarios.map(cess => {
                                    const saldoCess = saldos.cessionarios.find(c => 
                                        c.nome === cess.nome && 
                                        c.cedente === adv.nome &&
                                        (c.tipo === 'Cession√°rio de Advogado' || c.tipo.includes('Advogado'))
                                    );
                                    
                                    if (!saldoCess || saldoCess.saldo <= 0) {
                                        return cess; // N√£o teve pagamento, mant√©m original
                                    }
                                    
                                    // RECALCULAR IR 
                                    const novoIRCess =0
                                    if (adv.incidenciaIR && saldoCess.saldo > 0) {  
                                        novoIRCess = adv.tipo === 'PF' ? calcularIR(saldoCess.saldo) : saldoCess.saldo * 0.015;
                                    } 
                                    
                                    return {
                                        ...cess,
                                        valorBruto: saldoCess.saldo,
                                        ir: novoIRCess,
                                        valorLiquido: saldoCess.saldo - novoIRCess
                                    };
                                })
                            };
                        });
                    }
                    
                    // Cession√°rios de Advogados Sucumbenciais
                    if (resultadosAjustados.honorariosSucumbenciais?.honorarios) {
                        resultadosAjustados.honorariosSucumbenciais.honorarios = resultadosAjustados.honorariosSucumbenciais.honorarios.map(advSuc => {
                            if (!advSuc.cessionarios || advSuc.cessionarios.length === 0) {
                                return advSuc;
                            }
                            
                            return {
                                ...advSuc,
                                cessionarios: advSuc.cessionarios.map(cess => {
                                    const saldoCess = saldos.cessionarios.find(c => 
                                        c.nome === cess.nome && 
                                        c.cedente === advSuc.nome &&
                                        c.tipo === 'Cession√°rio de Adv. Sucumbencial'
                                    );
                                    
                                    if (!saldoCess || saldoCess.saldo <= 0) {
                                        return cess; // N√£o teve pagamento, mant√©m original
                                    }
                                    
                                    // RECALCULAR IR respeitando incidenciaIR
                                    let novoIRCess = 0;
                                    if (advSuc.incidenciaIR && saldoCess.saldo > 0) {
                                        novoIRCess = advSuc.tipo === 'PF' ? calcularIR(saldoCess.saldo) : saldoCess.saldo * 0.015;
                                    }
                                    
                                    return {
                                        ...cess,
                                        valorBruto: saldoCess.saldo,
                                        ir: novoIRCess,
                                        valorLiquido: saldoCess.saldo - novoIRCess
                                    };
                                })
                            };
                        });
                    }
                    
                    // Cession√°rios de Sindicatos
                    if (resultadosAjustados.sindicatos) {
                        resultadosAjustados.sindicatos = resultadosAjustados.sindicatos.map(sind => {
                            if (!sind.cessionarios || sind.cessionarios.length === 0) {
                                return sind;
                            }
                            
                            return {
                                ...sind,
                                cessionarios: sind.cessionarios.map(cess => {
                                    const saldoCess = saldos.cessionarios.find(c => 
                                        c.nome === cess.nome && 
                                        c.cedente === sind.nome &&
                                        c.tipo === 'Cession√°rio de Sindicato'
                                    );
                                    
                                    if (!saldoCess || saldoCess.saldo <= 0) {
                                        return cess; // N√£o teve pagamento, mant√©m original
                                    }
                                    
                                    // RECALCULAR IR do cession√°rio (mesma regra do sindicato)
                                    let novoIRCess = 0;
                                    if (sind.tipoTributacao === 'pj') {
                                        novoIRCess = saldoCess.saldo * 0.015;
                                    } else if (sind.aliquotaFixaIR) {
                                        novoIRCess = saldoCess.saldo * sind.aliquotaFixaIR;
                                    } else {
                                        novoIRCess = saldoCess.saldo * 0.015;
                                    }
                                    
                                    return {
                                        ...cess,
                                        valorBruto: saldoCess.saldo,
                                        ir: novoIRCess,
                                        valorLiquido: saldoCess.saldo - novoIRCess
                                    };
                                })
                            };
                        });
                    }
                    
                    // Cession√°rios de Herdeiros
                    if (resultadosAjustados.herdeiros) {
                        resultadosAjustados.herdeiros = resultadosAjustados.herdeiros.map(herd => {
                            if (!herd.cessoesHerdeiroFinais || herd.cessoesHerdeiroFinais.length === 0) {
                                return herd;
                            }
                            
                            return {
                                ...herd,
                                cessoesHerdeiroFinais: herd.cessoesHerdeiroFinais.map(cess => {
                                    const saldoCess = saldos.cessionarios.find(c => 
                                        c.nome === cess.cessionario && 
                                        c.cedente === herd.nome &&
                                        c.tipo === 'Cession√°rio de Herdeiro'
                                    );
                                    
                                    if (!saldoCess || saldoCess.saldo <= 0) {
                                        return cess; // N√£o teve pagamento, mant√©m original
                                    }
                                    
                                    // RECALCULAR Previd√™ncia sobre o novo valor
                                    const principalCessHerd = saldoCess.saldo * (resultados.percentualprinc || 0.5);
                                    const rraCessHerd = herd.rrapagamento;
                                    
                                    const resultadoPrevCessHerd = calcularPrevidenciaIsolada(dados, principalCessHerd, rraCessHerd);
                                    const novaPrevidenciaHerd = resultadoPrevCessHerd.valorPrevidencia;
                                    
                                    // RECALCULAR IR sobre o novo valor
                                    const temIR = dados.incidenciaIR || 
                                        (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.ir === true));
                                    
                                    let novoIRHerd = 0;
                                    if (temIR && rraCessHerd !== 0) {
                                        const resultadoIRCessHerd = calcularIRIsolado(
                                            dados,
                                            saldoCess.saldo,
                                            saldoCess.saldo,
                                            principalCessHerd,
                                            novaPrevidenciaHerd,
                                            rraCessHerd
                                        );
                                        novoIRHerd = resultadoIRCessHerd.valorIR;
                                    }
                                    
                                    return {
                                        ...cess,
                                        valorBruto: saldoCess.saldo,
                                        previdenciaCessao: novaPrevidenciaHerd,
                                        irCessao: novoIRHerd,
                                        valorLiquido: saldoCess.saldo - novaPrevidenciaHerd - novoIRHerd
                                    };
                                })
                            };
                        });
                    }
                }
            }
            
            return resultadosAjustados;
        }

        function calcularIRIsolado(dados, valortotatt, valorBase, principalBase, valorPrevidencia, rrapagamentoRecalculado) {
            let valorIR = 0;
            let aliquotaIR = 0;
            let baseIRHonora = 0;
            let baseIRSindi = 0;
            let baseIRPrev = 0;
            let baseIRRRA = 0;
            let valorIRUnitario = 0;
            let principalComDesagio =0;
            let valorDesagioIR = 0;
            let percentualDesagioIR = 0;
            let rraComDesagio = 0;

            const temIR = (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.ir === true));

            if (!temIR || (dados.tipoBeneficiario !== 'pj' && rrapagamentoRecalculado === 0)) {
                return { valorIR, aliquotaIR, baseIRHonora, baseIRSindi, baseIRPrev, principalComDesagio, percentualDesagioIR, rraComDesagio, baseIRRRA, valorIRUnitario };
            }

            const percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            const percentualTotalSind = dados.tipoCalculo === 'preferencia' ? 0 : 
                dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);

            if (dados.natureza === 'comum' && dados.tipoBeneficiario === 'pj') {
                // PESSOA JUR√çDICA
                const baseIRPJ = valortotatt - (valortotatt * percentualTotalAdv) - (valortotatt * percentualTotalSind);
                valorIR = baseIRPJ * 0.03;
                aliquotaIR = 0.03;
                valorIRUnitario = valorIR; 
                
                if (dados.tipoCalculo === 'acordo') {
                    percentualDesagioIR = dados.percentualAcordo || 0;
                    const valorDesagioIR = valorIR * percentualDesagioIR;
                    valorIR = valorIR - valorDesagioIR;
                    valorIRUnitario = valorIR;
                }
                
                baseIRHonora = baseIRSindi = baseIRPrev = baseIRRRA = 1;
            } else {
                // PESSOA F√çSICA
                baseIRHonora = principalBase - (principalBase * percentualTotalAdv);
                // Base 2: Sem sindicatos
                baseIRSindi = baseIRHonora - (principalBase * percentualTotalSind);
                // Base 3: Com des√°gio (se acordo)
                principalComDesagio = baseIRSindi;
                if (dados.tipoCalculo === 'acordo') {
                    percentualDesagioIR = dados.percentualAcordo || 0;
                    const valorDesagioIR = baseIRSindi * percentualDesagioIR;
                    principalComDesagio = baseIRSindi - valorDesagioIR;
                }

                // Recalcular RRA baseado no des√°gio
                percentualDesagioIR = dados.percentualAcordo || 0;
                //const proporcaoSemDesagio = 1 - percentualDesagioIR; sem desagio no rra.
                rraComDesagio = dados.rra !== 0 ? Math.max(1, rrapagamentoRecalculado) : 0;
                // Base 4: Sem previd√™ncia
                baseIRPrev = principalComDesagio - valorPrevidencia;
                // Base 5: Por RRA
                baseIRRRA = baseIRPrev / rraComDesagio;
                // Calcular IR final
                valorIRUnitario = calcularIR(baseIRRRA);
                valorIR = valorIRUnitario * rraComDesagio;
                aliquotaIR = obterAliquotaIR(baseIRRRA);
            }
            return {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                principalComDesagio,
                percentualDesagioIR, 
                rraComDesagio,
                baseIRRRA,
                valorIRUnitario,
            };
        }

        function calcularIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return (valorBruto * 0.075) - 182.16;
            else if (valorBruto <= 3751.05) return (valorBruto * 0.15) - 394.16;
            else if (valorBruto <= 4664.68) return (valorBruto * 0.225) - 675.49;
            else return (valorBruto * 0.275) - 908.73;
        }

        function obterAliquotaIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return 0.075;
            else if (valorBruto <= 3751.05) return 0.15;
            else if (valorBruto <= 4664.68) return 0.225;
            else return 0.275;
        }

        /**
         * Arredondamento espec√≠fico para RRA conforme legisla√ß√£o
         * Regras:
         * - < 5: mant√©m a 1¬™ casa decimal
         * - > 5: adiciona 1 √† 1¬™ casa decimal  
         * - = 5: analisa a 3¬™ casa decimal:
         *   - 3¬™ casa entre 0-4: mant√©m a 1¬™ casa decimal
         *   - 3¬™ casa entre 5-9: adiciona 1 √† 1¬™ casa decimal
         */
        function arredondarRRA(valor) {
            if (typeof valor !== 'number' || isNaN(valor)) {
                return 0;
            }
            // Converter para string para analisar d√≠gito por d√≠gito
            const valorStr = valor.toFixed(3); // Garantir 3 casas decimais
            const partes = valorStr.split('.');
            
            if (partes.length !== 2) {
                return Math.round(valor * 10) / 10; // Fallback para arredondamento normal
            }
            
            const parteInteira = partes[0];
            const parteDecimal = partes[1].padEnd(3, '0'); // Garantir 3 d√≠gitos decimais
            
            const primeiraDecimal = parseInt(parteDecimal[0]);
            const segundaDecimal = parseInt(parteDecimal[1]);
            const terceiraDecimal = parseInt(parteDecimal[2]);
            
            let novaParteDecimal = primeiraDecimal;
            
            if (segundaDecimal < 5) {
                // Regra I: menor que 5, mant√©m a 1¬™ casa decimal
                novaParteDecimal = primeiraDecimal;
            } else if (segundaDecimal > 5) {
                // Regra II: maior que 5, adiciona 1 √† 1¬™ casa decimal
                novaParteDecimal = primeiraDecimal + 1;
            } else if (segundaDecimal === 5) {
                // Regra III: igual a 5, analisar a 3¬™ casa decimal
                if (terceiraDecimal >= 0 && terceiraDecimal <= 4) {
                    // III.a: 3¬™ casa entre 0-4, mant√©m a 1¬™ casa decimal
                    novaParteDecimal = primeiraDecimal;
                } else if (terceiraDecimal >= 5 && terceiraDecimal <= 9) {
                    // III.b: 3¬™ casa entre 5-9, adiciona 1 √† 1¬™ casa decimal
                    novaParteDecimal = primeiraDecimal + 1;
                }
            }
            // Tratar caso onde a soma ultrapassa 9
            if (novaParteDecimal >= 10) {
                const novaParteInteira = parseInt(parteInteira) + 1;
                novaParteDecimal = novaParteDecimal - 10;
                return parseFloat(`${novaParteInteira}.${novaParteDecimal}`);
            }
            
            return parseFloat(`${parteInteira}.${novaParteDecimal}`);
        }

        function calcularPrevidenciaIsolada(dados, principalBase, rrapagamento) {
            let valorPrevidencia = 0;
            let aliquotaEfetiva = 0;
            let valorDesagioPrevidencia = 0;
            let percentualDesagioPrevidencia = 0;

            if (dados.tipoBeneficiario === 'pj') {
                return { 
                    valorPrevidencia: 0, 
                    aliquotaEfetiva: 0,
                    valorDesagioPrevidencia: 0,
                    percentualDesagioPrevidencia: 0
                };
            }
            
            const deveCalcularPrevidencia = dados.incidenciaPrevidencia || 
                (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.previdencia));
            
            if (deveCalcularPrevidencia) {
                let tipoPrevidencia = 'inss'; 
                let aliquotaFixa = 0;

                const itemComPrevidencia = dados.valoresPrincipais.find(item => item.tributacao?.previdencia);

                if (itemComPrevidencia) {
                    tipoPrevidencia = itemComPrevidencia.tributacao.tipoPrevidencia || 'inss';
                    aliquotaFixa = itemComPrevidencia.tributacao.aliquotaFixa || 0;
                } else {
                    tipoPrevidencia = dados.tipoPrevidencia || 'inss';
                    aliquotaFixa = dados.aliquotaFixa || 0;
                }

                if (tipoPrevidencia === 'fixa') {
                    valorPrevidencia = principalBase * aliquotaFixa;
                    aliquotaEfetiva = aliquotaFixa;
                } else {
                    const base = rrapagamento === 0 ? principalBase : principalBase / rrapagamento;
                    const resultadoINSS = calcularINSS(base);
                    valorPrevidencia = resultadoINSS * (rrapagamento || 1);
                    aliquotaEfetiva = base > 0 ? resultadoINSS / base : 0;
                }

                if (dados.tipoCalculo === 'acordo') {
                    percentualDesagioPrevidencia = dados.percentualAcordo || 0;
                    valorDesagioPrevidencia = valorPrevidencia * percentualDesagioPrevidencia;
                    valorPrevidencia = valorPrevidencia - valorDesagioPrevidencia;
                }
            }
            return { valorPrevidencia, aliquotaEfetiva, valorDesagioPrevidencia, percentualDesagioPrevidencia };
        }

        function calcularINSS(base) {
            if (base <= 1518.00) return base * 0.075;
            else if (base <= 2793.88) return 1518 * 0.075 + (base - 1518) * 0.09;
            else if (base <= 4190.83) return 1518 * 0.075 + 1275.88 * 0.09 + (base - 2793.88) * 0.12;
            else if (base <= 8157.41) return 1518 * 0.075 + 1275.88 * 0.09 + 1396.95 * 0.12 + (base - 4190.83) * 0.14;
            else return 951.63; // Teto
        }

        function exibirResultados(resultados, dados) {
            const container = document.getElementById('resultadosContent');
            const dataAtual = obterDataAtual();
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);

            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            const somenteHonorarioSucumbencial = dados.somenteHonorarioSucumbencial;

            let html = `
                ${gerarCabecalhoProcesso(dados, resultados, dataAtual)}
                ${gerarDemonstrativoValores(dados, resultados, dataAtual)}
                ${gerarCalculos(dados, resultados, inicioGraca, fimGraca)}
                ${gerarResumoCalculos(resultados,dados)}
            `;

            if (somenteHonorarioSucumbencial) {
                // Exibi√ß√£o espec√≠fica para sucumbencial
                html += `
                    ${gerarSecaoHonorariosSucumbenciais(resultados, dados)}
                    ${gerarSecaoCessoesHonorariosSucumbenciais(resultados, dados)}
                    ${gerarSecaoPagamentosOcorridos(resultados, dados)}
                    ${gerarDemonstrativoSaldoRemanescente(resultados)}
                    ${gerarTabelaHonorariosSucumbenciais(resultados, dados)}
                    <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                        <h4>üìã Notas sobre Tributa√ß√£o do Imposto de Renda:</h4>
                        <p style="margin: 5px 0;"><strong>Advogados Pessoa F√≠sica (PF):</strong> üè¶ LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</p>
                        <p style="margin: 5px 0;"><strong>Advogados Pessoa Jur√≠dica (PJ):</strong> üè¶ DECRETO 9.580, ART 714</p>
                    </div>
                `;
            } else {
                // Exibi√ß√£o normal (benefici√°rio, herdeiros, etc.)
                html += `
                    ${gerarSecaoHonorariosSucumbenciais(resultados, dados)}
                    ${gerarSecaoCessoesHonorariosSucumbenciais(resultados, dados)}

                    ${gerarSecaoDeducoesAcessorias(resultados, dados)}
                    ${gerarSecaoCessoesSindicatos(resultados, dados)}
                    ${gerarSecaoCessoesAdvogados(resultados, dados)}

                    ${gerarSecaoPagamentosOcorridos(resultados, dados)}
                    ${gerarDemonstrativoSaldoRemanescente(resultados)}

                    ${gerarSecaoCessoesBeneficiario(resultados, dados)}
                    ${temHerdeiros ? gerarSecaoHerdeiros(resultados, dados) : ''}
                    ${gerarSecaoCessoesHerdeiros(resultados, dados)} 
                    
                    ${gerarSecaoDeducoes(resultados, dados)}
                    ${gerarSecoesPagamentos(resultados, dados)}
                `;
            }

            html += `
                ${gerarSecaoNotasExplicativas()}
                ${gerarBotaoImprimir()}
            `;
            
            container.innerHTML = html;
            showTab('tab7');

            setTimeout(() => {
                const tabResultados = document.getElementById('tab7');
                if (tabResultados) {
                    tabResultados.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                };
            }, 100);
        }
        //${gerarIndicesUtilizados(dados, resultados, inicioGraca, fimGraca)} - tirei para melhorar apresenta√ß√£o
        function obterDataAtual() {
            const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
            const [ano, mes, dia] = dataAtualizacaoInput.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function formatarData(data) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                        'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return `${meses[data.getMonth()]}/${data.getFullYear()}`;
        }

        function formatarMoeda(valor) {
            if (valor === null || valor === undefined || valor === '' || isNaN(valor)) {
                return '0,00';
            }
            
            const numeroValido = parseFloat(valor) || 0;
            return `${numeroValido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function gerarCabecalhoProcesso(dados, resultados, dataAtual) {
            const secaoRRA = resultados.rraTotal && resultados.rraTotal !== 0 
                ? `<tr><td>Rendimentos Recebidos Acumuladamente Total (RRA):</td><td>${resultados.rraTotal} meses</td></tr>`
                : '';

                const tipos = {
                ordem: "Ordem Cronol√≥gica",
                preferencia: "Preferencial",
                acordo: "Acordo",
                parcial: "Parcial"
            };

            const tipoCalculo = tipos[dados.tipoCalculo] || "N√£o definido";

            let secaoDataBase = '';
            if (dados.valoresPrincipais && dados.valoresPrincipais.length > 0) {
                const datasBase = new Set();
                dados.valoresPrincipais.forEach(item => {
                    if (item.mesBase && item.anoBase) {
                        datasBase.add(`${item.mesBase}/${item.anoBase}`);
                    }
                });
                
                const datasUnicas = Array.from(datasBase);
                
                if (datasUnicas.length === 1) {
                    // Uma √∫nica data base
                    secaoDataBase = `<tr><td>Data-base do c√°lculo homologado na execu√ß√£o</td><td>${datasUnicas[0]}</td></tr>`;
                } else if (datasUnicas.length > 1) {
                    // M√∫ltiplas datas base
                    secaoDataBase = `<tr><td>Datas-base dos c√°lculos homologados</td><td>${datasUnicas.join(', ')}</td></tr>`;
                } else {
                    secaoDataBase = `<tr><td>Data-base do c√°lculo homologado na execu√ß√£o</td><td>N√£o informado</td></tr>`;
                }
            } else {
                secaoDataBase = `<tr><td>Data-base do c√°lculo homologado na execu√ß√£o</td><td>N√£o informado</td></tr>`;
            }
            
            return `
                <div class="table-container">
                    <h3>üìã Identifica√ß√£o do Processo</h3>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Informa√ß√£o</th></tr>
                        <tr><td>N√∫mero do Processo</td><td>${dados.numProcesso || 'N√£o informado'}</td></tr>
                        <tr><td>Ano do or√ßamento do Precat√≥rio</td><td>${dados.anoOrcamento || 'N√£o informado'}</td></tr>
                        <tr><td>Natureza do Processo</td><td>${dados.natureza === 'alimentar' ? '‚öñÔ∏è Alimentar' : '‚öñÔ∏è Comum'}</td></tr>
                        ${secaoRRA}
                        ${secaoDataBase}
                        <tr><td>Benefici√°rio Principal</td><td>${dados.beneficiario || 'N√£o informado'}</td></tr>
                        <tr><td>Devedor</td><td>${dados.credor || 'N√£o informado'}</td></tr>
                        <tr><td>Data do C√°lculo</td><td>${dataAtual}</td></tr>
                        <tr><td>Tipo de C√°lculo</td><td>${tipoCalculo}</td></tr>
                    </table>
                </div>
            `;
        }

        function gerarDemonstrativoValores(dados, resultados, dataAtual) {
            const indiceTotal = isNaN(resultados.indiceTotal) ? '1' : resultados.indiceTotal.toFixed(6);
    
            //  Calcular valores originais totais - EXCLUINDO valores negativos
            const valorPrincipalOriginal = (dados.valoresPrincipais || []).reduce((sum, item) => {
                const valor = parseFloat(item.valorPrincipal) || 0;
                return sum + (valor > 0 ? valor : 0); 
            }, 0);
            
            const valorJurosOriginal = (dados.valoresPrincipais || []).reduce((sum, item) => {
                const valor = parseFloat(item.valorJuros) || 0;
                return sum + (valor > 0 ? valor : 0);
            }, 0);
            
            const valorTotalOriginal = valorPrincipalOriginal + valorJurosOriginal;

            let textoDataBase = 'N√£o informado';
            if (dados.valoresPrincipais && dados.valoresPrincipais.length > 0) {
                const datasBase = new Set();
                dados.valoresPrincipais.forEach(item => {
                    if (item.mesBase && item.anoBase) {
                        datasBase.add(`${item.mesBase}/${item.anoBase}`);
                    }
                });
                
                const datasUnicas = Array.from(datasBase);
                
                if (datasUnicas.length === 1) {
                    textoDataBase = datasUnicas[0];
                } else if (datasUnicas.length > 1) {
                    textoDataBase = datasUnicas.join(', ');
                }
            }

            return `
                <div class="table-container">
                    <h3>üí∞ Demonstrativo de Atualiza√ß√£o Monet√°ria</h3>
                    <table>
                        <tr>
                            <th>Componente</th>
                            <th>Valor Hist√≥rico (${textoDataBase})</th>
                            <th>Corre√ß√£o Aplicada*</th>
                            <th>Valor Atualizado (${dataAtual})</th>
                        </tr>
                        <tr>
                            <td>Principal</td>
                            <td>R$ ${formatarMoeda(valorPrincipalOriginal)}</td>
                            <td>${indiceTotal}</td>
                            <td>R$ ${formatarMoeda(resultados.valorprincatt)}</td>
                        </tr>
                        <tr>
                            <td>Juros</td>
                            <td>R$ ${formatarMoeda(valorJurosOriginal)}</td>
                            <td>${indiceTotal}</td>
                            <td>R$ ${formatarMoeda(resultados.valorjurosatt)}</td>
                        </tr>
                        <tr class="highlight">
                            <td><strong>Total Atualizado</strong></td>
                            <td><strong>R$ ${formatarMoeda(valorTotalOriginal)}</strong></td>
                            <td><strong>-</strong></td>
                            <td><strong>R$ ${formatarMoeda(resultados.valortotatt)}</strong></td>
                        </tr>
                    </table>
                    <div class="success-box" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                        *Atualiza√ß√£o Monet√°ria conforme Resolu√ß√£o CNJ n¬∫ 303/2019, com √≠ndices de corre√ß√£o monet√°ria, conforme caput do Art.21- A - <strong>Per√≠odo de Corre√ß√£o</strong>: Os valores foram atualizados desde a base <strong>${textoDataBase}</strong> at√© <strong>${dataAtual}</strong>.
                    </div>
                </div>
            `;
        }

        /*function gerarIndicesUtilizados(dados, resultados, inicioGraca, fimGraca) {
            const inicioGracaFormatado = formatarData(inicioGraca);
            const fimGracaFormatado = formatarData(fimGraca);
            
            let linhasSelicHTML = '';
            if (resultados.dadosSelic.temSelicAntes) {
                linhasSelicHTML += `
                <tr>
                    <td>SELIC Antes da Gra√ßa</td>
                    <td>${resultados.dadosSelic.indiceSelicAntes.toFixed(6)}</td>
                    <td>${resultados.dadosSelic.periodoAntesGraca}</td>
                </tr>`;
            }
            if (resultados.dadosSelic.temSelicApos) {
                linhasSelicHTML += `
                <tr>
                    <td>SELIC Ap√≥s a Gra√ßa</td>
                    <td>${resultados.dadosSelic.indiceSelicApos.toFixed(6)}</td>
                    <td>${resultados.dadosSelic.periodoAposGraca}</td>
                </tr>`;
            }
            linhasSelicHTML += `
            <tr class="selic-acumulada">
                <td>SELIC Acumulada</td>
                <td>${resultados.dadosSelic.indiceselic.toFixed(6)}</td>
                <td>Total dos per√≠odos aplic√°veis</td>
            </tr>`;
            
            return `
                <div class="table-container">
                    <h3>üìä √çndices Utilizados</h3>
                    <table>
                        <tr><th>√çndice</th><th>Valor</th><th>Per√≠odo/Observa√ß√£o</th></tr>
                        <tr><td>√çndice CNJ</td><td>${resultados.indicesCNJ.toFixed(6)}</td><td>${dados.mesBase}/${dados.anoBase}</td></tr>
                        ${linhasSelicHTML}
                        <tr><td>IPCA-e Acumulado</td><td>${resultados.indiceipca.toFixed(6)}</td><td>Per√≠odo de Gra√ßa: ${inicioGracaFormatado} - ${fimGracaFormatado}</td></tr>
                        <tr><td>Juros de Mora</td><td>${resultados.jurosmora.toFixed(6)}</td><td>Natureza: ${dados.natureza}</td></tr>
                    </table>
                </div>
            `;
        }*/

        function gerarCalculos(dados, resultados, inicioGraca, fimGraca) {
            const inicioGracaFormatado = formatarData(inicioGraca);
            const fimGracaFormatado = formatarData(fimGraca);
            
            let memoriaisCalculos = '';

            const temSelicInformado = dados.valoresPrincipais?.some(item => 
                (item.tipoSelic === 'valor' && item.valorSelic > 0) || 
                (item.tipoSelic === 'percentual' && item.percentualSelic > 0)
            );

            const temJurosMora = dados.valoresPrincipais?.some(item => 
                item.indices.jurosMora && (resultados.itensCalculados?.find(calc => calc.id === item.id)?.jurosMoraCalculado || 0) > 0
            );
            
            // Para cada item, gerar memorial de c√°lculo individual
            if (dados.valoresPrincipais && dados.valoresPrincipais.length > 0) {
                const isSingleItem = dados.valoresPrincipais.length === 1;
                
                dados.valoresPrincipais.forEach((item, index) => {
                    const itemCalculado = resultados.itensCalculados?.find(calc => calc.id === item.id) || {};
                    
                    // Pegar os √≠ndices espec√≠ficos deste item
                    const indicesCNJ = itemCalculado.indices?.cnj || 1;
                    const indiceSelic = itemCalculado.indices?.selic || 1;
                    const indiceIpca = itemCalculado.indices?.ipca || 1;
                    const jurosMora = itemCalculado.indices?.jurosMora || 0;
                    
                    // C√°lculos passo a passo para este item
                    const principalCNJ = item.valorPrincipal * indicesCNJ;
                    const principalIPCA = principalCNJ * indiceIpca;
                    const principalFinal = itemCalculado.valorAtualizado?.principal || 0;
                    
                    const jurosOriginaisCNJ = item.valorJuros * indicesCNJ;
                    const valorJurosMora = itemCalculado.jurosMoraCalculado || 0;
                    const totalJuros = jurosOriginaisCNJ + valorJurosMora;
                    const totalJurosIPCA = totalJuros * indiceIpca;
                    const jurosFinal = itemCalculado.valorAtualizado?.juros || 0;

                    const temJurosIniciais = item.valorJuros && parseFloat(item.valorJuros) !== 0;
                    const temJurosMora = item.indices.jurosMora && valorJurosMora !== 0;
                    const temAlgumJuros = temJurosIniciais || temJurosMora;
                    
                    // T√≠tulo e detalhes condicionais
                    const titulo = isSingleItem ? 
                        'üî¢ MEMORIAL DE C√ÅLCULOS' : 
                        `üî¢ MEMORIAL DE C√ÅLCULOS - ${item.descricao || `Item ${index + 1}`}`;
                    
                    const detalhesItem = isSingleItem ? '' : `
                        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                            <strong>Base:</strong> ${item.mesBase}/${item.anoBase} | 
                            <strong>√çndices aplicados:</strong> ${Object.entries(item.indices || {})
                                .filter(([key, value]) => value)
                                .map(([key]) => key.toUpperCase())
                                .join(', ')}
                        </div>
                    `;
                    
                    const totalDoItem = isSingleItem ? '' : `
                        <div class="highlight" style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
                            <strong>TOTAL DESTE ITEM:</strong> R$ ${formatarMoeda(principalFinal)} + R$ ${formatarMoeda(jurosFinal)} = <strong>R$ ${formatarMoeda((principalFinal || 0) + (jurosFinal || 0))}</strong>
                        </div>
                    `;

                    const secaoJuros = temAlgumJuros ? `
                        <h4>‚öñÔ∏è Atualiza√ß√£o dos Juros - Passo a Passo</h4>
                        <table>
                            <tr><th>Etapa</th><th>C√°lculo</th><th>Valor</th></tr>
                            <tr>
                                <td>1. Juros Originais</td>
                                <td>Juros Homologado</td>
                                <td>R$ ${formatarMoeda(item.valorJuros)}</td>
                            </tr>
                            ${item.indices.cnj ? `
                            <tr>
                                <td>2. Corre√ß√£o CNJ</td>
                                <td>R$ ${formatarMoeda(item.valorJuros)} √ó ${indicesCNJ.toFixed(6)}</td>
                                <td>R$ ${formatarMoeda(jurosOriginaisCNJ)}</td>
                            </tr>` : ''}
                            ${item.indices.jurosMora && valorJurosMora > 0 ? `
                            <tr>
                                <td>3. Juros de Mora</td>
                                <td>Principal CNJ √ó ${(jurosMora * 100).toFixed(4)}%*</td>
                                <td>R$ ${formatarMoeda(valorJurosMora)}</td>
                            </tr>
                            <tr>
                                <td>4. Total Juros (CNJ + Mora)</td>
                                <td>R$ ${formatarMoeda(jurosOriginaisCNJ)} + R$ ${formatarMoeda(valorJurosMora)}</td>
                                <td>R$ ${formatarMoeda(totalJuros)}</td>
                            </tr>` : ''}
                            ${item.indices.ipca ? `
                            <tr>
                                <td>${item.indices.jurosMora ? '5' : '3'}. Aplica√ß√£o IPCA (gra√ßa - ${inicioGracaFormatado} - ${fimGracaFormatado})</td>
                                <td>R$ ${formatarMoeda(totalJuros)} √ó ${indiceIpca.toFixed(6)}</td>
                                <td>R$ ${formatarMoeda(totalJurosIPCA)}</td>
                            </tr>` : ''}
                            ${item.indices.selic ? `
                            <tr>
                                <td>${item.indices.jurosMora && item.indices.ipca ? '6' : item.indices.ipca ? '4' : '3'}. Aplica√ß√£o SELIC (exclu√≠do a gra√ßa)</td>
                                <td>R$ ${formatarMoeda(totalJurosIPCA)} √ó ${indiceSelic.toFixed(6)}</td>
                                <td><strong>R$ ${formatarMoeda(jurosFinal)}</strong></td>
                            </tr>` : `
                            <tr>
                                <td>Final</td>
                                <td>Valor Final dos Juros</td>
                                <td><strong>R$ ${formatarMoeda(jurosFinal)}</strong></td>
                            </tr>`}
                        </table>
                    ` : '';
                    
                    memoriaisCalculos += `
                        <div class="table-container" style="margin-top: 20px;">
                            <h3>${titulo}</h3>
                            ${detalhesItem}
                            
                            <h4>üí∞ Atualiza√ß√£o do Principal - Passo a Passo</h4>
                            <table>
                                <tr><th>Etapa</th><th>C√°lculo</th><th>Valor</th></tr>
                                <tr>
                                    <td>1. Valor Original</td>
                                    <td>Principal Homologado</td>
                                    <td>R$ ${formatarMoeda(item.valorPrincipal)}</td>
                                </tr>
                                ${item.indices.cnj ? `
                                <tr>
                                    <td>2. Corre√ß√£o CNJ</td>
                                    <td>R$ ${formatarMoeda(item.valorPrincipal)} √ó ${indicesCNJ.toFixed(6)}</td>
                                    <td>R$ ${formatarMoeda(principalCNJ)}</td>
                                </tr>` : ''}
                                ${item.indices.ipca ? `
                                <tr>
                                    <td>3. Aplica√ß√£o IPCA (gra√ßa - ${inicioGracaFormatado} - ${fimGracaFormatado})</td>
                                    <td>R$ ${formatarMoeda(principalCNJ)} √ó ${indiceIpca.toFixed(6)}</td>
                                    <td>R$ ${formatarMoeda(principalIPCA)}</td>
                                </tr>` : ''}
                                ${item.indices.selic ? `
                                <tr>
                                    <td>4. Aplica√ß√£o SELIC (exclu√≠do a gra√ßa)</td>
                                    <td>R$ ${formatarMoeda(principalIPCA)} √ó ${indiceSelic.toFixed(6)}</td>
                                    <td><strong>R$ ${formatarMoeda(principalFinal)}</strong></td>
                                </tr>` : `
                                <tr>
                                    <td>Final</td>
                                    <td>Valor Final do Principal</td>
                                    <td><strong>R$ ${formatarMoeda(principalFinal)}</strong></td>
                                </tr>`}
                            </table>
                            
                            ${secaoJuros}
                            
                            ${totalDoItem}
                        </div>
                    `;
                });
            }

            let notaSelicInformado = '';
            if (temSelicInformado) {
                const itensComSelic = dados.valoresPrincipais.filter(item => 
                    (item.tipoSelic === 'valor' && item.valorSelic > 0) || 
                    (item.tipoSelic === 'percentual' && item.percentualSelic > 0)
                );
                
                const notasItens = itensComSelic.map(item => {
                    const itemCalculado = resultados.itensCalculados?.find(calc => calc.id === item.id) || {};
                    const indiceSelic = itemCalculado.indices?.selic || 1;
                    
                    const percentualTotal = ((indiceSelic - 1) * 100).toFixed(2);
                    
                    let percentualInformado;
                    if (item.tipoSelic === 'valor') {
                        const totalBase = item.valorPrincipal + item.valorJuros;
                        percentualInformado = totalBase > 0 ? ((item.valorSelic / totalBase) * 100).toFixed(4) : 0;
                    } else {
                        percentualInformado = (item.percentualSelic * 100).toFixed(2);
                    }
                    
                    const percentualAutomatico = (parseFloat(percentualTotal) - parseFloat(percentualInformado)).toFixed(2);
                    
                    const dataBase = criarDataBase(item.mesBase, item.anoBase);
                    const dataInicio = new Date(dataBase);
                    if (item.mesReferenciaSelic === 'mesAnterior') {
                        
                    } else {
                        // Se SELIC informado √© do mesmo m√™s, come√ßar do m√™s seguinte
                        dataInicio.setMonth(dataInicio.getMonth() + 1);
                    }

                    const dataAtualizacaoInput = document.getElementById('dataatualizacao').value;
                    const dataFim = new Date(dataAtualizacaoInput);
                    
                    const periodoInicio = `${String(dataInicio.getMonth() + 1).padStart(2, '0')}/${dataInicio.getFullYear()}`;
                    const periodoFim = `${String(dataFim.getMonth() + 1).padStart(2, '0')}/${dataFim.getFullYear()}`;
                    
                    return `SELIC: ${percentualInformado}% C√°lculo Homologado (${item.mesBase}/${item.anoBase}) +  ${percentualAutomatico}% (${periodoInicio} a ${periodoFim}) = ${percentualTotal}% total`;
                }).join('; ');
                
                notaSelicInformado = `*${notasItens}.<br>`;
            }
            
            return `
                ${memoriaisCalculos}
                ${(notaSelicInformado || temJurosMora) ? `
                <div class="success-box" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                    ${notaSelicInformado}${temJurosMora ? '*Juros calculados de forma simples (at√© Novembro/2021), conforme art. 1¬∫ da Lei n¬∫ 12.703/2012; art. 1¬∫, "F", da Lei n¬∫ 9.494/1997; art. 100, ¬ß 12¬∫ da CF/88, Art.22 da Resolu√ß√£o 303 do CNJ e SV n¬∫ 17 do STF.' : ''}
                </div>` : ''}
            `;
        }

        function gerarResumoCalculos(resultados, dados) {
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;

            const temTributacaoMista = resultados.tributacaoIR && 
                resultados.tributacaoIR.isento > 0 && 
                resultados.tributacaoIR.principalTributado > 0;

            let basesPagamento = '';

            if (dados.somenteHonorarioSucumbencial && dados.tipoCalculo === 'parcial') {
                // Quando √© somente honor√°rio sucumbencial no pagamento parcial
                basesPagamento = `
                    <tr class="highlight">
                        <td><strong>Valor Dispon√≠vel para Pagamento</strong></td>
                        <td><strong>R$ ${formatarMoeda(dados.saldoParcial)}</strong></td>
                        <td><strong>100,00%</strong></td>
                    </tr>
                `;
            } else if (temHerdeiros && dados.tipoCalculo === 'preferencia') {
                // Prefer√™ncia ‚Üí discrimina os herdeiros
                const herdeirosParaMostrar = resultados.herdeiros.filter(h => h.temPreferencia);
                if (herdeirosParaMostrar.length > 0) {
                    basesPagamento = `
                        <tr class="highlight">
                            <td colspan="3"><strong>Base para Pagamento</strong></td>
                        </tr>
                        ${herdeirosParaMostrar.map(h => `
                            <tr class="highlight">
                                <td><strong>${h.nome}</strong></td>
                                <td><strong>R$ ${formatarMoeda(h.valorTotal)}</strong></td>
                                <td><strong>${((h.valorTotal / resultados.valortotatt) * 100).toFixed(2)}%</strong></td>
                            </tr>
                        `).join('')}
                    `;
                }
            } else {
                // Ordem ou sem herdeiros ‚Üí apenas a base do benefici√°rio principal
                basesPagamento = `
                    <tr class="highlight">
                        <td><strong>Base para Pagamento</strong></td>
                        <td><strong>R$ ${formatarMoeda(resultados.valorBase)}</strong></td>
                        <td><strong>${((resultados.valorBase / resultados.valortotatt) * 100).toFixed(2)}%</strong></td>
                    </tr>
                `;
            }

            let linhasPrincipais = `
                <tr>
                    <td>Valor Principal Atualizado</td>
                    <td>R$ ${formatarMoeda(resultados.valorprincatt)}</td>
                    <td>${(resultados.percentualprinc * 100).toFixed(4)}%</td>
                </tr>
                ${temTributacaoMista ? `
                <tr style="color: #666;font-size: 0.92em;">
                    <td style="padding-left: 20px;">‚Ü≥ Principal Tribut√°vel</td>
                    <td>‚Ü≥ R$ ${formatarMoeda(resultados.tributacaoIR.principalTributado)} (${((resultados.tributacaoIR.principalTributado / resultados.valortotatt) * 100).toFixed(4)}%)</td>
                    <td>-</td>
                </tr>
                ` : ''}
                <tr>
                    <td>Valor Juros Atualizado</td>
                    <td>R$ ${formatarMoeda(resultados.valorjurosatt)}</td>
                    <td>${(resultados.percentualjur * 100).toFixed(4)}%</td>
                </tr>
            `;

            return `
                <div class="table-container">
                    <h3>üìà Resumo dos C√°lculos</h3>
                    <table>
                        <tr><th>Descri√ß√£o</th><th>Valor</th><th>%</th></tr>
                        ${linhasPrincipais}
                        <tr>
                            <td><strong>Total Atualizado</strong></td>
                            <td><strong>R$ ${formatarMoeda(resultados.valortotatt)}</strong></td>
                            <td><strong>${((resultados.percentualprinc + resultados.percentualjur) * 100).toFixed(2)}%</strong></td>
                        </tr>
                        ${basesPagamento}
                    </table>
                </div>
            `;
        }

        function gerarSecaoHonorariosSucumbenciais(resultados, dados) {
            if (!resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais || 
                !resultados.honorariosSucumbenciais?.honorarios?.length) {
                return '';
            }

            if (dados.honorarioSucumbencial?.advogados?.some(adv => adv.tipoHonorario === 'valorPrincipal')) {
                return '';
            }

            const honorarios = resultados.honorariosSucumbenciais.honorarios;
            const valorBaseSucumbencial = resultados.honorariosSucumbenciais.valorBaseSucumbencial;

            let linhasAdvogados = '';
            let totalHonorariosBrutos = 0;
            
            honorarios.forEach((adv, index) => {
                const percentualExibicao = adv.tipoHonorario === 'percentual' 
                    ? `${(adv.percentual * 100).toFixed(2)}%`
                    : '100,00%';
                    
                // Calcular valor bruto original (antes da prefer√™ncia)
                let valorBrutoOriginal = 0;
                if (adv.tipoHonorario === 'percentual') {
                    valorBrutoOriginal = valorBaseSucumbencial * adv.percentual;
                } else if (adv.tipoHonorario === 'valorPrincipal') {
                    valorBrutoOriginal = valorBaseSucumbencial;
                }
                
                totalHonorariosBrutos += valorBrutoOriginal;
                
                linhasAdvogados += `
                    <tr>
                        <td>${adv.nome}</td>
                        <td>R$ ${formatarMoeda(valorBaseSucumbencial)}</td>
                        <td>${percentualExibicao}</td>
                        <td>R$ ${formatarMoeda(valorBrutoOriginal)}</td>
                    </tr>
                `;
            });

            return `
                <div class="table-container">
                    <h3>üíº Honor√°rios Sucumbenciais</h3>
                    
                    <table>
                        <tr>
                            <th>Advogado</th>
                            <th>Base de C√°lculo</th>
                            <th>Percentual</th>
                            <th>Valor Bruto</th>
                        </tr>
                        ${linhasAdvogados}
                        <tr class="highlight">
                            <td colspan="3"><strong>Total dos Honor√°rios Sucumbenciais</strong></td>
                            <td><strong>R$ ${formatarMoeda(totalHonorariosBrutos)}</strong></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function gerarSecaoCessoesHonorariosSucumbenciais(resultados, dados) {
            // Verificar se tem honor√°rios sucumbenciais
            if (!resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais || 
                !resultados.honorariosSucumbenciais?.honorarios?.length) {
                return '';
            }

            const honorarios = resultados.honorariosSucumbenciais.honorarios;
            const valorBaseSucumbencial = resultados.honorariosSucumbenciais.valorBaseSucumbencial;
            
            // Filtrar apenas advogados que t√™m cess√µes
            const advogadosComCessoes = honorarios.filter(adv => adv.temCessoes && adv.cessionarios?.length > 0);
            
            if (advogadosComCessoes.length === 0) {
                return '';
            }

            let secoesCessoes = '';

            advogadosComCessoes.forEach(adv => {
                // Calcular valor bruto original do honor√°rio
                let valorHonorarioTotal = 0;
                if (adv.tipoHonorario === 'percentual') {
                    valorHonorarioTotal = valorBaseSucumbencial * adv.percentual;
                } else if (adv.tipoHonorario === 'valorPrincipal') {
                    valorHonorarioTotal = valorBaseSucumbencial;
                }

                // Calcular total cedido
                const totalCedido = adv.percentualCessionarioAdv || 0;
                const listaCessionarios = adv.cessionarios?.map(c => c.nome).join(', ') || '';

                // Gerar linhas dos recebedores
                let linhasRecebedores = '';
                
                // Advogado (o que sobra ap√≥s cess√µes)
                const percentualAdvogado = adv.percentualAdvogado || (1 - totalCedido);
                const valorAdvogado = valorHonorarioTotal * percentualAdvogado;
                
                linhasRecebedores += `
                    <tr>
                        <td>${adv.nome}</td>
                        <td>${(percentualAdvogado * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(valorAdvogado)}</td>
                    </tr>
                `;

                // Cession√°rios
                if (adv.cessionarios && adv.cessionarios.length > 0) {
                    adv.cessionarios.forEach(cessionario => {
                        const valorCessionario = valorHonorarioTotal * cessionario.percentual;
                        linhasRecebedores += `
                            <tr>
                                <td>${cessionario.nome} (Cession√°rio)</td>
                                <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(valorCessionario)}</td>
                            </tr>
                        `;
                    });
                }

                const textoHonorario = dados.tipoCalculo === 'parcial' 
                ? `Valor do Honor√°rio (Parcial): R$ ${formatarMoeda(valorHonorarioTotal)}`
                : `Valor do Honor√°rio: R$ ${formatarMoeda(valorHonorarioTotal)}`;

                secoesCessoes += `
                    <div style="margin-bottom: 30px;">
                        <h4>Cess√£o do Advogado Sucumbencial: ${adv.nome}</h4>
                        <p><strong>${textoHonorario}</strong></p>
                        <p><strong>Cedido:</strong> ${(totalCedido * 100).toFixed(2)}% para: ${listaCessionarios}</p>
                        
                        <table>
                            <tr>
                                <th>Recebedor</th>
                                <th>Percentual</th>
                                <th>Valor do Direito</th>
                            </tr>
                            ${linhasRecebedores}
                            <tr class="highlight">
                                <td colspan="2"><strong>Total</strong></td>
                                <td><strong>R$ ${formatarMoeda(valorHonorarioTotal)}</strong></td>
                            </tr>
                        </table>
                    </div>
                `;
            });

            return `
                <div class="table-container">
                    <h3>üîÑ Cess√µes de Honor√°rios Sucumbenciais</h3>
                    ${secoesCessoes}
                </div>
            `;
        }

        function gerarSecaoDeducoesAcessorias(resultados, dados) {
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            const temSindicatos = resultados.sindicatos && resultados.sindicatos.length > 0;

            let temHonorarios = false;
            let honorariosParaMostrar = [];

            if (temHerdeiros) {
                const honorariosMap = new Map();
                resultados.herdeiros.forEach(h => {
                    if (h.honorarios && h.honorarios.length > 0) {
                        h.honorarios.forEach(a => {
                            if (!honorariosMap.has(a.nome)) {
                                honorariosMap.set(a.nome, {
                                    nome: a.nome,
                                    tipo: a.tipo,
                                    percentual: a.percentual
                                });
                            }
                        });
                    }
                });
                honorariosParaMostrar = Array.from(honorariosMap.values());
                temHonorarios = honorariosParaMostrar.length > 0;
            } else {
                temHonorarios = resultados.honorarios && resultados.honorarios.length > 0;
                honorariosParaMostrar = resultados.honorarios || [];
            }

            if (!temSindicatos && !temHonorarios) return '';

            // Se√ß√£o Sindicatos
            let secaoSindicatos = '';
            if (temSindicatos) {
                const isParcial = dados.tipoCalculo === 'parcial';
                const baseCalculoSindicato = isParcial ? resultados.valorBase : resultados.valortotatt;
                const linhasSindicatos = resultados.sindicatos.map(s => `
                    <tr>
                        <td>${s.nome}</td>
                        <td>R$ ${formatarMoeda(baseCalculoSindicato)}</td>
                        <td>${(s.percentual * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(s.valorBruto)}</td>
                    </tr>
                `).join('');
                const totalSindicatos = resultados.sindicatos.reduce((sum, s) => sum + s.valorBruto, 0);
                secaoSindicatos = `
                    <h3>üèõÔ∏è Sindicatos</h3>
                    <table>
                        <tr><th>Nome Sindicato</th><th>Base de C√°lculo</th><th>Percentual</th><th>Valor Bruto</th></tr>
                        ${linhasSindicatos}
                        <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                            <td colspan="3"><strong>TOTAL SINDICATOS</strong></td>
                            <td><strong>R$ ${formatarMoeda(totalSindicatos)}</strong></td>
                        </tr>
                    </table>
                `;
            }

            // Se√ß√£o Honor√°rios
            let secaoHonorarios = '';
            if (temHonorarios && honorariosParaMostrar.length > 0) {
                const baseGroups = new Map();

                if (temHerdeiros) {
                    // Filtra herdeiros por prefer√™ncia se for c√°lculo de prefer√™ncia
                    const herdeirosFiltrados = dados.tipoCalculo === 'preferencia'
                        ? resultados.herdeiros.filter(h => h.temPreferencia || h.isPreferenciaParcial)
                        : resultados.herdeiros;

                    // Agrupa herdeiros por base de c√°lculo
                    herdeirosFiltrados.forEach(h => {
                        let valorBaseContratualHerdeiro = h.valorTotal;
                        
                        if (resultados.totaisPorTipo && resultados.totaisPorTipo.contratual > 0) {
                            const proporcaoContratual = resultados.totaisPorTipo.contratual / resultados.totaisPorTipo.total;
                            valorBaseContratualHerdeiro = h.valorTotal * proporcaoContratual;
                        }
                        
                        const baseKey = valorBaseContratualHerdeiro.toFixed(2); 
                        if (!baseGroups.has(baseKey)) baseGroups.set(baseKey, []);
                        baseGroups.get(baseKey).push({
                            ...h,
                            valorTotal: valorBaseContratualHerdeiro 
                        });
                    });
                } else {
                    // Sem herdeiros, incluir benefici√°rio principal

                    let valorBaseContratual = resultados.valorBase;
    
                    if (resultados.totaisPorTipo && resultados.totaisPorTipo.contratual > 0) {
                        const proporcaoContratual = resultados.totaisPorTipo.contratual / resultados.totaisPorTipo.total;
                        valorBaseContratual = resultados.valorBase * proporcaoContratual;
                    }

                    baseGroups.set('PRINCIPAL', [{
                        nome: 'Benefici√°rio Principal',
                        valorTotal: valorBaseContratual
                    }]);
                }

                const secoes = [];
                baseGroups.forEach((herdeiros, base) => {
                    let valorBase = (base === 'PRINCIPAL') ? herdeiros[0].valorTotal : parseFloat(base);
                    const herdeirosNomes = herdeiros.map(h => h.nome).join(', ');

                    const titulo = dados.tipoCalculo === 'preferencia' && valorBase < resultados.valortotatt
                        ? 'üë©‚Äçüíº Advogados (H.Contratuais) - Honor√°rios da Prefer√™ncia'
                        : 'üë©‚Äçüíº Advogados (H.Contratuais)';

                    const linhasAdvogados = honorariosParaMostrar.map(a => `
                        <tr>
                            <td>${a.nome}</td>
                            <td>${a.tipo}</td>
                            <td>R$ ${formatarMoeda(valorBase)}</td>
                            <td>${(a.percentual * 100).toFixed(2)}%</td>
                            <td>R$ ${formatarMoeda(valorBase * a.percentual)}</td>
                        </tr>
                    `).join('');

                    const totalPercentual = honorariosParaMostrar.reduce((sum, h) => sum + h.percentual, 0);
                    const totalValor = valorBase * totalPercentual;

                    secoes.push(`
                        <h3>${titulo}</h3>
                        <p style="color: #155724; font-style: italic;">
                            Valores calculados sobre: R$ ${formatarMoeda(valorBase)}
                            <span style="color: #856404;"> - ${herdeirosNomes}</span>
                        </p>
                        <table>
                            <tr><th>Nome Advogado</th><th>PF/PJ</th><th>Base de C√°lculo</th><th>Percentual</th><th>Valor Bruto</th></tr>
                            ${linhasAdvogados}
                            <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td colspan="3"><strong>TOTAL HONOR√ÅRIOS</strong></td>
                                <td><strong>${(totalPercentual * 100).toFixed(2)}%</strong></td>
                                <td><strong>R$ ${formatarMoeda(totalValor)}</strong></td>
                            </tr>
                        </table>
                    `);
                });

                secaoHonorarios = secoes.join('');
            }

            return `
                <div class="deducoes-acessorias">
                    <div class="table-container">
                        <h3>üìÑ‚ûñ Dedu√ß√µes Acess√≥rias</h3>
                        <div class="explicacao-juridica">
                            <div class="titulo">Entenda as Dedu√ß√µes Acess√≥rias</div>
                            <p><strong>Contribui√ß√µes Sindicais:</strong> Percentual devido aos sindicatos quando aplic√°vel.</p>
                            <p><strong>Honor√°rios Advocat√≠cios:</strong> Percentual devido aos advogados conforme contrato.</p>
                        </div>
                        ${secaoSindicatos}
                        ${secaoHonorarios}
                    </div>
                </div>
            `;
        }

        function gerarSecaoCessoesSindicatos(resultados, dados) {
            if (!resultados.sindicatos) return '';

            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            
            if (!resultados.sindicatos) return '';

            const sindicatosComCessao = resultados.sindicatos.filter(sind => 
                sind.cessoesSind && sind.cessoesSind.length > 0
            );
            
            if (sindicatosComCessao.length === 0) return '';

            if (temHerdeiros) {
                if (isPreferencia) return '';
                
                // ORDEM/PARCIAL/ACORDO
                if (!isPreferencia) {
                    const sindicatosComCessao = resultados.sindicatos.filter(sind => 
                        sind.cessoesSind && sind.cessoesSind.length > 0
                    );
                    
                    if (sindicatosComCessao.length === 0) return '';
                    
                    const secoesSindicatos = sindicatosComCessao.map(sind => {
                        const cessionarios = sind.cessionarios ? sind.cessionarios.map(cessionario => `
                            <tr>
                                <td>${cessionario.nome} (cession√°rio)</td>
                                <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(cessionario.valorBruto)}</td>
                            </tr>
                        `).join('') : '';
                        
                        return `
                            <div style="margin-bottom: 20px;">
                                <h4>üîÑ Cess√£o de Sindicato: ${sind.nome}</h4>
                                <p><strong>Valor do Direito do Sindicato:</strong> R$ ${formatarMoeda(sind.valorBruto)}</p>
                                <p><strong>Cedido:</strong> ${(sind.percentualCessionarioSind * 100).toFixed(2)}% para ${sind.cessoesSind.length} cession√°rio${sind.cessoesSind.length > 1 ? 's' : ''}</p>
                                
                                <table>
                                    <tr><th>Recebedor</th><th>Percentual</th><th>Valor Bruto</th></tr>
                                    <tr style="background-color: #f8f9fa;">
                                        <td><strong>${sind.nome} (fica com)</strong></td>
                                        <td>${(sind.percentualSindicato * 100).toFixed(2)}%</td>
                                        <td>R$ ${formatarMoeda(sind.valorBrutoSindicato)}</td>
                                    </tr>
                                    ${cessionarios}
                                    <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                        <td>TOTAL</td>
                                        <td>100.00%</td>
                                        <td>R$ ${formatarMoeda(sind.valorBruto)}</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    }).join('');
                    return `
                        <div class="table-container">
                            <h3>üîÑ Cess√µes de Sindicatos</h3>
                            ${secoesSindicatos}
                        </div>
                    `;
                }
            }
            // BENEFICIARIO PRINCIPAL
            else {
                
                if (isPreferencia) return '';

                const sindicatosComCessao = resultados.sindicatos.filter(sind => 
                    sind.cessoesSind && sind.cessoesSind.length > 0
                );

                if (sindicatosComCessao.length === 0) return '';

                const secoesSindicatos = sindicatosComCessao.map(sind => {
                    const cessionarios = sind.cessionarios ? sind.cessionarios.map(cessionario => `
                        <tr>
                            <td>${cessionario.nome} (cession√°rio)</td>
                            <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                            <td>R$ ${formatarMoeda(cessionario.valorBruto)}</td>
                        </tr>
                    `).join('') : '';
                    return `
                        <div style="margin-bottom: 20px;">
                            <h4>üîÑ Cess√£o de Sindicato: ${sind.nome}</h4>
                            <p><strong>Valor do Direito do Sindicato:</strong> R$ ${formatarMoeda(sind.valorBruto)}</p>
                            <p><strong>Cedido:</strong> ${(sind.percentualCessionarioSind * 100).toFixed(2)}% para ${sind.cessoesSind.length} cession√°rio${sind.cessoesSind.length > 1 ? 's' : ''}</p>
                            <table>
                                <tr><th>Recebedor</th><th>Percentual</th><th>Valor Bruto</th></tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td><strong>${sind.nome} (fica com)</strong></td>
                                    <td>${(sind.percentualSindicato * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(sind.valorBrutoSindicato)}</td>
                                </tr>
                                ${cessionarios}
                                <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                    <td>TOTAL</td>
                                    <td>100.00%</td>
                                    <td>R$ ${formatarMoeda(sind.valorBruto)}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                }).join('');
                return `
                    <div class="table-container">
                        <h3>üîÑ Cess√µes de Sindicatos</h3>
                        ${secoesSindicatos}
                    </div>
                `;
            }
        }

        function gerarSecaoCessoesBeneficiario(resultados, dados) {
            if (!resultados.cessoesBeneficiarioCalculadas || resultados.cessoesBeneficiarioCalculadas.length === 0) return '';

            const dividaTotalAtualizada = resultados.valortotatt || 0;
            const valorPago = resultados.valorBase || 0; // pagamento efetivo (parcial)
            const percentualTotalAdv = (dados.advogados || []).reduce((sum, adv) => sum + (adv.percentual || 0), 0);
            const percentualTotalSind = (dados.sindicatos || []).reduce((sum, sind) => sum + (sind.percentual || 0), 0);
            const percentualDeducoes = percentualTotalAdv + percentualTotalSind;
            const dividaSemHonorarios = dividaTotalAtualizada * (1 - percentualDeducoes);

            const isParcial = dados.tipoCalculo === 'parcial';
            const isPreferenciasParcial = !!resultados.isPreferenciasParcial; 

            // Benefici√°rio bruto/liquido
            const valorBrutoBeneficiario = dividaTotalAtualizada * (resultados.percentualBeneficiarioFinal || 0);
            const deducoesBeneficiario = valorBrutoBeneficiario * percentualDeducoes;
            const parteBeneficiario = valorBrutoBeneficiario - deducoesBeneficiario;

            const temHerdeiros = resultados.temHerdeiros && Array.isArray(resultados.herdeiros) && resultados.herdeiros.length > 0;

            // percentual pago sobre a d√≠vida 
            const percentualPagoSobreDivida = dividaTotalAtualizada > 0 ? Math.min(1, valorPago / dividaTotalAtualizada) : 0;

            // calcula quanto o benefici√°rio recebe/agura dependendo do caso
            let beneficiarioRecebe = 0;
            let beneficiarioAguarda = 0;

            if (temHerdeiros && dados.tipoCalculo === 'preferencia') {
                // benefici√°rio faleceu e h√° prefer√™ncia: benefici√°rio recebe 0, tudo vai para aguardar (herdeiros)
                beneficiarioRecebe = 0;
                beneficiarioAguarda = parteBeneficiario;
            } else if (temHerdeiros) {
                // benefici√°rio faleceu (sem prefer√™ncia)
                beneficiarioRecebe = 0;
                beneficiarioAguarda = parteBeneficiario;
            } else if (isParcial) {
                // pagamento parcial
                beneficiarioRecebe = parteBeneficiario * percentualPagoSobreDivida;
                beneficiarioAguarda = Math.max(0, parteBeneficiario - beneficiarioRecebe);
            } else {
                // pagamento integral / padr√£o
                beneficiarioRecebe = (resultados.valorBeneficiarioAposCessoes != null) ? resultados.valorBeneficiarioAposCessoes : parteBeneficiario;
                beneficiarioAguarda = Math.max(0, parteBeneficiario - beneficiarioRecebe);
            }

            // lista de cession√°rios e c√°lculo de linhas
            const listaCessionarios = resultados.cessoesBeneficiarioCalculadas.map(cessao =>
                `${cessao.cessionario} (${((cessao.percentual || 0) * 100).toFixed(2)}%)`
            ).join(', ');

            const totalCedido = resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) =>
                total + (cessao.percentual || 0), 0
            );

            const linhasCessionarios = resultados.cessoesBeneficiarioCalculadas.map(cessao => {
                const valorBrutoCessionario = dividaTotalAtualizada * (cessao.percentual || 0);
                const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                const parteCessionario = valorBrutoCessionario - deducoesCessionario;

                let cessionarioRecebe = 0;
                let cessionarioAguarda = 0;

                if (isPreferenciasParcial) {
                    // prefer√™ncia parcial: cession√°rios n√£o recebem agora 
                    cessionarioRecebe = 0;
                    cessionarioAguarda = parteCessionario;
                } else if (isParcial) {
                    // pagamento parcial: cession√°rio recebe proporcionalmente sobre sua parte l√≠quida
                    cessionarioRecebe = parteCessionario * percentualPagoSobreDivida;
                    cessionarioAguarda = Math.max(0, parteCessionario - cessionarioRecebe);
                } else {
                    cessionarioRecebe = (cessao.valorBruto != null) ? (cessao.valorBruto) : parteCessionario;
                    
                    cessionarioAguarda = 0;
                }

                return `
                    <tr>
                        <td>${cessao.cessionario}</td>
                        <td>${((cessao.percentual || 0) * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(valorBrutoCessionario)}</td>
                        <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(deducoesCessionario)}</td>
                        <td>R$ ${formatarMoeda(parteCessionario)}</td>
                        <td>R$ ${formatarMoeda(cessionarioRecebe)}</td>
                        <td>R$ ${formatarMoeda(cessionarioAguarda)}</td>
                    </tr>
                `;
            }).join('');

            const totalValorBruto = dividaTotalAtualizada;
            const totalDeducoes = dividaTotalAtualizada * percentualDeducoes;
            const totalLiquido = dividaSemHonorarios;

            const somaRecebeCessionarios = resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) => {
                const valorBrutoCessionario = dividaTotalAtualizada * (cessao.percentual || 0);
                const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                const parteCessionario = valorBrutoCessionario - deducoesCessionario;

                if (isPreferenciasParcial) return total + 0;
                if (isParcial) return total + (parteCessionario * percentualPagoSobreDivida);
                // integral
                return total + ((cessao.valorBruto != null) ? cessao.valorBruto : parteCessionario);
            }, 0);

            const somaAguardaCessionarios = resultados.cessoesBeneficiarioCalculadas.reduce((total, cessao) => {
                const valorBrutoCessionario = dividaTotalAtualizada * (cessao.percentual || 0);
                const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                const parteCessionario = valorBrutoCessionario - deducoesCessionario;

                if (isPreferenciasParcial) return total + parteCessionario;
                if (isParcial) return total + (parteCessionario * (1 - percentualPagoSobreDivida));
                return total + 0;
            }, 0);

            const totalRecebe = beneficiarioRecebe + somaRecebeCessionarios;
            const totalAguarda = beneficiarioAguarda + somaAguardaCessionarios;

            const alertBox = resultados.isPreferenciasParcial ? `
                <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    <strong>‚ÑπÔ∏è Prefer√™ncia Parcial:</strong><br>
                    ‚Ä¢ <strong>Teto da prefer√™ncia:</strong> R$ ${formatarMoeda(resultados.valorBase)}<br>
                    ‚Ä¢ <strong>Pagamento imediato:</strong> R$ ${formatarMoeda(temHerdeiros ? 0 : beneficiarioRecebe)} ${temHerdeiros ? '(benefici√°rio falecido - valor vai para herdeiros)' : '(s√≥ para o benefici√°rio)'}<br>
                    ‚Ä¢ <strong>Saldo devedor total:</strong> R$ ${formatarMoeda(totalAguarda)}
                </div>
            ` : isParcial ? `
                <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    <strong>‚ö†Ô∏è Pagamento Parcial:</strong><br>
                    ‚Ä¢ <strong>D√≠vida total:</strong> R$ ${formatarMoeda(dividaTotalAtualizada)}<br>
                    ‚Ä¢ <strong>Valor do pagamento:</strong> R$ ${formatarMoeda(resultados.valorBase)}<br>
                </div>
            ` : temHerdeiros ? `
                <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    <strong>‚ö†Ô∏è Benefici√°rio Falecido:</strong><br>
                    ‚Ä¢ Os valores do benefici√°rio ser√£o distribu√≠dos entre os ${resultados.herdeiros.length} herdeiro(s)<br>
                    ‚Ä¢ ${dados.tipoCalculo === 'preferencia' ? 'Herdeiros com prefer√™ncia receber√£o conforme o teto estabelecido' : 'Distribui√ß√£o seguir√° ordem cronol√≥gica'}
                </div>
            ` : `
                <div class="success-box" style="margin-top: 10px; padding: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                    <strong>‚úÖ Pagamento Integral:</strong> Todos os benefici√°rios recebem integralmente.
                </div>
            `;

            return `
                <div class="cessoes-beneficiario">
                    <div class="table-container">
                        <h3>üîÑ Cess√µes do Benefici√°rio Principal</h3>
                        <div style="margin-bottom: 20px;">
                            <h4>Cess√£o do Benefici√°rio: ${dados.beneficiario}</h4>
                            <p><strong>Tipo de C√°lculo:</strong> ${dados.tipoCalculo} ${dados.tipoCalculo === 'preferencia' ? '(preferencial)' : '(ordem comum)'}</p>
                            <p><strong>D√≠vida Total:</strong> R$ ${formatarMoeda(dividaTotalAtualizada)}</p>
                            <p><strong>Total Cedido:</strong> ${(totalCedido * 100).toFixed(2)}% para: ${listaCessionarios}</p>
                            ${temHerdeiros ? `
                            <div style="background-color: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <p style="color: #004085; margin: 0;">
                                    <strong>‚ÑπÔ∏è Nota:</strong> O benefici√°rio faleceu, deixando ${resultados.herdeiros.length} herdeiro(s). 
                                    Os valores remanescentes do benefici√°rio ser√£o distribu√≠dos entre os herdeiros.
                                </p>
                            </div>
                            ` : ''}
                            
                            <table>
                                <tr>
                                    <th rowspan="2">Benefici√°rio</th>
                                    <th rowspan="2">%</th>
                                    <th rowspan="2">Valor Bruto</th>
                                    <th colspan="2" style="text-align: center; background-color: #f8f9fa;">Dedu√ß√µes Acess√≥rias</th>
                                    <th rowspan="2">Valor L√≠quido*</th>
                                    <th rowspan="2">Recebe Agora*</th>
                                    <th rowspan="2">Aguarda Ordem</th>
                                </tr>
                                <tr>
                                    <th style="background-color: #f8f9fa;">% Total</th>
                                    <th style="background-color: #f8f9fa;">Valor</th>
                                </tr>
                                ${resultados.percentualBeneficiarioFinal > 0 ? `
                                <tr>
                                    <td>${dados.beneficiario}${temHerdeiros ? ' ‚Ä†' : ''}</td>
                                    <td>${(resultados.percentualBeneficiarioFinal * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(valorBrutoBeneficiario)}</td>
                                    <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(deducoesBeneficiario)}</td>
                                    <td>R$ ${formatarMoeda(parteBeneficiario)}</td>
                                    <td>R$ ${formatarMoeda(beneficiarioRecebe)}</td>
                                    <td>R$ ${formatarMoeda(beneficiarioAguarda)}</td>
                                </tr>
                                ` : `
                                <tr style="background-color: #f8f9fa;">
                                    <td><em>${dados.beneficiario} (cedeu tudo)</em></td>
                                    <td>0.00%</td>
                                    <td>R$ 0,00</td>
                                    <td>0.00%</td>
                                    <td>R$ 0,00</td>
                                    <td>R$ 0,00</td>
                                    <td>R$ 0,00</td>
                                    <td>R$ 0,00</td>
                                </tr>
                                `}
                                ${linhasCessionarios}
                                <tr class="highlight" style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                                    <td>TOTAL</td>
                                    <td>100.00%</td>
                                    <td>R$ ${formatarMoeda(totalValorBruto)}</td>
                                    <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(totalDeducoes)}</td>
                                    <td>R$ ${formatarMoeda(totalLiquido)}</td>
                                    <td>R$ ${formatarMoeda(totalRecebe)}</td>
                                    <td>R$ ${formatarMoeda(totalAguarda)}</td>
                                </tr>
                            </table>
                            <div style="padding: 8px; margin: 10px 0; font-size: 0.85em; color: #666;">
                                <p style="margin: 0;">
                                    <strong>üìù Dedu√ß√µes Acess√≥rias:</strong> 
                                    Honor√°rios (${(percentualTotalAdv * 100).toFixed(2)}%) + 
                                    Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%) = 
                                    ${(percentualDeducoes * 100).toFixed(2)}%
                                </p>
                                <p style="margin: 5px 0 0 0;">
                                    <strong>* Valor L√≠quido/Recebe Agora:</strong> Valores ap√≥s a dedu√ß√£o de honor√°rios e sindicatos. 
                                    ${isParcial ? 'Valores calculados sobre o pagamento parcial.' : ''}
                                    ${temHerdeiros ? 'Para o benefici√°rio falecido, este valor ser√° distribu√≠do entre os herdeiros.' : ''}
                                </p>
                            </div>
                        </div>
                        ${alertBox}
                    </div>
                </div>
            `;
        }

        function gerarSecaoHerdeiros(resultados, dados) {
            if (!resultados.temHerdeiros || resultados.herdeiros.length === 0) return '';
            
            const linhasHerdeiros = resultados.herdeiros.map(h => {
                const valorBrutoHerdeiro = h.valorAposCessoesBeneficiario || h.valorTotalOriginal;
                
                let honorarioTotalReal = 0;
                let sindicatoTotalReal = 0;
                
                // Calcular honor√°rios sobre o valor real (ap√≥s cess√µes)
                if (dados.advogados && dados.advogados.length > 0) {
                    let valorBaseContratualHerdeiro = valorBrutoHerdeiro;
                    
                    // Aplicar propor√ß√£o contratual se dispon√≠vel
                    if (resultados.totaisPorTipo && resultados.totaisPorTipo.contratual > 0) {
                        const proporcaoContratual = resultados.totaisPorTipo.contratual / resultados.totaisPorTipo.total;
                        valorBaseContratualHerdeiro = valorBrutoHerdeiro * proporcaoContratual;
                    }
                    
                    honorarioTotalReal = dados.advogados.reduce((sum, adv) => {
                        return sum + (valorBaseContratualHerdeiro * adv.percentual);
                    }, 0);
                }
                
                // Calcular sindicatos sobre o valor real (ap√≥s cess√µes)
                if (dados.sindicatos && dados.sindicatos.length > 0) {
                    sindicatoTotalReal = dados.sindicatos.reduce((sum, sind) => {
                        return sum + (valorBrutoHerdeiro * sind.percentual);
                    }, 0);
                }
                
                const valorLiquidoSemTributos = valorBrutoHerdeiro - honorarioTotalReal - sindicatoTotalReal;
                
                // Calcular RRA proporcional ao valor real
                const rraReal = resultados.rraTotal !== 0 ? 
                    Math.round((valorBrutoHerdeiro * resultados.rraTotal) / resultados.valortotatt) : 0;
                
                return `
                    <tr>
                        <td>${h.nome}</td>
                        <td>${(h.percentual * 100).toFixed(2)}%</td>
                        <td>R$ ${formatarMoeda(valorBrutoHerdeiro)}</td>
                        <td>R$ ${formatarMoeda(honorarioTotalReal)}</td>
                        <td>R$ ${formatarMoeda(sindicatoTotalReal)}</td>
                        <td>R$ ${formatarMoeda(valorLiquidoSemTributos)}</td>
                        <td>${rraReal || 0}</td>
                    </tr>
                `;
            }).join('');
            
            // Calcular totais usando valores ap√≥s cess√µes
            const totalRealHerdeiros = resultados.herdeiros.reduce((sum, h) => 
                sum + (h.valorAposCessoesBeneficiario || h.valorTotalOriginal), 0);
            
            // Total de honor√°rios sobre valores reais
            let totalHonorarios = 0;
            if (dados.advogados) {
                let valorBaseContratualTotal = totalRealHerdeiros;
                
                if (resultados.totaisPorTipo && resultados.totaisPorTipo.contratual > 0) {
                    const proporcaoContratual = resultados.totaisPorTipo.contratual / resultados.totaisPorTipo.total;
                    valorBaseContratualTotal = totalRealHerdeiros * proporcaoContratual;
                }
                
                totalHonorarios = dados.advogados.reduce((sum, adv) => {
                    return sum + (valorBaseContratualTotal * adv.percentual);
                }, 0);
            }
            
            // Total de sindicatos sobre valores reais
            const totalSindicatos = dados.sindicatos ? 
                dados.sindicatos.reduce((sum, sind) => {
                    return sum + (totalRealHerdeiros * sind.percentual);
                }, 0) : 0;
            
            const totalLiquido = totalRealHerdeiros - totalHonorarios - totalSindicatos;
            const totalRRA = resultados.rraTotal !== 0 ? 
                Math.round((totalRealHerdeiros * resultados.rraTotal) / resultados.valortotatt) : 0;
            
            // Verificar se houve cess√£o do benefici√°rio
            const houveCessaoBeneficiario = resultados.percentualBeneficiarioFinal && resultados.percentualBeneficiarioFinal < 1;
            const percentualCedido = houveCessaoBeneficiario ? 
                ((1 - resultados.percentualBeneficiarioFinal) * 100).toFixed(2) : 0;
            
            let htmlCessaoInfo = '';
            if (houveCessaoBeneficiario) {
                htmlCessaoInfo = `
                    <div style="background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="color: #856404; margin: 0;">
                            <strong>‚ö†Ô∏è Aten√ß√£o - Cess√£o do Benefici√°rio Principal:</strong><br>
                            O benefici√°rio cedeu ${percentualCedido}% do precat√≥rio antes do falecimento.<br>
                            <strong>Valor total do precat√≥rio:</strong> R$ ${formatarMoeda(resultados.valortotatt)}<br>
                            <strong>Valor cedido pelo benefici√°rio:</strong> R$ ${formatarMoeda(resultados.valortotatt - totalRealHerdeiros)}<br>
                            <strong>Valor dispon√≠vel para herdeiros:</strong> R$ ${formatarMoeda(totalRealHerdeiros)}
                        </p>
                    </div>
                `;
            }
            
            return `
                <div class="cessoes-beneficiario">
                    <div class="table-container">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Distribui√ß√£o entre Herdeiros</h3>
                        ${htmlCessaoInfo}
                        <table>
                            <tr>
                                <th>Nome Herdeiro</th>
                                <th>%</th>
                                <th>Valor Bruto</th>
                                <th>Hon. Contratuais</th>
                                <th>Sindicatos</th>
                                <th>Valor L√≠quido*</th>
                                <th>RRA</th>
                            </tr>
                            ${linhasHerdeiros}
                            <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td><strong>TOTAIS</strong></td>
                                <td><strong>100%</strong></td>
                                <td><strong>R$ ${formatarMoeda(totalRealHerdeiros)}</strong></td>
                                <td><strong>R$ ${formatarMoeda(totalHonorarios)}</strong></td>
                                <td><strong>R$ ${formatarMoeda(totalSindicatos)}</strong></td>
                                <td><strong>R$ ${formatarMoeda(totalLiquido)}</strong></td>
                                <td><strong>${totalRRA || '-'}</strong></td>
                            </tr>
                        </table>
                        <div class="success-box" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                            <p style="margin: 0;">* Valor l√≠quido sem considerar Previd√™ncia e IR</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarSecaoCessoesHerdeiros(resultados, dados) {
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            
            if (!temHerdeiros) return '';
            
            // Verifica se algum herdeiro tem cess√µes
            const herdeirosComCessoes = resultados.herdeiros.filter(h => 
                h.cessoesHerdeiro && h.cessoesHerdeiro.length > 0
            );
            
            if (herdeirosComCessoes.length === 0) return '';
            
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            const percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            const percentualDeducoes = percentualTotalAdv + percentualTotalSind;
            
            // Gera se√ß√£o para cada herdeiro com cess√µes
            const secoesHerdeiros = herdeirosComCessoes.map(herdeiro => {
                const valorTotalHerdeiro = herdeiro.valorTotalOriginal;
                
                const valorBrutoSemCessoes = valorTotalHerdeiro; // Usar sempre o valor original
                
                // Lista de cession√°rios
                const listaCessionarios = herdeiro.cessoesHerdeiro.map(cessao => 
                    `${cessao.cessionario} (${(cessao.percentual * 100).toFixed(2)}%)`
                ).join(', ');
                
                const totalCedido = herdeiro.cessoesHerdeiro.reduce((total, cessao) => 
                    total + cessao.percentual, 0
                );
                
                // Valores do herdeiro ap√≥s cess√µes (BRUTOS, sem IR/Prev)
                const valorBrutoHerdeiroAposCessoes = valorBrutoSemCessoes * (1 - totalCedido);
                const deducoesHerdeiro = valorBrutoHerdeiroAposCessoes * percentualDeducoes;
                const valorLiquidoHerdeiro = valorBrutoHerdeiroAposCessoes - deducoesHerdeiro;
                
                const herdeiroRecebeAgora = isPreferencia ? 
                    (herdeiro.isPreferenciaParcial ? 
                        Math.min(valorLiquidoHerdeiro, herdeiro.valorTotal - (herdeiro.valorTotal * percentualDeducoes)) : 
                        valorLiquidoHerdeiro) : 
                    valorLiquidoHerdeiro;
                    
                const herdeiroAguarda = isPreferencia && herdeiro.isPreferenciaParcial ? 
                    Math.max(0, valorLiquidoHerdeiro - herdeiroRecebeAgora) : 0;
                
                // Linhas dos cession√°rios
                const linhasCessionarios = herdeiro.cessoesHerdeiro.map(cessao => {
                    const valorBrutoCessionario = valorBrutoSemCessoes * cessao.percentual;
                    const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                    const valorLiquidoCessionario = valorBrutoCessionario - deducoesCessionario;
                    
                    // Na prefer√™ncia parcial, cession√°rios n√£o recebem
                    const cessionarioRecebe = isPreferencia && herdeiro.isPreferenciaParcial ? 0 : valorLiquidoCessionario;
                    const cessionarioAguarda = isPreferencia && herdeiro.isPreferenciaParcial ? valorLiquidoCessionario : 0;
                    
                    return `
                        <tr>
                            <td>${cessao.cessionario}</td>
                            <td>${(cessao.percentual * 100).toFixed(2)}%</td>
                            <td>R$ ${formatarMoeda(valorBrutoCessionario)}</td>
                            <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                            <td>R$ ${formatarMoeda(deducoesCessionario)}</td>
                            <td>R$ ${formatarMoeda(valorLiquidoCessionario)}</td>
                            <td>R$ ${formatarMoeda(cessionarioRecebe)}</td>
                            <td>R$ ${formatarMoeda(cessionarioAguarda)}</td>
                        </tr>
                    `;
                }).join('');
                
                // Totais para este herdeiro (baseados no valor original)
                const totalValorBruto = valorBrutoSemCessoes;
                const totalDeducoes = valorBrutoSemCessoes * percentualDeducoes;
                const totalLiquido = valorBrutoSemCessoes - totalDeducoes;
                
                const totalRecebe = herdeiroRecebeAgora + herdeiro.cessoesHerdeiro.reduce((total, cessao) => {
                    const valorBrutoCessionario = valorBrutoSemCessoes * cessao.percentual;
                    const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                    const valorLiquidoCessionario = valorBrutoCessionario - deducoesCessionario;
                    const cessionarioRecebe = isPreferencia && herdeiro.isPreferenciaParcial ? 0 : valorLiquidoCessionario;
                    return total + cessionarioRecebe;
                }, 0);
                
                const totalAguarda = herdeiroAguarda + herdeiro.cessoesHerdeiro.reduce((total, cessao) => {
                    const valorBrutoCessionario = valorBrutoSemCessoes * cessao.percentual;
                    const deducoesCessionario = valorBrutoCessionario * percentualDeducoes;
                    const valorLiquidoCessionario = valorBrutoCessionario - deducoesCessionario;
                    const cessionarioAguarda = isPreferencia && herdeiro.isPreferenciaParcial ? valorLiquidoCessionario : 0;
                    return total + cessionarioAguarda;
                }, 0);
                
                const alertBox = isPreferencia && herdeiro.isPreferenciaParcial ? `
                    <div class="warning-box" style="margin-top: 10px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                        <strong>‚ÑπÔ∏è Prefer√™ncia Parcial:</strong><br>
                        ‚Ä¢ <strong>Cess√µes calculadas sobre valor original:</strong> R$ ${formatarMoeda(valorTotalHerdeiro)}<br>
                        ‚Ä¢ <strong>Teto da prefer√™ncia limita pagamento do herdeiro</strong><br>
                        ‚Ä¢ <strong>Cession√°rios aguardam</strong> ordem cronol√≥gica
                    </div>
                ` : `
                    <div class="success-box" style="margin-top: 10px; padding: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                        <strong>‚úÖ Pagamento Integral:</strong> Herdeiro e cession√°rios recebem integralmente baseado no valor original.
                    </div>
                `;
                
                return `
                    <div style="margin-bottom: 30px;">
                        <h4>Cess√£o do Herdeiro: ${herdeiro.nome}</h4>
                        <p><strong>Valor Original do Herdeiro:</strong> R$ ${formatarMoeda(valorTotalHerdeiro)}</p>
                        <p><strong>Total Cedido:</strong> ${(totalCedido * 100).toFixed(2)}% para: ${listaCessionarios}</p>
                        
                        <table>
                            <tr>
                                <th rowspan="2">Benefici√°rio</th>
                                <th rowspan="2">%</th>
                                <th rowspan="2">Valor Bruto</th>
                                <th colspan="2" style="text-align: center; background-color: #f8f9fa;">Dedu√ß√µes Acess√≥rias</th>
                                <th rowspan="2">Valor L√≠quido*</th>
                                <th rowspan="2">Recebe Agora</th>
                                <th rowspan="2">Aguarda Ordem</th>
                            </tr>
                            <tr>
                                <th style="background-color: #f8f9fa;">% Total</th>
                                <th style="background-color: #f8f9fa;">Valor</th>
                            </tr>
                            <tr>
                                <td>${herdeiro.nome}</td>
                                <td>${((1 - totalCedido) * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(valorBrutoHerdeiroAposCessoes)}</td>
                                <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(deducoesHerdeiro)}</td>
                                <td>R$ ${formatarMoeda(valorLiquidoHerdeiro)}</td>
                                <td>R$ ${formatarMoeda(herdeiroRecebeAgora)}</td>
                                <td>R$ ${formatarMoeda(herdeiroAguarda)}</td>
                            </tr>
                            ${linhasCessionarios}
                            <tr class="highlight" style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td>TOTAL</td>
                                <td>100.00%</td>
                                <td>R$ ${formatarMoeda(totalValorBruto)}</td>
                                <td>${(percentualDeducoes * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(totalDeducoes)}</td>
                                <td>R$ ${formatarMoeda(totalLiquido)}</td>
                                <td>R$ ${formatarMoeda(totalRecebe)}</td>
                                <td>R$ ${formatarMoeda(totalAguarda)}</td>
                            </tr>
                        </table>
                        
                        <div style="padding: 8px; margin: 10px 0; font-size: 0.85em; color: #666;">
                            <p style="margin: 0;">
                                <strong>üìù Dedu√ß√µes Acess√≥rias:</strong> 
                                Honor√°rios (${(percentualTotalAdv * 100).toFixed(2)}%) + 
                                Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%) = 
                                ${(percentualDeducoes * 100).toFixed(2)}%
                            </p>
                            <p style="margin: 5px 0 0 0;">
                                <strong>* Valor L√≠quido:</strong> Valor ap√≥s dedu√ß√£o apenas de honor√°rios e sindicatos (IR e Previd√™ncia calculados separadamente).
                            </p>
                        </div>
                        
                        ${alertBox}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="cessoes-herdeiros">
                    <div class="table-container">
                        <h3>üîÑ Cess√µes dos Herdeiros</h3>
                        <div style="margin-bottom: 20px;">
                            <p><strong>Tipo de C√°lculo:</strong> ${dados.tipoCalculo} ${dados.tipoCalculo === 'preferencia' ? '(preferencial)' : '(ordem comum)'}</p>
                            <p><strong>Herdeiros com Cess√µes:</strong> ${herdeirosComCessoes.length} de ${resultados.herdeiros.length} herdeiros</p>
                            
                            ${secoesHerdeiros}
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarSecaoCessoesAdvogados(resultados, dados) {
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            
            // HERDEIROS
            if (temHerdeiros) {
                const isPreferencia = dados.tipoCalculo === 'preferencia';
                const isParcial = dados.tipoCalculo === 'parcial';
                
                // ORDEM OU PARCIAL
                if (!isPreferencia) {
                    const advogadosComCessao = resultados.honorarios.filter(adv => 
                        adv.cessoesAdv && adv.cessoesAdv.length > 0
                    );
                    
                    if (advogadosComCessao.length === 0) return '';
                    
                    const secoesCessoes = advogadosComCessao.map(adv => {
                        // No pagamento parcial, calcular valores proporcionais
                        let valorHonorario, valorAdvogado;
                        
                        if (isParcial) {
                            // Calcular sobre o valor base parcial
                            valorHonorario = resultados.valorBase * adv.percentual;
                            valorAdvogado = resultados.valorBase * adv.percentualAdvogado;
                        } else {
                            valorHonorario = adv.valorBruto;
                            valorAdvogado = adv.valorBrutoAdvogado;
                        }
                        
                        // Cession√°rios tamb√©m recebem proporcionalmente no pagamento parcial
                        let cessionarios = '';
                        if (adv.cessionarios && adv.cessionarios.length > 0) {
                            cessionarios = adv.cessionarios.map(cessionario => {
                                let valorCessionario;
                                if (isParcial) {
                                    valorCessionario = valorHonorario * cessionario.percentual;
                                } else {
                                    // Para ordem comum, usar o valor correto do cession√°rio
                                    valorCessionario = cessionario.valorBruto;
                                }
                                
                                return `
                                    <tr>
                                        <td>${cessionario.nome} (cession√°rio)</td>
                                        <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                        <td>R$ ${formatarMoeda(valorCessionario)}</td>
                                    </tr>
                                `;
                            }).join('');
                        }
                        
                        return `
                            <div style="margin-bottom: 20px;">
                                <h4>üîÑ Cess√£o de Honor√°rios: ${adv.nome}</h4>
                                <p><strong>Valor do Honor√°rio${isParcial ? ' (Parcial)' : ''}:</strong> R$ ${formatarMoeda(valorHonorario)}</p>
                                <p><strong>Cedido:</strong> ${(adv.percentualCessionarioAdv * 100).toFixed(2)}% para ${adv.cessoesAdv.length} cession√°rio${adv.cessoesAdv.length > 1 ? 's' : ''}</p>
                                
                                <table>
                                    <tr><th>Recebedor</th><th>Percentual</th><th>Valor ${isParcial ? 'Parcial' : 'Bruto'}</th></tr>
                                    <tr style="background-color: #f8f9fa;">
                                        <td><strong>${adv.nome} (fica com)</strong></td>
                                        <td>${(adv.percentualAdvogado * 100).toFixed(2)}%</td>
                                        <td>R$ ${formatarMoeda(valorAdvogado)}</td>
                                    </tr>
                                    ${cessionarios}
                                    <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                        <td>TOTAL</td>
                                        <td>-%</td>
                                        <td>R$ ${formatarMoeda(valorHonorario)}</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    }).join('');
                    
                    const titulo = isParcial ? 'üîÑ Cess√µes de Honor√°rios - Pagamento Parcial' : 'üîÑ Cess√µes de Honor√°rios';
                    
                    return `
                        <div class="table-container">
                            <h3>${titulo}</h3>
                            ${secoesCessoes}
                        </div>
                    `;
                }
                
                //PREFER√äNCIA HERDEIRO
                else {
                    const isPreferenciaParcial = isPreferencia && resultados.valorBase < resultados.valortotatt;
                    
                    // herdeiros conforme o tipo de c√°lculo
                    const herdeirosFiltrados = resultados.herdeiros.filter(h => h.temPreferencia || h.isPreferenciaParcial);
                    
                    // Agrupa herdeiros por valor base
                    const baseGroups = new Map();
                    herdeirosFiltrados.forEach(h => {
                        const baseKey = h.valorTotal.toFixed(2);
                        if (!baseGroups.has(baseKey)) baseGroups.set(baseKey, []);
                        baseGroups.get(baseKey).push(h);
                    });
                    
                    const secoesPorBase = [];
                    
                    baseGroups.forEach((herdeiros, base) => {
                        const valorBase = parseFloat(base);
                        const herdeirosNomes = herdeiros.map(h => h.nome).join(', ');
                        
                        // Verifica se este grupo √© prefer√™ncia parcial ou total
                        const grupoEPreferenciaParcial = herdeiros.some(h => h.isPreferenciaParcial);
                        
                        // Busca advogados com cess√£o para este valor base
                        const advogadosComCessao = resultados.honorarios.filter(adv => 
                            adv.cessoesAdv && adv.cessoesAdv.length > 0
                        );
                        
                        if (advogadosComCessao.length === 0) return; // N√£o h√° cess√µes neste grupo
                        
                        const secoesCessoes = advogadosComCessao.map(adv => {
                            const valorHonorarioAdvogado = valorBase * adv.percentual;
                            const valorAdvogadoAposCessao = valorBase * adv.percentualAdvogado;
                            
                            let cessionarios = '';
                            if (grupoEPreferenciaParcial) {
                                // Prefer√™ncia parcial: cession√°rios aguardam
                                cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => `
                                    <tr>
                                        <td>${cessionario.nome} (cession√°rio) - <em>aguarda</em></td>
                                        <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                        <td>R$ ${formatarMoeda(valorBase * cessionario.percentual)}</td>
                                    </tr>
                                `).join('') : '';
                            } else {
                                // Prefer√™ncia total: cession√°rios recebem
                                cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => `
                                    <tr>
                                        <td>${cessionario.nome} (cession√°rio)</td>
                                        <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                        <td>R$ ${formatarMoeda(valorBase * cessionario.percentual)}</td>
                                    </tr>
                                `).join('') : '';
                            }
                            
                            return `
                                <div style="margin-bottom: 20px;">
                                    <h4>üîÑ Cess√£o de Honor√°rios: ${adv.nome}</h4>
                                    <p><strong>Valor do Honor√°rio:</strong> R$ ${formatarMoeda(valorHonorarioAdvogado)}</p>
                                    <p><strong>Cedido:</strong> ${(adv.percentualCessionarioAdv * 100).toFixed(2)}% para ${adv.cessoesAdv.length} cession√°rio${adv.cessoesAdv.length > 1 ? 's' : ''}</p>
                                    
                                    <table>
                                        <tr><th>Recebedor</th><th>Percentual</th><th>Valor ${grupoEPreferenciaParcial ? 'do Direito' : 'Bruto'}</th></tr>
                                        <tr style="background-color: #f8f9fa;">
                                            <td><strong>${adv.nome} (fica com)</strong></td>
                                            <td>${(adv.percentualAdvogado * 100).toFixed(2)}%</td>
                                            <td>R$ ${formatarMoeda(valorAdvogadoAposCessao)}</td>
                                        </tr>
                                        ${cessionarios}
                                        <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                            <td>TOTAL</td>
                                            <td>-%</td>
                                            <td>R$ ${formatarMoeda(valorHonorarioAdvogado)}</td>
                                        </tr>
                                    </table>
                                </div>
                            `;
                        }).join('');
                        
                        if (secoesCessoes.trim() === '') return; 
                        
                        const alertaStatus = grupoEPreferenciaParcial 
                            ? `<p style="color: #856404; font-weight: bold;">‚ö†Ô∏è Prefer√™ncia Parcial: Grupo limitado pelo teto (R$ ${formatarMoeda(dados.tetoPreferencia)}) - Cession√°rios aguardam</p>`
                            : `<p style="color: #155724; font-weight: bold;">‚úÖ Prefer√™ncia Total: Grupo recebe valor completo - Todos recebem</p>`;
                        
                        secoesPorBase.push(`
                            <div style="margin-bottom: 30px; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                                <p style="color: #155724; font-style: italic; margin-bottom: 10px;">
                                    <strong>Cess√µes calculadas sobre:</strong> R$ ${formatarMoeda(valorBase)}
                                    <span style="color: #856404;"> - ${herdeirosNomes}</span>
                                </p>
                                ${alertaStatus}
                                ${secoesCessoes}
                            </div>
                        `);
                    });
                    
                    if (secoesPorBase.length === 0) return ''; 
                    
                    const temAlgumParcial = secoesPorBase.some(secao => secao.includes('Prefer√™ncia Parcial'));
                    const titulo = temAlgumParcial 
                        ? 'üîÑ Cess√µes de Honor√°rios - Prefer√™ncia (Parcial/Total)'
                        : 'üîÑ Cess√µes de Honor√°rios - Prefer√™ncia Total';
                    
                    const explicacao = `‚Ä¢ <strong>Prefer√™ncia por grupo:</strong> Cada grupo tem tratamento espec√≠fico<br>
                        ‚Ä¢ <strong>Parcial:</strong> S√≥ advogados recebem, cession√°rios aguardam<br>
                        ‚Ä¢ <strong>Total:</strong> Advogados e cession√°rios recebem integralmente<br>
                        ‚Ä¢ <strong>Valores calculados</strong> conforme situa√ß√£o de cada grupo`;
                    
                    return `
                        <div class="table-container">
                            <h3>${titulo}</h3>
                            ${secoesPorBase.join('')}
                            <div style="margin-top: 10px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #007bff; font-size: 0.9em;">
                                <strong>üí° Explica√ß√£o da Prefer√™ncia:</strong><br>
                                ${explicacao}
                            </div>
                        </div>
                    `;
                }
            }
            // BENEFICIARIO PRINCIPAL
            else {
                const advogadosComCessao = resultados.honorarios.filter(adv => 
                    adv.cessoesAdv && adv.cessoesAdv.length > 0
                );
                
                if (advogadosComCessao.length === 0) return '';
                
                const isPreferencia = dados.tipoCalculo === 'preferencia';
                const isParcial = dados.tipoCalculo === 'parcial';
                const isPreferenciaParcial = isPreferencia && resultados.valorBase < resultados.valortotatt;
                
                const secoesCessoes = advogadosComCessao.map(adv => {
                    let valorHonorario, valorAdvogado;
                    
                    if (isParcial) {
                        // Pagamento parcial
                        valorHonorario = resultados.valorBase * adv.percentual;
                        valorAdvogado = resultados.valorBase * adv.percentualAdvogado;
                    } else if (isPreferenciaParcial) {
                        // Prefer√™ncia parcial
                        valorHonorario = adv.valorBruto;
                        valorAdvogado = adv.valorBrutoAdvogado;
                    } else if (isPreferencia) {
                        // Prefer√™ncia total
                        valorHonorario = resultados.valortotatt * adv.percentual;
                        valorAdvogado = resultados.valortotatt * adv.percentualAdvogado;
                    } else {
                        // Ordem comum
                        valorHonorario = adv.valorBruto;
                        valorAdvogado = adv.valorBrutoAdvogado;
                    }
                    
                    let cessionarios = '';
                    if (isPreferenciaParcial) {
                        // Prefer√™ncia parcial: cession√°rios aguardam
                        cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => `
                            <tr>
                                <td>${cessionario.nome} (cession√°rio) - <em>aguarda</em></td>
                                <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                <td>R$ ${formatarMoeda(cessionario.valorBruto)}</td>
                            </tr>
                        `).join('') : '';
                    } else if (isParcial) {
                        // Pagamento parcial: cession√°rios recebem proporcionalmente
                        cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => {
                            
                            const valorCessionario = valorHonorario * cessionario.percentual;
                            
                            return `
                                <tr>
                                    <td>${cessionario.nome} (cession√°rio)</td>
                                    <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(valorCessionario)}</td>
                                </tr>
                            `;
                        }).join('') : '';
                    } else {
                        // Ordem comum ou prefer√™ncia total: cession√°rios recebem
                        cessionarios = adv.cessionarios ? adv.cessionarios.map(cessionario => {
                            let valorCessionario;
                            if (isPreferencia) {
                                valorCessionario = resultados.valortotatt * cessionario.percentual;
                            } else {
                                // Para ordem comum, usar o valor correto j√° calculado
                                valorCessionario = cessionario.valorBruto;
                            }
                            
                            return `
                                <tr>
                                    <td>${cessionario.nome} (cession√°rio)</td>
                                    <td>${(cessionario.percentual * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(valorCessionario)}</td>
                                </tr>
                            `;
                        }).join('') : '';
                    }
                    
                    let textoValor = 'Bruto';
                    if (isPreferenciaParcial) textoValor = 'do Direito';
                    else if (isParcial) textoValor = 'Parcial';
                    
                    return `
                        <div style="margin-bottom: 20px;">
                            <h4>üîÑ Cess√£o de Honor√°rios: ${adv.nome}</h4>
                            <p><strong>Valor do Honor√°rio${isPreferenciaParcial ? ' (Prefer√™ncia)' : isParcial ? ' (Parcial)' : ''}:</strong> R$ ${formatarMoeda(valorHonorario)}</p>
                            <p><strong>Cedido:</strong> ${(adv.percentualCessionarioAdv * 100).toFixed(2)}% para ${adv.cessoesAdv.length} cession√°rio${adv.cessoesAdv.length > 1 ? 's' : ''}</p>
                            
                            <table>
                                <tr><th>Recebedor</th><th>Percentual</th><th>Valor ${textoValor}</th></tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td><strong>${adv.nome} (fica com)</strong></td>
                                    <td>${(adv.percentualAdvogado * 100).toFixed(2)}%</td>
                                    <td>R$ ${formatarMoeda(valorAdvogado)}</td>
                                </tr>
                                ${cessionarios}
                                <tr class="highlight" style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #dee2e6;">
                                    <td>TOTAL</td>
                                    <td>-%</td>
                                    <td>R$ ${formatarMoeda(valorHonorario)}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                }).join('');
                
                let titulo = 'üîÑ Cess√µes de Honor√°rios';
                if (isPreferenciaParcial) titulo = 'üîÑ Cess√µes de Honor√°rios - Prefer√™ncia Parcial';
                else if (isParcial) titulo = 'üîÑ Cess√µes de Honor√°rios - Pagamento Parcial';
                else if (isPreferencia) titulo = 'üîÑ Cess√µes de Honor√°rios - Prefer√™ncia Total';
                
                return `
                    <div class="table-container">
                        <h3>${titulo}</h3>
                        ${secoesCessoes}
                    </div>
                `;
            }
        }

        function gerarSecaoPagamentosOcorridos(resultados, dados) {
            if (!resultados.pagamentos || resultados.pagamentos.length === 0) {
                return '';
            }

            const pagamentosPorBeneficiario = {};
            resultados.pagamentos.forEach(pag => {
                if (!pagamentosPorBeneficiario[pag.beneficiario]) {
                    pagamentosPorBeneficiario[pag.beneficiario] = [];
                }
                pagamentosPorBeneficiario[pag.beneficiario].push(pag);
            });

            // Lista de cession√°rios (para filtrar)
            const cessionarios = new Set();
            
            // Cession√°rios do Benefici√°rio
            if (resultados.cessoesBeneficiarioFinais) {
                resultados.cessoesBeneficiarioFinais.forEach(c => cessionarios.add(c.cessionario));
            }
            
            // Cession√°rios de Herdeiros
            if (resultados.herdeiros) {
                resultados.herdeiros.forEach(h => {
                    if (h.cessoesHerdeiroFinais) {
                        h.cessoesHerdeiroFinais.forEach(c => cessionarios.add(c.cessionario));
                    }
                });
            }
            
            // Cession√°rios de Advogados
            if (resultados.honorarios) {
                resultados.honorarios.forEach(adv => {
                    if (adv.cessionarios) {
                        adv.cessionarios.forEach(c => cessionarios.add(c.nome));
                    }
                });
            }
            
            // Cession√°rios de Advogados Sucumbenciais
            if (resultados.honorariosSucumbenciais?.honorarios) {
                resultados.honorariosSucumbenciais.honorarios.forEach(adv => {
                    if (adv.cessionarios) {
                        adv.cessionarios.forEach(c => cessionarios.add(c.nome));
                    }
                });
            }
            
            // Cession√°rios de Sindicatos
            if (resultados.sindicatos) {
                resultados.sindicatos.forEach(sind => {
                    if (sind.cessionarios) {
                        sind.cessionarios.forEach(c => cessionarios.add(c.nome));
                    }
                });
            }

            let htmlLinhas = '';

            Object.keys(pagamentosPorBeneficiario).forEach(beneficiario => {
                // ‚ùå N√ÉO MOSTRAR cession√°rios sem pagamento direto
                if (cessionarios.has(beneficiario)) {
                    const pagamentosDoBeneficiario = pagamentosPorBeneficiario[beneficiario];
                    
                    // Verificar se teve pagamento direto
                    const tevePagamentoDireto = pagamentosDoBeneficiario.length > 0;
                    
                    if (!tevePagamentoDireto) {
                        return; // Pula este cession√°rio
                    }
                }
                
                const pagamentosDoBeneficiario = pagamentosPorBeneficiario[beneficiario];
                
                pagamentosDoBeneficiario.forEach(pag => {
                    const dataFormatada = new Date(pag.dataBase + 'T00:00:00').toLocaleDateString('pt-BR');
                    
                    const pagamentoOriginal = dados.pagamentos.find(p => 
                        p.beneficiario === pag.beneficiario && 
                        p.dataBase === pag.dataBase
                    );
                    
                    let valorOriginalPago = pag.valorOriginal.principal + pag.valorOriginal.juros;
                    
                    let detalhamentoGrid = `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; margin-top: 6px; font-size: 0.85em; color: #666;">
                            <span>Principal:</span>
                            <span style="text-align: right;">R$ ${formatarMoeda(pag.valorOriginal.principal)}</span>
                            <span>Juros:</span>
                            <span style="text-align: right;">R$ ${formatarMoeda(pag.valorOriginal.juros)}</span>
                    `;
                    
                    if (pagamentoOriginal) {
                        if (pagamentoOriginal.tipoSelic === 'valor' && pagamentoOriginal.valorSelic > 0) {
                            const valorSelicInformado = pagamentoOriginal.valorSelic;
                            valorOriginalPago += valorSelicInformado;
                            detalhamentoGrid += `
                                <span>SELIC:</span>
                                <span style="text-align: right;">R$ ${formatarMoeda(valorSelicInformado)}</span>
                            `;
                        } else if (pagamentoOriginal.tipoSelic === 'percentual' && pagamentoOriginal.percentualSelic > 0) {
                            const percentualSelicInformado = pagamentoOriginal.percentualSelic;
                            const valorSelicCalculado = (pag.valorOriginal.principal + pag.valorOriginal.juros) * percentualSelicInformado;
                            valorOriginalPago += valorSelicCalculado;
                            detalhamentoGrid += `
                                <span>SELIC (${(percentualSelicInformado * 100).toFixed(2)}%):</span>
                                <span style="text-align: right;">R$ ${formatarMoeda(valorSelicCalculado)}</span>
                            `;
                        }
                    }
                    
                    detalhamentoGrid += `</div>`;
                    
                    const detalhesIndices = [];
                    
                    if (pag.indices.cnj && pag.indices.cnj !== 1) {
                        detalhesIndices.push(`CNJ: ${(pag.indices.cnj).toFixed(6)}`);
                    }
                    
                    if (pag.indices.selic && pag.indices.selic !== 1) {
                        const percentualSelic = ((pag.indices.selic - 1) * 100).toFixed(2);
                        detalhesIndices.push(`SELIC: ${percentualSelic}%`);
                    }
                    
                    if (pag.indices.ipca && pag.indices.ipca !== 1) {
                        detalhesIndices.push(`IPCA: ${(pag.indices.ipca).toFixed(6)}`);
                    }
                    
                    if (pag.indices.jurosMora && pag.indices.jurosMora > 0) {
                        const percentualMora = (pag.indices.jurosMora * 100).toFixed(4);
                        detalhesIndices.push(`J.Mora: ${percentualMora}%`);
                    }
                    
                    const indicesTexto = detalhesIndices.length > 0 ? 
                        detalhesIndices.join(' | ') : 
                        'Sem corre√ß√£o';

                    htmlLinhas += `
                        <tr>
                            <td>${beneficiario}</td>
                            <td>${dataFormatada}</td>
                            <td>
                                <strong style="font-size: 1.05em;">R$ ${formatarMoeda(valorOriginalPago)}</strong>
                                ${detalhamentoGrid}
                            </td>
                            <td>${indicesTexto}</td>
                            <td><strong>R$ ${formatarMoeda(pag.valorAtualizado.total)}</strong></td>
                        </tr>
                    `;
                });
            });

            return `
                <div class="deducoes-acessorias">
                    <div class="table-container">
                        <h3>üí≥ Pagamentos Ocorridos</h3>
                        <div class="explicacao-juridica">
                            <div class="titulo">Entenda os Pagamentos Ocorridos</div>
                            <p><strong>Valores Pagos:</strong> Montantes que j√° foram pagos aos benefici√°rios em datas anteriores.</p>
                            <p><strong>Atualiza√ß√£o Monet√°ria:</strong> Os valores foram corrigidos desde a data do pagamento at√© a data de atualiza√ß√£o do c√°lculo.</p>
                            <p><strong>Desconto Necess√°rio:</strong> Estes valores devem ser deduzidos dos montantes devidos atualmente.</p>
                        </div>
                        
                        <table>
                            <tr>
                                <th>Benefici√°rio</th>
                                <th>Data do Pagamento</th>
                                <th>Valor Original Pago</th>
                                <th>√çndices Aplicados</th>
                                <th>Valor Atualizado</th>
                            </tr>
                            ${htmlLinhas}
                        </table>
                    </div>
                </div>
            `;
        }

        function gerarDemonstrativoSaldoRemanescente(resultados) {
            if (!resultados.saldosFinais) {
                return '';
            }
            
            const saldos = resultados.saldosFinais;
            let htmlLinhas = '';
            
            // 1. Benefici√°rio Principal
            if (saldos.beneficiarioPrincipal && saldos.beneficiarioPrincipal.pagamento > 0) {
                const benef = saldos.beneficiarioPrincipal;
                htmlLinhas += `
                    <tr>
                        <td>${benef.nome} (Benefici√°rio Principal)</td>
                        <td>R$ ${formatarMoeda(benef.valorBruto)}</td>
                        <td>R$ ${formatarMoeda(benef.pagamento)}</td>
                        <td><strong>R$ ${formatarMoeda(benef.saldo)}</strong></td>
                    </tr>
                `;
            }
            
            // 2. Herdeiros
            if (saldos.herdeiros && saldos.herdeiros.length > 0) {
                saldos.herdeiros.forEach(herd => {
                    let detalhesPagamento = '';
                    if (herd.pagamentoDoBeneficiario && herd.pagamentoDoBeneficiario > 0) {
                        detalhesPagamento = `<br><small style="color: #666;">(Direto: R$ ${formatarMoeda(herd.pagamentoDireto)} + Do Benef.: R$ ${formatarMoeda(herd.pagamentoDoBeneficiario)})</small>`;
                    }
                    
                    htmlLinhas += `
                        <tr>
                            <td>${herd.nome} (Herdeiro)</td>
                            <td>R$ ${formatarMoeda(herd.valorBruto)}</td>
                            <td>R$ ${formatarMoeda(herd.pagamento)}${detalhesPagamento}</td>
                            <td><strong>R$ ${formatarMoeda(herd.saldo)}</strong></td>
                        </tr>
                    `;
                });
            }
            
            // 3. Advogados
            if (saldos.advogados && saldos.advogados.length > 0) {
                saldos.advogados.forEach(adv => {
                    htmlLinhas += `
                        <tr>
                            <td>${adv.nome} (Advogado ${adv.tipo})</td>
                            <td>R$ ${formatarMoeda(adv.valorBruto)}</td>
                            <td>R$ ${formatarMoeda(adv.pagamento)}</td>
                            <td><strong>R$ ${formatarMoeda(adv.saldo)}</strong></td>
                        </tr>
                    `;
                });
            }
            
            // 4. Advogados Sucumbenciais
            if (saldos.advogadosSucumbenciais && saldos.advogadosSucumbenciais.length > 0) {
                saldos.advogadosSucumbenciais.forEach(advSuc => {
                    htmlLinhas += `
                        <tr>
                            <td>${advSuc.nome} (Adv. Sucumbencial ${advSuc.tipo})</td>
                            <td>R$ ${formatarMoeda(advSuc.valorBruto)}</td>
                            <td>R$ ${formatarMoeda(advSuc.pagamento)}</td>
                            <td><strong>R$ ${formatarMoeda(advSuc.saldo)}</strong></td>
                        </tr>
                    `;
                });
            }
            
            // 5. Sindicatos
            if (saldos.sindicatos && saldos.sindicatos.length > 0) {
                saldos.sindicatos.forEach(sind => {
                    htmlLinhas += `
                        <tr>
                            <td>${sind.nome} (Sindicato)</td>
                            <td>R$ ${formatarMoeda(sind.valorBruto)}</td>
                            <td>R$ ${formatarMoeda(sind.pagamento)}</td>
                            <td><strong>R$ ${formatarMoeda(sind.saldo)}</strong></td>
                        </tr>
                    `;
                });
            }
            
            // 6. Cession√°rios (SEMPRE mostrar, mesmo sem pagamento direto)
            if (saldos.cessionarios && saldos.cessionarios.length > 0) {
                saldos.cessionarios.forEach(cess => {
                    // S√≥ mostrar se teve pagamento
                    if (cess.pagamento > 0) {  // üëà ESTA LINHA √â CRUCIAL
                        let detalhesPagamento = '';
                        
                        // Se tem pagamentoDireto definido, mostrar detalhamento
                        if (cess.hasOwnProperty('pagamentoDireto')) {
                            const pagamentoDoCedente = cess.pagamento - cess.pagamentoDireto;
                            if (pagamentoDoCedente > 0) {
                                detalhesPagamento = `<br><small style="color: #666;">(Direto: R$ ${formatarMoeda(cess.pagamentoDireto)} + Do Cedente: R$ ${formatarMoeda(pagamentoDoCedente)})</small>`;
                            }
                        }
                        
                        htmlLinhas += `
                            <tr>
                                <td>${cess.nome} (${cess.tipo})</td>
                                <td>R$ ${formatarMoeda(cess.valorBruto)}</td>
                                <td>R$ ${formatarMoeda(cess.pagamento)}${detalhesPagamento}</td>
                                <td><strong>R$ ${formatarMoeda(cess.saldo)}</strong></td>
                            </tr>
                        `;
                    }  // üëà FECHA O IF
                });
            }
            
            return `
                <div class="pagamentos-finais">
                    <div class="table-container">
                        <h3>üìä Demonstrativo do Saldo Remanescente</h3>
                        <table>
                            <tr>
                                <th>Benefici√°rio</th>
                                <th>Valor Antes do Pagamento (Bruto)</th>
                                <th>(-) Valor Pago</th>
                                <th>Saldo Remanescente (Bruto)</th>
                            </tr>
                            ${htmlLinhas}
                            <tr class="highlight">
                                <td><strong>TOTAL</strong></td>
                                <td><strong>R$ ${formatarMoeda(saldos.totalGeralOriginal)}</strong></td>
                                <td><strong>R$ ${formatarMoeda(saldos.totalGeralOriginal - saldos.totalGeralBruto)}</strong></td>
                                <td><strong>R$ ${formatarMoeda(saldos.totalGeralBruto)}</strong></td>
                            </tr>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            <strong>‚ö†Ô∏è Observa√ß√£o:</strong> Os valores de IR e Previd√™ncia ser√£o calculados sobre o saldo remanescente.
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarSecaoDeducoes(resultados, dados) {
            const temPrevidencia = dados.incidenciaPrevidencia || 
                (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.previdencia === true));
            
            const temIR = (dados.incidenciaIR || 
                (dados.valoresPrincipais && dados.valoresPrincipais.some(item => item.tributacao?.ir === true))) 
                && (dados.tipoBeneficiario === 'pj' || resultados.rrapagamento !== 0);

            if (!temPrevidencia && !temIR) return '';

            if (dados.tipoCalculo === 'acordo') {
                if (!validarAdesaoParaAcordo(dados)) return '';
            }

            const resultadosParaUsar = resultados.saldosFinais 
                ? ajustarResultadosComPagamentos(resultados, dados) 
                : resultados;

            const config = {
                temPrevidencia,
                temIR,
                tipoPrevidencia: dados.valoresPrincipais?.find(item => item.tributacao?.tipoPrevidencia)?.tributacao.tipoPrevidencia || null,
                temHerdeiros: resultadosParaUsar.temHerdeiros && resultadosParaUsar.herdeiros.length > 0  // ‚Üê MUDOU
            };

            if (dados.natureza === 'comum') {
                return gerarDeducoesSimples(resultadosParaUsar, dados, config.temPrevidencia, config.temIR);
            }
            
            if (!config.temHerdeiros) {
                return gerarDeducoesSimples(resultadosParaUsar, dados, config.temPrevidencia, config.temIR);
            }
            
            if (dados.tipoCalculo === 'preferencia') {
                return gerarDeducoesPreferencia(resultadosParaUsar, dados, config);
            } else {
                return gerarDeducoesOrdem(resultadosParaUsar, dados, config);
            }
        }

        function validarAdesaoParaAcordo(dados) {
            const adesoes = obterAdesaoAcordo();
            const beneficiarioOuHerdeirosAderiram = adesoes.beneficiario || adesoes.herdeiros.length > 0;
            
            let cessionarioRelevante = false;
            if (adesoes.cessionarios.length > 0) {
                for (let i = 0; i < adesoes.cessionarios.length; i++) {
                    const cessaoIndex = adesoes.cessionarios[i];
                    const cessao = dados.cessoes[cessaoIndex];
                    if (cessao && (cessao.tipo === 'cessaobenPrincipal' || cessao.tipo === 'cessaoherdeiro')) {
                        cessionarioRelevante = true;
                        break;
                    }
                }
            }
            
            return beneficiarioOuHerdeirosAderiram || cessionarioRelevante;
        }

        function gerarDeducoesOrdem(resultados, dados, config) {
            const { temPrevidencia, temIR, tipoPrevidencia } = config;
            
            let herdeirosFiltrados = resultados.herdeiros;
            if (dados.tipoCalculo === 'acordo') {
                const adesoes = obterAdesaoAcordo();
                herdeirosFiltrados = resultados.herdeiros.filter((h, index) => 
                    adesoes.herdeiros.includes(index)
                );
            }
            
            const secoes = [];
            
            const secaoBeneficiario = gerarSecaoBeneficiarioPrincipal(resultados, dados, temPrevidencia, temIR, tipoPrevidencia);
            if (secaoBeneficiario) {
                secoes.push(secaoBeneficiario);
            }
            
            const secoesHerdeiros = gerarSecoesHerdeirosAgrupados(herdeirosFiltrados, dados, temPrevidencia, temIR, tipoPrevidencia);
            secoes.push(...secoesHerdeiros);
            
            if (secoes.length === 0) return '';
            
            return montarResultadoFinal(secoes, 'ordem');
        }

        function gerarDeducoesPreferencia(resultados, dados, config) {
            const { temPrevidencia, temIR, tipoPrevidencia } = config;
            
            let herdeirosFiltrados;
            if (dados.tipoCalculo === 'acordo') {
                const adesoes = obterAdesaoAcordo();
                const herdeirosPorAdesao = resultados.herdeiros.filter((h, index) => 
                    adesoes.herdeiros.includes(index)
                );
                herdeirosFiltrados = herdeirosPorAdesao.filter(h => h.temPreferencia || h.isPreferenciaParcial);
            } else {
                herdeirosFiltrados = resultados.herdeiros.filter(h => h.temPreferencia || h.isPreferenciaParcial);
            }
            
            if (herdeirosFiltrados.length === 0) return '';
            
            const secoesPorBase = gerarSecoesPreferenciaPorBase(herdeirosFiltrados, dados, temPrevidencia, temIR, tipoPrevidencia);
            
            if (secoesPorBase.length === 0) return '';
            
            const isPreferenciaParcial = resultados.valorBase < resultados.valortotatt;
            const tipoTitulo = isPreferenciaParcial ? 'preferencia_parcial' : 'preferencia_total';
            
            return montarResultadoFinal(secoesPorBase, tipoTitulo);
        }

        function gerarSecaoBeneficiarioPrincipal(resultados, dados, temPrevidencia, temIR, tipoPrevidencia) {
            const temCessoesBeneficiario = resultados.cessoesBeneficiarioCalculadas && resultados.cessoesBeneficiarioCalculadas.length > 0;
            if (!temCessoesBeneficiario) return null;
            
            let secaoPrevidencia = '';
            if (temPrevidencia) {
                if (tipoPrevidencia === 'fixa') {
                    secaoPrevidencia = gerarDetalhePrevidenciaFixa(resultados, dados, temCessoesBeneficiario);
                } else {
                    secaoPrevidencia = gerarDetalhePrevidenciaINSS(resultados, dados, temCessoesBeneficiario);
                }
            }
            
            let secaoIR = '';
            if (temIR) {
                secaoIR = gerarDetalheIR(resultados, dados, temPrevidencia, temCessoesBeneficiario);
            }
            
            if (!secaoPrevidencia && !secaoIR) return null;
            
            return `
                <div style="margin-bottom: 30px; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <p style="color: #155724; font-style: italic; margin-bottom: 15px;">
                        <strong>Dedu√ß√µes do Benefici√°rio Principal:</strong> ${dados.beneficiario}
                        <span style="color: #856404;"> - R$ ${formatarMoeda(resultados.valorBase)}</span>
                    </p>
                    ${secaoPrevidencia}
                    ${secaoIR}
                </div>
            `;
        }

        function gerarSecoesHerdeirosAgrupados(herdeirosFiltrados, dados, temPrevidencia, temIR, tipoPrevidencia) {
            if (herdeirosFiltrados.length === 0) return [];
            
            const baseGroups = new Map();
            herdeirosFiltrados.forEach(h => {
                const baseKey = h.valorTotal.toFixed(2);
                if (!baseGroups.has(baseKey)) baseGroups.set(baseKey, []);
                baseGroups.get(baseKey).push(h);
            });
            
            const secoes = [];
            
            baseGroups.forEach((herdeiros, base) => {
                const valorBase = parseFloat(base);
                const herdeirosNomes = herdeiros.map(h => h.nome).join(', ');
                const primeiroHerdeiro = herdeiros[0];
                
                let secaoPrevidencia = '';
                if (temPrevidencia) {
                    if (tipoPrevidencia === 'fixa') {
                        secaoPrevidencia = gerarDetalhePrevidenciaFixaHerdeiros(herdeiros, dados, valorBase);
                    } else {
                        secaoPrevidencia = gerarDetalhePrevidenciaINSSHerdeiros(herdeiros, dados, valorBase);
                    }
                }
                
                let secaoIR = '';
                if (temIR && primeiroHerdeiro.rrapagamento !== 0) {
                    secaoIR = gerarDetalheIRHerdeiros(herdeiros, dados, valorBase, temPrevidencia, false);
                }
                
                if (secaoPrevidencia || secaoIR) {
                    secoes.push(`
                        <div style="margin-bottom: 30px; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                            <p style="color: #155724; font-style: italic; margin-bottom: 15px;">
                                <strong>Dedu√ß√µes de:</strong> ${herdeirosNomes}
                                <span style="color: #856404;"> - R$ ${formatarMoeda(valorBase)}</span>
                            </p>
                            ${secaoPrevidencia}
                            ${secaoIR}
                        </div>
                    `);
                }
            });
            
            return secoes;
        }

        function gerarSecoesPreferenciaPorBase(herdeirosFiltrados, dados, temPrevidencia, temIR, tipoPrevidencia) {
            const baseGroups = new Map();
            herdeirosFiltrados.forEach(h => {
                const baseKey = h.valorTotal.toFixed(2);
                if (!baseGroups.has(baseKey)) baseGroups.set(baseKey, []);
                baseGroups.get(baseKey).push(h);
            });
            
            const secoesPorBase = [];
            
            baseGroups.forEach((herdeiros, base) => {
                const valorBase = parseFloat(base);
                const herdeirosNomes = herdeiros.map(h => h.nome).join(', ');
                const primeiroHerdeiro = herdeiros[0];
                const temAlgumParcial = herdeiros.some(h => h.isPreferenciaParcial);
                
                let secaoPrevidencia = '';
                if (temPrevidencia) {
                    if (tipoPrevidencia === 'fixa') {
                        secaoPrevidencia = gerarDetalhePrevidenciaFixaHerdeirosSemCessao(herdeiros, dados, valorBase);
                    } else {
                        secaoPrevidencia = gerarDetalhePrevidenciaINSSHerdeirosSemCessao(herdeiros, dados, valorBase);
                    }
                }
                
                let secaoIR = '';
                if (temIR && primeiroHerdeiro.rrapagamento !== 0) {
                    secaoIR = gerarDetalheIRHerdeirosSemCessao(herdeiros, dados, valorBase, temPrevidencia, temAlgumParcial);
                }
                
                if (secaoPrevidencia || secaoIR) {
                    secoesPorBase.push(`
                        <div style="margin-bottom: 30px; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                            <p style="color: #155724; font-style: italic; margin-bottom: 15px;">
                                <strong>Dedu√ß√µes de:</strong> ${herdeirosNomes}
                                <span style="color: #856404;"> - R$ ${formatarMoeda(valorBase)}</span>
                                ${temAlgumParcial ? ' <em>(Prefer√™ncia Parcial)</em>' : ' <em>(Prefer√™ncia Total)</em>'}
                            </p>
                            ${secaoPrevidencia}
                            ${secaoIR}
                        </div>
                    `);
                }
            });
            
            return secoesPorBase;
        }

        function montarResultadoFinal(secoes, tipo) {
            const titulos = {
                'ordem': 'üè¶ Dedu√ß√µes Legais',
                'preferencia_total': 'üè¶ Dedu√ß√µes Legais - Prefer√™ncia Total',
                'preferencia_parcial': 'üè¶ Dedu√ß√µes Legais - Prefer√™ncia (Parcial/Total)'
            };
            
            const explicacoes = {
                'ordem': `
                    ‚Ä¢ <strong>Benefici√°rio principal:</strong> Discrimina cess√µes quando aplic√°vel<br>
                    ‚Ä¢ <strong>Herdeiros agrupados:</strong> Por valor igual, com cess√µes individuais<br>
                    ‚Ä¢ <strong>C√°lculos espec√≠ficos</strong> para cada situa√ß√£o
                `,
                'preferencia_total': `
                    ‚Ä¢ <strong>Herdeiros agrupados</strong> por valor igual, com c√°lculos espec√≠ficos<br>
                    ‚Ä¢ <strong>Previd√™ncia e IR</strong> individuais por herdeiro<br>
                    ‚Ä¢ <strong>Cess√µes n√£o aplic√°veis</strong> na prefer√™ncia (cession√°rios aguardam ordem cronol√≥gica)
                `,
                'preferencia_parcial': `
                    ‚Ä¢ <strong>Herdeiros agrupados</strong> por valor igual, com c√°lculos espec√≠ficos<br>
                    ‚Ä¢ <strong>Previd√™ncia e IR</strong> individuais por herdeiro<br>
                    ‚Ä¢ <strong>Cess√µes n√£o aplic√°veis</strong> na prefer√™ncia (cession√°rios aguardam ordem cronol√≥gica)
                `
            };
            
            return `
                <div class="deducoes-legais">
                    <div class="table-container">
                        <h3>${titulos[tipo]}</h3>
                        ${secoes.join('')}
                        <div style="margin-top: 10px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #007bff; font-size: 0.9em;">
                            <strong>üí° Explica√ß√£o:</strong><br>
                            ${explicacoes[tipo]}
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarDeducoesSimples(resultados, dados, temPrevidencia, temIR) {
            const temCessoes = resultados.cessoesBeneficiarioCalculadas && resultados.cessoesBeneficiarioCalculadas.length > 0;
            const isPJ = dados.natureza === 'comum' && dados.tipoBeneficiario === 'pj';

            const tipoPrevidencia = dados.valoresPrincipais?.find(item => item.tributacao?.tipoPrevidencia)?.tributacao.tipoPrevidencia || null;
            
            let secaoPrevidencia = '';
            if (temPrevidencia && !isPJ) { // PJ n√£o tem previd√™ncia
                if (tipoPrevidencia === 'fixa') {
                    secaoPrevidencia = gerarDetalhePrevidenciaFixa(resultados, dados, temCessoes);
                } else {
                    secaoPrevidencia = gerarDetalhePrevidenciaINSS(resultados, dados, temCessoes);
                }
            }
            
            let secaoIR = '';
            if (temIR) {
                if (isPJ) {
                    secaoIR = gerarDetalheIRPJ(resultados, dados, temCessoes);
                } else {
                    secaoIR = gerarDetalheIR(resultados, dados, temPrevidencia, temCessoes);
                }
            }

            if (!secaoPrevidencia && !secaoIR) {
                return '';
            }
            
            const titulo = isPJ ? 'üè¶ Dedu√ß√µes Legais - Pessoa Jur√≠dica' : 'üè¶ Dedu√ß√µes Legais';
            
            return `
                <div class="deducoes-legais">
                    <div class="table-container">
                        <h3>${titulo}</h3>
                        ${secaoPrevidencia}
                        ${secaoIR}
                    </div>
                </div>
            `;
        }

        function gerarDetalhePrevidenciaFixa(resultados, dados, temCessoes) {
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let valorSemDesagio = resultados.valorPrevidencia;
            let valorDesagio = 0;
            let valorComDesagio = resultados.valorPrevidencia;
            
            if (isAcordo && resultados.valorDesagioPrevidencia) {
                valorComDesagio = resultados.valorPrevidencia; // valor final (j√° com des√°gio)
                valorDesagio = resultados.valorDesagioPrevidencia; // valor do desconto
                valorSemDesagio = resultados.valorPrevidencia + resultados.valorDesagioPrevidencia; // valor original
            }

            const aliquotaFixa = dados.valoresPrincipais?.find(item => item.tributacao?.aliquotaFixa)?.tributacao.aliquotaFixa || 0;

            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                </tr>
                ${resultados.valorPrevidenciaBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorPrevidenciaBeneficiario)}</td>
                </tr>` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.previdenciaCessao > 0 ? `
                <tr>
                    <th>${cessao.cessionario}:</th>
                    <td>R$ ${formatarMoeda(cessao.previdenciaCessao)}</td>
                </tr>` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - Al√≠quota Fixa</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota Fixa:</th>
                        <td>${(aliquotaFixa * 100).toFixed(2)}%</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : ''}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && valorDesagio > 0 ? `
                    <tr style="color: #dc3545;">
                        <th>(-) Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td>R$ ${formatarMoeda(valorDesagio)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaINSS(resultados, dados, temCessoes) {
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            const base = resultados.rrapagamento === 0 ? resultados.principal : resultados.principal / resultados.rrapagamento;
            
            let valorSemDesagio = resultados.valorPrevidencia;
            let valorDesagio = 0;
            let valorComDesagio = resultados.valorPrevidencia;
            
            if (isAcordo && resultados.valorDesagioPrevidencia) {
                valorComDesagio = resultados.valorPrevidencia; // valor final (j√° com des√°gio)
                valorDesagio = resultados.valorDesagioPrevidencia; // valor do desconto
                valorSemDesagio = resultados.valorPrevidencia + resultados.valorDesagioPrevidencia; // valor original
            }
            
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                </tr>
                ${resultados.valorPrevidenciaBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorPrevidenciaBeneficiario)}</td>
                </tr>` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.previdenciaCessao > 0 ? `
                <tr>
                    <th>${cessao.cessionario}:</th>
                    <td>R$ ${formatarMoeda(cessao.previdenciaCessao)}</td>
                </tr>` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - INSS</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    ${resultados.rrapagamento !== 0 ? `
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(resultados.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(base)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>Al√≠quota Efetiva INSS:</th>
                        <td>${(resultados.aliquotaEfetiva * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(valorSemDesagio / (resultados.rrapagamento || 1))} ${base > 8157.41 ? '(TETO)' : ''}</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : ''}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && valorDesagio > 0 ? `
                    <tr style="color: #dc3545;">
                        <th>(-) Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td>R$ ${formatarMoeda(valorDesagio)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalheIR(resultados, dados, temPrevidencia, temCessoes) {
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;

            let percentualTotalAdv = 0;
            let percentualTotalSind = 0;
            
            if (dados.tipoCalculo === 'preferencia') {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = 0;
            } else {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            }

            let baseComDesagio = '';
            if (isAcordo && resultados.percentualDesagioIR > 0) {
                baseComDesagio = `
                <tr>
                    <th>Base IR com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                    <td>R$ ${formatarMoeda(resultados.principalComDesagio)}</td>
                </tr>`;
            }
            
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                </tr>
                ${resultados.valorIRBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorIRBeneficiario)}</td>
                </tr>
                ` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.irCessao > 0 ? `
                    <tr>
                        <th>${cessao.cessionario}:</th>
                        <td>R$ ${formatarMoeda(cessao.irCessao)}</td>
                    </tr>
                    ` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Imposto de Renda - LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</th>
                    </tr>
                    <tr>
                        <th>Principal:</th>
                        <td>R$ ${formatarMoeda(resultados.principal)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem H.Contratuais (${(percentualTotalAdv * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRHonora)}</td>
                    </tr>
                    ${percentualTotalSind > 0 ? `
                    <tr>
                        <th>Base IR sem Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRSindi)}</td>
                    </tr>` : ''}
                    ${baseComDesagio}
                    ${temPrevidencia ? `
                    <tr>
                        <th>Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(resultados.valorPrevidencia)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRPrev)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(resultados.rraComDesagio || resultados.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base IR por RRA:</th>
                        <td>R$ ${formatarMoeda(resultados.baseIRRRA)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota IR:</th>
                        <td>${(resultados.aliquotaIR * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor IR Mensal:</th>
                        <td>R$ ${formatarMoeda(resultados.valorIRUnitario)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor IR Devido Total:</th>
                        <td><strong>R$ ${formatarMoeda(resultados.valorIR)}</strong></td>
                    </tr>
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalheIRPJ(resultados, dados, temCessoes) {
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            let percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            
            const baseSemHonorarios = resultados.valortotatt - (resultados.valortotatt * percentualTotalAdv);
            const baseSemSindicatos = baseSemHonorarios - (resultados.valortotatt * percentualTotalSind);
            
            let baseComDesagio = '';
            if (isAcordo && percentualDesagio > 0) {
                const baseAposDesagio = baseSemSindicatos * (1 - percentualDesagio);
                
                baseComDesagio = `
                <tr>
                    <th>Base IR com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                    <td>R$ ${formatarMoeda(baseAposDesagio)}</td>
                </tr>`;
            }
            
            const distribuicaoCessoes = temCessoes ? `
                <tr style="border-top: 1px solid #dee2e6;">
                    <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                </tr>
                ${resultados.valorIRBeneficiario > 0 ? `
                <tr>
                    <th>${dados.beneficiario}:</th>
                    <td>R$ ${formatarMoeda(resultados.valorIRBeneficiario)}</td>
                </tr>
                ` : ''}
                ${resultados.cessoesBeneficiarioFinais ? resultados.cessoesBeneficiarioFinais.map((cessao) => 
                    cessao.irCessao > 0 ? `
                    <tr>
                        <th>${cessao.cessionario}:</th>
                        <td>R$ ${formatarMoeda(cessao.irCessao)}</td>
                    </tr>
                    ` : ''
                ).join('') : ''}
            ` : '';
            
            return `
                <table class="ir-table">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Imposto de Renda PJ - Art. 27, da Lei n¬∫ 10.833/03</th>
                    </tr>
                    <tr>
                        <th>Valor Total:</th>
                        <td>R$ ${formatarMoeda(resultados.valortotatt)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem H.Contratuais (${(percentualTotalAdv * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(baseSemHonorarios)}</td>
                    </tr>
                    ${percentualTotalSind > 0 ? `
                    <tr>
                        <th>Base IR sem Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(baseSemSindicatos)}</td>
                    </tr>` : ''}
                    ${baseComDesagio}
                    <tr>
                        <th>Al√≠quota IR:</th>
                        <td>3,0%</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor IR Devido Total:</th>
                        <td><strong>R$ ${formatarMoeda(resultados.valorIR)}</strong></td>
                    </tr>
                    ${distribuicaoCessoes}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaFixaHerdeirosSemCessao(herdeiros, dados, valorBase) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let valorSemDesagio = primeiroHerdeiro.valorPrevidencia;
            let valorComDesagio = primeiroHerdeiro.valorPrevidencia;
            
            if (isAcordo && primeiroHerdeiro.valorDesagioPrevidencia) {
                valorComDesagio = primeiroHerdeiro.valorPrevidencia; 
                valorSemDesagio = primeiroHerdeiro.valorPrevidencia + primeiroHerdeiro.valorDesagioPrevidencia; 
            }
            
            // Distribui√ß√£o por herdeiros
            const distribuicaoHerdeiros = herdeiros.map(herdeiro => `
                <tr>
                    <th>${herdeiro.nome}:</th>
                    <td>R$ ${formatarMoeda(herdeiro.valorPrevidencia)}</td>
                </tr>
            `).join('');

            const aliquotaFixa = dados.valoresPrincipais?.find(item => item.tributacao?.aliquotaFixa)?.tributacao.aliquotaFixa || 0;
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - Al√≠quota Fixa</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota Fixa:</th>
                        <td>${(aliquotaFixa * 100).toFixed(2)}%</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : 'por Herdeiro'}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && primeiroHerdeiro.valorDesagioPrevidencia > 0 ? `
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaINSSHerdeirosSemCessao(herdeiros, dados, valorBase) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            const base = primeiroHerdeiro.rrapagamento === 0 ? primeiroHerdeiro.principal : primeiroHerdeiro.principal / primeiroHerdeiro.rrapagamento;
            
            let valorSemDesagio = primeiroHerdeiro.valorPrevidencia;
            let valorComDesagio = primeiroHerdeiro.valorPrevidencia;
            
            if (isAcordo && primeiroHerdeiro.valorDesagioPrevidencia) {
                valorComDesagio = primeiroHerdeiro.valorPrevidencia; // valor final (j√° com des√°gio)
                valorSemDesagio = primeiroHerdeiro.valorPrevidencia + primeiroHerdeiro.valorDesagioPrevidencia; // valor original
            }

            const distribuicaoHerdeiros = herdeiros.map(herdeiro => `
                <tr>
                    <th>${herdeiro.nome}:</th>
                    <td>R$ ${formatarMoeda(herdeiro.valorPrevidencia)}</td>
                </tr>
            `).join('');
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - INSS</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    ${primeiroHerdeiro.rrapagamento !== 0 ? `
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(primeiroHerdeiro.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(base)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>Al√≠quota Efetiva INSS:</th>
                        <td>${(primeiroHerdeiro.aliquotaEfetiva * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(valorSemDesagio / (primeiroHerdeiro.rrapagamento || 1))} ${base > 8157.41 ? '(TETO)' : ''}</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : 'por Herdeiro'}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && primeiroHerdeiro.valorDesagioPrevidencia > 0 ? `
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function gerarDetalheIRHerdeirosSemCessao(herdeiros, dados, valorBase, temPrevidencia, temAlgumParcial) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            // Calcula percentuais 
            let percentualTotalAdv = 0;
            let percentualTotalSind = 0;

            if (dados.tipoCalculo === 'preferencia') {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = 0; // Sindicatos n√£o recebem na prefer√™ncia
            } else {
                // ORDEM CRONOL√ìGICA
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            }
            
            //acordo
            let baseComDesagio = '';
            if (isAcordo && percentualDesagio > 0) {
                baseComDesagio = `
                <tr>
                    <th>Base IR com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                    <td>R$ ${formatarMoeda(primeiroHerdeiro.principalComDesagio || primeiroHerdeiro.baseIRSindi)}</td>
                </tr>`;
            }
            
            const distribuicaoHerdeiros = herdeiros.map(herdeiro => `
                <tr>
                    <th>${herdeiro.nome}:</th>
                    <td>R$ ${formatarMoeda(herdeiro.valorIR)}</td>
                </tr>
            `).join('');
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Imposto de Renda - LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem H.Contratuais (${(percentualTotalAdv * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRHonora)}</td>
                    </tr>
                    ${percentualTotalSind > 0 ? `
                    <tr>
                        <th>Base IR sem Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRSindi)}</td>
                    </tr>` : ''}
                    ${baseComDesagio}
                    ${temPrevidencia ? `
                    <tr>
                        <th>Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.valorPrevidencia)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRPrev)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(primeiroHerdeiro.rraComDesagio || primeiroHerdeiro.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base IR por RRA:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRRRA)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota IR:</th>
                        <td>${(primeiroHerdeiro.aliquotaIR * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor IR Mensal:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.valorIRUnitario)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor IR Devido Total por Herdeiro:</th>
                        <td><strong>R$ ${formatarMoeda(primeiroHerdeiro.valorIR)}</strong></td>
                    </tr>
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaFixaHerdeiros(herdeiros, dados, valorBase) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let valorSemDesagio = primeiroHerdeiro.valorPrevidencia;
            let valorComDesagio = primeiroHerdeiro.valorPrevidencia;
            
            if (isAcordo && primeiroHerdeiro.valorDesagioPrevidencia) {
                valorComDesagio = primeiroHerdeiro.valorPrevidencia; // valor final (j√° com des√°gio)
                valorSemDesagio = primeiroHerdeiro.valorPrevidencia + primeiroHerdeiro.valorDesagioPrevidencia; // valor original
            }

            const aliquotaFixa = dados.valoresPrincipais?.find(item => item.tributacao?.aliquotaFixa)?.tributacao.aliquotaFixa || 0;
            
            const distribuicaoHerdeiros = herdeiros.map(herdeiro => {
                const temCessoes = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
                
                if (!temCessoes) {
                    return `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(herdeiro.valorPrevidencia)}</td>
                        </tr>
                    `;
                } else {
                    // Com cess√µes - distribui proporcionalmente
                    const valorPrevidenciaTotal = herdeiro.valorPrevidencia;
                    const cessoesTotais = herdeiro.cessoesHerdeiro.reduce((total, cessao) => total + cessao.percentual, 0);
                    const percentualHerdeiro = 1.0 - cessoesTotais;
                    
                    const valorHerdeiro = valorPrevidenciaTotal * percentualHerdeiro;
                    
                    let linhas = `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(valorHerdeiro)}</td>
                        </tr>
                    `;
                    
                    herdeiro.cessoesHerdeiro.forEach(cessao => {
                        const valorCessionario = valorPrevidenciaTotal * cessao.percentual;
                        linhas += `
                            <tr>
                                <th style="padding-left: 20px;">${cessao.cessionario} (Cession√°rio de ${herdeiro.nome} - ${(cessao.percentual * 100).toFixed(2)}%):</th>
                                <td>R$ ${formatarMoeda(valorCessionario)}</td>
                            </tr>
                        `;
                    });
                    
                    return linhas;
                }
            }).join('');
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - Al√≠quota Fixa</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota Fixa:</th>
                        <td>${(aliquotaFixa * 100).toFixed(2)}%</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : 'por Herdeiro'}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && primeiroHerdeiro.valorDesagioPrevidencia > 0 ? `
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function gerarDetalhePrevidenciaINSSHerdeiros(herdeiros, dados, valorBase) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            const base = primeiroHerdeiro.rrapagamento === 0 ? primeiroHerdeiro.principal : primeiroHerdeiro.principal / primeiroHerdeiro.rrapagamento;
            
            let valorSemDesagio = primeiroHerdeiro.valorPrevidencia;
            let valorComDesagio = primeiroHerdeiro.valorPrevidencia;
            
            if (isAcordo && primeiroHerdeiro.valorDesagioPrevidencia) {
                valorComDesagio = primeiroHerdeiro.valorPrevidencia; // valor final (j√° com des√°gio)
                valorSemDesagio = primeiroHerdeiro.valorPrevidencia + primeiroHerdeiro.valorDesagioPrevidencia; // valor original
            }
            
            const distribuicaoHerdeiros = herdeiros.map(herdeiro => {
                const temCessoes = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
                
                if (!temCessoes) {
                    return `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(herdeiro.valorPrevidencia)}</td>
                        </tr>
                    `;
                } else {
                    const valorPrevidenciaTotal = herdeiro.valorPrevidencia;
                    const cessoesTotais = herdeiro.cessoesHerdeiro.reduce((total, cessao) => total + cessao.percentual, 0);
                    const percentualHerdeiro = 1.0 - cessoesTotais;
                    
                    const valorHerdeiro = valorPrevidenciaTotal * percentualHerdeiro;
                    
                    let linhas = `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(valorHerdeiro)}</td>
                        </tr>
                    `;
                    
                    herdeiro.cessoesHerdeiro.forEach(cessao => {
                        const valorCessionario = valorPrevidenciaTotal * cessao.percentual;
                        linhas += `
                            <tr>
                                <th style="padding-left: 20px;">${cessao.cessionario} (Cession√°rio de ${herdeiro.nome} - ${(cessao.percentual * 100).toFixed(2)}%):</th>
                                <td>R$ ${formatarMoeda(valorCessionario)}</td>
                            </tr>
                        `;
                    });
                    
                    return linhas;
                }
            }).join('');
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Previd√™ncia - INSS</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    ${primeiroHerdeiro.rrapagamento !== 0 ? `
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(primeiroHerdeiro.rraComDesagio || primeiroHerdeiro.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(base)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>Al√≠quota Efetiva INSS:</th>
                        <td>${(primeiroHerdeiro.aliquotaEfetiva * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor INSS por RRA:</th>
                        <td>R$ ${formatarMoeda(valorSemDesagio / (primeiroHerdeiro.rrapagamento || 1))} ${base > 8157.41 ? '(TETO)' : ''}</td>
                    </tr>
                    <tr ${!isAcordo ? 'class="total-row"' : ''}>
                        <th>Valor Previd√™ncia ${isAcordo ? 'sem Des√°gio' : 'por Herdeiro'}:</th>
                        <td>${!isAcordo ? '<strong>' : ''}R$ ${formatarMoeda(valorSemDesagio)}${!isAcordo ? '</strong>' : ''}</td>
                    </tr>
                    ${isAcordo && primeiroHerdeiro.valorDesagioPrevidencia > 0 ? `
                    <tr class="total-row">
                        <th>Valor Previd√™ncia com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                        <td><strong>R$ ${formatarMoeda(valorComDesagio)}</strong></td>
                    </tr>` : ''}
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function gerarDetalheIRHerdeiros(herdeiros, dados, valorBase, temPrevidencia, temAlgumParcial) {
            const primeiroHerdeiro = herdeiros[0];
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let percentualTotalAdv = 0;
            let percentualTotalSind = 0;

            if (dados.tipoCalculo === 'preferencia') {
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = 0; // Sindicatos n√£o recebem na prefer√™ncia
            } else {
                // ORDEM CRONOL√ìGICA
                percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
                percentualTotalSind = dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            }
            
            let baseComDesagio = '';
            if (isAcordo && percentualDesagio > 0) {
                baseComDesagio = `
                <tr>
                    <th>Base IR com Des√°gio ${(percentualDesagio * 100).toFixed(2)}%:</th>
                    <td>R$ ${formatarMoeda(primeiroHerdeiro.principalComDesagio || primeiroHerdeiro.baseIRSindi)}</td>
                </tr>`;
            }
            
            const distribuicaoHerdeiros = herdeiros.map(herdeiro => {
                const temCessoes = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
                
                if (!temCessoes) {
                    return `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(herdeiro.valorIR)}</td>
                        </tr>
                    `;
                } else {
                    const valorIRTotal = herdeiro.valorIR;
                    const cessoesTotais = herdeiro.cessoesHerdeiro.reduce((total, cessao) => total + cessao.percentual, 0);
                    const percentualHerdeiro = 1.0 - cessoesTotais;
                    
                    const valorHerdeiro = valorIRTotal * percentualHerdeiro;
                    
                    let linhas = `
                        <tr>
                            <th>${herdeiro.nome}:</th>
                            <td>R$ ${formatarMoeda(valorHerdeiro)}</td>
                        </tr>
                    `;
                    
                    herdeiro.cessoesHerdeiro.forEach(cessao => {
                        const valorCessionario = valorIRTotal * cessao.percentual;
                        linhas += `
                            <tr>
                                <th style="padding-left: 20px;">${cessao.cessionario} (Cession√°rio de ${herdeiro.nome} - ${(cessao.percentual * 100).toFixed(2)}%):</th>
                                <td>R$ ${formatarMoeda(valorCessionario)}</td>
                            </tr>
                        `;
                    });
                    
                    return linhas;
                }
            }).join('');
            
            return `
                <table class="ir-table" style="margin-bottom: 15px;">
                    <tr>
                        <th colspan="2" class="section-header">üìÑ Imposto de Renda - LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</th>
                    </tr>
                    <tr>
                        <th>Principal (base):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.principal)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem H.Contratuais (${(percentualTotalAdv * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRHonora)}</td>
                    </tr>
                    ${percentualTotalSind > 0 ? `
                    <tr>
                        <th>Base IR sem Sindicatos (${(percentualTotalSind * 100).toFixed(2)}%):</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRSindi)}</td>
                    </tr>` : ''}
                    ${baseComDesagio}
                    ${temPrevidencia ? `
                    <tr>
                        <th>Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.valorPrevidencia)}</td>
                    </tr>
                    <tr>
                        <th>Base IR sem Previd√™ncia:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRPrev)}</td>
                    </tr>` : ''}
                    <tr>
                        <th>RRA Pagamento:</th>
                        <td>${arredondarRRA(primeiroHerdeiro.rraComDesagio || primeiroHerdeiro.rrapagamento)}</td>
                    </tr>
                    <tr>
                        <th>Base IR por RRA:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.baseIRRRA)}</td>
                    </tr>
                    <tr>
                        <th>Al√≠quota IR:</th>
                        <td>${(primeiroHerdeiro.aliquotaIR * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <th>Valor IR Mensal:</th>
                        <td>R$ ${formatarMoeda(primeiroHerdeiro.valorIRUnitario)}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Valor IR Devido Total por Herdeiro:</th>
                        <td><strong>R$ ${formatarMoeda(primeiroHerdeiro.valorIR)}</strong></td>
                    </tr>
                    <tr style="border-top: 1px solid #dee2e6;">
                        <th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">üìä Distribui√ß√£o:</th>
                    </tr>
                    ${distribuicaoHerdeiros}
                </table>
            `;
        }

        function arredondarParaDuasCasas(valor) {
            return Math.round(valor * 100) / 100;
        }

        function gerarSecoesPagamentos(resultados, dados) {
            // ========== AJUSTAR RESULTADOS SE HOUVER PAGAMENTOS ==========
            const resultadosParaUsar = resultados.saldosFinais 
                ? ajustarResultadosComPagamentos(resultados, dados) 
                : resultados;
            // =============================================================
            
            if (dados.tipoCalculo === 'acordo') {
                return gerarTabelaPagamentosAcordo(resultadosParaUsar, dados);
            }

            const temHerdeiros = resultadosParaUsar.temHerdeiros && resultadosParaUsar.herdeiros.length > 0;

            if (temHerdeiros) {
                return gerarPagamentosComHerdeiros(resultadosParaUsar, dados);
            } else {
                return gerarPagamentosSemHerdeiros(resultadosParaUsar, dados);
            }
        }

        function gerarTabelaPagamentosAcordo(resultados, dados) {
            if (dados.tipoCalculo !== 'acordo') return '';
            
            const adesoes = obterAdesaoAcordo();
            const percentualDesagio = dados.percentualAcordo || 0;
            const pagamentosAcordo = [];
            
            // 1. BENEFICI√ÅRIO PRINCIPAL
            if (adesoes.beneficiario && resultados.valorBeneficiarioFinal > 0) {
                const valorDevido = arredondarParaDuasCasas(resultados.valorBeneficiarioAposCessoes);
                const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                const previdencia = arredondarParaDuasCasas(resultados.valorPrevidenciaBeneficiario);
                const ir = arredondarParaDuasCasas(resultados.valorIRBeneficiario);
                const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                
                pagamentosAcordo.push({
                    credor: `${dados.beneficiario} (Benefici√°rio)`,
                    valorDevido: valorDevido,
                    valorDesagio: valorDesagio,
                    valorAposDesagio: valorAposDesagio,
                    previdencia: previdencia,
                    ir: ir,
                    valorLiquido: valorLiquido,
                    rra: resultados.rraComDesagio || resultados.rrapagamento
                });
            }
            
            // 2. HERDEIROS QUE ADERIRAM
            if (resultados.temHerdeiros && adesoes.herdeiros.length > 0) {
                resultados.herdeiros.forEach((herdeiro, index) => {
                    if (adesoes.herdeiros.includes(index) && herdeiro.valorLiquido > 0) {
                        const temCessoes = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
                        const valorDevidoOriginal = temCessoes ? herdeiro.valorFinalAposCessoes : herdeiro.valorBruto;
                        const previdenciaOriginal = temCessoes ? herdeiro.valorPrevidenciaFinal : herdeiro.valorPrevidencia;
                        const irOriginal = temCessoes ? herdeiro.valorIRFinal : herdeiro.valorIR;
                        
                        const valorDevido = arredondarParaDuasCasas(valorDevidoOriginal);
                        const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                        const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                        const previdencia = arredondarParaDuasCasas(previdenciaOriginal);
                        const ir = arredondarParaDuasCasas(irOriginal);
                        const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                        
                        pagamentosAcordo.push({
                            credor: `${herdeiro.nome} (Herdeiro)`,
                            valorDevido: valorDevido,
                            valorDesagio: valorDesagio,
                            valorAposDesagio: valorAposDesagio,
                            previdencia: previdencia,
                            ir: ir,
                            valorLiquido: valorLiquido,
                            rra: herdeiro.rraComDesagio || herdeiro.rrapagamento
                        });
                    }
                });
            }

            //3. ADVOGADOS CONTRATUAIS QUE ADERIRAM
            if (adesoes.advogados.length > 0 && resultados.honorarios) {
                resultados.honorarios.forEach((advogado, index) => {
                    if (adesoes.advogados.includes(index) && advogado.valorBrutoAdvogado > 0) {
                        const valorDevido = arredondarParaDuasCasas(advogado.valorBrutoAdvogado);
                        const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                        const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                        const previdencia = 0;
                        const ir = arredondarParaDuasCasas(advogado.irAdvogado || 0);
                        const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                        
                        pagamentosAcordo.push({
                            credor: `${advogado.nome} (Adv. ${advogado.tipo})`,
                            valorDevido: valorDevido,
                            valorDesagio: valorDesagio,
                            valorAposDesagio: valorAposDesagio,
                            previdencia: previdencia,
                            ir: ir,
                            valorLiquido: valorLiquido,
                            rra: '-'
                        });
                    }
                });
            }

            if (adesoes.advogadosSucumbenciais && adesoes.advogadosSucumbenciais.length > 0 && 
                resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais) {
                
                resultados.honorariosSucumbenciais.honorarios.forEach((advogado, index) => {
                    if (adesoes.advogadosSucumbenciais.includes(index) && advogado.valorBrutoAdvogado > 0) {
                        const valorDevido = arredondarParaDuasCasas(advogado.valorBrutoAdvogado);
                        const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                        const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                        const previdencia = 0;
                        const ir = arredondarParaDuasCasas(advogado.irAdvogado || 0);
                        const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                        
                        pagamentosAcordo.push({
                            credor: `${advogado.nome} (Adv. Sucumb. ${advogado.tipo})`,
                            valorDevido: valorDevido,
                            valorDesagio: valorDesagio,
                            valorAposDesagio: valorAposDesagio,
                            previdencia: previdencia,
                            ir: ir,
                            valorLiquido: valorLiquido,
                            rra: '-'
                        });
                    }
                });
            }
            
            // 5. SINDICATOS QUE ADERIRAM
            if (adesoes.sindicatos.length > 0 && resultados.sindicatos) {
                resultados.sindicatos.forEach((sindicato, index) => {
                    if (adesoes.sindicatos.includes(index) && sindicato.valorBrutoSindicato > 0) {
                        const valorDevido = arredondarParaDuasCasas(sindicato.valorBrutoSindicato);
                        const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                        const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                        const previdencia = 0;
                        const ir = arredondarParaDuasCasas(sindicato.irSindicato || 0);
                        const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                        
                        pagamentosAcordo.push({
                            credor: `${sindicato.nome} (Sindicato)`,
                            valorDevido: valorDevido,
                            valorDesagio: valorDesagio,
                            valorAposDesagio: valorAposDesagio,
                            previdencia: previdencia,
                            ir: ir,
                            valorLiquido: valorLiquido,
                            rra: '-'
                        });
                    }
                });
            }
            
            //6. CESSION√ÅRIOS QUE ADERIRAM
            if (adesoes.cessionarios.length > 0) {
                adesoes.cessionarios.forEach(cessaoIndex => {
                    const cessao = dados.cessoes[cessaoIndex];
                    if (!cessao) return;
                    
                    // Cession√°rios do benefici√°rio
                    if (cessao.tipo === 'cessaobenPrincipal' && resultados.cessoesBeneficiarioFinais) {
                        const cessionarioData = resultados.cessoesBeneficiarioFinais.find(c => c.cessionario === cessao.cessionario);
                        if (cessionarioData && cessionarioData.valorLiquido > 0) {
                            const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                            const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                            const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                            const previdencia = arredondarParaDuasCasas(cessionarioData.previdenciaCessao);
                            const ir = arredondarParaDuasCasas(cessionarioData.irCessao);
                            const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                            
                            pagamentosAcordo.push({
                                credor: `${cessao.cessionario} (Cess. de ${dados.beneficiario})`,
                                valorDevido: valorDevido,
                                valorDesagio: valorDesagio,
                                valorAposDesagio: valorAposDesagio,
                                previdencia: previdencia,
                                ir: ir,
                                valorLiquido: valorLiquido,
                                rra: resultados.rraComDesagio || resultados.rrapagamento
                            });
                        }
                    }
                    
                    // Cession√°rios de herdeiros
                    if (cessao.tipo === 'cessaoherdeiro' && resultados.temHerdeiros) {
                        const herdeiro = resultados.herdeiros.find(h => h.nome === cessao.cedente);
                        if (herdeiro && herdeiro.cessoesHerdeiro) {
                            const cessionarioData = herdeiro.cessoesHerdeiro.find(c => c.cessionario === cessao.cessionario);
                            if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                const previdencia = arredondarParaDuasCasas(cessionarioData.previdenciaCessao);
                                const ir = arredondarParaDuasCasas(cessionarioData.irCessao);
                                const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                
                                pagamentosAcordo.push({
                                    credor: `${cessao.cessionario} (Cess. de ${herdeiro.nome})`,
                                    valorDevido: valorDevido,
                                    valorDesagio: valorDesagio,
                                    valorAposDesagio: valorAposDesagio,
                                    previdencia: previdencia,
                                    ir: ir,
                                    valorLiquido: valorLiquido,
                                    rra: herdeiro.rraComDesagio || herdeiro.rrapagamento
                                });
                            }
                        }
                    }
                    
                    // Cession√°rios de advogados contratuais
                    if (cessao.tipo === 'cessaoAdv') {
                        let cessionarioEncontrado = false;
                        
                        if (resultados.honorarios) {
                            const advogado = resultados.honorarios.find(adv => adv.nome === cessao.cedente);
                            if (advogado && advogado.cessionarios) {
                                const cessionarioData = advogado.cessionarios.find(c => c.nome === cessao.cessionario);
                                if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                    const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                    const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                    const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                    const previdencia = 0;
                                    const ir = arredondarParaDuasCasas(cessionarioData.ir);
                                    const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                    
                                    pagamentosAcordo.push({
                                        credor: `${cessao.cessionario} (Cess. de ${cessao.cedente})`,
                                        valorDevido: valorDevido,
                                        valorDesagio: valorDesagio,
                                        valorAposDesagio: valorAposDesagio,
                                        previdencia: previdencia,
                                        ir: ir,
                                        valorLiquido: valorLiquido,
                                        rra: '-'
                                    });
                                    cessionarioEncontrado = true;
                                }
                            }
                        }
                        
                        // Verificar nos advogados dos herdeiros
                        if (!cessionarioEncontrado && resultados.temHerdeiros) {
                            resultados.herdeiros.forEach(herdeiro => {
                                if (herdeiro.honorarios) {
                                    const advogado = herdeiro.honorarios.find(adv => adv.nome === cessao.cedente);
                                    if (advogado && advogado.cessionarios) {
                                        const cessionarioData = advogado.cessionarios.find(c => c.nome === cessao.cessionario);
                                        if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                            const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                            const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                            const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                            const previdencia = 0;
                                            const ir = arredondarParaDuasCasas(cessionarioData.ir);
                                            const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                            
                                            pagamentosAcordo.push({
                                                credor: `${cessao.cessionario} (Cess. de ${cessao.cedente})`,
                                                valorDevido: valorDevido,
                                                valorDesagio: valorDesagio,
                                                valorAposDesagio: valorAposDesagio,
                                                previdencia: previdencia,
                                                ir: ir,
                                                valorLiquido: valorLiquido,
                                                rra: '-'
                                            });
                                        }
                                    }
                                }
                            });
                        }
                    }

                    //Cessao de adv sucumbencial
                    if (cessao.tipo === 'cessaoAdvSuc') {
                        if (resultados.honorariosSucumbenciais?.honorarios) {
                            const advogado = resultados.honorariosSucumbenciais.honorarios.find(adv => adv.nome === cessao.cedente);
                            if (advogado && advogado.cessionarios) {
                                const cessionarioData = advogado.cessionarios.find(c => c.nome === cessao.cessionario);
                                if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                    const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                    const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                    const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                    const previdencia = 0;
                                    const ir = arredondarParaDuasCasas(cessionarioData.ir);
                                    const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                    
                                    pagamentosAcordo.push({
                                        credor: `${cessao.cessionario} (Cess. Adv. Sucumb. ${cessao.cedente})`,
                                        valorDevido: valorDevido,
                                        valorDesagio: valorDesagio,
                                        valorAposDesagio: valorAposDesagio,
                                        previdencia: previdencia,
                                        ir: ir,
                                        valorLiquido: valorLiquido,
                                        rra: '-'
                                    });
                                }
                            }
                        }
                    }
                    
                    // Cession√°rios de sindicatos
                    if (cessao.tipo === 'cessaoSind') {
                        let cessionarioEncontrado = false;
                        
                        // Verificar nos sindicatos do benefici√°rio
                        if (resultados.sindicatos) {
                            const sindicato = resultados.sindicatos.find(sind => sind.nome === cessao.cedente);
                            if (sindicato && sindicato.cessionarios) {
                                const cessionarioData = sindicato.cessionarios.find(c => c.nome === cessao.cessionario);
                                if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                    const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                    const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                    const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                    const previdencia = 0;
                                    const ir = arredondarParaDuasCasas(cessionarioData.ir);
                                    const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                    
                                    pagamentosAcordo.push({
                                        credor: `${cessao.cessionario} (Cess. de ${cessao.cedente})`,
                                        valorDevido: valorDevido,
                                        valorDesagio: valorDesagio,
                                        valorAposDesagio: valorAposDesagio,
                                        previdencia: previdencia,
                                        ir: ir,
                                        valorLiquido: valorLiquido,
                                        rra: '-'
                                    });
                                    cessionarioEncontrado = true;
                                }
                            }
                        }
                        
                        // Verificar nos sindicatos dos herdeiros
                        if (!cessionarioEncontrado && resultados.temHerdeiros) {
                            resultados.herdeiros.forEach(herdeiro => {
                                if (herdeiro.sindicatos) {
                                    const sindicato = herdeiro.sindicatos.find(sind => sind.nome === cessao.cedente);
                                    if (sindicato && sindicato.cessionarios) {
                                        const cessionarioData = sindicato.cessionarios.find(c => c.nome === cessao.cessionario);
                                        if (cessionarioData && cessionarioData.valorLiquido > 0) {
                                            const valorDevido = arredondarParaDuasCasas(cessionarioData.valorBruto);
                                            const valorDesagio = arredondarParaDuasCasas(valorDevido * percentualDesagio);
                                            const valorAposDesagio = arredondarParaDuasCasas(valorDevido - valorDesagio);
                                            const previdencia = 0;
                                            const ir = arredondarParaDuasCasas(cessionarioData.ir);
                                            const valorLiquido = arredondarParaDuasCasas(valorAposDesagio - previdencia - ir);
                                            
                                            pagamentosAcordo.push({
                                                credor: `${cessao.cessionario} (Cess. de ${cessao.cedente})`,
                                                valorDevido: valorDevido,
                                                valorDesagio: valorDesagio,
                                                valorAposDesagio: valorAposDesagio,
                                                previdencia: previdencia,
                                                ir: ir,
                                                valorLiquido: valorLiquido,
                                                rra: '-'
                                            });
                                        }
                                    }
                                }
                            });
                        }
                    }
                });
            }
            
            if (pagamentosAcordo.length === 0) return '';
    
            // GERAR 1¬™ TABELA: C√°lculo do Des√°gio
            const linhasCalculo = pagamentosAcordo.map(pagamento => `
                <tr>
                    <td>${pagamento.credor}</td>
                    <td>R$ ${formatarMoeda(pagamento.valorDevido)}</td>
                    <td>R$ ${formatarMoeda(pagamento.valorDesagio)}</td>
                    <td>R$ ${formatarMoeda(pagamento.valorAposDesagio)}</td>
                </tr>
            `).join('');
            
            // GERAR 2¬™ TABELA: Pagamentos Finais
            const linhasPagamento = pagamentosAcordo.map(pagamento => `
                <tr>
                    <td>${pagamento.credor}</td>
                    <td>R$ ${formatarMoeda(pagamento.valorAposDesagio)}</td>
                    <td>R$ ${formatarMoeda(pagamento.previdencia)}</td>
                    <td>R$ ${formatarMoeda(pagamento.ir)}</td>
                    <td>R$ ${formatarMoeda(pagamento.valorLiquido)}</td>
                    <td>${pagamento.rra}</td>
                </tr>
            `).join('');
            
            // Calcular totais
            const totais = {
                valorDevido: pagamentosAcordo.reduce((total, p) => total + p.valorDevido, 0),
                valorDesagio: pagamentosAcordo.reduce((total, p) => total + p.valorDesagio, 0),
                valorAposDesagio: pagamentosAcordo.reduce((total, p) => total + p.valorAposDesagio, 0),
                previdencia: pagamentosAcordo.reduce((total, p) => total + p.previdencia, 0),
                ir: pagamentosAcordo.reduce((total, p) => total + p.ir, 0),
                valorLiquido: pagamentosAcordo.reduce((total, p) => total + p.valorLiquido, 0)
            };
            
            return `
                    <!-- 1¬™ TABELA: C√°lculo do Des√°gio -->
                    <div class="table-container">
                        <h3>üìä C√°lculo do Des√°gio ${(percentualDesagio * 100).toFixed(2)}%</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Credor</th>
                                    <th>Valor Devido</th>
                                    <th>Des√°gio ${(percentualDesagio * 100).toFixed(2)}%</th>
                                    <th>Valor Ap√≥s Des√°gio</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${linhasCalculo}
                            </tbody>
                            <tfoot>
                                <tr class="highlight">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.valorDevido)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.valorDesagio)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.valorAposDesagio)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                <div class="pagamentos-acordo">
                    <!-- 2¬™ TABELA: Valores Finais para Pagamento -->
                    <div class="table-container">
                        <h3>üí∞ Pagamento do Acordo</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Credor</th>
                                    <th>Valor Base</th>
                                    <th>Previd√™ncia</th>
                                    <th>IR</th>
                                    <th>Valor L√≠quido</th>
                                    <th>RRA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${linhasPagamento}
                            </tbody>
                            <tfoot>
                                <tr class="highlight">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.valorAposDesagio)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.previdencia)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.ir)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totais.valorLiquido)}</strong></td>
                                    <td><strong>-</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                            <h4>‚öñÔ∏è Informa√ß√µes do Acordo:</h4>
                            <p style="margin: 5px 0;"><strong>Des√°gio aplicado:</strong> ${(percentualDesagio * 100).toFixed(2)}% sobre o valor devido</p>
                            <p style="margin: 5px 0;"><strong>Tributos calculados:</strong> Sobre o valor ap√≥s des√°gio</p>
                            <p style="margin: 5px 0;"><strong>Apenas credores que aderiram</strong> ao acordo aparecem nesta tabela</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarPagamentosComHerdeiros(resultados, dados) {
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            
            const herdeirosParaPagar = isPreferencia 
                ? resultados.herdeiros.filter(h => h.temPreferencia || h.isPreferenciaParcial)
                : resultados.herdeiros;
            
            const herdeirosComPagamentos = herdeirosParaPagar.filter(h => {
                return h.valorLiquido > 0 || (h.cessoesHerdeiro && h.cessoesHerdeiro.length > 0);
            });
            
            if (herdeirosComPagamentos.length === 0) return '';
            
            let secaoCessionariosBeneficiario = '';
            if (resultados.cessoesBeneficiarioFinais && resultados.cessoesBeneficiarioFinais.length > 0) {
                const cessionariosBeneficiario = resultados.cessoesBeneficiarioFinais.filter(cessao => cessao.valorLiquido > 0);
                
                if (cessionariosBeneficiario.length > 0) {
                    const linhasCessionarios = cessionariosBeneficiario.map(cessao => {
                        const valorDevidoArredondado = arredondarParaDuasCasas(cessao.valorBruto);
                        const previdenciaArredondada = arredondarParaDuasCasas(cessao.previdenciaCessao);
                        const irArredondado = arredondarParaDuasCasas(cessao.irCessao);
                        const valorLiquidoCalculado = arredondarParaDuasCasas(valorDevidoArredondado - previdenciaArredondada - irArredondado);
                        
                        return `
                            <tr>
                                <td>${cessao.cessionario} (Cession√°rio de ${dados.beneficiario})</td>
                                <td>R$ ${formatarMoeda(valorDevidoArredondado)}</td>
                                <td>R$ ${formatarMoeda(previdenciaArredondada)}</td>
                                <td>R$ ${formatarMoeda(irArredondado)}</td>
                                <td>R$ ${formatarMoeda(valorLiquidoCalculado)}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    const totalCessionarios = calcularTotalCessionariosBeneficiario(cessionariosBeneficiario);
                    
                    secaoCessionariosBeneficiario = `
                        <div class="pagamentos-finais" style="margin-bottom: 20px;">
                            <div class="table-container">
                                <h3>üìä Cession√°rios do Benefici√°rio Principal</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Credor</th>
                                            <th>Valor Devido</th>
                                            <th>Previd√™ncia</th>
                                            <th>Imposto de Renda</th>
                                            <th>Valor L√≠quido</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${linhasCessionarios}
                                    </tbody>
                                    <tfoot>
                                        <tr class="highlight">
                                            <td><strong>TOTAL CESSION√ÅRIOS</strong></td>
                                            <td><strong>R$ ${formatarMoeda(totalCessionarios.totalDevido)}</strong></td>
                                            <td><strong>R$ ${formatarMoeda(totalCessionarios.totalPrevidencia)}</strong></td>
                                            <td><strong>R$ ${formatarMoeda(totalCessionarios.totalIR)}</strong></td>
                                            <td><strong>R$ ${formatarMoeda(totalCessionarios.totalLiquido)}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
            
            const secoesHerdeiros = herdeirosComPagamentos.map(herdeiro => 
                gerarTabelaHerdeiro(herdeiro, dados, isPreferencia, herdeirosComPagamentos.length)
            ).join('');
            
            const todosPagamentos = coletarTodosPagamentos(resultados, dados);

            const totaisGerais = {
                totalDevido: calcularTotalDevido(todosPagamentos),
                totalPrevidencia: calcularTotalPrevidencia(todosPagamentos),
                totalIR: calcularTotalIR(todosPagamentos),
                totalLiquido: calcularTotalLiquido(todosPagamentos)
            };

            const tabelaHonorariosSucumbenciais = gerarTabelaHonorariosSucumbenciais(resultados, dados);
            
            const temHonorariosSucumbenciais = resultados.honorariosSucumbenciais?.honorarios?.some(adv => adv.temPreferencia) || false;

            const mostrarResumoGeral = herdeirosComPagamentos.length > 1 || temHonorariosSucumbenciais;

            return `
                ${secaoCessionariosBeneficiario}
                ${secoesHerdeiros}
                ${tabelaHonorariosSucumbenciais}
                ${mostrarResumoGeral ? `
                <div class="pagamentos-finais" style="margin-top: 30px;">
                    <div class="table-container">
                        <h3>üéØ RESUMO GERAL DE TODOS OS PAGAMENTOS</h3>
                        <table style="background-color: #f8f9fa;">
                            <thead>
                                <tr style="background-color: #e9ecef;">
                                    <th>Total Geral</th>
                                    <th>Valor Devido</th>
                                    <th>Previd√™ncia</th>
                                    <th>Imposto de Renda</th>
                                    <th>Valor L√≠quido</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="highlight" style="font-weight: bold; font-size: 1.1em;">
                                    <td><strong>TOTAL FINAL</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisGerais.totalDevido)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisGerais.totalPrevidencia)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisGerais.totalIR)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisGerais.totalLiquido)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                            <h4>üìã Notas sobre Tributa√ß√£o do Imposto de Renda:</h4>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa F√≠sica (PF):</strong> üè¶ LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</p>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa Jur√≠dica (PJ):</strong> üè¶ DECRETO 9.580, art 714</p>
                            <p style="margin: 5px 0;"><strong>Sindicatos:</strong> Tributa√ß√£o conforme Art. 27, da Lei n¬∫ 10.833/03 ou al√≠quota fixa quando aplic√°vel</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        function gerarTabelaHerdeiro(herdeiro, dados, isPreferencia, totalHerdeiros) {
            const pagamentosHerdeiro = [];
            
            // 1. O pr√≥prio herdeiro
            const temCessoesHerdeiro = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
            const valorDevido = temCessoesHerdeiro ? herdeiro.valorFinalAposCessoes : herdeiro.valorBruto;
            const previdencia = temCessoesHerdeiro ? herdeiro.valorPrevidenciaFinal : herdeiro.valorPrevidencia;
            const ir = temCessoesHerdeiro ? herdeiro.valorIRFinal : herdeiro.valorIR;
            
            if (herdeiro.valorLiquido > 0) {
                pagamentosHerdeiro.push({
                    credor: `${herdeiro.nome} (Herdeiro)`,
                    valorDevido: valorDevido,
                    previdencia: previdencia,
                    ir: ir,
                    valorLiquido: herdeiro.valorLiquido
                });
            }
            
            // 2. Cession√°rios do herdeiro (s√≥ ordem cronol√≥gica)
            if (!isPreferencia && herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0) {
                herdeiro.cessoesHerdeiro
                    .filter(cessao => cessao.valorLiquido && cessao.valorLiquido > 0)
                    .forEach(cessao => {
                        pagamentosHerdeiro.push({
                            credor: `${cessao.cessionario} (Cession√°rio de ${herdeiro.nome})`,
                            valorDevido: cessao.valorBruto,
                            previdencia: cessao.previdenciaCessao,
                            ir: cessao.irCessao,
                            valorLiquido: cessao.valorLiquido
                        });
                    });
            }
            
            // 3. Advogados deste herdeiro
            if (herdeiro.honorarios && herdeiro.honorarios.length > 0) {
                herdeiro.honorarios.forEach(adv => {
                    let devePagarAdvogado = false;
                    
                    if (isPreferencia) {
                        devePagarAdvogado = herdeiro.temPreferencia || herdeiro.isPreferenciaParcial;
                    } else {
                        devePagarAdvogado = true;
                    }
                    
                    if (devePagarAdvogado && adv.valorBrutoAdvogado > 0) {
                        pagamentosHerdeiro.push({
                            credor: `${adv.nome} (Advogado ${adv.tipo})`,
                            valorDevido: adv.valorBrutoAdvogado,
                            previdencia: 0,
                            ir: adv.irAdvogado || 0,
                            valorLiquido: adv.valorLiquidoAdvogado
                        });
                        
                        // Cession√°rios do advogado
                        if (adv.cessionarios && adv.cessionarios.length > 0) {
                            let cessionariosDevemReceber = false;
                            
                            if (isPreferencia) {
                                cessionariosDevemReceber = herdeiro.temPreferencia && !herdeiro.isPreferenciaParcial;
                            } else {
                                cessionariosDevemReceber = true;
                            }
                            
                            if (cessionariosDevemReceber) {
                                adv.cessionarios.forEach(cessionario => {
                                    pagamentosHerdeiro.push({
                                        credor: `${cessionario.nome} (Cession√°rio de ${adv.nome})`,
                                        valorDevido: cessionario.valorBruto,
                                        previdencia: 0,
                                        ir: cessionario.ir || 0,
                                        valorLiquido: cessionario.valorLiquido
                                    });
                                });
                            }
                        }
                    }
                });
            }
            
            // 4. Sindicatos deste herdeiro
            if (herdeiro.sindicatos && herdeiro.sindicatos.length > 0) {
                herdeiro.sindicatos.forEach(sind => {
                    let devePagarSindicato = false;
                    
                    if (isPreferencia) {
                        devePagarSindicato = false;
                    } else {
                        // Na ordem
                        devePagarSindicato = true;
                    }
                    
                    if (devePagarSindicato) {
                        // Se sindicato tem cession√°rios, s√≥ mostra o sindicato se ele ainda tem valor pr√≥prio
                        const temCessionarios = sind.cessionarios && sind.cessionarios.length > 0;
                        
                        if (!temCessionarios && sind.valorBrutoSindicato > 0) {
                            pagamentosHerdeiro.push({
                                credor: `${sind.nome} (Sindicato)`,
                                valorDevido: sind.valorBrutoSindicato,
                                previdencia: 0,
                                ir: sind.irSindicato || 0,
                                valorLiquido: sind.valorLiquidoSindicato
                            });
                        } else if (temCessionarios) {
                            if (sind.valorBrutoSindicato > 0) {
                                pagamentosHerdeiro.push({
                                    credor: `${sind.nome} (Sindicato)`,
                                    valorDevido: sind.valorBrutoSindicato,
                                    previdencia: 0,
                                    ir: sind.irSindicato || 0,
                                    valorLiquido: sind.valorLiquidoSindicato
                                });
                            }
                            
                            sind.cessionarios.forEach(cessionario => {
                                if (cessionario.valorBruto > 0) {
                                    pagamentosHerdeiro.push({
                                        credor: `${cessionario.nome} (Cession√°rio de ${sind.nome})`,
                                        valorDevido: cessionario.valorBruto,
                                        previdencia: 0,
                                        ir: cessionario.ir || 0,
                                        valorLiquido: cessionario.valorLiquido
                                    });
                                }
                            });
                        }
                    }
                });
            }
            
            // Tabela para este herdeiro
            const linhas = pagamentosHerdeiro.map(pagamento => {
                const valorDevidoArredondado = arredondarParaDuasCasas(pagamento.valorDevido);
                const previdenciaArredondada = arredondarParaDuasCasas(pagamento.previdencia);
                const irArredondado = arredondarParaDuasCasas(pagamento.ir);
                const valorLiquidoCalculado = arredondarParaDuasCasas(valorDevidoArredondado - previdenciaArredondada - irArredondado);
                
                return `
                    <tr>
                        <td>${pagamento.credor}</td>
                        <td>R$ ${formatarMoeda(valorDevidoArredondado)}</td>
                        <td>R$ ${formatarMoeda(previdenciaArredondada)}</td>
                        <td>R$ ${formatarMoeda(irArredondado)}</td>
                        <td>R$ ${formatarMoeda(valorLiquidoCalculado)}</td>
                    </tr>
                `;
            }).join('');
            
            const totaisHerdeiro = {
                totalDevido: pagamentosHerdeiro.reduce((total, p) => total + arredondarParaDuasCasas(p.valorDevido), 0),
                totalPrevidencia: pagamentosHerdeiro.reduce((total, p) => total + arredondarParaDuasCasas(p.previdencia), 0),
                totalIR: pagamentosHerdeiro.reduce((total, p) => total + arredondarParaDuasCasas(p.ir), 0),
                totalLiquido: pagamentosHerdeiro.reduce((total, p) => {
                    const valorDevidoArr = arredondarParaDuasCasas(p.valorDevido);
                    const previdenciaArr = arredondarParaDuasCasas(p.previdencia);
                    const irArr = arredondarParaDuasCasas(p.ir);
                    return total + arredondarParaDuasCasas(valorDevidoArr - previdenciaArr - irArr);
                }, 0)
            };
            
            const statusHerdeiro = isPreferencia ? 
                (herdeiro.isPreferenciaParcial ? ' (Prefer√™ncia Parcial)' : ' (Prefer√™ncia Total)') : 
                ' (Ordem Cronol√≥gica)';
            
            const mostrarTotalHerdeiro = true;
            
            return `
                <div class="pagamentos-finais" style="margin-bottom: 20px;">
                    <div class="table-container">
                        <h3>üìä Pagamentos - ${herdeiro.nome}${statusHerdeiro}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Credor</th>
                                    <th>Valor Devido</th>
                                    <th>Previd√™ncia</th>
                                    <th>Imposto de Renda</th>
                                    <th>Valor L√≠quido</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${linhas}
                            </tbody>
                            ${mostrarTotalHerdeiro ? `
                            <tfoot>
                                <tr class="highlight">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisHerdeiro.totalDevido)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisHerdeiro.totalPrevidencia)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisHerdeiro.totalIR)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totaisHerdeiro.totalLiquido)}</strong></td>
                                </tr>
                            </tfoot>
                            ` : ''}
                        </table>
                        ${totalHerdeiros === 1 ? `
                        <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                            <h4>üìã Notas sobre Tributa√ß√£o do Imposto de Renda:</h4>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa F√≠sica (PF):</strong> üè¶ LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</p>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa Jur√≠dica (PJ):</strong> üè¶ DECRETO 9.580, art 714</p>
                            <p style="margin: 5px 0;"><strong>Sindicatos:</strong> Tributa√ß√£o conforme Art. 27, da Lei n¬∫ 10.833/03 ou al√≠quota fixa quando aplic√°vel</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function gerarTabelaHonorariosSucumbenciais(resultados, dados) {
            // Verificar se tem honor√°rios sucumbenciais
            if (!resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais || 
                !resultados.honorariosSucumbenciais?.honorarios?.length) {
                return '';
            }

            const honorarios = resultados.honorariosSucumbenciais.honorarios;
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const pagamentos = [];
            
            honorarios.forEach(adv => {
                // ADVOGADO SUCUMBENCIAL
                let deveReceberAdvogado = true;
                let valorAdvogadoPagamento = adv.valorBrutoAdvogado;
                
                if (isPreferencia && !adv.temPreferencia) {
                    deveReceberAdvogado = false;
                }
                
                if (deveReceberAdvogado && valorAdvogadoPagamento > 0) {
                    pagamentos.push({
                        credor: `${adv.nome} (Adv. Sucumbencial ${adv.tipo})`,
                        valorDevido: valorAdvogadoPagamento,
                        previdencia: 0,
                        ir: adv.irAdvogado || 0,
                        valorLiquido: adv.valorLiquidoAdvogado || 0
                    });
                }
                
                // CESSION√ÅRIOS DO ADVOGADO SUCUMBENCIAL
                if (isPreferencia) {
                    // Na prefer√™ncia: cession√°rios s√≥ recebem se n√£o foi limitado
                    if (adv.temPreferencia && !adv.foiLimitadoPorPreferencia && adv.cessionarios?.length > 0) {
                        adv.cessionarios.forEach(cessionario => {
                            if (cessionario.valorLiquido > 0) {
                                pagamentos.push({
                                    credor: `${cessionario.nome} (Cess. Adv. Sucumb. ${adv.nome})`,
                                    valorDevido: cessionario.valorBruto,
                                    previdencia: 0,
                                    ir: cessionario.ir || 0,
                                    valorLiquido: cessionario.valorLiquido
                                });
                            }
                        });
                    }
                } else {
                    // Ordem/Parcial: cession√°rios sempre recebem
                    if (adv.cessionarios?.length > 0) {
                        adv.cessionarios.forEach(cessionario => {
                            if (cessionario.valorLiquido > 0) {
                                pagamentos.push({
                                    credor: `${cessionario.nome} (Cess. Adv. Sucumb. ${adv.nome})`,
                                    valorDevido: cessionario.valorBruto,
                                    previdencia: 0,
                                    ir: cessionario.ir || 0,
                                    valorLiquido: cessionario.valorLiquido
                                });
                            }
                        });
                    }
                }
            });
            
            if (pagamentos.length === 0) return '';
            
            // Calcular totais
            const totalDevido = pagamentos.reduce((sum, p) => sum + p.valorDevido, 0);
            const totalPrevidencia = pagamentos.reduce((sum, p) => sum + p.previdencia, 0);
            const totalIR = pagamentos.reduce((sum, p) => sum + p.ir, 0);
            const totalLiquido = pagamentos.reduce((sum, p) => sum + p.valorLiquido, 0);
            
            return `
                <div class="pagamentos-finais" style="margin-bottom: 20px;">
                    <div class="table-container">
                        <h3>üíº Pagamentos - Honor√°rios Sucumbenciais</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Credor</th>
                                    <th>Valor Devido</th>
                                    <th>Previd√™ncia</th>
                                    <th>Imposto de Renda</th>
                                    <th>Valor L√≠quido</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pagamentos.map(pagamento => `
                                    <tr>
                                        <td>${pagamento.credor}</td>
                                        <td>R$ ${formatarMoeda(pagamento.valorDevido)}</td>
                                        <td>R$ ${formatarMoeda(pagamento.previdencia)}</td>
                                        <td>R$ ${formatarMoeda(pagamento.ir)}</td>
                                        <td>R$ ${formatarMoeda(pagamento.valorLiquido)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="highlight">
                                    <td><strong>Total Honor√°rios Sucumbenciais</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totalDevido)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totalPrevidencia)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totalIR)}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(totalLiquido)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                `;
        }

        function coletarTodosPagamentos(resultados, dados) {
            const pagamentos = [];
            const temHerdeiros = resultados.temHerdeiros && resultados.herdeiros.length > 0;
            
            if (temHerdeiros) {
                const isPreferencia = dados.tipoCalculo === 'preferencia';
                
                // Cession√°rios do Benefici√°rio
                if (resultados.cessoesBeneficiarioFinais) {
                    resultados.cessoesBeneficiarioFinais
                        .filter(cessao => cessao.valorLiquido && cessao.valorLiquido > 0)
                        .forEach(cessao => {
                            pagamentos.push({
                                credor: `${cessao.cessionario} (Cession√°rio de ${dados.beneficiario})`,
                                valorDevido: cessao.valorBruto,
                                previdencia: cessao.previdenciaCessao,
                                ir: cessao.irCessao,
                                valorLiquido: cessao.valorLiquido
                            });
                        });
                }
                
                // Herdeiros
                const herdeirosParaPagar = isPreferencia 
                    ? resultados.herdeiros.filter(h => h.temPreferencia || h.isPreferenciaParcial)
                    : resultados.herdeiros;
                    
                herdeirosParaPagar
                    .filter(h => h.valorLiquido > 0)
                    .forEach(herdeiro => {
                        const temCessoesHerdeiro = herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0;
                        const valorDevido = temCessoesHerdeiro ? herdeiro.valorFinalAposCessoes : herdeiro.valorBruto;
                        const previdencia = temCessoesHerdeiro ? herdeiro.valorPrevidenciaFinal : herdeiro.valorPrevidencia;
                        const ir = temCessoesHerdeiro ? herdeiro.valorIRFinal : herdeiro.valorIR;
                        
                        pagamentos.push({
                            credor: `${herdeiro.nome} (Herdeiro)`,
                            valorDevido: valorDevido,
                            previdencia: previdencia,
                            ir: ir,
                            valorLiquido: herdeiro.valorLiquido
                        });
                        
                        // Cession√°rios dos herdeiros (s√≥ ordem)
                        if (!isPreferencia && herdeiro.cessoesHerdeiro && herdeiro.cessoesHerdeiro.length > 0) {
                            herdeiro.cessoesHerdeiro
                                .filter(cessao => cessao.valorLiquido && cessao.valorLiquido > 0)
                                .forEach(cessao => {
                                    pagamentos.push({
                                        credor: `${cessao.cessionario} (Cession√°rio de ${herdeiro.nome})`,
                                        valorDevido: cessao.valorBruto,
                                        previdencia: cessao.previdenciaCessao,
                                        ir: cessao.irCessao,
                                        valorLiquido: cessao.valorLiquido
                                    });
                                });
                        }
                        
                        // Advogados e cession√°rios
                        if (herdeiro.honorarios) {
                            herdeiro.honorarios.forEach(adv => {
                                let devePagar = isPreferencia ? (herdeiro.temPreferencia || herdeiro.isPreferenciaParcial) : true;
                                if (devePagar && adv.valorBrutoAdvogado > 0) {
                                    pagamentos.push({
                                        credor: `${adv.nome} (Advogado ${adv.tipo})`,
                                        valorDevido: adv.valorBrutoAdvogado,
                                        previdencia: 0,
                                        ir: adv.irAdvogado || 0,
                                        valorLiquido: adv.valorLiquidoAdvogado
                                    });
                                    
                                    // Cession√°rios do advogado
                                    if (adv.cessionarios && adv.cessionarios.length > 0) {
                                        let cessionariosRecebem = isPreferencia ? (herdeiro.temPreferencia && !herdeiro.isPreferenciaParcial) : true;
                                        if (cessionariosRecebem) {
                                            adv.cessionarios.forEach(cessionario => {
                                                pagamentos.push({
                                                    credor: `${cessionario.nome} (Cession√°rio de ${adv.nome})`,
                                                    valorDevido: cessionario.valorBruto,
                                                    previdencia: 0,
                                                    ir: cessionario.ir || 0,
                                                    valorLiquido: cessionario.valorLiquido
                                                });
                                            });
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Sindicatos e cession√°rios
                        if (herdeiro.sindicatos) {
                            herdeiro.sindicatos.forEach(sind => {
                                let devePagar = isPreferencia ? (herdeiro.temPreferencia) : true;
                                if (devePagar) {
                                    // Se sindicato tem cession√°rios
                                    const temCessionarios = sind.cessionarios && sind.cessionarios.length > 0;
                                    
                                    if (!temCessionarios && sind.valorBrutoSindicato > 0) {
                                        // Sindicato sem cess√£o 
                                        pagamentos.push({
                                            credor: `${sind.nome} (Sindicato)`,
                                            valorDevido: sind.valorBrutoSindicato,
                                            previdencia: 0,
                                            ir: sind.irSindicato || 0,
                                            valorLiquido: sind.valorLiquidoSindicato
                                        });
                                    } else if (temCessionarios) {
                                        // Sindicato com cess√£o
                                        if (sind.valorBrutoSindicato > 0) {
                                            pagamentos.push({
                                                credor: `${sind.nome} (Sindicato)`,
                                                valorDevido: sind.valorBrutoSindicato,
                                                previdencia: 0,
                                                ir: sind.irSindicato || 0,
                                                valorLiquido: sind.valorLiquidoSindicato
                                            });
                                        }
                                        
                                        sind.cessionarios.forEach(cessionario => {
                                            if (cessionario.valorBruto > 0) {
                                                pagamentos.push({
                                                    credor: `${cessionario.nome} (Cession√°rio de ${sind.nome})`,
                                                    valorDevido: cessionario.valorBruto,
                                                    previdencia: 0,
                                                    ir: cessionario.ir || 0,
                                                    valorLiquido: cessionario.valorLiquido
                                                });
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                    if (resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais) {
                        resultados.honorariosSucumbenciais.honorarios.forEach(adv => {
                            if (adv.valorBrutoAdvogado > 0) {
                                pagamentos.push({
                                    credor: `${adv.nome} (Adv. Sucumbencial ${adv.tipo})`,
                                    valorDevido: adv.valorBrutoAdvogado,
                                    previdencia: 0,
                                    ir: adv.irAdvogado || 0,
                                    valorLiquido: adv.valorLiquidoAdvogado || 0
                                });
                            }
                        });
                    }
                }
            return pagamentos;
        }

        function gerarPagamentosSemHerdeiros(resultados, dados) {
            const todosPagamentos = coletarTodosPagamentosSemHerdeiros(resultados, dados);

            if (todosPagamentos.length === 0) return '';

            return `
                <div class="pagamentos-finais">
                    <div class="table-container">
                        <h3>üí∞ Resumo de Pagamentos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Credor</th>
                                    <th>Valor Devido</th>
                                    <th>Previd√™ncia</th>
                                    <th>Imposto de Renda</th>
                                    <th>Valor L√≠quido</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${todosPagamentos.map(pagamento => {
                                    const valorDevidoArredondado = arredondarParaDuasCasas(pagamento.valorDevido);
                                    const previdenciaArredondada = arredondarParaDuasCasas(pagamento.previdencia);
                                    const irArredondado = arredondarParaDuasCasas(pagamento.ir);
                                    const valorLiquidoCalculado = arredondarParaDuasCasas(valorDevidoArredondado - previdenciaArredondada - irArredondado);
                                    
                                    return `
                                        <tr>
                                            <td>${pagamento.credor}</td>
                                            <td>R$ ${formatarMoeda(valorDevidoArredondado)}</td>
                                            <td>R$ ${formatarMoeda(previdenciaArredondada)}</td>
                                            <td>R$ ${formatarMoeda(irArredondado)}</td>
                                            <td>R$ ${formatarMoeda(valorLiquidoCalculado)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="highlight">
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>R$ ${formatarMoeda(calcularTotalDevido(todosPagamentos))}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(calcularTotalPrevidencia(todosPagamentos))}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(calcularTotalIR(todosPagamentos))}</strong></td>
                                    <td><strong>R$ ${formatarMoeda(calcularTotalLiquido(todosPagamentos))}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                            <h4>üìã Notas sobre Tributa√ß√£o do Imposto de Renda:</h4>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa F√≠sica (PF):</strong> üè¶ LEI N¬∫ 15.191, DE 11 DE AGOSTO DE 2025</p>
                            <p style="margin: 5px 0;"><strong>Advogados Pessoa Jur√≠dica (PJ):</strong> üè¶ DECRETO 9.580, art 714</p>
                            <p style="margin: 5px 0;"><strong>Sindicatos:</strong> Tributa√ß√£o conforme Art. 27, da Lei n¬∫ 10.833/03 ou al√≠quota fixa quando aplic√°vel</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function calcularTotalCessionariosBeneficiario(cessionarios) {
            return {
                totalDevido: cessionarios.reduce((total, c) => total + arredondarParaDuasCasas(c.valorBruto), 0),
                totalPrevidencia: cessionarios.reduce((total, c) => total + arredondarParaDuasCasas(c.previdenciaCessao), 0),
                totalIR: cessionarios.reduce((total, c) => total + arredondarParaDuasCasas(c.irCessao), 0),
                totalLiquido: cessionarios.reduce((total, c) => {
                    const valorDevidoArr = arredondarParaDuasCasas(c.valorBruto);
                    const previdenciaArr = arredondarParaDuasCasas(c.previdenciaCessao);
                    const irArr = arredondarParaDuasCasas(c.irCessao);
                    return total + arredondarParaDuasCasas(valorDevidoArr - previdenciaArr - irArr);
                }, 0)
            };
        }

        function coletarTodosPagamentosSemHerdeiros(resultados, dados) {
            const pagamentos = [];
            
            // Benefici√°rio
            if (resultados.valorBeneficiarioFinal > 0) {
                pagamentos.push({
                    credor: `${dados.beneficiario} (Benefici√°rio)`,
                    valorDevido: resultados.valorBeneficiarioAposCessoes,
                    previdencia: resultados.valorPrevidenciaBeneficiario,
                    ir: resultados.valorIRBeneficiario,
                    valorLiquido: resultados.valorBeneficiarioFinal
                });
            }
            
            // Cession√°rios do Benefici√°rio
            if (resultados.cessoesBeneficiarioFinais) {
                resultados.cessoesBeneficiarioFinais
                    .filter(cessao => cessao.valorLiquido && cessao.valorLiquido > 0)
                    .forEach(cessao => {
                        pagamentos.push({
                            credor: `${cessao.cessionario} (Cession√°rio de ${dados.beneficiario})`,
                            valorDevido: cessao.valorBruto,
                            previdencia: cessao.previdenciaCessao,
                            ir: cessao.irCessao,
                            valorLiquido: cessao.valorLiquido
                        });
                    });
            }
            
            // Sindicatos
            if (resultados.sindicatos) {
                resultados.sindicatos
                    .filter(sind => sind.podeReceber && sind.percentualSindicato > 0 && sind.valorBrutoSindicato > 0)
                    .forEach(sind => {
                        pagamentos.push({
                            credor: `${sind.nome} (Sindicato)`,
                            valorDevido: sind.valorBrutoSindicato,
                            previdencia: 0,
                            ir: sind.irSindicato,
                            valorLiquido: sind.valorLiquidoSindicato
                        });
                    });
            }
            
            // Cession√°rios de Sindicatos
            if (resultados.sindicatos) {
                resultados.sindicatos.forEach(sind => {
                    if (sind.cessionarios && sind.cessionarios.length > 0 && sind.podeReceber) {
                        sind.cessionarios.forEach(cessionario => {
                            pagamentos.push({
                                credor: `${cessionario.nome} (Cession√°rio de ${sind.nome})`,
                                valorDevido: cessionario.valorBruto,
                                previdencia: 0,
                                ir: cessionario.ir,
                                valorLiquido: cessionario.valorLiquido
                            });
                        });
                    }
                });
            }
            
            // Advogados
            const advogadosParaPagar = resultados.honorarios.filter(adv => 
                adv.percentualAdvogado > 0 && adv.valorBrutoAdvogado > 0
            );
            
            advogadosParaPagar.forEach(adv => {
                pagamentos.push({
                    credor: `${adv.nome} (Advogado ${adv.tipo})`,
                    valorDevido: adv.valorBrutoAdvogado,
                    previdencia: 0,
                    ir: adv.irAdvogado,
                    valorLiquido: adv.valorLiquidoAdvogado
                });
            });
            
            // Cession√°rios de Advogados
            const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && resultados.valorBase < resultados.valortotatt;
            const isParcial = dados.tipoCalculo === 'parcial';

            if (isParcial) {
                resultados.honorarios.forEach(adv => {
                    if (adv.cessionarios && adv.cessionarios.length > 0) {
                        adv.cessionarios.forEach(cessionario => {
                            // Valor do honor√°rio parcial do advogado
                            const honorarioParcial = resultados.valorBase * adv.percentual;
                            const valorDevido = honorarioParcial * cessionario.percentual;
                            
                            let irCorreto = 0;
                            if (adv.tipo === 'PF') {
                                irCorreto = calcularIR(valorDevido); 
                            } else {
                                irCorreto = valorDevido * 0.015; // PJ: 1,5%
                            }
                            
                            const valorLiquido = valorDevido - irCorreto;
                            
                            pagamentos.push({
                                credor: `${cessionario.nome} (Cession√°rio de ${adv.nome})`,
                                valorDevido: valorDevido,
                                previdencia: 0,
                                ir: irCorreto,
                                valorLiquido: valorLiquido
                            });
                        });
                    }
                });
            } else if (!isPreferenciaParcial) {
                resultados.honorarios.forEach(adv => {
                    if (adv.cessionarios && adv.cessionarios.length > 0) {
                        adv.cessionarios.forEach(cessionario => {
                            pagamentos.push({
                                credor: `${cessionario.nome} (Cession√°rio de ${adv.nome})`,
                                valorDevido: cessionario.valorBruto,
                                previdencia: 0,
                                ir: cessionario.ir,
                                valorLiquido: cessionario.valorLiquido
                            });
                        });
                    }
                });
            }

            if (resultados.honorariosSucumbenciais?.temHonorariosSucumbenciais && 
                resultados.honorariosSucumbenciais?.honorarios?.length > 0) {
                
                const isPreferencia = dados.tipoCalculo === 'preferencia';
                const isParcial = dados.tipoCalculo === 'parcial';
                
                resultados.honorariosSucumbenciais.honorarios.forEach(adv => {
                    // ADVOGADO SUCUMBENCIAL
                    let deveReceberAdvogado = true;
                    let valorAdvogadoPagamento = adv.valorBrutoAdvogado;
                    
                    if (isPreferencia && !adv.temPreferencia) {
                        deveReceberAdvogado = false;
                    }
                    
                    if (deveReceberAdvogado && valorAdvogadoPagamento > 0) {
                        pagamentos.push({
                            credor: `${adv.nome} (Adv. Sucumbencial ${adv.tipo})`,
                            valorDevido: valorAdvogadoPagamento,
                            previdencia: 0,
                            ir: adv.irAdvogado || 0,
                            valorLiquido: adv.valorLiquidoAdvogado || 0
                        });
                    }
                    
                    let deveReceberCessionarios = true;
                    
                    if (isPreferencia) {
                        if (!adv.temPreferencia) {
                            deveReceberCessionarios = false;
                        } else if (adv.foiLimitadoPorPreferencia) {
                            deveReceberCessionarios = false;
                        }
                    }
                    
                    if (deveReceberCessionarios && adv.cessionarios && adv.cessionarios.length > 0) {
                        adv.cessionarios.forEach(cessionario => {
                            if (cessionario.valorLiquido > 0) {
                                pagamentos.push({
                                    credor: `${cessionario.nome} (Cession√°rio de ${adv.nome})`,
                                    valorDevido: cessionario.valorBruto,
                                    previdencia: 0,
                                    ir: cessionario.ir || 0,
                                    valorLiquido: cessionario.valorLiquido
                                });
                            }
                        });
                    }
                });
            }

            return pagamentos;
        }

        function calcularTotalDevido(pagamentos) {
            return pagamentos.reduce((total, p) => total + arredondarParaDuasCasas(p.valorDevido), 0);
        }

        function calcularTotalPrevidencia(pagamentos) {
            return pagamentos.reduce((total, p) => total + arredondarParaDuasCasas(p.previdencia), 0);
        }

        function calcularTotalIR(pagamentos) {
            return pagamentos.reduce((total, p) => total + arredondarParaDuasCasas(p.ir), 0);
        }

        function calcularTotalLiquido(pagamentos) {
            return pagamentos.reduce((total, p) => {
                const valorDevidoArredondado = arredondarParaDuasCasas(p.valorDevido);
                const previdenciaArredondada = arredondarParaDuasCasas(p.previdencia);
                const irArredondado = arredondarParaDuasCasas(p.ir);
                const valorLiquidoCalculado = arredondarParaDuasCasas(valorDevidoArredondado - previdenciaArredondada - irArredondado);
                return total + valorLiquidoCalculado;
            }, 0);
        }

        function gerarSecaoNotasExplicativas() {
            return `
                <div class="notas-explicativas">
                    <h3>üìù Notas Explicativas do C√°lculo</h3>
                    <textarea id="notasExplicativas" class="textarea-notas" placeholder="Digite aqui as notas explicativas sobre os crit√©rios utilizados no c√°lculo, fundamenta√ß√£o legal, decis√µes judiciais aplicadas, metodologia de atualiza√ß√£o monet√°ria, etc. Exemplo: 1- Destaque do cr√©dito preferencial, conforme decis√£o de id... 2- Atualiza√ß√£o do C√°lculo do id..." maxlength="5000"></textarea>
                </div>
            `;
        }

        function obterNotasExplicativas() {
            const textarea = document.getElementById('notasExplicativas');
            return textarea ? textarea.value.trim() : '';
        }

        function prepararTextareaParaImpressao() {
            // Primeiro, remove qualquer elemento anterior
            const elementoAnterior = document.getElementById('notasParaImpressao');
            if (elementoAnterior) {
                elementoAnterior.remove();
            }
            
            const textarea = document.getElementById('notasExplicativas');
            if (textarea && textarea.value.trim()) {
                // Na impress√£o
                const notasDiv = document.createElement('div');
                notasDiv.id = 'notasParaImpressao';
                notasDiv.style.display = 'none';
                notasDiv.innerHTML = `
                    <div class="notas-explicativas-impressao">
                        <h3>üìù Notas Explicativas do C√°lculo</h3>
                        <div class="conteudo-notas">${textarea.value}</div>
                    </div>
                `;
                
                // Inserir antes do bot√£o de imprimir
                const botao = document.querySelector('.print-button-container');
                if (botao) {
                    botao.parentNode.insertBefore(notasDiv, botao);
                }
            }
        }

        function limparNotasExplicativas() {
            const textarea = document.getElementById('notasExplicativas');
            if (textarea) {
                textarea.value = '';
            }
        }
        
        function gerarBotaoImprimir() {
            return `
                <div class="print-button-container" style="text-align: center; margin: 20px 0; display: block;">
                    <button onclick="prepararTextareaParaImpressao(); window.print();" style="
                        background-color: #343A40;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        font-size: 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        transition: background-color 0.3s;
                    " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#343A40'">
                        üñ®Ô∏è Imprimir / Salvar PDF
                    </button>
                </div>
            `;
        }

        //Modelo Sindifaz - um processo padr√£o com varias cessoes
        function configurarSindiFaz() {
            if (!confirm("Configurar dados padr√£o do SindiFaz?")) return;
            try {
            const dados = {
                advogados: [
                    ["FURTADO COELHO ADVOGADOS ASSOCIADOS", "PJ", 0.16],
                    ["FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "PF", 0.06],
                    ["ADAUTO FORTES ADVOGADOS ASSOCIADOS", "PJ", 0.02666667],
                    ["JUAREZ CHAVES DE AZEVEDO JUNIOR - SOCIEDADE INDIVIDUAL DE ADVOCACIA", "PJ", 0.013333333]
                ],
                cessoes: [
                    ["cessaoAdv", "FURTADO COELHO ADVOGADOS ASSOCIADOS", "LAGUZ I FIDC NP", 0.02],
                    ["cessaoAdv", "FURTADO COELHO ADVOGADOS ASSOCIADOS", "DOMUS OCTANTE I FIDC LTDA", 0.02],
                    ["cessaoAdv", "ADAUTO FORTES ADVOGADOS ASSOCIADOS", "LAGUZ I FIDC NP", 0.0063],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "LAGUZ I FIDC NP", 0.01],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "REAG LEGAL CLAIMS FIDC NP", 0.01],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "FLAVIA CEOLIN LOPES PIANA", 0.00444],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "FJ CONSULTORIA LTDA", 0.001653],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "ISA MARIA LEME OPPENHEIMER BORGES", 0.003907],
                    ["cessaoSindicato", "Sindifaz", "TABARE FIDC NP", 0.5],
                    ["cessaoSindicato", "Sindifaz", "ZEFIROS I FIDC NP", 0.5]
                ]
            };
            
            preencherSindiFaz(dados);
            alert("‚úÖ SindiFaz configurado!");
                
            } catch (error) {
                alert("‚ùå Erro ao configurar.");
            }
        }

        function preencherSindiFaz(dados) {
            const definir = (id, valor) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = valor;
                    el.dispatchEvent(new Event('change'));
                }
            };
            
            // 1. Advogados
            definir('quantAdvogados', dados.advogados.length);
            setTimeout(() => {
                dados.advogados.forEach(([nome, tipo, perc], i) => {
                    definir(`advNome${i}`, nome);
                    definir(`advTipo${i}`, tipo);
                    definir(`advPercentual${i}`, perc);
                });
            }, 100);
            
            // 2. Sindicato
            definir('quantSindicatos', 1);
            setTimeout(() => {
                definir('sindNome0', 'Sindifaz');
                definir('sindPercentual0', 0.01);
                definir('sindTrib0', 'nao');
            }, 200);
            
            // 3. Cess√µes
            definir('quantCessoes', dados.cessoes.length);
            setTimeout(() => {
                dados.cessoes.forEach(([tipo, cedente, cessionario, perc], i) => {
                    definir(`cessaoTipo${i}`, tipo);
                    setTimeout(() => {
                        definir(`cedenteNome${i}`, cedente);
                        definir(`cessionarioNome${i}`, cessionario);
                        definir(`cessaoPercentual${i}`, perc);
                    }, 50);
                });
            }, 300);
            
            // 4. Configura√ß√µes padr√£o
            setTimeout(() => {
                definir('natureza', 'alimentar');
                definir('incidenciaIR', 'sim');
                definir('incidenciaPrevidencia', 'sim');

                setTimeout(() => {
                    definir('tipoPrevidencia', 'fixa');
                    definir('aliquotaFixa', 0.08); 
                    definir('anoOrcamento', 2020);
                    definir('mesBase', 'fevereiro');
                    definir('anoBase', 2018);
                    definir('dataBase', '2018-02-01');
                }, 100);
            }, 400);
        }

    </script>
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-icon">‚öñÔ∏è</div>
            
            <div class="copyright-text">
                ¬© <span class="developer-name">Gabriel de Jesus Silva</span>
            </div>
            
            <div class="subtitle">Sistema de Precat√≥rios</div>
            
            <div class="divider"></div>
            
            <div class="footer-meta">
                2025 ‚Ä¢ PreCalc v2.2
            </div>
        </div>
    </footer>
</body>
</html>