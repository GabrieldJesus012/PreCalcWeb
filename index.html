<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="/print.css" media="print">
    <link rel="shortcut icon" href="/assets/precalc2.ico" type="image/x-icon">
    <meta name="description" content="C√°lculos de Precat√≥rios.">
    <script src="resultados.js"></script>
    <title>PreCalc Web</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PreCalc</h1>
            <p>Sistema de C√°lculo de Precat√≥rios</p>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="showTab('tab1')">üìÖ Informa√ß√µes Gerais</button>
                <button class="tab-button" onclick="showTab('tab2')">üí∞ Informa√ß√µes Financeiras</button>
                <button class="tab-button" onclick="showTab('tab8')">‚öñÔ∏è Sucumbencial</button>
                <button class="tab-button" onclick="showTab('tab3')">üë©‚Äçüíº Dedu√ß√µes Acess√≥rias</button>
                <button class="tab-button" onclick="showTab('tab4')">üë• Herdeiros</button>
                <button class="tab-button" onclick="showTab('tab5')">üîÑ Cess√µes de Cr√©dito</button>
                <button class="tab-button" id= "tabPagamento" onclick="showTab('tab9')" style="display: none;">üí≥ Pagamentos</button>
                <button class="tab-button" id="tabAcordo" onclick="showTab('tab6')" style="display: none;">ü§ù Ades√£o ao Acordo</button>
                <button class="tab-button" onclick="showTab('tab7')">üìä Resultados</button>
            </div>

            <!-- Tab 1: Informa√ß√µes Gerais -->
            <div id="tab1" class="tab-content active">
                <form id="calculatorForm" class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Informa√ß√µes Gerais</h3>
                        <div class="input-group">
                            <div class="label-with-button">
                                <label for="numprocesso">Processo:</label>
                                    <button type="button" class="btn-sindifaz" onclick="configurarSindiFaz()" title="Preencher dados padr√£o do SindiFaz">
                                        SindiFaz
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="numprocesso" placeholder="N√∫mero do processo" style="flex: 1;">
                                <button type="button" class="btn-add" onclick="buscarDadosProcesso()" style="white-space: nowrap; padding: 8px 16px;">
                                    üîç Buscar
                                </button>
                            </div>
                            <div id="statusCarregamento" style="margin-top: 5px; font-size: 12px; color: #666;">
                                ‚è≥ Carregando base de dados...
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="beneficiario">Benefici√°rio Principal:</label>
                            <input type="text" id="beneficiario" placeholder="Nome do benefici√°rio principal">
                        </div>
                        <div class="input-group tipo-beneficiario" id="tipoBeneficiarioGroup">
                            <label>Tipo do Benefici√°rio:</label>
                            <select id="tipoBeneficiario">
                                <option value="pf">Pessoa F√≠sica (PF)</option>
                                <option value="pj">Pessoa Jur√≠dica (PJ)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="credor">Devedor:</label>
                            <input type="text" id="credor" placeholder="Nome do Devedor">
                        </div>
                        <h3>‚öñÔ∏è Configura√ß√µes do Processo</h3>
                        <div class="input-group">
                            <label for="natureza">Natureza da A√ß√£o:</label>
                            <select id="natureza" onchange="toggleTipoBeneficiario()">
                                <option value="alimentar">Alimentar</option>
                                <option value="comum">Comum</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="tipoCalculo">Tipo de C√°lculo:</label>
                            <select id="tipoCalculo">
                                <option value="ordem">Ordem</option>
                                <option value="preferencia">Prefer√™ncia</option>
                                <option value="acordo">Acordo</option>
                                <option value="parcial">Parcial</option>
                            </select>
                        </div>
                        <div class="input-group" id="perguntaPagamento" style="display: none;">
                            <label for="houvePagamento">Houve pagamento?</label>
                            <select id="houvePagamento">
                                <option value="nao">N√£o</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                        <div class="input-group" id="tetoPreferencia" style="display: none;">
                            <label>Teto de Prefer√™ncia (R$):</label>
                            <input type="number" id="tetoPreferenciaPrincipal" step="0.01" placeholder="0.00">
                        </div>
                        <div class="input-group" id="percentualAcordo" style="display: none;">
                            <label>% do Des√°gio (ex: 0.4 para 40%):</label>
                            <input type="number" id="percentualAcordoValor" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                        <div class="input-group" id="saldoParcial" style="display: none;">
                            <label>Saldo Parcial (R$):</label>
                            <input type="number" id="saldoParcialValor" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tab 2: Informa√ß√µes Financeiras -->
            <div id="tab2" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üìÖ Datas-base de c√°lculos</h3>
                        <div class="input-group">
                            <label for="dataatualizacao">Data de Atualiza√ß√£o:</label>
                            <input type="date" name="" id="dataatualizacao" style="margin-bottom:8px;" >
                            <label for="anoOrcamento">Ano do Or√ßamento:</label>
                            <input type="number" id="anoOrcamento" placeholder="Ano do Or√ßamento">
                        </div>
                        <h3>üí∞ Informa√ß√µes Financeiras</h3>
                            <div class="input-group">
                                <label for="descricaoPrincipal">Descri√ß√£o:</label>
                                <input type="text" id="descricaoPrincipal" placeholder="Ex: Sal√°rios">
                            </div>
                            <div class="input-group">
                                <label for="dataBase">Data Base:</label>
                                <input type="date" id="dataBase">
                            </div>
                            <div class="date-row" style="display: none;">
                                <div class="input-group">
                                    <label for="mesBase">M√™s Base:</label>
                                    <select id="mesBase">
                                        <option value="janeiro">Janeiro</option>
                                        <option value="fevereiro">Fevereiro</option>
                                        <option value="mar√ßo">Mar√ßo</option>
                                        <option value="abril">Abril</option>
                                        <option value="maio">Maio</option>
                                        <option value="junho">Junho</option>
                                        <option value="julho">Julho</option>
                                        <option value="agosto">Agosto</option>
                                        <option value="setembro">Setembro</option>
                                        <option value="outubro">Outubro</option>
                                        <option value="novembro">Novembro</option>
                                        <option value="dezembro">Dezembro</option>
                                    </select>
                                </div>
                                <div class="input-group" style="display: none;">
                                    <label for="anoBase">Ano Base:</label>
                                    <input type="number" id="anoBase" placeholder="Ano Base">
                                </div>
                            </div>
                            <div class="date-row">
                                <div class="input-group">
                                    <label for="valorPrincipal">Valor Principal (R$):</label>
                                    <input type="number" id="valorPrincipal" step="0.01" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label for="valorJuros">Valor dos Juros (R$):</label>
                                    <input type="number" id="valorJuros" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            <div class="valor-selic-group">
                                <label>Selic ("%"/ "R$"):</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="radio" id="selicValor" name="tipoSelic" value="valor" checked>
                                        <label for="selicValor">Valor em R$</label>
                                    </div>
                                    
                                    <div class="checkbox-item">
                                        <input type="radio" id="selicPercentual" name="tipoSelic" value="percentual">
                                        <label for="selicPercentual">Percentual (%)</label>
                                    </div>
                                </div>
                                
                                <div class="selic-inputs">
                                    <div class="input-group" id="campoValorSelic">
                                        <label for="valorSelic">Valor Selic (R$):</label>
                                        <input type="number" id="valorSelic" step="0.01" placeholder="0.00">
                                    </div>
                                    
                                    <div class="input-group" id="campoPercentualSelic" style="display: none;">
                                        <label for="percentualSelic">Percentual Selic (ex: 0.3 para 30%):</label>
                                        <input type="number" id="percentualSelic" step="0.01" placeholder="0.00">
                                    </div>

                                    <div class="input-group" id="campoMesReferencSelic">
                                        <label for="mesReferenciaSelic">Este valor SELIC refere-se ao:</label>
                                        <select id="mesReferenciaSelic">
                                            <option value="mesAnterior">M√™s Anterior ao m√™s base</option>
                                            <option value="mesmomesBase">M√™s base</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        <div class="input-group">
                            <label for="rra">RRA:</label>
                            <input type="number" id="rra" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label for="tipoUsoHonorario">Tipo de Uso para Honor√°rios:</label>
                            <select id="tipoUsoHonorario">
                                <option value="ambos" selected>Ambos (contratual e sucumbencial)</option>
                                <option value="contratual">Honor√°rio contratual apenas</option>
                                <option value="sucumbencial">Honor√°rio sucumbencial apenas</option>
                                <option value="nenhum">N√£o usado para honor√°rios</option>
                            </select>
                        </div>
                        <label>√çndices de Corre√ß√£o:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalCNJ" checked>
                                <label for="principalCNJ">CNJ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalSELIC" checked>
                                <label for="principalSELIC">SELIC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalIPCAE" checked>
                                <label for="principalIPCAE">IPCA-E</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalJurosMora" checked>
                                <label for="principalJurosMora">Juros de Mora</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="principalIPCA" checked>
                                <label for="principalIPCA">IPCA</label>
                            </div>
                        </div>
                        <h3>üè¶ Impostos e Contribui√ß√µes</h3>
                        <div class="date-row">
                            <div class="input-group">
                                <label for="incidenciaIR">Incid√™ncia de IR:</label>
                                <select id="incidenciaIR">
                                    <option value="sim">Sim</option>
                                    <option value="nao">N√£o</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="incidenciaPrevidencia">Incid√™ncia de Previd√™ncia:</label>
                                <select id="incidenciaPrevidencia">
                                    <option value="sim">Sim</option>
                                    <option value="nao">N√£o</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group" id="tipoPrevidenciaDiv" style="display: none;">
                            <label for="tipoPrevidencia">Tipo de Previd√™ncia:</label>
                            <select id="tipoPrevidencia">
                                <option value="inss">INSS</option>
                                <option value="fixa">Al√≠quota Fixa</option>
                            </select>
                        </div>
                        <div class="input-group" id="aliquotaFixaDiv" style="display: none;">
                            <label for="aliquotaFixa">Al√≠quota Fixa (ex: 0.14 para 14%):</label>
                            <input type="number" id="aliquotaFixa" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                        <div style="text-align: center;">
                            <button class="btn-add" onclick="adicionarValorPrincipal()">
                                ‚ûï Adicionar Valor Principal
                            </button>
                        </div>
                        <div style="margin-top: 20px;">
                            <h3>üìã Valores Cadastrados</h3>
                            <div id="listaValoresPrincipais" class="lista-items">
                                <!-- Valores ser√£o adicionados aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Dedu√ß√µes Acess√≥rias (Honor√°rios) -->
            <div id="tab3" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë©‚Äçüíº Honor√°rios Contratuais</h3>
                        <div class="input-group">
                            <label for="quantAdvogados">Quantidade de Advogados:</label>
                            <input type="number" id="quantAdvogados" value="0" min="0">
                        </div>
                        <div id="advogadosContainer"></div>
                        <h3>ü§ù Sindicatos</h3>
                        <div class="input-group">
                            <label for="quantSindicatos">Quantidade de Sindicatos:</label>
                            <input type="number" id="quantSindicatos" value="0" min="0">
                        </div>
                        <div id="sindicatosContainer"></div>
                    </div>
                    
                </div>
            </div>

            <!-- Tab 4: Herdeiros  -->
            <div id="tab4" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üë• Herdeiros</h3>
                        <div class="input-group">
                            <label for="quantHerdeiros">Quantidade de Herdeiros:</label>
                            <input type="number" id="quantHerdeiros" value="0" min="0">
                        </div>
                        <div id="herdeirosContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Cess√£o  -->
            <div id="tab5" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üîÑ Cess√µes</h3>
                        <div class="input-group">
                            <label for="quantCessoes">Quantidade de Cess√µes:</label>
                            <input type="number" id="quantCessoes" value="0" min="0">
                        </div>
                        <div id="cessaoContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Ades√£o ao Acordo (Nova Aba) -->
            <div id="tab6" class="tab-content">
                <div class="form-section">
                    <div class="form-group">
                        <div class="alerta-didatico">
                            <h4>‚ö†Ô∏è Importante</h4>
                            <p>Selecione abaixo apenas as pessoas/entidades que aderiram ao acordo. O c√°lculo ser√° realizado somente para os selecionados.</p>
                        </div>
                        
                        <h3>ü§ù Quem Aderiu ao Acordo?</h3>
                        <div id="acordoContainer">
                            <p class="loading">Preencha as abas anteriores para ver as op√ß√µes de ades√£o...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Resultados -->
            <div id="tab7" class="tab-content">
                <div id="results" class="results">
                    <div class="section-title">Resultados dos C√°lculos</div>
                    <div id="resultadosContent">
                        <p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 8: Honor√°rios Sucumbencial -->
        <div id="tab8" class="tab-content">
            <div class="form-section">
                <div class="form-group">
                    <h3>‚öñÔ∏è Honor√°rios Sucumbencial</h3>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">üéØ Controle de Cen√°rio</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="somenteHonorarioSucumbencial">
                            <label for="somenteHonorarioSucumbencial">
                                <strong>Apenas Honor√°rio Sucumbencial</strong> 
                            </label>
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; color: #6c757d;">
                            üí° Marque esta op√ß√£o quando o processo √© APENAS do(s) advogado(s) sucumbencial(is)
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="quantAdvogadosSucumbenciais">Quantidade de Advogados Sucumbenciais:</label>
                        <input type="number" id="quantAdvogadosSucumbenciais" value="0" min="0">
                    </div>
                    
                    <div id="advogadosSucumbenciaisContainer"></div>
                </div>
            </div>
        </div>  

        <!-- Tab 9: Pagamento -->
        <div id="tab9" class="tab-content">
            <div class="form-section">
                <div class="form-section">
                    <div class="form-group">
                        <h3>üí≥ Configura√ß√£o dos Pagamentos</h3>
                        
                        <div class="input-group">
                            <label for="quantidadePagamentos">Quantos pagamentos ocorreram?</label>
                            <input type="number" id="quantidadePagamentos" min="0" value="0">
                        </div>

                        <div id="listaPagamentos"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="btn-container">
            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar Formul√°rio</button>
            <button type="button" class="btn" onclick="calcular()">üßÆ Calcular Valores</button>
        </div>
    </div>

    <script>
        // ====================================
        // CONTROLE DE ABAS E UTILIDADES
        // ====================================

        const $ = id => document.getElementById(id);

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('active', tab.id === tabId);
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                btn.classList.toggle('active', onclick && onclick.includes(`showTab('${tabId}')`));
            });

            if (tabId === 'tab6' && typeof atualizarAdesaoAcordo === 'function') {
                atualizarAdesaoAcordo();
            }
        }

        // ====================================
        // FUN√á√ïES DE VISIBILIDADE
        // ====================================

        function toggleDisplay(el, mostrar, tipo = 'block') {
            if (!el) return;
            el.style.display = mostrar ? tipo : 'none';
        }

        function toggleTipoBeneficiario() {
            const natureza = $('natureza').value;
            const grupo = $('tipoBeneficiarioGroup');
            grupo.classList.toggle('show', natureza === 'comum');
            if (natureza !== 'comum') $('tipoBeneficiario').value = 'pf';
        }

        function atualizarVisibilidadePreferencia() {
            const tipo = Cache.tipoCalculo?.value;
            const quant = parseInt(Cache.quantHerdeiros?.value) || 0;
            for (let i = 0; i < quant; i++) {
                toggleDisplay($(`herdPreferenciaContainer${i}`), tipo === 'preferencia', '');
            }
        }

        function atualizarVisibilidadePreferenciaSucumbencial() {
            const tipo = Cache.tipoCalculo?.value;
            const quant = parseInt(Cache.quantAdvogadosSucumbenciais?.value) || 0;
            for (let i = 0; i < quant; i++) {
                toggleDisplay($(`advSucPreferenciaContainer${i}`), tipo === 'preferencia');
            }
        }

        function toggleTipoPagamento(index) {
            const tipo = $(`pagTipoInformacao${index}`).value;
            document.querySelectorAll(`.pag-campo-total-${index}`).forEach(el =>
                toggleDisplay(el, tipo === 'total')
            );
            document.querySelectorAll(`.pag-campo-separado-${index}`).forEach(el =>
                toggleDisplay(el, tipo !== 'total')
            );
        }

        function toggleAbaPagamento() {
            const houvePagamento = Cache.houvePagamento?.value === 'sim';
            const tabPagamento = document.getElementById('tabPagamento');
            
            toggleDisplay(tabPagamento, houvePagamento);
            
            if (!houvePagamento) {
                // Zerar quantidade se diferente de 0
                if (Cache.quantidadePagamentos && Cache.quantidadePagamentos.value !== '0') {
                    Cache.quantidadePagamentos.value = 0;
                    Cache.quantidadePagamentos.dispatchEvent(new Event('change'));
                }
                
                // Se aba de pagamento est√° ativa, volta pra tab1
                const abaPagamentoAtiva = document.getElementById('tab9');
                if (abaPagamentoAtiva?.classList.contains('active')) {
                    showTab('tab1');
                }
            }
        }

        function toggleSelicPagamento(index) {
            const valor = $(`pagSelicValor${index}`);
            toggleDisplay($(`pagCampoValorSelic${index}`), valor?.checked);
            toggleDisplay($(`pagCampoPercentualSelic${index}`), !valor?.checked);
            if (valor?.checked) $(`pagPercentualSelic${index}`).value = '';
            else $(`pagValorSelic${index}`).value = '';
        }

        function toggleAliquotaSindicato(index) {
            const selectTrib = document.getElementById(`sindTrib${index}`);
            const aliquotaContainer = document.getElementById(`aliquotaSindContainer${index}`);
            
            if (!selectTrib || !aliquotaContainer) return;
            
            const mostrarAliquota = selectTrib.value === 'fixa';
            
            aliquotaContainer.style.display = mostrarAliquota ? 'block' : 'none';
            
            // Limpar valor quando ocultar
            if (!mostrarAliquota) {
                const aliquotaInput = document.getElementById(`aliquotaSind${index}`);
                if (aliquotaInput) {
                    aliquotaInput.value = '';
                }
            }
        }

        function toggleCamposSucumbencial(index) {
            const tipoHonorario = document.getElementById(`advSucTipoHonorario${index}`);
            const percentualContainer = document.getElementById(`advSucPercentualContainer${index}`);
            
            if (!tipoHonorario) return;
            
            if (tipoHonorario.value === 'percentual') {
                if (percentualContainer) percentualContainer.style.display = 'block';
            } else if (tipoHonorario.value === 'valorPrincipal') {
                if (percentualContainer) percentualContainer.style.display = 'none';
            }
        }

        function toggleAbaAcordo() {
            const tipoCalculo = Cache.tipoCalculo?.value;
            const natureza = Cache.natureza?.value;
            const isAcordo = tipoCalculo === 'acordo';
            
            toggleDisplay($('tetoPreferencia'), tipoCalculo === 'preferencia' && natureza === 'alimentar');
            toggleDisplay($('percentualAcordo'), isAcordo)

            const tabAcordo = $('tabAcordo');
            toggleDisplay(tabAcordo, isAcordo);
            
            if (!isAcordo) {
                const abaAcordoAtiva = $('tab6');
                if (abaAcordoAtiva?.classList.contains('active')) {
                    showTab('tab1');
                }
            }
        }

        // ====================================
        // INICIALIZA√á√ÉO PRINCIPAL
        // ====================================

        document.addEventListener('DOMContentLoaded', function() {
            const anoAtual = new Date().getFullYear();
            $('anoBase').value = anoAtual;
            $('anoOrcamento').value = anoAtual;
            
            Cache.init();
            Cache.init();
            initializeFormEventListeners();
            configureEventListeners();
            
            ['incidenciaPrevidencia','tipoPrevidencia','tipoCalculo','natureza'].forEach(id =>
                $(id)?.dispatchEvent(new Event('change'))
            );

            const selic = {
                valor: $('selicValor'),
                perc: $('selicPercentual'),
                campoValor: $('campoValorSelic'),
                campoPerc: $('campoPercentualSelic'),
                inputValor: $('valorSelic'),
                inputPerc: $('percentualSelic')
            };

            function alternarCamposSelic() {
                const usarValor = selic.valor.checked;
                toggleDisplay(selic.campoValor, usarValor);
                toggleDisplay(selic.campoPerc, !usarValor);
                if (usarValor) selic.inputPerc.value = '';
                else selic.inputValor.value = '';
            }

            selic.valor?.addEventListener('change', alternarCamposSelic);
            selic.perc?.addEventListener('change', alternarCamposSelic);
            alternarCamposSelic();
            toggleAbaAcordo();
            toggleAbaPagamento();
        });
        
        document.addEventListener('blur', function(e) {
            if (e.target.id && e.target.id.startsWith('pagDataBase')) {
                
                const match = e.target.id.match(/\d+$/);
                if (!match) return;
                
                const index = match[0];
                const campoData = document.getElementById(`pagDataBase${index}`);
                const campoTipo = document.getElementById(`pagTipoInformacao${index}`);
                
                if (!campoData || !campoTipo) return;
                
                const dataBase = campoData.value;
                const tipoInformacao = campoTipo.value;
                
                if (!dataBase || dataBase.length !== 10) return;
                
                if (tipoInformacao !== 'total') return;
                
                const dataPagamento = new Date(dataBase + 'T00:00:00');
                if (isNaN(dataPagamento.getTime())) return;
                
                const dataLimite = new Date(2021, 11, 31);
                
                if (dataPagamento <= dataLimite) {
                    alert(`‚ö†Ô∏è ATEN√á√ÉO - Pagamento ${parseInt(index) + 1}\n\nPara pagamentos at√© 31/12/2021, n√£o √© poss√≠vel usar "Valor Total".\n\nO tipo foi alterado automaticamente para "Valores Separados".\n\nüìå Motivo: Limita√ß√£o das APIs do Banco Central para datas antigas.`);
                    
                    campoTipo.value = 'separado';
                    
                    if (typeof toggleTipoPagamento === 'function') {
                        toggleTipoPagamento(index);
                    }
                }
            }
        }, true); 

        document.addEventListener('change', function(e) {
            if (e.target.id && e.target.id.startsWith('pagTipoInformacao')) {
                
                const match = e.target.id.match(/\d+$/);
                if (!match) return;
                
                const index = match[0];
                const campoData = document.getElementById(`pagDataBase${index}`);
                const campoTipo = document.getElementById(`pagTipoInformacao${index}`);
                
                if (!campoData || !campoTipo) return;
                
                const dataBase = campoData.value;
                const tipoInformacao = campoTipo.value;
                
                if (!dataBase || dataBase.length !== 10 || tipoInformacao !== 'total') return;
                
                const dataPagamento = new Date(dataBase + 'T00:00:00');
                if (isNaN(dataPagamento.getTime())) return;
                
                const dataLimite = new Date(2021, 11, 31);
                
                if (dataPagamento <= dataLimite) {
                    alert(`‚ö†Ô∏è ATEN√á√ÉO - Pagamento ${parseInt(index) + 1}\n\nPara pagamentos at√© 31/12/2021, n√£o √© poss√≠vel usar "Valor Total".\n\nO tipo foi alterado automaticamente para "Valores Separados".\n\nüìå Motivo: Limita√ß√£o das APIs do Banco Central para datas antigas.`);
                    
                    campoTipo.value = 'separado';
                    
                    if (typeof toggleTipoPagamento === 'function') {
                        toggleTipoPagamento(index);
                    }
                }
            }
        });

        // ====================================
        // INICIALIZA√á√ÉO NA CARGA DA P√ÅGINA
        // ====================================

        window.addEventListener('load', () => {
            ['tipoCalculo','natureza','incidenciaPrevidencia','tipoPrevidencia'].forEach(id =>
                $(id)?.dispatchEvent(new Event('change'))
            );
            $('selicValor').checked = true;
            $('selicValor').dispatchEvent(new Event('change'));
            toggleAbaAcordo();
            toggleAbaPagamento();
        });
        
        // ====================================
        // INICIALIZA√á√ÉO DE FORMUL√ÅRIOS
        // ====================================

        function initializeFormEventListeners() {
            const handlers = [
                ['quantAdvogados', criarElementoAdvogado, 'advogados'],
                ['quantAdvogadosSucumbenciais', criarElementoAdvogadoSucumbencial, 'advogadosSucumbenciais'],
                ['quantSindicatos', criarElementoSindicato, 'sindicatos'],
                ['quantHerdeiros', criarElementoHerdeiro, 'herdeiros']
            ];

            handlers.forEach(([campo, fn, tipo]) => {
                Cache[campo]?.addEventListener('change', function() {
                    criarElementosFormulario({
                        container: Cache[`${tipo}Container`],
                        quantidade: parseInt(this.value) || 0,
                        criarElementoFn: fn,
                        tipo,
                        callback: atualizarOpcoesCessao
                    });
                });
            });

            // Cess√µes
            Cache.quantCessoes?.addEventListener('change', e =>
                criarCessoes(parseInt(e.target.value) || 0)
            );

            Cache.quantidadePagamentos?.addEventListener('change', e => {
                criarElementosFormulario({
                    container: Cache.pagamentosContainer,
                    quantidade: parseInt(e.target.value) || 0,
                    criarElementoFn: criarElementoPagamento,
                    tipo: 'pagamentos'
                });
            });

            Cache.tipoCalculo?.addEventListener('change', function() {
                DadosFormulario.salvarHerdeiros();
                atualizarVisibilidadePreferencia();
                atualizarVisibilidadePreferenciaSucumbencial();
            });
            
            // Benefici√°rio
            Cache.beneficiario?.addEventListener('change', atualizarOpcoesCessao);
        }

        // ====================================
        // CONFIGURA√á√ÉO DE EVENT LISTENERS
        // ====================================

        function configureEventListeners() {
            // Atualiza m√™s e ano a partir de dataBase
            $('dataBase')?.addEventListener('change', e => {
                const [ano, mes] = e.target.value.split('-');
                const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
                $('mesBase').value = meses[parseInt(mes) - 1] || '';
                $('anoBase').value = ano || '';
            });

            // Tipo de c√°lculo
            $('tipoCalculo')?.addEventListener('change', () => {
                const tipo = $('tipoCalculo').value;
                const natureza = $('natureza').value;

                toggleDisplay($('tetoPreferencia'), tipo === 'preferencia' && natureza === 'alimentar');
                toggleDisplay($('percentualAcordo'), tipo === 'acordo');
                toggleDisplay($('saldoParcial'), tipo === 'parcial');

                const permitePagamento = ['ordem','acordo'].includes(tipo);
                toggleDisplay($('perguntaPagamento'), permitePagamento);

                const houvePagamento = $('houvePagamento');
                if (!permitePagamento && houvePagamento) {
                    houvePagamento.value = 'nao';
                    toggleAbaPagamento();
                }

                if (houvePagamento && !houvePagamento.dataset.listenerAdded) {
                    houvePagamento.addEventListener('change', toggleAbaPagamento);
                    houvePagamento.dataset.listenerAdded = 'true';
                }

                toggleAbaAcordo();
            });

            // Natureza
            $('natureza')?.addEventListener('change', () => {
                const tipo = $('tipoCalculo').value;
                toggleDisplay($('tetoPreferencia'), tipo === 'preferencia' && $('natureza').value === 'alimentar');
            });

            // Incid√™ncia Previd√™ncia
            $('incidenciaPrevidencia')?.addEventListener('change', () => {
                const incidencia = $('incidenciaPrevidencia').value === 'sim';
                toggleDisplay($('tipoPrevidenciaDiv'), incidencia);
                toggleDisplay($('aliquotaFixaDiv'), incidencia && $('tipoPrevidencia').value === 'fixa');
            });

            $('tipoPrevidencia')?.addEventListener('change', () => {
                toggleDisplay($('aliquotaFixaDiv'), $('incidenciaPrevidencia').value === 'sim' && $('tipoPrevidencia').value === 'fixa');
            });

            // Honor√°rio sucumbencial
            $('somenteHonorarioSucumbencial')?.addEventListener('change', e => {
                if (e.target.checked && (parseInt($('quantAdvogadosSucumbenciais')?.value) || 0) === 0) {
                    alert('‚ö†Ô∏è Para marcar "Somente Honor√°rio Sucumbencial", voc√™ precisa ter pelo menos 1 Advogado Sucumbencial cadastrado.');
                    e.target.checked = false;
                }
            });
        }

        // ====================================
        // Cadastro Valores Principais - informa√ß√µes financeiras
        // ====================================

        let valoresPrincipais = [];
        function adicionarValorPrincipal() {
            const mesBase = $('mesBase').value;
            const anoBase = $('anoBase').value;
            const valorPrincipal = parseFloat($('valorPrincipal').value) || 0;
            const valorJuros = parseFloat($('valorJuros').value) || 0;
            const rra = parseFloat($('rra').value) || 0;
            const descricao = $('descricaoPrincipal').value || 'Valor Principal';
            const tipoUsoHonorario = $('tipoUsoHonorario')?.value || 'ambos';

            const tipoSelic = document.querySelector('input[name="tipoSelic"]:checked')?.value;
            const valorSelic = parseFloat($('valorSelic').value) || 0;
            const percentualSelic = parseFloat($('percentualSelic').value) || 0;
            const mesReferenciaSelic = $('mesReferenciaSelic').value;

            if (!anoBase || (!valorPrincipal && !valorJuros)) {
                alert('Preencha o ano base e pelo menos um valor (principal, juros)');
                return;
            }

            const indices = { 
                cnj: $('principalCNJ').checked, 
                selic: $('principalSELIC').checked, 
                ipcae: $('principalIPCAE').checked, 
                jurosMora: $('principalJurosMora').checked,
                ipca: $('principalIPCA').checked,
            };

            const tributacao = {
                ir: $('incidenciaIR').value === 'sim',
                previdencia: $('incidenciaPrevidencia').value === 'sim',
                tipoPrevidencia: $('tipoPrevidencia').value,
                aliquotaFixa: parseFloat($('aliquotaFixa').value) || 0,
                rra: parseFloat(rra) || 0
            };

            if (tributacao.previdencia) {
                const existeFixa = valoresPrincipais.some(item => item.tributacao.previdencia && item.tributacao.tipoPrevidencia === 'fixa');
                const existeINSS = valoresPrincipais.some(item => item.tributacao.previdencia && item.tributacao.tipoPrevidencia === 'inss');

                if ((existeFixa && tributacao.tipoPrevidencia === 'inss') ||
                    (existeINSS && tributacao.tipoPrevidencia === 'fixa')) {
                    alert('‚ùå Todos os itens devem seguir o mesmo padr√£o de previd√™ncia (fixa ou INSS).');
                    return;
                }
            }

            const valor = {
                id: Date.now(),
                mesBase,
                anoBase: parseInt(anoBase),
                valorPrincipal,
                valorJuros,
                tipoSelic,
                valorSelic: tipoSelic === 'valor' ? valorSelic : 0,
                percentualSelic: tipoSelic === 'percentual' ? percentualSelic : 0,
                mesReferenciaSelic,
                indices,
                tributacao,
                descricao,
                tipoUsoHonorario,
            };

            valoresPrincipais.push(valor);
            renderizarValoresPrincipais();
            limparFormularioPrincipal();

            alert("‚úÖ Valor cadastrado com sucesso!");

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====================================
        // // Renderizar valores principais
        // ====================================

        function renderizarValoresPrincipais() {
            const lista = document.getElementById('listaValoresPrincipais');
            lista.innerHTML = '';

            valoresPrincipais.forEach(valor => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                const indicesTexto = Object.entries(valor.indices)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => key.toUpperCase())
                    .join(', ');

                const tributacaoTexto = [];
                if (valor.tributacao.ir) tributacaoTexto.push('IR');
                if (valor.tributacao.previdencia) {
                    if (valor.tributacao.tipoPrevidencia === 'fixa') {
                        tributacaoTexto.push(`PREV: ${(valor.tributacao.aliquotaFixa * 100).toFixed(2)}%`);
                    } else {
                        tributacaoTexto.push('PREV: INSS');
                    }
                }
                if (valor.tributacao.rra > 0) tributacaoTexto.push(`RRA: ${valor.tributacao.rra}`);

                const tipoUsoTexto = {
                    'ambos': 'Ambos honor√°rios',
                    'contratual': 'S√≥ contratual', 
                    'sucumbencial': 'S√≥ sucumbencial',
                    'nenhum': 'Sem honor√°rios'
                }[valor.tipoUsoHonorario] || 'Ambos honor√°rios';

                let selicTexto = '';
                if (valor.tipoSelic === 'valor' && valor.valorSelic > 0) {
                    selicTexto = `R$ ${valor.valorSelic.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                } else if (valor.tipoSelic === 'percentual' && valor.percentualSelic > 0) {
                    selicTexto = `${(valor.percentualSelic * 100).toFixed(4)}%`;
                } else {
                    selicTexto = 'R$ 0,00';
                }

                div.innerHTML = `
                    <div class="item-header">
                        <strong>${valor.descricao}</strong>
                        <button class="btn-editar" onclick="editarValorPrincipal(${valor.id})">‚úèÔ∏è Editar</button>
                        <button class="btn-remover" onclick="removerValorPrincipal(${valor.id})">üóëÔ∏è Remover</button>
                    </div>
                    <div class="item-info">
                        <span><strong>Base:</strong> ${valor.mesBase}/${valor.anoBase}</span>
                        <span><strong>Principal:</strong> R$ ${valor.valorPrincipal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span><strong>Juros:</strong> R$ ${valor.valorJuros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        <span><strong>Selic:</strong> ${selicTexto}</span>
                        <span><strong>Refere-se ao:</strong> ${valor.mesReferenciaSelic === 'mesAnterior' ? 'M√™s anterior' : 'Mesmo m√™s'}</span>
                        <span><strong>√çndices:</strong> ${indicesTexto}</span>
                        <span><strong>Tributa√ß√£o:</strong> ${tributacaoTexto.join(', ') || 'Nenhuma'}</span>
                        <span><strong>Uso:</strong> ${tipoUsoTexto}</span>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        // ====================================
        // Editar Valores
        // ====================================

        function editarValorPrincipal(id) {
            const valorParaEditar = valoresPrincipais.find(v => v.id === id);
            if (!valorParaEditar) {
                alert('Valor n√£o encontrado!');
                return;
            }
            $('descricaoPrincipal').value = valorParaEditar.descricao || '';
            $('mesBase').value = valorParaEditar.mesBase || '';
            $('anoBase').value = valorParaEditar.anoBase || '';
            $('valorPrincipal').value = valorParaEditar.valorPrincipal || '';
            $('valorJuros').value = valorParaEditar.valorJuros || '';
            $('rra').value = valorParaEditar.tributacao.rra || '';
            $('tipoUsoHonorario').value = valorParaEditar.tipoUsoHonorario || 'ambos';

            if (valorParaEditar.tipoSelic === 'valor') {
                $('selicValor').checked = true;
                $('valorSelic').value = valorParaEditar.valorSelic || '';
                $('percentualSelic').value = '';
            } else if (valorParaEditar.tipoSelic === 'percentual') {
                $('selicPercentual').checked = true;
                $('percentualSelic').value = valorParaEditar.percentualSelic || '';
                $('valorSelic').value = '';
            } else {
                $('selicValor').checked = true;
                $('valorSelic').value = '';
                $('percentualSelic').value = '';
            }

            $('mesReferenciaSelic').value = valorParaEditar.mesReferenciaSelic || 'mesAnterior';
            $('selicValor').dispatchEvent(new Event('change'));
            $('selicPercentual').dispatchEvent(new Event('change'));

            $('principalCNJ').checked = valorParaEditar.indices.cnj || false; 
            $('principalSELIC').checked = valorParaEditar.indices.selic || false; 
            $('principalIPCAE').checked = valorParaEditar.indices.ipcae || false; 
            $('principalJurosMora').checked = valorParaEditar.indices.jurosMora || false;
            $('principalIPCA').checked = valorParaEditar.indices.ipca || false; 

            const trib = valorParaEditar.tributacao || {};
            $('incidenciaIR').value = trib.ir ? 'sim' : 'nao';
            $('incidenciaPrevidencia').value = trib.previdencia ? 'sim' : 'nao';
            
            if (trib.previdencia) {
                $('tipoPrevidencia').value = trib.tipoPrevidencia || 'inss';
                $('aliquotaFixa').value = trib.tipoPrevidencia === 'fixa' ? trib.aliquotaFixa || '' : '';
            }

            $('incidenciaPrevidencia').dispatchEvent(new Event('change'));
            $('tipoPrevidencia').dispatchEvent(new Event('change'));

            // Remove valor antigo e re-renderiza lista
            valoresPrincipais = valoresPrincipais.filter(v => v.id !== id);
            renderizarValoresPrincipais();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====================================
        // Remover valores e Limpar formularios
        // ====================================

        function removerValorPrincipal(id) {
            valoresPrincipais = valoresPrincipais.filter(v => v.id !== id);
            renderizarValoresPrincipais();
        }

        function limparFormularioPrincipal() {
            $('valorPrincipal').value = '';
            $('valorJuros').value = '';
            $('valorSelic').value = '';
            $('percentualSelic').value = '';
            $('mesReferenciaSelic').value = 'mesAnterior';
            $('rra').value = '';
            $('descricaoPrincipal').value = ''; 
            $('tipoUsoHonorario').value = 'ambos';
            $('selicValor').checked = true;
            const eventoSelic = new Event('change');
            $('selicValor').dispatchEvent(eventoSelic);
        }

        // ====================================
        // Armazenamento do formul√°rio
        // ====================================

        const DadosFormulario = {
            advogados: [],
            advogadosSucumbenciais: [],
            herdeiros: [],
            sindicatos: [],
            cessoes: [],
            pagamentos: [],
            
            config: {
                advogados: {
                    quantId: 'quantAdvogados',
                    campos: ['nome', 'tipo', 'incidenciaIR', 'percentual'],
                    prefixo: 'adv',
                    maiusculo: false
                },
                advogadosSucumbenciais: {
                    quantId: 'quantAdvogadosSucumbenciais',
                    campos: ['nome', 'tipo', 'incidenciaIR', 'tipoHonorario', 'percentual', 'temPreferencia'],
                    prefixo: 'advSuc',
                    maiusculo: false,
                    condicional: (dados, i) => {
                        if (dados.tipoHonorario !== 'percentual') delete dados.percentual;
                        dados.preferencia = dados.temPreferencia;
                        delete dados.temPreferencia;
                    }
                },
                herdeiros: {
                    quantId: 'quantHerdeiros',
                    campos: ['nome', 'percentual', 'preferencia'],
                    prefixo: 'herd',
                    maiusculo: false
                },
                sindicatos: {
                    quantId: 'quantSindicatos',
                    campos: ['nome', 'percentual', 'trib', 'aliquotaSind'],
                    prefixo: 'sind',
                    maiusculo: false,
                    mapeamento: { trib: 'tributacao', aliquotaSind: 'aliquota' }
                },
                cessoes: {
                    quantId: 'quantCessoes',
                    campos: ['tipo', 'cedenteNome', 'cessionarioNome', 'percentual'],
                    prefixo: 'cessao',
                    maiusculo: false,
                    mapeamento: { cedenteNome: 'cedente', cessionarioNome: 'cessionario' }
                },
                pagamentos: {
                    quantId: 'quantidadePagamentos',
                    campos: ['beneficiario', 'dataBase', 'tipoInformacao', 'valorTotal', 'valorPrincipal', 
                            'valorJuros', 'valorSelic', 'percentualSelic', 'mesReferenciaSelic'],
                    prefixo: 'pag',
                    maiusculo: false,
                    mapeamento: { mesReferenciaSelic: 'selicReferencia' },
                    condicional: (dados, i) => {
                        // Detecta tipo de Selic
                        const selicValorRadio = $(`pagSelicValor${i}`);
                        dados.tipoSelic = selicValorRadio?.checked ? 'valor' : 'percentual';
                    }
                }
            },
            
            salvarTipo(tipo) {
                const cfg = this.config[tipo];
                if (!cfg) return;
                
                this[tipo] = [];
                const quantidade = parseInt($(cfg.quantId)?.value) || 0;
                
                for (let i = 0; i < quantidade; i++) {
                    const dados = {};
                    
                    cfg.campos.forEach(campo => {
                        const nomeCampo = cfg.mapeamento?.[campo] || campo;
                        const idCompleto = campo.includes('Nome') || campo.includes('aliquota') || campo.includes('Referencia')
                            ? `${campo}${i}` 
                            : `${cfg.prefixo}${campo.charAt(0).toUpperCase() + campo.slice(1)}${i}`;
                        
                        const elemento = $(idCompleto);
                        dados[nomeCampo] = elemento?.value || '';
                    });
                    
                    if (cfg.condicional) cfg.condicional(dados, i);
                    
                    this[tipo].push(dados);
                }
            },
            
            restaurarTipo(tipo) {
                const cfg = this.config[tipo];
                if (!cfg) return;
                
                const quantidade = parseInt($(cfg.quantId)?.value) || 0;
                const limite = Math.min(this[tipo].length, quantidade);
                
                for (let i = 0; i < limite; i++) {
                    const dados = this[tipo][i];
                    
                    cfg.campos.forEach(campo => {
                        const nomeCampo = cfg.mapeamento?.[campo] || campo;
                        // Tratamento especial para campos com 'Nome' ou outros que n√£o seguem o padr√£o
                        const idCompleto = campo.includes('Nome') || campo.includes('aliquota') || campo.includes('Referencia')
                            ? `${campo}${i}` 
                            : `${cfg.prefixo}${campo.charAt(0).toUpperCase() + campo.slice(1)}${i}`;
                        
                        const elemento = $(idCompleto);
                        
                        // Mapeamento reverso para advogadosSucumbenciais
                        let valorParaRestaurat = dados[nomeCampo];
                        if (tipo === 'advogadosSucumbenciais' && nomeCampo === 'preferencia') {
                            valorParaRestaurat = dados.preferencia;
                        }
                        
                        if (elemento && valorParaRestaurat !== undefined && valorParaRestaurat !== '') {
                            elemento.value = valorParaRestaurat;
                        }
                    });
                    
                    if (tipo === 'advogadosSucumbenciais') {
                        toggleCamposSucumbencial(i);
                    } else if (tipo === 'sindicatos') {
                        toggleAliquotaSindicato(i);
                    } else if (tipo === 'cessoes') {
                        atualizarCedentes(i);
                        setTimeout(() => {
                            const cedenteNome = $(`cedenteNome${i}`);
                            const cessionarioNome = $(`cessionarioNome${i}`);
                            const cessaoPercentual = $(`cessaoPercentual${i}`);
                            
                            if (cedenteNome) cedenteNome.value = dados.cedente;
                            if (cessionarioNome) cessionarioNome.value = dados.cessionario;
                            if (cessaoPercentual) cessaoPercentual.value = dados.percentual;
                        }, 50);
                    } else if (tipo === 'pagamentos') {
                        this.restaurarPagamentoEspecial(i, dados);
                    }
                }
            },
            
            restaurarPagamentoEspecial(i, dados) {
                const tipoInformacao = $(`pagTipoInformacao${i}`);
                if (tipoInformacao) {
                    tipoInformacao.value = dados.tipoInformacao || 'total';
                    
                    if (typeof toggleTipoPagamento === 'function') toggleTipoPagamento(i);
                }
                
                if (dados.tipoInformacao === 'total') {
                    const valorTotal = document.getElementById(`pagValorTotal${i}`);
                    if (valorTotal) valorTotal.value = dados.valorTotal;
                } else {
                    const valorPrincipal = $(`pagValorPrincipal${i}`);
                    const valorJuros = $(`pagValorJuros${i}`);
                    const selicValorRadio = $(`pagSelicValor${i}`);
                    const selicPercentualRadio = $(`pagSelicPercentual${i}`);
                    const valorSelic = $(`pagValorSelic${i}`);
                    const percentualSelic = $(`pagPercentualSelic${i}`);
                    
                    if (valorPrincipal) valorPrincipal.value = dados.valorPrincipal;
                    if (valorJuros) valorJuros.value = dados.valorJuros;
                    
                    if (dados.tipoSelic === 'valor') {
                        if (selicValorRadio) selicValorRadio.checked = true;
                        if (valorSelic) valorSelic.value = dados.valorSelic;
                    } else {
                        if (selicPercentualRadio) selicPercentualRadio.checked = true;
                        if (percentualSelic) percentualSelic.value = dados.percentualSelic;
                    }
                    if (typeof toggleSelicPagamento === 'function') toggleSelicPagamento(i);
                }
            },
            
            // M√©todos p√∫blicos simplificados
            salvar(tipo) {
                if (tipo === 'todos') {
                    this.salvarTodos();
                } else {
                    this.salvarTipo(tipo);
                }
            },
            
            salvarAdvogados() { this.salvarTipo('advogados'); },
            salvarAdvogadosSucumbenciais() { this.salvarTipo('advogadosSucumbenciais'); },
            salvarHerdeiros() { this.salvarTipo('herdeiros'); },
            salvarSindicatos() { this.salvarTipo('sindicatos'); },
            salvarCessoes() { this.salvarTipo('cessoes'); },
            salvarPagamentos() { this.salvarTipo('pagamentos'); },
            
            salvarTodos() {
                ['advogados', 'advogadosSucumbenciais', 'herdeiros', 'sindicatos', 'cessoes', 'pagamentos']
                    .forEach(tipo => this.salvarTipo(tipo));
            },
            
            restaurarAdvogados() { this.restaurarTipo('advogados'); },
            restaurarAdvogadosSucumbenciais() { this.restaurarTipo('advogadosSucumbenciais'); },
            restaurarHerdeiros() { this.restaurarTipo('herdeiros'); },
            restaurarSindicatos() { this.restaurarTipo('sindicatos'); },
            restaurarCessoes() { this.restaurarTipo('cessoes'); },
            restaurarPagamentos() { this.restaurarTipo('pagamentos'); }
        };

        // ====================================
        // CACHE
        // ====================================

        const Cache = {
            config: {
                // Containers
                containers: [
                    'advogadosContainer',
                    'advogadosSucumbenciaisContainer',
                    'sindicatosContainer',
                    'herdeirosContainer'
                ],
                
                // Dados b√°sicos
                dadosBasicos: [
                    'numprocesso',
                    'anoOrcamento',
                    'beneficiario',
                    'tipoBeneficiario',
                    'credor',
                    'natureza',
                    'tipoCalculo',
                    'calculatorForm'
                ],
                
                // Quantidades
                quantidades: [
                    'quantAdvogados',
                    'quantAdvogadosSucumbenciais',
                    'quantHerdeiros',
                    'quantSindicatos',
                    'quantCessoes',
                    'quantidadePagamentos'
                ],
                
                // Campos condicionais
                condicionais: [
                    'tetoPreferenciaPrincipal',
                    'percentualAcordoValor',
                    'saldoParcialValor',
                    'somenteHonorarioSucumbencial',
                    'houvePagamento'
                ]
            },
            
            especiais: {
                pagamentosContainer: 'listaPagamentos'
            },
            
            init() {
                Object.values(this.config).forEach(grupo => {
                    grupo.forEach(id => {
                        this[id] = document.getElementById(id);
                    });
                });
                
                Object.entries(this.especiais).forEach(([prop, id]) => {
                    this[prop] = document.getElementById(id);
                });
            },
            
            getValue(elementId, defaultValue = '', parser = null) {
                const element = this[elementId];
                if (!element) return defaultValue;
                
                const value = element.value;
                if (!value && defaultValue !== '') return defaultValue;
                
                return parser ? parser(value) || defaultValue : value;
            }
        };

        // ====================================
        // CRIA√á√ÉO DE ELEMENTOS
        // ====================================

        const ConfigCampos = {
            advogado: {
                titulo: 'Advogado',
                prefixo: 'adv',
                campos: [
                    { id: 'Nome', label: 'Nome', type: 'text', placeholder: 'Nome do advogado' },
                    { id: 'Tipo', label: 'Tipo', type: 'select', options: [
                        { value: 'PF', text: 'Pessoa F√≠sica' },
                        { value: 'PJ', text: 'Pessoa Jur√≠dica' }
                    ]},
                    { id: 'IncidenciaIR', label: 'Incid√™ncia de IR', type: 'select', options: [
                        { value: 'sim', text: 'Sim', selected: true },
                        { value: 'nao', text: 'N√£o' }
                    ]},
                    { id: 'Percentual', label: 'Percentual (ex: 0.1 para 10%)', type: 'number', step: '0.01', min: '0', max: '1', placeholder: '0.00' }
                ]
            },
            
            advogadoSucumbencial: {
                titulo: 'Advogado Sucumbencial',
                prefixo: 'advSuc',
                campos: [
                    { id: 'Nome', label: 'Nome', type: 'text', placeholder: 'Nome do advogado' },
                    { id: 'Tipo', label: 'Tipo', type: 'select', options: [
                        { value: 'PF', text: 'Pessoa F√≠sica' },
                        { value: 'PJ', text: 'Pessoa Jur√≠dica' }
                    ]},
                    { id: 'IncidenciaIR', label: 'Incid√™ncia de IR', type: 'select', options: [
                        { value: 'sim', text: 'Sim', selected: true },
                        { value: 'nao', text: 'N√£o' }
                    ]},
                    { id: 'TipoHonorario', label: 'Tipo de Honor√°rio', type: 'select', onChange: 'toggleCamposSucumbencial', options: [
                        { value: 'percentual', text: 'Percentual' },
                        { value: 'valorPrincipal', text: 'Valor Principal Pr√≥prio' }
                    ]},
                    { id: 'Percentual', label: 'Percentual (ex: 0.3 para 30%)', type: 'number', step: '0.01', min: '0', max: '1', placeholder: '0.00', containerId: 'Container' },
                    { id: 'TemPreferencia', label: 'Tem Prefer√™ncia?', type: 'select', condicional: 'preferencia', containerId: 'Container', options: [
                        { value: 'nao', text: 'N√£o' },
                        { value: 'sim', text: 'Sim' }
                    ]}
                ]
            },
            
            sindicato: {
                titulo: 'Sindicato',
                prefixo: 'sind',
                campos: [
                    { id: 'Nome', label: 'Nome', type: 'text', placeholder: 'Nome do sindicato' },
                    { id: 'Percentual', label: 'Percentual (ex: 0.1 para 10%)', type: 'number', step: '0.01', min: '0', max: '1', placeholder: '0.00' },
                    { id: 'Trib', label: 'Tributa√ß√£o', type: 'select', onChange: 'toggleAliquotaSindicato', options: [
                        { value: 'nao', text: 'Sem Tributa√ß√£o do IR' },
                        { value: 'lei', text: 'Art. 27, da Lei n¬∫ 10.833/03' },
                        { value: 'fixa', text: 'Al√≠quota Fixa' }
                    ]},
                    { id: 'aliquotaSind', label: 'Al√≠quota Fixa (ex: 0.015 para 1,5%)', type: 'number', step: '0.001', min: '0', max: '1', placeholder: '0.000', containerId: 'Container', hidden: true, semPrefixo: true }
                ]
            },
            
            herdeiro: {
                titulo: 'Herdeiro',
                prefixo: 'herd',
                campos: [
                    { id: 'Nome', label: 'Nome', type: 'text', placeholder: 'Nome do herdeiro' },
                    { id: 'Percentual', label: 'Percentual (ex: 0.1 para 10%)', type: 'number', step: '0.01', min: '0', max: '1', placeholder: '0.00' },
                    { id: 'Preferencia', label: 'Tem direito √† prefer√™ncia?', type: 'select', condicional: 'preferencia', containerId: 'Container', options: [
                        { value: 'sim', text: 'Sim' },
                        { value: 'nao', text: 'N√£o' }
                    ]}
                ]
            }
        };
        
        function criarCampo(campo, prefixo, index) {
            const id = campo.semPrefixo ? `${campo.id}${index}` : `${prefixo}${campo.id}${index}`;
            const containerId = campo.containerId ? `${campo.semPrefixo ? campo.id : prefixo + campo.id}${campo.containerId}${index}` : null;
            
            const tipoCalculo = Cache.tipoCalculo?.value;
            const mostraPreferencia = tipoCalculo === 'preferencia';
            const isCondicional = campo.condicional === 'preferencia';
            const display = (isCondicional && !mostraPreferencia) || campo.hidden ? 'display: none;' : '';
            
            let html = `<div class="input-group" ${containerId ? `id="${containerId}"` : ''} ${display ? `style="${display}"` : ''}>
                <label>${campo.label}${campo.type !== 'select' && campo.type !== 'text' ? ':' : ''}</label>`;
            
            if (campo.type === 'select') {
                const onChange = campo.onChange ? ` onchange="${campo.onChange}(${index})"` : '';
                html += `<select id="${id}"${onChange}>`;
                campo.options.forEach(opt => {
                    html += `<option value="${opt.value}"${opt.selected ? ' selected' : ''}>${opt.text}</option>`;
                });
                html += `</select>`;
            } else {
                const attrs = [];
                if (campo.step) attrs.push(`step="${campo.step}"`);
                if (campo.min) attrs.push(`min="${campo.min}"`);
                if (campo.max) attrs.push(`max="${campo.max}"`);
                if (campo.placeholder) attrs.push(`placeholder="${campo.placeholder}"`);
                
                html += `<input type="${campo.type}" id="${id}" ${attrs.join(' ')}>`;
            }
            
            html += `</div>`;
            return html;
        }

        function criarElementoGenerico(tipo, index) {
            const config = ConfigCampos[tipo];
            if (!config) return null;
            
            const div = document.createElement('div');
            div.className = 'advogado-item';
            
            let html = `<div class="advogado-header">${config.titulo} ${index + 1}</div><div class="advogado-row">`;
            
            config.campos.forEach(campo => {
                html += criarCampo(campo, config.prefixo, index);
            });
            
            html += `</div>`;
            div.innerHTML = html;
            
            const nomeInput = div.querySelector(`#${config.prefixo}Nome${index}`);
            if (nomeInput) {
                nomeInput.addEventListener('change', atualizarOpcoesCessao);
            }
            
            if (tipo === 'sindicato') {
                const tribSelect = div.querySelector(`#sindTrib${index}`);
                if (tribSelect) {
                    tribSelect.addEventListener('change', () => toggleAliquotaSindicato(index));
                }
            }
            
            return div;
        }

        function criarElementoAdvogado(index) {
            return criarElementoGenerico('advogado', index);
        }

        function criarElementoAdvogadoSucumbencial(index) {
            return criarElementoGenerico('advogadoSucumbencial', index);
        }

        function criarElementoSindicato(index) {
            return criarElementoGenerico('sindicato', index);
        }

        function criarElementoHerdeiro(index) {
            return criarElementoGenerico('herdeiro', index);
        }

        function criarElementoPagamento(index) {
            const pagDiv = document.createElement('div');
            pagDiv.className = 'advogado-item'; 
            pagDiv.innerHTML = `
                <div class="advogado-header">Pagamento ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Benefici√°rio:</label>
                        <select id="pagBeneficiario${index}">
                            <option value="">Selecione o benefici√°rio...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="pagDataBase${index}">Data do Pagamento:</label>
                        <input type="date" id="pagDataBase${index}">
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label for="pagTipoInformacao${index}">Tipo de Informa√ß√£o:</label>
                        <select id="pagTipoInformacao${index}" onchange="toggleTipoPagamento(${index})">
                            <option value="total">Informar apenas Valor Total pago</option>
                            <option value="separado">Informar Principal, Juros e SELIC separadamente</option>
                        </select>
                    </div>
                    <div class="input-group pag-campo-total-${index}" style="display: none; grid-column: span 2;">
                        <label>Valor Total Pago (R$):</label>
                        <input type="number" id="pagValorTotal${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="input-group pag-campo-total-${index}" style="display: none; grid-column: span 2; background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <small style="color: #1976d2;"><strong>‚ÑπÔ∏è C√°lculo Autom√°tico:</strong> O sistema calcular√° Principal, Juros e SELIC automaticamente.</small>
                    </div>
                    <div class="input-group pag-campo-separado-${index}">
                        <label>Valor Principal (R$):</label>
                        <input type="number" id="pagValorPrincipal${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="input-group pag-campo-separado-${index}">
                        <label>Valor Juros (R$):</label>
                        <input type="number" id="pagValorJuros${index}" step="0.01" placeholder="0,00">
                    </div>
                    <div class="valor-selic-group pag-campo-separado-${index}">
                        <label>Selic ("%"/ "R$"):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" id="pagSelicValor${index}" name="tipoSelic${index}" value="valor" checked>
                                <label for="pagSelicValor${index}">Valor em R$</label>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="radio" id="pagSelicPercentual${index}" name="tipoSelic${index}" value="percentual">
                                <label for="pagSelicPercentual${index}">Percentual (%)</label>
                            </div>
                        </div>
                        
                        <div class="selic-inputs">
                            <div class="input-group" id="pagCampoValorSelic${index}">
                                <label for="pagValorSelic${index}">Valor Selic (R$):</label>
                                <input type="number" id="pagValorSelic${index}" step="0.01" placeholder="0.00">
                            </div>
                            
                            <div class="input-group" id="pagCampoPercentualSelic${index}" style="display: none;">
                                <label for="pagPercentualSelic${index}">Percentual Selic (ex: 0.3 para 30%):</label>
                                <input type="number" id="pagPercentualSelic${index}" step="0.01" placeholder="0.00">
                            </div>

                            <div class="input-group" id="pagCampoMesReferencSelic${index}">
                                <label for="pagMesReferenciaSelic${index}">Este valor SELIC refere-se ao:</label>
                                <select id="pagMesReferenciaSelic${index}">
                                    <option value="mesAnterior">M√™s Anterior ao m√™s base</option>
                                    <option value="mesmomesBase">M√™s base</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const valorRadio = pagDiv.querySelector(`#pagSelicValor${index}`);
            const percentualRadio = pagDiv.querySelector(`#pagSelicPercentual${index}`);
            
            valorRadio.addEventListener('change', () => toggleSelicPagamento(index));
            percentualRadio.addEventListener('change', () => toggleSelicPagamento(index));

            setTimeout(() => popularBeneficiariosPagamento(index), 10);
            
            return pagDiv;
        }

        function popularBeneficiariosPagamento(index) {
            const beneficiarioSelect = document.getElementById(`pagBeneficiario${index}`);
            if (!beneficiarioSelect) return;
            
            const valorAtual = beneficiarioSelect.value;
            beneficiarioSelect.innerHTML = '<option value="">Selecione o benefici√°rio...</option>';
            
            const { advogados, advogadosSucumbenciais, herdeiros, sindicatos } = getQuantidadesCessao();
            
            const tipos = [
                { quant: 1, prefixo: '', sufixo: 'beneficiario', label: 'Benefici√°rio Principal', getId: () => document.getElementById('beneficiario')?.value?.trim() },
                { quant: advogados, prefixo: 'advNome', label: 'Advogado' },
                { quant: advogadosSucumbenciais, prefixo: 'advSucNome', label: 'Adv. Sucumbencial' },
                { quant: herdeiros, prefixo: 'herdNome', label: 'Herdeiro' },
                { quant: sindicatos, prefixo: 'sindNome', label: 'Sindicato' },
                { quant: parseInt(document.getElementById('quantCessoes')?.value) || 0, prefixo: 'cessionarioNome', label: 'Cession√°rio' }
            ];
            
            tipos.forEach(tipo => {
                for (let i = 0; i < tipo.quant; i++) {
                    const nome = tipo.getId ? tipo.getId() : document.getElementById(`${tipo.prefixo}${i}`)?.value?.trim();
                    if (nome) {
                        beneficiarioSelect.innerHTML += `<option value="${nome}">${nome} (${tipo.label})</option>`;
                    }
                }
            });
            
            if (valorAtual) beneficiarioSelect.value = valorAtual;
        }

        function criarElementosFormulario(config) {
            const { container, quantidade, criarElementoFn, callback, tipo } = config;
            
            if (!container) return;
            
            if (tipo) DadosFormulario.salvar(tipo);
            
            container.innerHTML = '';
            
            if (quantidade <= 0) {
                callback && callback();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < quantidade; i++) {
                const elemento = criarElementoFn(i);
                fragment.appendChild(elemento);
            }
            
            container.appendChild(fragment);
            
            if (tipo) {
                setTimeout(() => {
                    // Chama fun√ß√£o de restaurar gen√©rica
                    const funcaoRestaurar = `restaurar${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                    if (DadosFormulario[funcaoRestaurar]) {
                        DadosFormulario[funcaoRestaurar]();
                    }
                    
                    // Casos especiais
                    if (tipo === 'pagamentos') {
                        const quantPag = parseInt(document.getElementById('quantidadePagamentos')?.value) || 0;
                        for (let i = 0; i < quantPag; i++) {
                            toggleTipoPagamento(i);
                        }
                    }
                    
                    callback && callback();
                }, 10);
            } else {
                callback && callback();
            }
        }

        function limparFormulario() {
            ['advogados', 'advogadosSucumbenciais', 'herdeiros', 'sindicatos', 'cessoes', 'pagamentos']
            .forEach(tipo => DadosFormulario[tipo] = []);
            
            valoresPrincipais = [];
            $('listaValoresPrincipais').innerHTML = '';
            
            Cache.calculatorForm?.reset();
            
            [
                ['quantAdvogados', 'advogadosContainer'],
                ['quantAdvogadosSucumbenciais', 'advogadosSucumbenciaisContainer'],
                ['quantHerdeiros', 'herdeirosContainer'],
                ['quantSindicatos', 'sindicatosContainer'],
                ['quantCessoes', 'cessaoContainer'],
                ['quantidadePagamentos', 'pagamentosContainer']
            ].forEach(([quant, container]) => {
                const el = Cache[quant];
                const cont = Cache[container] || $(container);
                if (el) el.value = 0;
                if (cont) cont.innerHTML = '';
            });
            
            $('resultadosContent').innerHTML = 
            '<p class="loading">Execute o c√°lculo para ver os resultados aqui...</p>';
    
            [
                ['somenteHonorarioSucumbencial', false, 'checked'],
                ['houvePagamento', 'nao', 'value']
            ].forEach(([id, valor, prop]) => {
                const el = document.getElementById(id);
                if (el) el[prop] = valor;
            });
            
            limparNotasExplicativas();

            showTab('tab1');
            toggleAbaAcordo();
            toggleAbaPagamento();

            $('tipoCalculo').dispatchEvent(new Event('change'));
        }

        // ====================================
        // CESSAO
        // ====================================

        function getQuantidadesCessao() {
            return {
                advogados: parseInt(Cache.quantAdvogados?.value) || 0,
                advogadosSucumbenciais: parseInt(Cache.quantAdvogadosSucumbenciais?.value) || 0,
                herdeiros: parseInt(Cache.quantHerdeiros?.value) || 0,
                sindicatos: parseInt(Cache.quantSindicatos?.value) || 0,
                cessoes: parseInt(Cache.quantCessoes?.value) || 0
            };
        }

        function criarCessoes(quant) {
            const container = $('cessaoContainer');
            if (!container) return;
                
            DadosFormulario.salvarCessoes();
            container.innerHTML = '';
            
            const { advogados, advogadosSucumbenciais, herdeiros, sindicatos } = getQuantidadesCessao();
            const opcoesTipo = criarOpcoesTipoCessao(advogados,advogadosSucumbenciais, herdeiros, sindicatos);
            const temUnicaOpcao = opcoesTipo.split('<option').length === 3;
            
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < quant; i++) {
                fragment.appendChild(criarElementoCessao(i, opcoesTipo));
            }
            container.appendChild(fragment);
            
            setTimeout(() => {
                if (DadosFormulario.cessoes.length > 0) {
                    DadosFormulario.restaurarCessoes();
                }
                
                for (let i = 0; i < quant; i++) {
                    const cessaoTipo = $(`cessaoTipo${i}`);
                    const cedenteSelect = $(`cedenteNome${i}`);
                    
                    if (i >= DadosFormulario.cessoes.length) {
                        if (temUnicaOpcao && cessaoTipo) {
                            cessaoTipo.value = 'cessaobenPrincipal';
                            atualizarCedentes(i);
                        }
                    } 
                    else if (cessaoTipo?.value && cedenteSelect) {
                        if (!cedenteSelect.value || cedenteSelect.value === '' || 
                            cedenteSelect.options[cedenteSelect.selectedIndex]?.text.includes('Selecione')) {
                            atualizarCedentes(i);
                        }
                    }
                }
            }, 20);
        }

        function criarElementoCessao(index, opcoesTipo) {
            const cessaoDiv = document.createElement('div');
            cessaoDiv.className = 'advogado-item';
            
            cessaoDiv.innerHTML = `
                <div class="advogado-header">Cession√°rio ${index + 1}</div>
                <div class="advogado-row">
                    <div class="input-group">
                        <label>Tipo de Cess√£o:</label>
                        <select id="cessaoTipo${index}" onchange="atualizarCedentes(${index})">
                            ${opcoesTipo}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cedente ${index + 1}:</label>
                        <select id="cedenteNome${index}">
                            <option value="">Selecione primeiro o tipo de cess√£o</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cession√°rio ${index + 1}:</label>
                        <input type="text" id="cessionarioNome${index}" placeholder="Nome do Cession√°rio">
                    </div>
                    <div class="input-group">
                        <label>Percentual Cedido (ex: 0.1 para 10%):</label>
                        <input type="number" id="cessaoPercentual${index}" step="0.01" min="0" max="1" placeholder="0.00">
                    </div>
                </div>
            `;
            
            return cessaoDiv;
        }

        function criarOpcoesTipoCessao(quantAdvogados,quantAdvogadosSucumbenciais, quantHerdeiros, quantSindicatos) {
            if (quantAdvogados === undefined) {
                const q = getQuantidadesCessao();
                quantAdvogados = q.advogados;
                quantAdvogadosSucumbenciais = q.advogadosSucumbenciais;
                quantHerdeiros = q.herdeiros;
                quantSindicatos = q.sindicatos;
            }
            
            const opcoes = [['cessaobenPrincipal', 'Do Benefici√°rio Principal', true]];
            const tiposDisponiveis = [
                ['cessaoAdv', 'Do Advogado', quantAdvogados > 0],
                ['cessaoAdvSuc', 'Do Advogado Sucumbencial', quantAdvogadosSucumbenciais > 0],
                ['cessaoherdeiro', 'Do Herdeiro', quantHerdeiros > 0],
                ['cessaoSindicato', 'Do Sindicato', quantSindicatos > 0]
            ];
            
            tiposDisponiveis.forEach(([valor, texto, condicao]) => {
                if (condicao) opcoes.push([valor, texto]);
            });
            
            return opcoes.map(([valor, texto]) => `<option value="${valor}">${texto}</option>`).join('');
        }

        function criarOpcoesCedente(tipoCessao, index) {
            const campobeneficiario = Cache.beneficiario?.value.trim();
            const beneficiarioPrincipal = campobeneficiario || 'Benefici√°rio Principal';
            const { advogados, advogadosSucumbenciais, herdeiros, sindicatos } = getQuantidadesCessao();
            
            const opcoes = ['<option value="">Selecione o cedente</option>'];
            
            const configTipos = {
                'cessaobenPrincipal': {
                    opcoes: [[beneficiarioPrincipal, beneficiarioPrincipal]]
                },
                'cessaoAdv': {
                    quant: advogados,
                    prefixo: 'advNome',
                    label: 'Advogado'
                },
                'cessaoAdvSuc': {
                    quant: advogadosSucumbenciais,
                    prefixo: 'advSucNome',
                    label: 'Adv. Sucumbencial'
                },
                'cessaoherdeiro': {
                    quant: herdeiros,
                    prefixo: 'herdNome',
                    label: 'Herdeiro',
                    fallback: herdeiros === 0 ? [[beneficiarioPrincipal, beneficiarioPrincipal]] : null
                },
                'cessaoSindicato': {
                    quant: sindicatos,
                    prefixo: 'sindNome',
                    label: 'Sindicato'
                }
            };
            
            const config = configTipos[tipoCessao];
            if (!config) return opcoes.join('');
            
            if (config.opcoes) {
                config.opcoes.forEach(([valor, texto]) => {
                    opcoes.push(`<option value="${valor}">${texto}</option>`);
                });
            }else if (config.fallback) {
                config.fallback.forEach(([valor, texto]) => {
                    opcoes.push(`<option value="${valor}">${texto}</option>`);
                });
            }else if (config.quant > 0) {
                for (let i = 0; i < config.quant; i++) {
                    const nome = document.getElementById(`${config.prefixo}${i}`)?.value.trim() || 
                                `${config.label} ${i + 1}`;
                    opcoes.push(`<option value="${nome}">${nome}</option>`);
                }
            }
            
            return opcoes.join('');
        }

        function atualizarCedentes(index) {
            const tipoCessao = $(`cessaoTipo${index}`)?.value;
            const cedenteSelect = $(`cedenteNome${index}`);
            
            if (tipoCessao && cedenteSelect) {
                cedenteSelect.innerHTML = criarOpcoesCedente(tipoCessao, index);
                
                const opcoes = cedenteSelect.querySelectorAll('option');
                if (opcoes.length === 2) cedenteSelect.selectedIndex = 1;
            }
        }

        function atualizarOpcoesCessao() {
            const { cessoes } = getQuantidadesCessao();
            
            if (cessoes > 0) {
                DadosFormulario.salvarCessoes();
                
                requestAnimationFrame(() => {
                    for (let i = 0; i < cessoes; i++) {
                        const cessaoTipo = document.getElementById(`cessaoTipo${i}`);
                        if (cessaoTipo?.value) {
                            const cedenteAtual = document.getElementById(`cedenteNome${i}`)?.value;
                            atualizarCedentes(i);
                            
                            // Restaurar cedente se ainda existir
                            setTimeout(() => {
                                const cedenteSelect = document.getElementById(`cedenteNome${i}`);
                                if (cedenteSelect && cedenteAtual) {
                                    const opcoes = Array.from(cedenteSelect.options);
                                    if (opcoes.some(opt => opt.value === cedenteAtual)) {
                                        cedenteSelect.value = cedenteAtual;
                                    }
                                }
                            }, 10);
                        }
                    }
                });
            }
            
            atualizarTodosBeneficiariosPagamentos();
        }

        function atualizarTodosBeneficiariosPagamentos() {
            const quantPagamentos = parseInt(Cache.quantidadePagamentos?.value) || 0;
            for (let i = 0; i < quantPagamentos; i++) {
                popularBeneficiariosPagamento(i);
            }
        }

        function atualizarTodosCedentes() {
            const { cessoes } = getQuantidadesCessao();
            for (let i = 0; i < cessoes; i++) {
                const cessaoTipoElement = document.getElementById(`cessaoTipo${i}`);
                if (cessaoTipoElement?.value) atualizarCedentes(i);
            }
        }

        // ====================================
        // Acordo
        // ====================================

        function atualizarAdesaoAcordo() {
            const container = document.getElementById('acordoContainer');
            if (!container) return;

            DadosFormulario.salvarTodos();

            const beneficiario = Cache.beneficiario?.value.trim() || 'Benefici√°rio Principal';
            const { advogados, advogadosSucumbenciais, herdeiros, sindicatos, cessoes } = getQuantidadesCessao();

            let html = '';

            // Benefici√°rio Principal - APENAS se N√ÉO houver herdeiros (pessoa ainda viva)
            if (herdeiros === 0) {
                html += criarItemAcordo('beneficiario', beneficiario, 'Benefici√°rio Principal');
            }

            const tiposConfig = [
                { 
                    quant: advogados, 
                    dados: DadosFormulario.advogados, 
                    prefixo: 'advogado', 
                    label: 'Advogado Contratual',
                    labelPadrao: 'Advogado'
                },
                { 
                    quant: advogadosSucumbenciais, 
                    dados: DadosFormulario.advogadosSucumbenciais, 
                    prefixo: 'advogadoSucumbencial', 
                    label: 'Adv. Sucumbencial',
                    labelPadrao: 'Adv. Sucumbencial'
                },
                { 
                    quant: herdeiros, 
                    dados: DadosFormulario.herdeiros, 
                    prefixo: 'herdeiro', 
                    label: 'Herdeiro',
                    labelPadrao: 'Herdeiro'
                },
                { 
                    quant: sindicatos, 
                    dados: DadosFormulario.sindicatos, 
                    prefixo: 'sindicato', 
                    label: 'Sindicato',
                    labelPadrao: 'Sindicato'
                }
            ];

            tiposConfig.forEach(({ quant, dados, prefixo, label, labelPadrao }) => {
                for (let i = 0; i < quant; i++) {
                    const nome = dados[i]?.nome?.trim() || `${labelPadrao} ${i + 1}`;
                    html += criarItemAcordo(`${prefixo}_${i}`, nome, label);
                }
            });

            const tiposCessaoTexto = {
                'cessaobenPrincipal': (cedente) => `Cession√°rio do ${cedente}`,
                'cessaoAdv': (cedente) => `Cession√°rio do Advogado ${cedente}`,
                'cessaoAdvSuc': (cedente) => `Cession√°rio do Advogado Sucumbencial ${cedente}`,
                'cessaoherdeiro': (cedente) => `Cession√°rio do Herdeiro ${cedente}`,
                'cessaoSindicato': (cedente) => `Cession√°rio do Sindicato ${cedente}`
            };

            for (let i = 0; i < cessoes; i++) {
                const cessao = DadosFormulario.cessoes[i];
                if (cessao?.cessionario?.trim()) {
                    const nomeCessionario = cessao.cessionario.trim();
                    const nomeCedente = cessao.cedente?.trim() || 'Desconhecido';
                    const tipoTexto = tiposCessaoTexto[cessao.tipo] 
                        ? tiposCessaoTexto[cessao.tipo](nomeCedente)
                        : `Cession√°rio de ${nomeCedente}`;
                    
                    html += criarItemAcordo(`cessionario_${i}`, nomeCessionario, tipoTexto);
                }
            }

            container.innerHTML = html || '<p class="loading">Nenhuma pessoa/entidade cadastrada para aderir ao acordo.</p>';
        }

        function criarItemAcordo(id, nome, tipo) {
            return `
                <div class="acordo-item" id="acordo_${id}">
                    <input type="checkbox" class="acordo-checkbox" id="check_${id}" onchange="toggleAcordoItem('${id}')">
                    <div class="acordo-info">
                        <div class="acordo-name">${nome}</div>
                        <div class="acordo-details">${tipo}</div>
                    </div>
                </div>
            `;
        }

        function toggleAcordoItem(id) {
            const checkbox = $(`check_${id}`);
            const item = $(`acordo_${id}`);
            
            if (checkbox && item) {
                item.classList.toggle('selected', checkbox.checked);
            }
        }

        function obterAdesaoAcordo() {
            const adesoes = {
                beneficiario: false,
                advogados: [],
                advogadosSucumbenciais: [],
                herdeiros: [],
                sindicatos: [],
                cessionarios: []
            };

            if ($('check_beneficiario')?.checked) {
                adesoes.beneficiario = true;
            }

            const tiposVerificacao = [
                { quant: parseInt(Cache.quantAdvogados?.value) || 0, prefixo: 'advogado', array: 'advogados' },
                { quant: parseInt(Cache.quantAdvogadosSucumbenciais?.value) || 0, prefixo: 'advogadoSucumbencial', array: 'advogadosSucumbenciais' },
                { quant: parseInt(Cache.quantHerdeiros?.value) || 0, prefixo: 'herdeiro', array: 'herdeiros' },
                { quant: parseInt(Cache.quantSindicatos?.value) || 0, prefixo: 'sindicato', array: 'sindicatos' },
                { quant: parseInt(Cache.quantCessoes?.value) || 0, prefixo: 'cessionario', array: 'cessionarios' }
            ];

            tiposVerificacao.forEach(({ quant, prefixo, array }) => {
                for (let i = 0; i < quant; i++) {
                    if ($(`check_${prefixo}_${i}`)?.checked) {
                        adesoes[array].push(i);
                    }
                }
            });

            return adesoes;
        }

        // ====================================
        // Coleta de dados e dados
        // ====================================

        function coletarDados() {
            const dados = {
                numProcesso: Cache.getValue('numprocesso', 'Processo'),
                anoOrcamento: Cache.getValue('anoOrcamento', 2026, parseInt),
                beneficiario: Cache.getValue('beneficiario', 'Beneficiario'),
                tipoBeneficiario: Cache.getValue('tipoBeneficiario', 'pf'),
                credor: Cache.getValue('credor', 'Devedor'),
                natureza: Cache.getValue('natureza'),
                tipoCalculo: Cache.getValue('tipoCalculo'),

                somenteHonorarioSucumbencial: document.getElementById('somenteHonorarioSucumbencial')?.checked || false,
                
                valoresPrincipais: valoresPrincipais.map(valor => ({
                    ...valor,
                    valorPrincipal: parseFloat(valor.valorPrincipal) || 0,
                    valorJuros: parseFloat(valor.valorJuros) || 0,
                    valorSelic: parseFloat(valor.valorSelic) || 0,
                    percentualSelic: parseFloat(valor.percentualSelic) || 0,
                    tipoSelic: valor.tipoSelic || 'valor',
                    tributacao: {
                        ...valor.tributacao,
                        rra: parseFloat(valor.tributacao.rra) || 0,
                        aliquotaFixa: parseFloat(valor.tributacao.aliquotaFixa) || 0
                    }
                })),
                
                // Quantidades
                quantAdvogados: Cache.getValue('quantAdvogados', 0, parseInt),
                quantAdvogadosSucumbenciais: Cache.getValue('quantAdvogadosSucumbenciais', 0, parseInt), 
                quantHerdeiros: Cache.getValue('quantHerdeiros', 0, parseInt),
                quantSindicatos: Cache.getValue('quantSindicatos', 0, parseInt),
                quantCessoes: Cache.getValue('quantCessoes', 0, parseInt),
                quantidadePagamentos: Cache.getValue('quantidadePagamentos', 0, parseInt), 
                
                advogados: [],
                herdeiros: [],
                sindicatos: [],
                cessoes: [],
                pagamentos: []
            };
            
            const camposCondicionais = {
                'preferencia': ['tetoPreferenciaPrincipal', 'tetoPreferencia', 0],
                'acordo': ['percentualAcordoValor', 'percentualAcordo', 0],
                'parcial': ['saldoParcialValor', 'saldoParcial', 0]
            };

            const condicional = camposCondicionais[dados.tipoCalculo];
            if (condicional) {
                const [campoId, propriedade, valorPadrao] = condicional;
                dados[propriedade] = Cache.getValue(campoId, valorPadrao, parseFloat);
            }
            
            
            coletarAdvogados(dados);
            coletarHonorarioSucumbencial(dados);
            coletarHerdeiros(dados);
            coletarSindicatos(dados);
            coletarCessoes(dados);
            coletarPagamentos(dados);
            
            return dados;
        }

        function coletarAdvogados(dados) {
            for (let i = 0; i < dados.quantAdvogados; i++) {
                dados.advogados.push({
                    nome: $(`advNome${i}`)?.value || '',
                    tipo: $(`advTipo${i}`)?.value || '',
                    incidenciaIR: $(`advIncidenciaIR${i}`)?.value === 'sim',
                    percentual: parseFloat($(`advPercentual${i}`)?.value) || 0
                });
            }
        }

        function coletarHonorarioSucumbencial(dados) {
            const quantAdvogados = dados.quantAdvogadosSucumbenciais;
            
            dados.honorarioSucumbencial = {
                somenteHonorarioSucumbencial: dados.somenteHonorarioSucumbencial,
                advogados: []
            };
            
            for (let i = 0; i < quantAdvogados; i++) {
                const advogado = {
                    nome: $(`advSucNome${i}`)?.value || `Advogado Sucumbencial ${i + 1}`,
                    tipo: $(`advSucTipo${i}`)?.value || 'PF',
                    incidenciaIR: $(`advSucIncidenciaIR${i}`)?.value === 'sim',
                    tipoHonorario: $(`advSucTipoHonorario${i}`)?.value || 'percentual',
                    preferencia: $(`advSucTemPreferencia${i}`)?.value === 'sim'
                };
                
                // Adicionar percentual se for tipo percentual
                if (advogado.tipoHonorario === 'percentual') {
                    advogado.percentual = parseFloat($(`advSucPercentual${i}`)?.value) || 0;
                }
                
                dados.honorarioSucumbencial.advogados.push(advogado);
            }
        }

        function coletarHerdeiros(dados) {
            for (let i = 0; i < dados.quantHerdeiros; i++) {
                dados.herdeiros.push({
                    nome: $(`herdNome${i}`)?.value || `Herdeiro ${i + 1}`,
                    percentual: parseFloat($(`herdPercentual${i}`)?.value) || 0,
                    temPreferencia: $(`herdPreferencia${i}`)?.value === 'sim'
                });
            }
        }

        function coletarSindicatos(dados) {
            for (let i = 0; i < dados.quantSindicatos; i++) {
                const tributacao = $(`sindTrib${i}`)?.value;
                
                const aliquotasMap = {
                    'nao': 1,      // 100% - sem tributa√ß√£o
                    'lei': 0.03,   // 3% - Art. 27, da Lei n¬∫ 10.833/03
                    'fixa': parseFloat($(`aliquotaSind${i}`)?.value) || 0
                };
                
                dados.sindicatos.push({
                    nome: $(`sindNome${i}`)?.value || `Sindicato ${i + 1}`,
                    percentual: parseFloat($(`sindPercentual${i}`)?.value) || 0,
                    tributacao,
                    aliquotaTributacao: aliquotasMap[tributacao] || 0
                });
            }
        }

        function coletarCessoes(dados) {
            for (let i = 0; i < dados.quantCessoes; i++) {
                const tipo = $(`cessaoTipo${i}`)?.value;
                const cedente = $(`cedenteNome${i}`)?.value;
                
                if (tipo && cedente) {
                    dados.cessoes.push({
                        tipo,
                        cedente,
                        cessionario: $(`cessionarioNome${i}`)?.value || `Cession√°rio ${i + 1}`,
                        percentual: parseFloat($(`cessaoPercentual${i}`)?.value) || 0
                    });
                }
            }
        }

        function coletarPagamentos(dados) {
            dados.pagamentos = [];
            
            for (let i = 0; i < dados.quantidadePagamentos; i++) {
                const beneficiario = $(`pagBeneficiario${i}`)?.value?.trim();
                const dataBase = $(`pagDataBase${i}`)?.value;
                const tipoInformacao = $(`pagTipoInformacao${i}`)?.value || 'separado';
                
                if (!beneficiario || !dataBase) continue;
                
                const pagamento = { beneficiario, dataBase, tipoInformacao };
                
                if (tipoInformacao === 'total') {
                    const valorTotal = $(`pagValorTotal${i}`)?.value;
                    if (!valorTotal || parseFloat(valorTotal) <= 0) continue;
                    pagamento.valorTotal = parseFloat(valorTotal);                    
                } else {
                    const valorPrincipal = parseFloat($(`pagValorPrincipal${i}`)?.value) || 0;
                    const valorJuros = parseFloat($(`pagValorJuros${i}`)?.value) || 0;
                    
                    if (valorPrincipal === 0 && valorJuros === 0) continue;
                    
                    const selicValorRadio = $(`pagSelicValor${i}`);

                    pagamento.valorPrincipal = valorPrincipal;
                    pagamento.valorJuros = valorJuros;
                    pagamento.tipoSelic = selicValorRadio?.checked ? 'valor' : 'percentual';
                    pagamento.valorSelic = parseFloat($(`pagValorSelic${i}`)?.value) || 0;
                    pagamento.percentualSelic = parseFloat($(`pagPercentualSelic${i}`)?.value) || 0;
                    pagamento.selicReferencia = $(`pagMesReferenciaSelic${i}`)?.value || 'mesAnterior';
                }
                
                dados.pagamentos.push(pagamento);
            }
            
            dados.quantidadePagamentos = dados.pagamentos.length; 
        }

        // ====================================
        // Validacao de dados
        // ====================================

        function validarDados(dados) {
            const erros = [];
            
            if (dados.herdeiros.length > 0) {
                const somaHerdeiros = dados.herdeiros.reduce((sum, h) => sum + h.percentual, 0);
                if (Math.abs(somaHerdeiros - 1.0) > 0.001) {
                    erros.push(`A soma dos percentuais dos herdeiros deve ser 100% (atual: ${(somaHerdeiros * 100).toFixed(2)}%)`);
                }
            }

            if (dados.tipoCalculo === 'acordo') {
                const adesoes = obterAdesaoAcordo();
                
                const temAdesao = adesoes.beneficiario || 
                        Object.values(adesoes).some(arr => Array.isArray(arr) && arr.length > 0);
                
                if (!temAdesao) {
                    erros.push("Para c√°lculo de acordo, pelo menos 1 pessoa/entidade deve aderir ao acordo. V√° para a aba 'Ades√£o ao Acordo' e selecione quem aderiu.");
                }
            }
            
            validarCessoes(dados, erros);
            
            return erros;
        }

        function validarCessoes(dados, erros) {
            // Criar mapas de nomes para valida√ß√£o r√°pida
            const mapas = {
                'cessaobenPrincipal': new Set([dados.beneficiario.trim(), 'Benefici√°rio Principal']),
                'cessaoAdv': new Set(dados.advogados.map(adv => adv.nome)),
                'cessaoAdvSuc': new Set(dados.honorarioSucumbencial?.advogados.map(adv => adv.nome) || []),
                'cessaoherdeiro': new Set(dados.herdeiros.map(h => h.nome)),
                'cessaoSindicato': new Set(dados.sindicatos.map(s => s.nome))
            };
            
            dados.cessoes.forEach((cessao, i) => {
                // Validar percentual
                if (cessao.percentual > 1.0) {
                    erros.push(`Cess√£o ${i + 1}: Percentual n√£o pode ser maior que 100%`);
                }
                
                // Validar se cedente existe
                const cedenteExiste = mapas[cessao.tipo]?.has(cessao.cedente.trim());
                if (!cedenteExiste) {
                    erros.push(`Cess√£o ${i + 1}: Cedente "${cessao.cedente}" n√£o encontrado`);
                }
            });
        }
        
        const meses = {
            "janeiro": 1, "fevereiro": 2, "mar√ßo": 3, "abril": 4,
            "maio": 5, "junho": 6, "julho": 7, "agosto": 8,
            "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12
        };

        // ====================================
        // Indices
        // ====================================

        // √çndices CNJ
        const indicesCNJ = {
            // 1968-1969
            "julho-1968":2.3766255,"agosto-1968":2.3244716,"setembro-1968":2.2827271,"outubro-1968":2.25106,"novembro-1968":2.217677,"dezembro-1968":2.1821434,
            "janeiro-1969":2.1410981,"fevereiro-1969":2.1027271,"mar√ßo-1969":2.066267,"abril-1969":2.0375611,"maio-1969":2.0064697,"junho-1969":1.9819624,
            "julho-1969":1.9555362,"agosto-1969":1.942091,"setembro-1969":1.9278542,"outubro-1969":1.9104688,"novembro-1969":1.8798598,"dezembro-1969":1.8412823,
            
            // 1970-1971
            "janeiro-1970":1.800848,"fevereiro-1970":1.7613375,"mar√ßo-1970":1.7266451,"abril-1970":1.7073184,"maio-1970":1.6917904,"junho-1970":1.6761739,
            "julho-1970":1.6507773,"agosto-1970":1.6362565,"setembro-1970":1.6209546,"outubro-1970":1.6018885,"novembro-1970":1.5721689,"dezembro-1970":1.5394815,
            "janeiro-1971":1.5099171,"fevereiro-1971":1.4826188,"mar√ßo-1971":1.4632754,"abril-1971":1.4488205,"maio-1971":1.4322237,"junho-1971":1.4120702,
            "julho-1971":1.3846389,"agosto-1971":1.3575278,"setembro-1971":1.329601,"outubro-1971":1.301244,"novembro-1971":1.275563,"dezembro-1971":1.2549928,
            
            // 1972-1973
            "janeiro-1972":1.239693,"fevereiro-1972":1.2249585,"mar√ßo-1972":1.2088431,"abril-1972":1.1952032,"maio-1972":1.1794914,"junho-1972":1.1599378,
            "julho-1972":1.1394877,"agosto-1972":1.1233748,"setembro-1972":1.1140215,"outubro-1972":1.1061046,"novembro-1972":1.0956172,"dezembro-1972":1.0884246,
            "janeiro-1973":1.0761382,"fevereiro-1973":1.0656129,"mar√ßo-1973":1.0545619,"abril-1973":1.0420264,"maio-1973":1.0302028,"junho-1973":1.0172858,
            "julho-1973":1.0061466,"agosto-1973":0.9972007,"setembro-1973":0.9889252,"outubro-1973":0.9794005,"novembro-1973":0.9727795,"dezembro-1973":0.9645367,
            
            // 1974-1975
            "janeiro-1974":0.9459925,"fevereiro-1974":0.9361227,"mar√ßo-1974":0.9223112,"abril-1974":0.9108553,"maio-1974":0.8961917,"junho-1974":0.8775275,
            "julho-1974":0.8492863,"agosto-1974":0.8135031,"setembro-1974":0.7764805,"outubro-1974":0.7484388,"novembro-1974":0.7326216,"dezembro-1974":0.7235169,
            "janeiro-1975":0.7143679,"fevereiro-1975":0.7036899,"mar√ßo-1975":0.6921938,"abril-1975":0.6794291,"maio-1975":0.666136,"junho-1975":0.6511219,
            "julho-1975":0.6394392,"agosto-1975":0.6286861,"setembro-1975":0.6190415,"outubro-1975":0.6067296,"novembro-1975":0.5938325,"dezembro-1975":0.5824938,
            
            // 1976-1977
            "janeiro-1976":0.5719658,"fevereiro-1976":0.5611914,"mar√ßo-1976":0.5489126,"abril-1976":0.5361777,"maio-1976":0.5229782,"junho-1976":0.5078638,
            "julho-1976":0.4933112,"agosto-1976":0.4810212,"setembro-1976":0.4679752,"outubro-1976":0.4530738,"novembro-1976":0.4373045,"dezembro-1976":0.4244541,
            "janeiro-1977":0.4152786,"fevereiro-1977":0.4082102,"mar√ßo-1977":0.400325,"abril-1977":0.3914485,"maio-1977":0.3804735,"junho-1977":0.3686124,
            "julho-1977":0.3567162,"agosto-1977":0.3474371,"setembro-1977":0.3404576,"outubro-1977":0.3357513,"novembro-1977":0.331159,"dezembro-1977":0.3262852,
            
            // 1978-1979
            "janeiro-1978":0.3200147,"fevereiro-1978":0.3134001,"mar√ßo-1978":0.3063011,"abril-1978":0.2986019,"maio-1978":0.2901279,"junho-1978":0.2815487,
            "julho-1978":0.2733153,"agosto-1978":0.2651989,"setembro-1978":0.25803,"outubro-1978":0.251462,"novembro-1978":0.2456308,"dezembro-1978":0.2394985,
            "janeiro-1979":0.2333575,"fevereiro-1979":0.2282044,"mar√ßo-1979":0.2230193,"abril-1979":0.2175856,"maio-1979":0.2097292,"junho-1979":0.2020075,
            "julho-1979":0.1955035,"agosto-1979":0.190327,"setembro-1979":0.1850037,"outubro-1979":0.1778589,"novembro-1979":0.170058,"dezembro-1979":0.1627145,
            
            // 1980-1981
            "janeiro-1980":0.1563371,"fevereiro-1980":0.1500323,"mar√ßo-1980":0.1446787,"abril-1980":0.1395176,"maio-1980":0.134541,"junho-1980":0.1301177,
            "julho-1980":0.1260823,"agosto-1980":0.1221721,"setembro-1980":0.1183831,"outubro-1980":0.1149345,"novembro-1980":0.1113712,"dezembro-1980":0.1079184,
            "janeiro-1981":0.1032714,"fevereiro-1981":0.0983531,"mar√ßo-1981":0.0923506,"abril-1981":0.0868771,"maio-1981":0.0819597,"junho-1981":0.0773206,
            "julho-1981":0.072944,"agosto-1981":0.0688153,"setembro-1981":0.0650428,"outubro-1981":0.061535,"novembro-1981":0.0582165,"dezembro-1981":0.0551816,
            
            // 1982-1983
            "janeiro-1982":0.0524539,"fevereiro-1982":0.0499561,"mar√ßo-1982":0.0475773,"abril-1982":0.0453117,"maio-1982":0.0429495,"junho-1982":0.0407105,
            "julho-1982":0.0385881,"agosto-1982":0.036404,"setembro-1982":0.0340224,"outubro-1982":0.0317967,"novembro-1982":0.0297165,"dezembro-1982":0.0279028,
            "janeiro-1983":0.0261998,"fevereiro-1983":0.0247168,"mar√ßo-1983":0.0231648,"abril-1983":0.0212521,"maio-1983":0.0194973,"junho-1983":0.0180531,
            "julho-1983":0.0167468,"agosto-1983":0.0153641,"setembro-1983":0.0141604,"outubro-1983":0.0129319,"novembro-1983":0.0117884,"dezembro-1983":0.0108749,
            
            // 1984-1985
            "janeiro-1984":0.0101068,"fevereiro-1984":0.0092048,"mar√ßo-1984":0.0081966,"abril-1984":0.0074514,"maio-1984":0.0068425,"junho-1984":0.0062832,
            "julho-1984":0.0057539,"agosto-1984":0.0052166,"setembro-1984":0.0047166,"outubro-1984":0.0042684,"novembro-1984":0.0037908,"dezembro-1984":0.0034493,
            "janeiro-1985":0.0031216,"fevereiro-1985":0.0027722,"mar√ßo-1985":0.0025157,"abril-1985":0.0022322,"maio-1985":0.001996,"junho-1985":0.0018145,
            "julho-1985":0.0016615,"agosto-1985":0.0015439,"setembro-1985":0.0014272,"outubro-1985":0.0013082,"novembro-1985":0.0012001,"dezembro-1985":0.00108,
            
            // 1986-1987
            "janeiro-1986":0.0009528,"fevereiro-1986":0.0008197,"mar√ßo-1986":0.7167849,"abril-1986":0.7175942,"maio-1986":0.7120335,"junho-1986":0.7021997,
            "julho-1986":0.6933895,"agosto-1986":0.6852283,"setembro-1986":0.6739057,"outubro-1986":0.6624906,"novembro-1986":0.6501229,"dezembro-1986":0.6294125,
            "janeiro-1987":0.5867511,"fevereiro-1987":0.5022781,"mar√ßo-1987":0.4199434,"abril-1987":0.3667159,"maio-1987":0.3031719,"junho-1987":0.2455992,
            "julho-1987":0.2080982,"agosto-1987":0.201938,"setembro-1987":0.1898626,"outubro-1987":0.1796563,"novembro-1987":0.1645506,"dezembro-1987":0.1458267,
            
            // 1988-1989
            "janeiro-1988":0.1277614,"fevereiro-1988":0.1096562,"mar√ßo-1988":0.0929596,"abril-1988":0.0801306,"maio-1988":0.0671787,"junho-1988":0.0570374,
            "julho-1988":0.0477181,"agosto-1988":0.03847,"setembro-1988":0.0318829,"outubro-1988":0.02571,"novembro-1988":0.0202043,"dezembro-1988":0.0159189,
            "janeiro-1989":12.3603833,"fevereiro-1989":8.6605825,"mar√ßo-1989":7.863249,"abril-1989":7.4118151,"maio-1989":6.9071782,"junho-1989":6.2828366,
            "julho-1989":5.0329457,"agosto-1989":3.9086105,"setembro-1989":3.0220826,"outubro-1989":2.2229176,"novembro-1989":1.6152449,"dezembro-1989":1.1421578,
            
            // 1990-1991
            "janeiro-1990":0.7438344,"fevereiro-1990":0.4764825,"mar√ßo-1990":0.2757736,"abril-1990":0.1496168,"maio-1990":0.1033265,"junho-1990":0.095788,
            "julho-1990":0.0874377,"agosto-1990":0.0774333,"setembro-1990":0.0691184,"outubro-1990":0.0612969,"novembro-1990":0.053675,"dezembro-1990":0.0464397,
            "janeiro-1991":0.0392559,"fevereiro-1991":0.0327378,"mar√ßo-1991":0.0268629,"abril-1991":0.0240298,"maio-1991":0.0228833,"junho-1991":0.0214504,
            "julho-1991":0.0193544,"agosto-1991":0.0172591,"setembro-1991":0.0149274,"outubro-1991":0.0129108,"novembro-1991":0.010663,"dezembro-1991":0.0084306,
            
            // 1992-1993
            "janeiro-1992":0.0068,"fevereiro-1992":0.005414,"mar√ßo-1992":0.0042934,"abril-1992":0.0035183,"maio-1992":0.0029361,"junho-1992":0.0023784,
            "julho-1992":0.0019294,"agosto-1992":0.0015944,"setembro-1992":0.0012948,"outubro-1992":0.0010499,"novembro-1992":0.0008367,"dezembro-1992":0.0006764,
            "janeiro-1993":0.0005477,"fevereiro-1993":0.000423,"mar√ßo-1993":0.0003338,"abril-1993":0.000265,"maio-1993":0.0002081,"junho-1993":0.0001616,
            "julho-1993":0.000124,"agosto-1993":0.0948816,"setembro-1993":0.0718836,"outubro-1993":0.0534912,"novembro-1993":0.0395748,"dezembro-1993":0.0295551,
            
            // 1994-1995
            "janeiro-1994":0.0216221,"fevereiro-1994":0.0155364,"mar√ßo-1994":0.0111214,"abril-1994":0.007743,"maio-1994":0.0054818,"junho-1994":0.0038013,
            "julho-1994":7.2267421,"agosto-1994":6.8685226,"setembro-1994":6.5409759,"outubro-1994":6.4362456,"novembro-1994":6.3160917,"dezembro-1994":6.1347593,
            "janeiro-1995":5.9996804,"fevereiro-1995":5.9996804,"mar√ßo-1995":5.9996804,"abril-1995":5.7498707,"maio-1995":5.7498707,"junho-1995":5.7498707,
            "julho-1995":5.3675089,"agosto-1995":5.3675089,"setembro-1995":5.3675089,"outubro-1995":5.1056133,"novembro-1995":5.1056133,"dezembro-1995":5.1056133,
            
            // 1996-1997
            "janeiro-1996":4.8992201,"fevereiro-1996":4.8992201,"mar√ßo-1996":4.8992201,"abril-1996":4.8992201,"maio-1996":4.8992201,"junho-1996":4.8992201,
            "julho-1996":4.5891079,"agosto-1996":4.5891079,"setembro-1996":4.5891079,"outubro-1996":4.5891079,"novembro-1996":4.5891079,"dezembro-1996":4.5891079,
            "janeiro-1997":4.4576018,"fevereiro-1997":4.4576018,"mar√ßo-1997":4.4576018,"abril-1997":4.4576018,"maio-1997":4.4576018,"junho-1997":4.4576018,
            "julho-1997":4.4576018,"agosto-1997":4.4576018,"setembro-1997":4.4576018,"outubro-1997":4.4576018,"novembro-1997":4.4576018,"dezembro-1997":4.4576018,
            
            // 1998-1999
            "janeiro-1998":4.2243094,"fevereiro-1998":4.2243094,"mar√ßo-1998":4.2243094,"abril-1998":4.2243094,"maio-1998":4.2243094,"junho-1998":4.2243094,
            "julho-1998":4.2243094,"agosto-1998":4.2243094,"setembro-1998":4.2243094,"outubro-1998":4.2243094,"novembro-1998":4.2243094,"dezembro-1998":4.2243094,
            "janeiro-1999":4.1555616,"fevereiro-1999":4.1555616,"mar√ßo-1999":4.1555616,"abril-1999":4.1555616,"maio-1999":4.1555616,"junho-1999":4.1555616,
            "julho-1999":4.1555616,"agosto-1999":4.1555616,"setembro-1999":4.1555616,"outubro-1999":4.1555616,"novembro-1999":4.1555616,"dezembro-1999":4.1555616,
            
            // 2000-2001
            "janeiro-2000":3.8154156,"fevereiro-2000":3.8154156,"mar√ßo-2000":3.8154156,"abril-2000":3.8154156,"maio-2000":3.8154156,"junho-2000":3.8154156,
            "julho-2000":3.8154156,"agosto-2000":3.8154156,"setembro-2000":3.8154156,"outubro-2000":3.8154156,"novembro-2000":3.8154156,"dezembro-2000":3.8154156,
            "janeiro-2001":3.5982417,"fevereiro-2001":3.5757147,"mar√ßo-2001":3.557925,"abril-2001":3.5451624,"maio-2001":3.5275248,"junho-2001":3.5103242,
            "julho-2001":3.4970355,"agosto-2001":3.4644695,"setembro-2001":3.4240655,"outubro-2001":3.4111033,"novembro-2001":3.3985288,"dezembro-2001":3.3652132,
            
            // 2002-2003
            "janeiro-2002":3.3468057,"fevereiro-2002":3.3261834,"mar√ßo-2002":3.3116123,"abril-2002":3.2984186,"maio-2002":3.2728901,"junho-2002":3.2592014,
            "julho-2002":3.2484814,"agosto-2002":3.2236593,"setembro-2002":3.1917418,"outubro-2002":3.172075,"novembro-2002":3.1437809,"dezembro-2002":3.0797227,
            "janeiro-2003":2.9885713,"fevereiro-2003":2.9305465,"mar√ßo-2003":2.8677429,"abril-2003":2.8354191,"maio-2003":2.8034597,"junho-2003":2.7798311,
            "julho-2003":2.7737289,"agosto-2003":2.7787306,"setembro-2003":2.7712483,"outubro-2003":2.7555417,"novembro-2003":2.7374743,"dezembro-2003":2.7328285,
            
            // 2004-2005
            "janeiro-2004":2.7203151,"fevereiro-2004":2.7019419,"mar√ßo-2004":2.6778413,"abril-2004":2.6671726,"maio-2004":2.6615833,"junho-2004":2.6472879,
            "julho-2004":2.6325457,"agosto-2004":2.6082886,"setembro-2004":2.5878446,"outubro-2004":2.575226,"novembro-2004":2.5670116,"dezembro-2004":2.5509407,
            "janeiro-2005":2.5296912,"fevereiro-2005":2.5126055,"mar√ßo-2005":2.4941488,"abril-2005":2.4854498,"maio-2005":2.4671925,"junho-2005":2.4468834,
            "julho-2005":2.4439507,"agosto-2005":2.4412653,"setembro-2005":2.4344488,"outubro-2005":2.4305599,"novembro-2005":2.4170246,"dezembro-2005":2.3983177,
            
            // 2006-2007
            "janeiro-2006":2.3892386,"fevereiro-2006":2.3771153,"mar√ßo-2006":2.3648182,"abril-2006":2.3561007,"maio-2006":2.3521021,"junho-2006":2.3457685,
            "julho-2006":2.3492925,"agosto-2006":2.3497624,"setembro-2006":2.3453063,"outubro-2006":2.3441343,"novembro-2006":2.3373559,"dezembro-2006":2.3287396,
            "janeiro-2007":2.3206174,"fevereiro-2007":2.3086127,"mar√ßo-2007":2.2980417,"abril-2007":2.2886582,"maio-2007":2.2836342,"junho-2007":2.2777121,
            "julho-2007":2.2711259,"agosto-2007":2.2656882,"setembro-2007":2.2562121,"outubro-2007":2.249688,"novembro-2007":2.2443017,"dezembro-2007":2.2391516,
            
            // 2008-2009
            "janeiro-2008":2.2235865,"fevereiro-2008":2.2081296,"mar√ßo-2008":2.1940875,"abril-2008":2.1890526,"maio-2008":2.176213,"junho-2008":2.1640941,
            "julho-2008":2.1447909,"agosto-2008":2.1313634,"setembro-2008":2.1239296,"outubro-2008":2.1184217,"novembro-2008":2.1120854,"dezembro-2008":2.1017867,
            "janeiro-2009":2.0957091,"fevereiro-2009":2.0873597,"mar√ßo-2009":2.0742917,"abril-2009":2.0720124,"maio-2009":2.06458,"junho-2009":2.0524704,
            "julho-2009":2.0447005,"agosto-2009":2.0402121,"setembro-2009":2.0355303,"outubro-2009":2.0316702,"novembro-2009":2.0280197,"dezembro-2009":2.0191355,
            
            // 2010-2011
            "janeiro-2010":2.0114919,"fevereiro-2010":2.0010862,"mar√ßo-2010":1.9824512,"abril-2010":1.9716073,"maio-2010":1.9621888,"junho-2010":1.9499044,
            "julho-2010":1.9462066,"agosto-2010":1.9479598,"setembro-2010":1.9489343,"outubro-2010":1.9429112,"novembro-2010":1.9309394,"dezembro-2010":1.9144749,
            "janeiro-2011":1.9013556,"fevereiro-2011":1.8870143,"mar√ßo-2011":1.8688861,"abril-2011":1.8577396,"maio-2011":1.8435443,"junho-2011":1.8307292,
            "julho-2011":1.8265282,"agosto-2011":1.8247035,"setembro-2011":1.8197901,"outubro-2011":1.8101961,"novembro-2011":1.802625,"dezembro-2011":1.7943709,
            
            // 2012-2013
            "janeiro-2012":1.7843784,"fevereiro-2012":1.7728548,"mar√ßo-2012":1.7635083,"abril-2012":1.7591105,"maio-2012":1.7515787,"junho-2012":1.742691,
            "julho-2012":1.7395598,"agosto-2012":1.7338381,"setembro-2012":1.7271024,"outubro-2012":1.7188519,"novembro-2012":1.7077515,"dezembro-2012":1.6985792,
            "janeiro-2013":1.6869393,"fevereiro-2013":1.6722237,"mar√ßo-2013":1.6609294,"abril-2013":1.6528305,"maio-2013":1.6444439,"junho-2013":1.6369141,
            "julho-2013":1.6307174,"agosto-2013":1.6295766,"setembro-2013":1.6269735,"outubro-2013":1.6225925,"novembro-2013":1.6148413,"dezembro-2013":1.6056888,
            
            // 2014-2015
            "janeiro-2014":1.5937358,"fevereiro-2014":1.5831288,"mar√ßo-2014":1.572124,"abril-2014":1.5607306,"maio-2014":1.5486512,"junho-2014":1.5397208,
            "julho-2014":1.532518,"agosto-2014":1.5299171,"setembro-2014":1.5277782,"outubro-2014":1.521843,"novembro-2014":1.5145731,"dezembro-2014":1.5088395,
            "janeiro-2015":1.4970131,"fevereiro-2015":1.4838072,"mar√ßo-2015":1.4643316,"abril-2015":1.4463963,"maio-2015":1.4310837,"junho-2015":1.4225484,
            "julho-2015":1.4086032,"agosto-2015":1.4003412,"setembro-2015":1.3943455,"outubro-2015":1.3889287,"novembro-2015":1.3798219,"dezembro-2015":1.3681922,
            
            // 2016-2017
            "janeiro-2016":1.3522358,"fevereiro-2016":1.3399087,"mar√ßo-2016":1.3211484,"abril-2016":1.3154918,"maio-2016":1.3088168,"junho-2016":1.2976569,
            "julho-2016":1.292487,"agosto-2016":1.2855451,"setembro-2016":1.279786,"outubro-2016":1.2768493,"novembro-2016":1.2744279,"dezembro-2016":1.2711229,
            "janeiro-2017":1.2687124,"fevereiro-2017":1.2647915,"mar√ßo-2017":1.2579983,"abril-2017":1.2561142,"maio-2017":1.2534819,"junho-2017":1.2504807,
            "julho-2017":1.2484831,"agosto-2017":1.2507344,"setembro-2017":1.2463721,"outubro-2017":1.2450026,"novembro-2017":1.240784,"dezembro-2017":1.2368261,
            
            // 2018-2019
            "janeiro-2018":1.2325123,"fevereiro-2018":1.2277242,"mar√ßo-2018":1.2230765,"abril-2018":1.2218547,"maio-2018":1.2192942,"junho-2018":1.2175895,
            "julho-2018":1.2042227,"agosto-2018":1.1965646,"setembro-2018":1.1950111,"outubro-2018":1.1939366,"novembro-2018":1.1870517,"dezembro-2018":1.1848006,
            "janeiro-2019":1.1866993,"fevereiro-2019":1.1831498,"mar√ßo-2019":1.1791408,"abril-2019":1.1728076,"maio-2019":1.1644237,"junho-2019":1.1603625,
            "julho-2019":1.1596667,"agosto-2019":1.1586239,"setembro-2019":1.1576978,"outubro-2019":1.1566568,"novembro-2019":1.1556167,"dezembro-2019":1.1540011,
            
            // 2020-2021
            "janeiro-2020":1.14201,"fevereiro-2020":1.1339589,"mar√ßo-2020":1.1314697,"abril-2020":1.1312434,"maio-2020":1.1313565,"junho-2020":1.1380712,
            "julho-2020":1.1378436,"agosto-2020":1.1344403,"setembro-2020":1.1318371,"outubro-2020":1.1267666,"novembro-2020":1.1162736,"dezembro-2020":1.1073045,
            "janeiro-2021":1.0956901,"fevereiro-2021":1.0872099,"mar√ßo-2021":1.0820162,"abril-2021":1.0720462,"maio-2021":1.0656523,"junho-2021":1.060984,
            "julho-2021":1.0522503,"agosto-2021":1.0447282,"setembro-2021":1.0355122,"outubro-2021":1.0238404,"novembro-2021":1.0117,"dezembro-2021":1
        };

        function obterIndiceCNJ(mesBase, anoBase) {
            const numeroMesBase = meses[mesBase.toLowerCase()];
            // Se o per√≠odo base √© ap√≥s dezembro de 2021, n√£o h√° corre√ß√£o
            if (anoBase > 2021 || (anoBase === 2021 && numeroMesBase > 12)) {
                return 1.0000;
            }
            
            const chave = `${mesBase.toLowerCase()}-${anoBase}`;
            return indicesCNJ[chave] || 1.0000;
        }

        // ====================================
        // Juros de mora (Card. Poupan√ßa)
        // ====================================
        
        const periodosJuros = [
            [10, 1964, 12, 2002, 0.5, 0.5],
            [1, 2003, 6, 2009, 0.5, 1.0],
            [7, 2009, 5, 2012, 0.5, 0.5],
            [6, 2012, 6, 2012, 0.4828, 0.4828],
            [7, 2012, 7, 2012, 0.4973, 0.4973],
            [8, 2012, 8, 2012, 0.4675, 0.4675],
            [9, 2012, 10, 2012, 0.4273, 0.4273],
            [11, 2012, 4, 2013, 0.4134, 0.4134],
            [5, 2013, 5, 2013, 0.4273, 0.4273],
            [6, 2013, 6, 2013, 0.4551, 0.4551],
            [7, 2013, 7, 2013, 0.4761, 0.4761],
            [8, 2013, 8, 2013, 0.4828, 0.4828],
            [9, 2013, 9, 2017, 0.5, 0.5],
            [10, 2017, 10, 2017, 0.4690, 0.4690],
            [11, 2017, 12, 2017, 0.4273, 0.4273],
            [1, 2018, 2, 2018, 0.3994, 0.3994],
            [3, 2018, 3, 2018, 0.3855, 0.3855],
            [4, 2018, 7, 2019, 0.3715, 0.3715],
            [8, 2019, 9, 2019, 0.3434, 0.3434],
            [10, 2019, 10, 2019, 0.3153, 0.3153],
            [11, 2019, 12, 2019, 0.2871, 0.2871],
            [1, 2020, 2, 2020, 0.2588, 0.2588],
            [3, 2020, 3, 2020, 0.2446, 0.2446],
            [4, 2020, 5, 2020, 0.2162, 0.2162],
            [6, 2020, 6, 2020, 0.1733, 0.1733],
            [7, 2020, 8, 2020, 0.1303, 0.1303],
            [9, 2020, 3, 2021, 0.1159, 0.1159],
            [4, 2021, 5, 2021, 0.1590, 0.1590],
            [6, 2021, 6, 2021, 0.2019, 0.2019],
            [7, 2021, 8, 2021, 0.2446, 0.2446],
            [9, 2021, 9, 2021, 0.3012, 0.3012],
            [10, 2021, 10, 2021, 0.3575, 0.3575],
            [11, 2021, 11, 2021, 0.4412, 0.4412]
        ];

        function calcularPeriodoGraca(anoOrcamento) {
            let inicioGraca;
            if (anoOrcamento <= 2022) {
                // Julho do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 6, 1); // Julho
            } else if (anoOrcamento >= 2023 && anoOrcamento <= 2026) {
                // Abril do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 3, 1); // Abril
            } else { // anoOrcamento >= 2027
                // Fevereiro do ano anterior
                inicioGraca = new Date(anoOrcamento - 1, 1, 1); // Fevereiro
            }
            const fimGraca = new Date(anoOrcamento, 11, 31);
            return { inicioGraca, fimGraca };
        }
        
        function criarDataBase(mesBase, anoBase) {
            const numeroMes = meses[mesBase.toLowerCase()];
            return new Date(anoBase, numeroMes - 1, 1);
        }

        function obterTaxaJuros(mes, ano, natureza) {
            const dataConsulta = new Date(ano, mes - 1, 1);
            for (const periodo of periodosJuros) {
                const [mesInicio, anoInicio, mesFim, anoFim, juroAlimentar, juroComum] = periodo;
                const dataInicio = new Date(anoInicio, mesInicio - 1, 1);
                const dataFim = new Date(anoFim, mesFim - 1, 1);
                if (dataConsulta >= dataInicio && dataConsulta <= dataFim) {
                    return natureza === 'alimentar' ? juroAlimentar : juroComum;
                }
            }
            return 0;
        }
        
        function estaNoPeriodoGraca(data, inicioGraca, fimGraca) {
            return data >= inicioGraca && data <= fimGraca;
        }

        function gerarMesesEntreDatas(dataInicio, dataFim) {
            const meses = [];
            const atual = new Date(dataInicio);
            while (atual <= dataFim) {
                meses.push({
                    mes: atual.getMonth() + 1,
                    ano: atual.getFullYear(),
                    data: new Date(atual)
                });
                atual.setMonth(atual.getMonth() + 1);
            }
            return meses;
        }

        function calcularSomaJurosMora(mesBase, anoBase, natureza, inicioGraca = null, fimGraca = null) {
            const dataBase = criarDataBase(mesBase, anoBase);
            const dataLimite = new Date(2021, 10, 1); // Novembro/2021 (m√™s 10)
            if (dataBase > dataLimite) {
                return 0; // Fora do per√≠odo, sem juros
            }
            const mesesCalculo = gerarMesesEntreDatas(dataBase, dataLimite);
            let somaJuros = 0;
            for (const mesInfo of mesesCalculo) {
                const { mes, ano, data } = mesInfo;
                const estaGraca = inicioGraca && fimGraca && estaNoPeriodoGraca(data, inicioGraca, fimGraca);
                if (estaGraca) continue;
                const taxa = obterTaxaJuros(mes, ano, natureza);
                somaJuros += taxa;
            }
            return somaJuros;
        }

        // ====================================
        // Selic
        // ====================================

        const hoje = new Date().toISOString().split('T')[0];
        $("dataatualizacao").value = hoje;

        async function calcularSelic(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataReferencia = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));

                const primeiroDiaMesAtual = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                
                // ‚ö†Ô∏è LIMITAR at√© 31/07/2025 para SELIC antiga
                const dataLimite31Jul2025 = new Date(2025, 6, 31);
                const dataFinalSelic = ultimoDiaMesAnterior < dataLimite31Jul2025 ? ultimoDiaMesAnterior : dataLimite31Jul2025;
                
                const dataFinal = dataFinalSelic.toLocaleDateString('pt-BR');
                
                const urlselic = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                
                const response = await fetch(urlselic);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosselic = await response.json();
                
                return processarDadosSelic(dadosselic, dataBase, inicioGraca, fimGraca);
                
            } catch (error) {
                console.error(`Erro ao obter dados da SELIC: ${error}`);
            }
        }

        function processarDadosSelic(dadosselic, dataBase, inicioGraca, fimGraca) {
            function strParaData(dataStr) {
                const [dia, mes, ano] = dataStr.split('/');
                return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            }
            
            // Aplica SELIC antes do in√≠cio da gra√ßa
            let selicAntesGraca = [];
            let periodoAntesGraca = '';
            if (dataBase < inicioGraca) {
                const dadosAntesGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataBase <= dataItem && dataItem < inicioGraca;
                });
                selicAntesGraca = dadosAntesGraca.map(item => parseFloat(item.valor.replace(',', '.')));
                
                // Definir per√≠odo antes da gra√ßa
                if (dadosAntesGraca.length > 0) {
                    const primeiraData = dadosAntesGraca[0].data;
                    const ultimaData = dadosAntesGraca[dadosAntesGraca.length - 1].data;
                    periodoAntesGraca = `${primeiraData} a ${ultimaData}`;
                }
            }
            
            let dadosAposGraca = [];
            if (dataBase > fimGraca) {
                // Se dataBase √© ap√≥s a gra√ßa, aplica SELIC da dataBase at√© hoje
                dadosAposGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataItem >= dataBase;
                });
            } else {
                // Se dataBase √© antes/durante a gra√ßa, aplica SELIC ap√≥s a gra√ßa at√© hoje
                dadosAposGraca = dadosselic.filter(item => {
                    const dataItem = strParaData(item.data);
                    return dataItem > fimGraca;
                });
            }
            
            const selicAposGraca = dadosAposGraca.map(item => parseFloat(item.valor.replace(',', '.')));
            
            // Definir per√≠odo ap√≥s a gra√ßa
            let periodoAposGraca = '';
            if (dadosAposGraca.length > 0) {
                const primeiraData = dadosAposGraca[0].data;
                const ultimaData = dadosAposGraca[dadosAposGraca.length - 1].data;
                periodoAposGraca = `${primeiraData} a ${ultimaData}`;
            }
            
            // Soma da SELIC
            const somaSelicAntes = selicAntesGraca.reduce((sum, val) => sum + val, 0);
            const somaSelicApos = selicAposGraca.reduce((sum, val) => sum + val, 0);
            const somaSelic = somaSelicAntes + somaSelicApos;
            const indiceselic = 1 + (somaSelic / 100);
            const indiceSelicAntes = somaSelicAntes > 0 ? 1 + (somaSelicAntes / 100) : 1.0;
            const indiceSelicApos = somaSelicApos > 0 ? 1 + (somaSelicApos / 100) : 1.0;
            
            return {
                indiceselic,
                indiceSelicAntes,
                indiceSelicApos,
                periodoAntesGraca,
                periodoAposGraca,
                temSelicAntes: selicAntesGraca.length > 0,
                temSelicApos: selicAposGraca.length > 0
            };
        }

        // ====================================
        // IPCA-E
        // ====================================

        async function calcularIpcaE(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataReferencia = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));

                const primeiroDiaMesAtual = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                const urlipcae = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.10764/dados?formato=json&dataInicial=01/12/2021&dataFinal=${dataFinal}`;
                //10764 - IPCA.E
                const response = await fetch(urlipcae);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosipcae = await response.json();
                
                return processarDadosIpcaE(dadosipcae, dataBase, inicioGraca, fimGraca);
                
            } catch (error) {
                console.error(`Erro ao obter dados do IPCA - E: ${error}`);
            }
        }

        function processarDadosIpcaE(dadosipcae, dataBase, inicioGraca, fimGraca) {
            function strParaData(dataStr) {
                const [dia, mes, ano] = dataStr.split('/');
                return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            }
            
            let ipcaEGraca = [];
            
            if (dataBase <= fimGraca) {
                // Determina o in√≠cio efetivo: o maior entre dataBase e inicioGraca
                const inicioEfetivo = dataBase > inicioGraca ? dataBase : inicioGraca;
                
                ipcaEGraca = dadosipcae
                    .filter(item => {
                        const dataItem = strParaData(item.data);
                        return inicioEfetivo <= dataItem && dataItem <= fimGraca;
                    })
                    .map(item => parseFloat(item.valor.replace(',', '.')));
            }
            // Se dataBase > fimGraca, n√£o aplica IPCA (ipcaGraca fica vazio)
            
            let indiceipcae = 1.0;
            for (const valor of ipcaEGraca) {
                indiceipcae *= 1 + (valor / 100);
            }
            
            return indiceipcae;
        }

        // ====================================
        // IPCA
        // ====================================

        async function calcularIpca(dataBase, inicioGraca, fimGraca) {
            try {
                // Descobre a data final como o √∫ltimo dia do m√™s anterior ao m√™s atual
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataReferencia = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));

                const primeiroDiaMesAtual = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                
                // S√©rie 433 = IPCA normal (n√£o √© o IPCA-E)
                const urlipca = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json&dataInicial=01/08/2025&dataFinal=${dataFinal}`;
                
                const response = await fetch(urlipca);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const dadosipca = await response.json();
                
                return processarDadosIpca(dadosipca, dataBase, inicioGraca, fimGraca);
                
            } catch (error) {
                console.error(`Erro ao obter dados do IPCA (433): ${error}`);
                return { indiceipca: 1.0, periodo: '', temDados: false };
            }
        }

        function processarDadosIpca(dadosipca, dataBase, inicioGraca, fimGraca) {
            function strParaData(dataStr) {
                const [dia, mes, ano] = dataStr.split('/');
                return new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
            }
            
            // Data de corte: 01/08/2025
            const dataAgosto2025 = new Date(2025, 7, 1); // m√™s 7 = agosto (0-indexed)
            
            // Se n√£o temos dados ou data de atualiza√ß√£o √© antes de agosto/2025, retorna neutro
            if (!dadosipca || dadosipca.length === 0) {
                return { indiceipca: 1.0, periodo: '', temDados: false };
            }
            
            // IPCA aplica apenas de agosto/2025 em diante
            const dataInicioIPCA = dataAgosto2025;
            
            // Filtrar dados de agosto/2025 at√© a data de atualiza√ß√£o
            const dadosIPCAFiltrados = dadosipca.filter(item => {
                const dataItem = strParaData(item.data);
                return dataItem >= dataInicioIPCA;
            });
            
            const valoresIPCA = dadosIPCAFiltrados.map(item => parseFloat(item.valor.replace(',', '.')));
            
            // Calcular √≠ndice acumulado
            let indiceipca = 1.0;
            for (const valor of valoresIPCA) {
                indiceipca *= 1 + (valor / 100);
            }

            const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
            const [anoAtual, mesAtual, diaAtual] = dataAtualizacaoInput.split('-');
            const dataAtualReferencia = new Date(parseInt(anoAtual), parseInt(mesAtual) - 1, parseInt(diaAtual));
            
            // M√™s da atualiza√ß√£o - 1 (porque IPCA √© sempre do m√™s anterior)
            const mesReferencia = dataAtualReferencia.getMonth(); // 0-indexed
            const anoReferencia = dataAtualReferencia.getFullYear();

            const mesInicio = dataAgosto2025.getFullYear() * 12 + dataAgosto2025.getMonth();
            const mesFim = anoReferencia * 12 + (mesReferencia - 1); // -1 para m√™s anterior
            const quantidadeMesesReal = Math.max(0, mesFim - mesInicio + 1); // +1 porque inclui o m√™s de in√≠cio
            
            // Definir per√≠odo
            let periodo = '';
            if (dadosIPCAFiltrados.length > 0) {
                const primeiraData = dadosIPCAFiltrados[0].data;
                const ultimaData = dadosIPCAFiltrados[dadosIPCAFiltrados.length - 1].data;
                periodo = `${primeiraData} a ${ultimaData}`;
            }
            
            return {
                indiceipca,
                periodo,
                temDados: valoresIPCA.length > 0,
                quantidadeMeses: valoresIPCA.length //quantidadeMesesReal 
            };
        }

        //Juros 2% a.a

        function calcularJuros2PorcentoAA(quantidadeMeses) {
            if (!quantidadeMeses || quantidadeMeses <= 0) {
                return 0;
            }
            
            const percentual = (0.02 / 12) * quantidadeMeses;
            return percentual;
        }

        // ====================================
        // COMPARA√á√ÉO SELIC VS IPCA + 2% A.A (P√≥s agosto/2025)
        // ====================================

        async function calcularSelicPosAgosto2025() {
            try {
                const dataAgosto2025 = new Date(2025, 7, 1); // 01/08/2025
                
                // Pega a data de atualiza√ß√£o do formul√°rio
                const dataAtualizacaoInput = document.getElementById("dataatualizacao").value;
                const [ano, mes, dia] = dataAtualizacaoInput.split('-');
                const dataAtualizacao = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                
                // Se data de atualiza√ß√£o √© antes de agosto/2025, retorna neutro
                if (dataAtualizacao <= dataAgosto2025) {
                    return {
                        indiceSelecionado: 1.0,
                        tipoIndice: 'nenhum',
                        indiceSelic: 1.0,
                        indiceIpcaMais2: 1.0,
                        selicMaior: false,
                        quantidadeMeses: 0,
                        periodo: ''
                    };
                }
                
                // 1. Buscar SELIC de agosto/2025 at√© data atual
                const primeiroDiaMesAtual = new Date(dataAtualizacao.getFullYear(), dataAtualizacao.getMonth(), 1);
                const ultimoDiaMesAnterior = new Date(primeiroDiaMesAtual - 1);
                const dataFinal = ultimoDiaMesAnterior.toLocaleDateString('pt-BR');
                
                const urlselic = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados?formato=json&dataInicial=01/08/2025&dataFinal=${dataFinal}`;
                const responseSelic = await fetch(urlselic);
                
                if (!responseSelic.ok) {
                    throw new Error(`Erro ao buscar SELIC: ${responseSelic.status}`);
                }
                
                const dadosSelic = await responseSelic.json();
                
                // Calcular √≠ndice SELIC acumulado
                let indiceSelic = 1.0;
                for (const item of dadosSelic) {
                    const valor = parseFloat(item.valor.replace(',', '.'));
                    indiceSelic *= 1 + (valor / 100);
                }
                
                // 2. Buscar IPCA (433) de agosto/2025 at√© data atual
                const dadosIpca = await calcularIpca(dataAgosto2025, null, null);
                
                // 3. Calcular IPCA + Juros 2% a.a
                const juros2AA = calcularJuros2PorcentoAA(dadosIpca.quantidadeMeses);
                const indiceIpcaMais2 = dadosIpca.indiceipca * (1 + juros2AA);
                
                // 4. Comparar: SELIC > IPCA+2%?
                const selicMaior = indiceSelic > indiceIpcaMais2;
                
                // 5. Retornar o menor √≠ndice
                const indiceSelecionado = selicMaior ? indiceIpcaMais2 : indiceSelic;
                const tipoIndice = selicMaior ? 'ipca' : 'selic';
                
                // Per√≠odo
                let periodo = '';
                if (dadosSelic.length > 0) {
                    periodo = `01/08/2025 a ${dadosSelic[dadosSelic.length - 1].data}`;
                }
                
                return {
                    indiceSelecionado,      // O menor (que ser√° aplicado)
                    tipoIndice,             // 'selic' ou 'ipca'
                    indiceSelic,            // SELIC isolada
                    indiceIpcaMais2,        // IPCA + 2% a.a
                    selicMaior,             // true se SELIC > IPCA+2%
                    quantidadeMeses: dadosIpca.quantidadeMeses,
                    periodo,
                    percentualSelic: ((indiceSelic - 1) * 100).toFixed(4),
                    percentualIpcaMais2: ((indiceIpcaMais2 - 1) * 100).toFixed(4),
                    percentualJuros2AA: (juros2AA * 100).toFixed(4)
                };
                
            } catch (error) {
                console.error(`Erro em calcularSelicPosAgosto2025: ${error}`);
                return {
                    indiceSelecionado: 1.0,
                    tipoIndice: 'erro',
                    indiceSelic: 1.0,
                    indiceIpcaMais2: 1.0,
                    selicMaior: false,
                    quantidadeMeses: 0,
                    periodo: ''
                };
            }
        }

        // ====================================
        // Calculos
        // ====================================

        async function calcular() {
            if (!Cache.elementos) {
                Cache.init();
            }

            if (!valoresPrincipais || valoresPrincipais.length === 0) {
                alert("‚ö†Ô∏è Voc√™ precisa adicionar pelo menos um Valor Principal antes de calcular!");
                return;
            }
            
            const dados = coletarDados();
            const erros = validarDados(dados);
            
            if (erros.length > 0) {
                alert("Erros encontrados:\n" + erros.join("\n"));
                return;
            }
            
            const resultados = await calcularValores(dados);
            exibirResultados(resultados, dados)
        }
        
        // ====================================
        // FUN√á√ÉO DE C√ÅLCULO 
        // ====================================

        async function calcularIndicesEValores(baseData, dados, valorPrincipal, valorJuros, configIndices = {}) {
            const { inicioGraca, fimGraca } = calcularPeriodoGraca(dados.anoOrcamento);
            const { mesBase, anoBase } = baseData;
            const dataBase = criarDataBase(mesBase, anoBase);
            
            const indices = {
                cnj: 1,
                selic: 1,
                ipcae: 1,
                ipca: 1,
                jurosMora: 0
            };

            try {
                // 1. CNJ
                if (configIndices.aplicarCNJ) {
                    indices.cnj = obterIndiceCNJ(mesBase, anoBase);
                }

                // 2. Caderneta de Poupan√ßa Juros de Mora
                if (configIndices.aplicarJurosMora) {
                    indices.jurosMora = calcularSomaJurosMora(mesBase, anoBase, dados.natureza, inicioGraca, fimGraca) / 100;
                }

                // 3. IPCA-E (per√≠odo de gra√ßa)
                if (configIndices.aplicarIpcaE) {
                    try {
                        indices.ipcae = await calcularIpcaE(dataBase, inicioGraca, fimGraca);
                    } catch (error) {
                        console.error("‚ö†Ô∏è Erro ao calcular IPCA-E (usando 1.0):", error.message);
                    }
                }
                
                // 4. SELIC
                if (configIndices.aplicarSelic) {
                    const temSelicInformado = (configIndices.tipoSelic === 'valor' && configIndices.valorSelic > 0) || 
                                            (configIndices.tipoSelic === 'percentual' && configIndices.percentualSelic > 0);
                    
                    let dataInicioSelic = new Date(dataBase);
                    if (temSelicInformado && configIndices.selicReferencia !== 'mesAnterior') {
                        dataInicioSelic.setMonth(dataInicioSelic.getMonth() + 1);
                    }
                    
                    try {
                        const dadosSelicCompletos = await calcularSelic(dataInicioSelic, inicioGraca, fimGraca);
                        indices.selic = dadosSelicCompletos.indiceselic;
                        
                        // Adicionar SELIC informado
                        if (temSelicInformado) {
                            let percentualSelicAdicional = 0;
                            
                            if (configIndices.tipoSelic === 'valor' && configIndices.valorSelic > 0) {
                                const totalBase = valorPrincipal + valorJuros;
                                if (totalBase > 0) percentualSelicAdicional = configIndices.valorSelic / totalBase;
                            } else if (configIndices.tipoSelic === 'percentual') {
                                percentualSelicAdicional = configIndices.percentualSelic || 0;
                            }
                            
                            if (percentualSelicAdicional > 0) {
                                indices.selic = 1 + (indices.selic - 1) + percentualSelicAdicional;
                            }
                        }
                    } catch (error) {
                        console.error("‚ö†Ô∏è Erro ao calcular SELIC (usando 1.0):", error.message);
                    }
                }
            } catch (error) {
                console.error("‚ùå Erro geral em calcularIndicesEValores:", error);
            }
            
            // Calcular valores base
            const principalCNJ = valorPrincipal * indices.cnj;
            const jurosCNJ = valorJuros * indices.cnj;
            const valorJurosMora = principalCNJ * indices.jurosMora;
            const jurosTotal = jurosCNJ + valorJurosMora;
            const totalAntesSelic = principalCNJ + jurosTotal;
            const valorSelicSeparado = totalAntesSelic * (indices.selic - 1);
            
            // Verificar PEC
            const comparacaoSelicIpca = await calcularSelicPosAgosto2025();
            const usarLogicaPEC = comparacaoSelicIpca.quantidadeMeses > 0;
            
            // ====================================
            // SITUA√á√ÉO 1: PEC com SELIC > IPCA+2%
            // ====================================
            if (usarLogicaPEC && comparacaoSelicIpca.selicMaior) {
                const dadosIpca = await calcularIpca(dataBase, inicioGraca, fimGraca);
                const indiceIpca = dadosIpca.indiceipca;
                const percentualJuros2AA = calcularJuros2PorcentoAA(dadosIpca.quantidadeMeses);
                
                const principalComIpca = principalCNJ * indices.ipcae * indiceIpca;
                const jurosComIpca = jurosTotal * indiceIpca * indices.ipcae;
                const selicComIpca = valorSelicSeparado * indiceIpca * indices.ipcae;
                const valorJuros2AA = principalComIpca * percentualJuros2AA;
                
                const jurosFinal = jurosComIpca + valorJuros2AA;
                const totalFinal = principalComIpca + jurosFinal + selicComIpca;
                
                // Valores para tributa√ß√£o (com SELIC incorporada)
                const principalComSelicTributacao = valorPrincipal * indices.cnj * indices.ipcae * indiceIpca * indices.selic;
                const jurosOriginaisComSelic = valorJuros * indices.cnj * indices.ipcae * indiceIpca * indices.selic;
                const jurosMoraComSelic = valorJurosMora * indices.ipcae * indiceIpca * indices.selic;
                const jurosComSelicTributacao = jurosOriginaisComSelic + jurosMoraComSelic + valorJuros2AA;
                
                indices.ipca = indiceIpca;
                
                return {
                    valorPrincipalAtualizado: principalComIpca,
                    valorJurosAtualizado: jurosFinal,
                    valorSelicSeparado: selicComIpca,
                    principalTributacao: principalComSelicTributacao,
                    jurosTributacao: jurosComSelicTributacao,
                    indices: {
                        ...indices,
                        indicePrincipal: indices.cnj * indiceIpca,
                        indiceJuros: indices.cnj * indiceIpca,
                        juros2AA: percentualJuros2AA 
                    },
                    jurosMoraCalculado: valorJurosMora,
                    detalhamentoPEC: {
                        usouLogicaPEC: true,
                        selicMaior: true,
                        indiceSelic: comparacaoSelicIpca.indiceSelic,
                        indiceIpcaMais2: comparacaoSelicIpca.indiceIpcaMais2,
                        indiceIpcaPuro: indiceIpca,
                        percentualJuros2AA,
                        valorJuros2AA,
                        quantidadeMeses: comparacaoSelicIpca.quantidadeMeses
                    }
                };
            }
            
            // ====================================
            // SITUA√á√ïES 2 e 3: C√°lculo unificado
            // ====================================
            const totalComSelic = totalAntesSelic * indices.selic;
            const totalComIpcaE = totalComSelic * indices.ipcae;
            
            // Aplicar √≠ndice p√≥s-agosto se houver PEC (Situa√ß√£o 2) ou manter como est√° (Situa√ß√£o 3)
            const indiceFinal = usarLogicaPEC ? comparacaoSelicIpca.indiceSelecionado : 1;
            const totalFinal = totalComIpcaE * indiceFinal;
            
            // Proporcionalizar principal e juros
            const proporcaoPrincipal = principalCNJ / totalAntesSelic;
            const proporcaoJuros = jurosTotal / totalAntesSelic;
            
            const principalFinal = totalFinal * proporcaoPrincipal;
            const jurosFinal = totalFinal * proporcaoJuros;
            
            const indicePrincipal = indices.cnj * indices.selic * indices.ipcae * indiceFinal;
            const indiceJuros = indicePrincipal;
            
            if (usarLogicaPEC) {
                indices.ipca = comparacaoSelicIpca.indiceSelecionado;
            }
            
            return {
                valorPrincipalAtualizado: principalFinal,
                valorJurosAtualizado: jurosFinal,
                valorSelicSeparado: 0,
                principalTributacao: principalFinal,
                jurosTributacao: jurosFinal,
                indices: {
                    ...indices,
                    indicePrincipal,
                    indiceJuros
                },
                jurosMoraCalculado: valorJurosMora,
                detalhamentoPEC: usarLogicaPEC ? {
                    usouLogicaPEC: true,
                    selicMaior: false,
                    indiceSelic: comparacaoSelicIpca.indiceSelic,
                    indiceIpcaMais2: comparacaoSelicIpca.indiceIpcaMais2,
                    quantidadeMeses: comparacaoSelicIpca.quantidadeMeses
                } : {
                    usouLogicaPEC: false
                }
            };
        }

        // ====================================
        // CALCULAR ITEM PRINCIPAL 
        // ====================================

        async function calcularItemPrincipal(item, dados) {
            const configIndices = {
                aplicarCNJ: item.indices.cnj || false,
                aplicarSelic: item.indices.selic || false,
                aplicarIpcaE: item.indices.ipcae || false,
                aplicarJurosMora: item.indices.jurosMora || false,
                aplicarIpca: item.indices.ipca || false,
                tipoSelic: item.tipoSelic,
                valorSelic: item.valorSelic,
                percentualSelic: item.percentualSelic,
                selicReferencia: item.mesReferenciaSelic
            };
            
            const baseData = { mesBase: item.mesBase, anoBase: item.anoBase };
            
            const calculo = await calcularIndicesEValores(
                baseData, 
                dados, 
                item.valorPrincipal, 
                item.valorJuros, 
                configIndices
            );
            
            return {
                id: item.id,
                descricao: item.descricao,
                valorOriginal: {
                    principal: item.valorPrincipal,
                    juros: item.valorJuros,
                    total: item.valorPrincipal + item.valorJuros
                },
                valorAtualizado: {
                    principal: calculo.valorPrincipalAtualizado,
                    juros: calculo.valorJurosAtualizado,
                    selic: calculo.valorSelicSeparado || 0,  // ‚¨ÖÔ∏è NOVO
                    total: calculo.valorPrincipalAtualizado + 
                        calculo.valorJurosAtualizado + 
                        (calculo.valorSelicSeparado || 0)
                },

                valorSelicSeparado: calculo.valorSelicSeparado || 0,
                principalTributacao: calculo.principalTributacao,
                jurosTributacao: calculo.jurosTributacao,

                indices: calculo.indices,
                tributacao: item.tributacao,
                jurosMoraCalculado: calculo.jurosMoraCalculado,

                detalhamentoPEC: calculo.detalhamentoPEC
            };
        }

        // ====================================
        // TOTALIZAR ITENS TRIBUTA√á√ÉO
        // ====================================

        function totalizarTributacao(itensCalculados) {
            const totais = {
                valorPrincipalTotal: 0,
                valorJurosTotal: 0,
                valorSelicTotal: 0,  
                valorGeralTotal: 0,
                rraTotal: 0,
                principalTributadoIR: 0,
                jurosTributadoIR: 0,
                isentoIR: 0,
                principalTributadoPrevidencia: 0,
                jurosTributadoPrevidencia: 0,
                isentoPrevidencia: 0
            };
            
            for (const item of itensCalculados) {
                totais.valorPrincipalTotal += item.valorAtualizado.principal;
                totais.valorJurosTotal += item.valorAtualizado.juros;
                
                // ‚¨ÖÔ∏è SELIC separada
                const valorSelicItem = item.valorSelicSeparado || 0;
                totais.valorSelicTotal += valorSelicItem;
                
                // ‚¨ÖÔ∏è Total geral (com SELIC)
                totais.valorGeralTotal += item.valorAtualizado.principal + 
                                        item.valorAtualizado.juros + 
                                        valorSelicItem;
                
                totais.rraTotal += item.tributacao.rra || 0;
                
                // ========== TRIBUTA√á√ÉO IR ==========
                if (item.tributacao.ir) {
                    // ‚¨ÖÔ∏è USA OS VALORES DE TRIBUTA√á√ÉO (com SELIC incorporada)
                    if (item.principalTributacao !== undefined && item.jurosTributacao !== undefined) {
                        totais.principalTributadoIR += item.principalTributacao;
                        totais.jurosTributadoIR += item.jurosTributacao;
                    } else {
                        // Fallback para l√≥gica antiga (caso n√£o tenha os novos campos)
                        totais.principalTributadoIR += item.valorAtualizado.principal;
                        totais.jurosTributadoIR += item.valorAtualizado.juros;
                    }
                } else {
                    totais.isentoIR += item.valorAtualizado.principal + 
                                    item.valorAtualizado.juros + 
                                    valorSelicItem;
                }
                
                // ========== TRIBUTA√á√ÉO PREVID√äNCIA ==========
                if (item.tributacao.previdencia) {
                    totais.principalTributadoPrevidencia += item.valorAtualizado.principal;
                    totais.jurosTributadoPrevidencia += item.valorAtualizado.juros;
                } else {
                    totais.isentoPrevidencia += item.valorAtualizado.principal + 
                                                item.valorAtualizado.juros + 
                                                valorSelicItem;
                }
            }
            
            return totais;
        }

        // ====================================
        // CALCULAR PAGAMENTOS 
        // ====================================

        async function calcularPagamentos(dados) {
            if (!dados.pagamentos || dados.pagamentos.length === 0) return [];
            
            const pagamentosCalculados = [];
            
            for (let i = 0; i < dados.pagamentos.length; i++) {
                const pagamento = dados.pagamentos[i];
                
                try {
                    // Se informou apenas total, calcular componentes
                    if (pagamento.tipoInformacao === 'total') {
                        const componentes = await calcularComponentesPagamentoTotal(dados, pagamento);
                        if (!componentes) {
                            console.error(`‚ùå Erro ao calcular componentes do pagamento ${i + 1}`);
                            continue;
                        }
                        Object.assign(pagamento, componentes);
                    }
                    
                    // Converter data
                    const [ano, mes] = pagamento.dataBase.split('-');
                    const mesesNomes = ['', 'janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 
                                    'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                    const baseData = {
                        mesBase: mesesNomes[parseInt(mes)],
                        anoBase: parseInt(ano)
                    };
                    
                    // Usar fun√ß√£o gen√©rica (PAGAMENTOS SEMPRE APLICAM TODOS OS √çNDICES)
                    const configIndices = {
                        aplicarCNJ: true,        // ‚≠ê Sempre
                        aplicarSelic: true,      // ‚≠ê Sempre
                        aplicarIpcaE: true,       // ‚≠ê Sempre
                        aplicarJurosMora: true,  // ‚≠ê Sempre
                        aplicarIpca: true, // ‚≠ê Sempre
                        tipoSelic: pagamento.tipoSelic,
                        valorSelic: pagamento.valorSelic,
                        percentualSelic: pagamento.percentualSelic,
                        selicReferencia: pagamento.selicReferencia
                    };
                    
                    const calculo = await calcularIndicesEValores(
                        baseData,
                        dados,
                        pagamento.valorPrincipal,
                        pagamento.valorJuros,
                        configIndices
                    );
                    
                    pagamentosCalculados.push({
                        beneficiario: pagamento.beneficiario,
                        dataBase: pagamento.dataBase,
                        valorOriginal: {
                            principal: pagamento.valorPrincipal,
                            juros: pagamento.valorJuros,
                            total: pagamento.valorPrincipal + pagamento.valorJuros
                        },
                        valorAtualizado: {
                            principal: calculo.valorPrincipalAtualizado,
                            juros: calculo.valorJurosAtualizado,
                            selic: calculo.valorSelicSeparado || 0,
                            total: calculo.valorPrincipalAtualizado + calculo.valorJurosAtualizado  + (calculo.valorSelicSeparado || 0)
                        },

                        principalTributacao: calculo.principalTributacao,
                        jurosTributacao: calculo.jurosTributacao,
                        valorSelicSeparado: calculo.valorSelicSeparado || 0, 

                        indices: calculo.indices,
                        jurosMoraCalculado: calculo.jurosMoraCalculado,
                        selicReferencia: pagamento.selicReferencia,
                        tipoSelic: pagamento.tipoSelic
                    });
                    
                } catch (error) {
                    console.error(`Erro ao calcular pagamento ${i + 1}:`, error);
                }
            }
            
            return pagamentosCalculados;
        }

        async function calcularComponentesPagamentoTotal(dados, pagamento) {
            const campoData = document.getElementById("dataatualizacao");
            if (!campoData) {
                console.error("‚ùå Campo 'dataatualizacao' n√£o encontrado!");
                return null;
            }
            
            const dataOriginal = campoData.value;
            
            try {
                // ‚≠ê Alterar data temporariamente para calcular at√© a data do pagamento
                campoData.value = pagamento.dataBase;
                
                let valorPrincipalAtualizado = 0;
                let valorJurosAtualizado = 0;
                let percentualSelicAcumulado = 0;
                
                // Calcular cada item at√© a data do pagamento
                for (const item of dados.valoresPrincipais) {
                    try {
                        const itemCalculado = await calcularItemPrincipal(item, dados);
                        valorPrincipalAtualizado += itemCalculado.valorAtualizado.principal;
                        valorJurosAtualizado += itemCalculado.valorAtualizado.juros;

                        // ‚¨ÖÔ∏è ADICIONAR SELIC SEPARADA
                        const valorSelicItem = itemCalculado.valorSelicSeparado || 0;
                        if (valorSelicItem > 0) {
                            // Distribuir SELIC proporcionalmente entre principal e juros
                            const totalItem = itemCalculado.valorAtualizado.principal + itemCalculado.valorAtualizado.juros;
                            if (totalItem > 0) {
                                const propPrinc = itemCalculado.valorAtualizado.principal / totalItem;
                                const propJuros = itemCalculado.valorAtualizado.juros / totalItem;
                                valorPrincipalAtualizado += valorSelicItem * propPrinc;
                                valorJurosAtualizado += valorSelicItem * propJuros;
                            }
                        }

                        if (item.indices.selic && itemCalculado.indices.selic) {
                            percentualSelicAcumulado = itemCalculado.indices.selic - 1;
                        }
                    } catch (error) {
                        console.error(`‚ö†Ô∏è Erro ao calcular item ${item.id}:`, error.message);
                        // Continua com pr√≥ximo item
                    }
                }
                
                if (valorPrincipalAtualizado === 0 && valorJurosAtualizado === 0) {
                    console.error("‚ùå Nenhum item foi calculado com sucesso!");
                    return null;
                }
                
                const totalAtualizado = valorPrincipalAtualizado + valorJurosAtualizado;
                const proporcao = pagamento.valorTotal / totalAtualizado;
                
                const principalPago = valorPrincipalAtualizado * proporcao;
                const jurosPago = valorJurosAtualizado * proporcao;
                
                const indiceSelic = 1 + percentualSelicAcumulado;
                const principalSemSelic = principalPago / indiceSelic;
                const jurosSemSelic = jurosPago / indiceSelic;
                
                return {
                    valorPrincipal: principalSemSelic,
                    valorJuros: jurosSemSelic,
                    percentualSelicOriginal: percentualSelicAcumulado,
                    tipoSelic: 'percentual',
                    percentualSelic: percentualSelicAcumulado,
                    valorSelic: 0,
                    selicReferencia: 'mesAnterior'
                };
                
            } catch (error) {
                console.error("‚ùå Erro em calcularComponentesPagamentoTotal:", error);
                return null;
            } finally {
                // ‚≠ê SEMPRE restaura a data original (mesmo com erro)
                campoData.value = dataOriginal;
            }
        }

        // ====================================
        // CALCULAR VALORES 
        // ====================================

        async function calcularValores(dados) {
            if (!dados.valoresPrincipais || dados.valoresPrincipais.length === 0) {
                console.error('‚ùå Erro: Nenhum valor principal encontrado!');
                return null;
            }
            
            // 1. Calcular todos os itens
            const itensCalculados = [];
            for (const item of dados.valoresPrincipais) {
                try {
                    itensCalculados.push(await calcularItemPrincipal(item, dados));
                } catch (error) {
                    console.error(`‚ùå Erro ao calcular item ${item.descricao}:`, error);
                    throw error;
                }
            }
            
            // 2. Totalizar tributa√ß√£o
            const totais = totalizarTributacao(itensCalculados);

            // 3. Calcular totais por tipo de honor√°rio
            const totaisPorTipo = {
                contratual: 0,
                sucumbencial: 0,
                nenhum: 0,
                total: totais.valorGeralTotal
            };

            const tiposMap = {
                'contratual': ['contratual'],
                'sucumbencial': ['sucumbencial'],
                'ambos': ['contratual', 'sucumbencial'],
                'nenhum': ['nenhum']
            };

            dados.valoresPrincipais.forEach((itemOriginal, index) => {
                const itemCalculado = itensCalculados[index];
                if (!itemCalculado) return;
                
                const valorSelicItem = itemCalculado.valorSelicSeparado || 0;
                const valorAtualizado = itemCalculado.valorAtualizado.principal + 
                                        itemCalculado.valorAtualizado.juros + 
                                        valorSelicItem;
                const tipos = tiposMap[itemOriginal.tipoUsoHonorario] || [];
                
                tipos.forEach(tipo => {
                    totaisPorTipo[tipo] += valorAtualizado;
                });
            });
            
            // 4. Percentuais e √≠ndices gerais
            const percentualprinc = totais.valorPrincipalTotal / totais.valorGeralTotal;
            const percentualjur = totais.valorJurosTotal / totais.valorGeralTotal;
            const percentualselic = totais.valorSelicTotal / totais.valorGeralTotal; 

            const valorOriginalTotal = itensCalculados.reduce((sum, item) => 
                sum + item.valorOriginal.total, 0);
            const indiceTotal = totais.valorGeralTotal / valorOriginalTotal;
            
            // 5. Percentuais de tributa√ß√£o IR
            const percentualPrincipalTributadoIR = (totais.principalTributadoIR / totais.valorGeralTotal) * 100;
            const percentualJurosTributadoIR = (totais.jurosTributadoIR / totais.valorGeralTotal) * 100;
            const percentualIsentoIR = (totais.isentoIR / totais.valorGeralTotal) * 100;
            
            // 6. Dados para detalhamento
            const dadosParaDetalhamento = {
                ...dados,
                valorPrincipal: totais.valorPrincipalTotal,
                valorJuros: totais.valorJurosTotal,
                valorSelic: totais.valorSelicTotal, 
                rra: totais.rraTotal,
                incidenciaIR: dados.valoresPrincipais.some(item => item.tributacao?.ir === true),
                incidenciaPrevidencia: dados.valoresPrincipais.some(item => item.tributacao?.previdencia === true),
                tributacaoIR: {
                    principalTributado: totais.principalTributadoIR,
                    jurosTributado: totais.jurosTributadoIR,
                    isento: totais.isentoIR,
                    percentuais: {
                        principalTributado: percentualPrincipalTributadoIR,
                        jurosTributado: percentualJurosTributadoIR,
                        isento: percentualIsentoIR
                    }
                },
                tributacaoPrevidencia: {
                    principalTributado: totais.principalTributadoPrevidencia,
                    jurosTributado: totais.jurosTributadoPrevidencia,
                    isento: totais.isentoPrevidencia
                },
                totaisPorTipo
            };
            
            // 7. C√°lculos de distribui√ß√£o
            const detalhamento = calcularGlobal(dadosParaDetalhamento, totais.valorGeralTotal, percentualprinc, percentualjur,totaisPorTipo);
            const honorariosSucumbenciais = calcularHonorariosSucumbenciais(dadosParaDetalhamento, totais.valorGeralTotal, totaisPorTipo);
            const herdeiros = calcularHerdeiros(dadosParaDetalhamento, totais.valorGeralTotal, totais.valorPrincipalTotal, totais.valorJurosTotal, detalhamento,totaisPorTipo);

            // 8. Pagamentos
            const pagamentosCalculados = await calcularPagamentos(dados);
            const totalPagamentos = pagamentosCalculados.reduce((total, pag) => 
                total + pag.valorAtualizado.total, 0
            );
            
            // 9. Resultado final
            const resultadoFinal = {
                valorprincatt: totais.valorPrincipalTotal,
                valorjurosatt: totais.valorJurosTotal,
                valorSelicatt: totais.valorSelicTotal,
                valortotatt: totais.valorGeralTotal,
                
                tributacaoIR: {
                    principalTributado: totais.principalTributadoIR,
                    jurosTributado: totais.jurosTributadoIR,
                    isento: totais.isentoIR,
                    percentuais: {
                        principalTributado: percentualPrincipalTributadoIR,
                        jurosTributado: percentualJurosTributadoIR,
                        isento: percentualIsentoIR
                    }
                },
                tributacaoPrevidencia: {
                    principalTributado: totais.principalTributadoPrevidencia,
                    jurosTributado: totais.jurosTributadoPrevidencia,
                    isento: totais.isentoPrevidencia
                },
                rraTotal: totais.rraTotal,
                
                itensCalculados,
                ...detalhamento,
                
                herdeiros,
                temHerdeiros: herdeiros.length > 0,
                honorariosSucumbenciais,

                pagamentos: pagamentosCalculados,
                totalPagamentos: totalPagamentos,
                
                indiceTotal,
                percentualprinc,
                percentualjur,
                percentualselic,
                valorOriginalTotal,
                totaisPorTipo
            };
            
            // 10. Saldos finais
            resultadoFinal.saldosFinais = calcularSaldoFinalComPagamentos(resultadoFinal, pagamentosCalculados, dados);

            return resultadoFinal;
        }

        // ====================================
        // Detalhamentos
        // ====================================

        function calcularGlobal(dados, valortotatt, percentualprinc, percentualjur,totaisPorTipo = null) {
            const valorBase = calcularValorBase(dados, valortotatt, totaisPorTipo);

            const temTributacaoIR = dados.valoresPrincipais?.some(item => item.tributacao?.ir) || false;
            let principal, jurosBase;
            
            if (temTributacaoIR && dados.tributacaoIR) {
                const percentualPrincipalTributadoIR = dados.tributacaoIR.percentuais?.principalTributado || 0;
                const percentualJurosTributadoIR = dados.tributacaoIR.percentuais?.jurosTributado || 0;
                
                principal = valorBase * (percentualPrincipalTributadoIR / 100);
                jurosBase = valorBase * (percentualJurosTributadoIR / 100);
            } else {
                principal = valorBase * percentualprinc;
                jurosBase = valorBase * percentualjur;
            }

            let rrapagamento = calcularRRAPonderado(dados, valorBase, valortotatt);
            
            const cessoesBeneficiario = dados.cessoes?.filter(c => c.tipo === 'cessaobenPrincipal') || [];
            const { 
                valorBaseParaHonorarios, 
                valorBeneficiarioQueRecebeEfetivamente 
            } = calcularBasesComCessoes(dados, valorBase, valortotatt, cessoesBeneficiario);
            

            // Honor√°rios
            const { honorarios, valorHonorarioTotal } = calcularHonorarios(
                dados, 
                valorBaseParaHonorarios, 
                valortotatt, 
                totaisPorTipo
            );
            
            // Sindicatos 
            const { sindicatos, valorSindicatoTotal } = calcularSindicatos(
                dados, 
                valorBaseParaHonorarios, 
                valortotatt
            );

            const valorSindicatoParaDescontar = dados.tipoCalculo === 'preferencia' ? 0 : valorSindicatoTotal;

            // REC√ÅLCULO PARA PREFER√äNCIA E PARCIAL 
            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            const isParcial = dados.tipoCalculo === 'parcial';

            if (isPreferenciasParcial) {
                if (temTributacaoIR && dados.tributacaoIR) {
                    const percentualPrincipalTributadoIR = dados.tributacaoIR.percentuais?.principalTributado || 0;
                    principal = valorBeneficiarioQueRecebeEfetivamente * (percentualPrincipalTributadoIR / 100);
                } else {
                    principal = valorBeneficiarioQueRecebeEfetivamente * percentualprinc;
                }
                
                rrapagamento = calcularRRAPonderado(dados, valorBeneficiarioQueRecebeEfetivamente, valortotatt);
            } else if (isParcial) {
                const proporcaoParcial = valorBase / valortotatt;
                if (temTributacaoIR && dados.tributacaoIR) {
                    principal = dados.tributacaoIR.principalTributado * proporcaoParcial;
                    jurosBase = dados.tributacaoIR.jurosTributado * proporcaoParcial;
                } else {
                    principal = valorBase * percentualprinc;
                    jurosBase = valorBase * percentualjur;
                }
                
                // Recalcular RRA proporcional
                rrapagamento = calcularRRAPonderado(dados, valorBase, valortotatt);
            }

            // PREVID√äNCIA      
            const resultadoPrevidencia = calcularPrevidenciaIsolada(dados, principal, rrapagamento);
            let {
                valorPrevidencia,
                aliquotaEfetiva,
                valorDesagioPrevidencia,
                percentualDesagioPrevidencia
            } = resultadoPrevidencia;

            //Imposto de Renda
            const resultadoIR = calcularIRIsolado(dados, valortotatt, valorBase, principal, valorPrevidencia, rrapagamento);
            let {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                principalComDesagio,
                percentualDesagioIR,
                rraComDesagio,
                baseIRPrev,
                baseIRRRA,
                valorIRUnitario,
            } = resultadoIR;

            // Cess√µes
            const resultadoCessoes = calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR);
            let {
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            } = resultadoCessoes;

            return {
                // Base
                valorBase,
                principal,
                jurosBase,
                rrapagamento,
                // Honor√°rios
                honorarios,
                valorHonorarioTotal,
                // Sindicatos
                sindicatos,
                valorSindicatoTotal,
                // Previd√™ncia
                valorPrevidencia,
                aliquotaEfetiva,
                valorDesagioPrevidencia,   
                percentualDesagioPrevidencia,
                // Imposto de Renda
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                principalComDesagio,
                percentualDesagioIR,
                rraComDesagio,
                baseIRRRA,
                valorIRUnitario,
                // Benefici√°rio e Cess√µes
                valorBeneficiarioBruto: resultadoCessoes.valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioCalculadas,
                cessoesBeneficiarioFinais,
                // Flags
                isPreferenciasParcial
            };
        }

        // ====================================
        // FUN√á√ïES AUXILIARES DE CALCULAR GLOBAL
        // ====================================

        function calcularValorBase(dados, valortotatt, totaisPorTipo) {
            let valorBase = valortotatt;
            
            if (dados.tipoCalculo === 'preferencia' && dados.natureza === 'alimentar') {
                valorBase = Math.min(valortotatt, dados.tetoPreferencia);
            } else if (dados.tipoCalculo === 'parcial') {
                // Verificar se h√° honor√°rio sucumbencial
                if (dados.honorarioSucumbencial?.advogados?.length > 0) {
                    // Calcular propor√ß√£o considerando sucumbencial
                    const dadosTemporarios = { ...dados, tipoCalculo: 'ordem',saldoParcial: undefined };
                    const resultadoSucumbencial = calcularHonorariosSucumbenciais(
                        dadosTemporarios, 
                        valortotatt, 
                        totaisPorTipo
                    );
                    
                    const valorTotalSucumbencial = resultadoSucumbencial.valorHonorarioTotal;
                    const totalGeral = valortotatt + valorTotalSucumbencial;
                    
                    if (dados.saldoParcial >= totalGeral) {
                        valorBase =  valortotatt; 
                    } else {
                        const proporcaoPrecatorio = valortotatt / totalGeral;
                        valorBase = dados.saldoParcial * proporcaoPrecatorio;
                    }
                } else {
                    // Sem sucumbencial - l√≥gica simples
                    valorBase = Math.min(valortotatt, dados.saldoParcial);
                }
            }
            
            return valorBase;
        }

        function calcularRRAPonderado(dados, valorBase, valortotatt) {
            if (!dados.valoresPrincipais?.length) return 0;
            
            // Somar TODOS os RRAs dos itens
            let rraTotal = 0;
            
            for (const item of dados.valoresPrincipais) {
                const rraItem = item.tributacao?.rra || 0;
                rraTotal += rraItem;
            }
            
            if (rraTotal === 0) return 0;
            
            return arredondarRRA((valorBase * rraTotal) / valortotatt);
        }

        function calcularBasesComCessoes(dados, valorBase, valortotatt, cessoesBeneficiario) {
            let valorBaseParaHonorarios = valorBase;
            let valorBeneficiarioQueRecebeEfetivamente = valorBase;
            
            if (cessoesBeneficiario.length > 0) {
                const percentualBeneficiarioFinal = 1.0 - cessoesBeneficiario.reduce(
                    (total, cessao) => total + cessao.percentual, 
                    0
                );
                
                const direitoBeneficiarioTotal = valortotatt * percentualBeneficiarioFinal;
                
                const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
                const isParcial = dados.tipoCalculo === 'parcial';
                
                valorBeneficiarioQueRecebeEfetivamente = isPreferenciasParcial 
                    ? Math.min(direitoBeneficiarioTotal, valorBase) 
                    : direitoBeneficiarioTotal;
                
                if (isPreferenciasParcial) {
                    valorBaseParaHonorarios = valorBeneficiarioQueRecebeEfetivamente;
                } else {
                    // Ordem cronol√≥gica ou parcial
                    valorBaseParaHonorarios = valorBase;
                }
            }
            
            return { valorBaseParaHonorarios, valorBeneficiarioQueRecebeEfetivamente };
        }

        // ====================================
        // CESSOES BEN. PRINCIPAL
        // ====================================

        function calcularCessoesBeneficiarioPrincipal(dados, valorBase, valortotatt, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidencia, valorIR) {
            const valorBeneficiarioBruto = valorBase - valorHonorarioTotal - valorSindicatoParaDescontar;
            const cessoesBeneficiario = dados.cessoes?.filter(c => c.tipo === 'cessaobenPrincipal') || [];
            
            if (cessoesBeneficiario.length === 0) {
                return {
                    valorBeneficiarioBruto,
                    valorCessoesBeneficiario: 0,
                    cessoesBeneficiarioCalculadas: [],
                    percentualBeneficiarioFinal: 1.0,
                    valorBeneficiarioAposCessoes: valorBeneficiarioBruto,
                    valorPrevidenciaBeneficiario: valorPrevidencia,
                    valorIRBeneficiario: valorIR,
                    valorBeneficiarioFinal: valorBeneficiarioBruto - valorPrevidencia - valorIR,
                    cessoesBeneficiarioFinais: []
                };
            }

            const totalPercentualCessoes = cessoesBeneficiario.reduce((sum, c) => sum + c.percentual, 0);
            percentualBeneficiarioFinal = 1.0 - totalPercentualCessoes;
            
            const percentualAdvogados = dados.advogados.length > 0 ? 
                dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0) : 0;
            const valortotattSemAdvogados = valortotatt - (valortotatt * percentualAdvogados);

            const isPreferenciasParcial = dados.tipoCalculo === 'preferencia' && valorBase < valortotatt;
            const deveReceberAgora = !isPreferenciasParcial;

            const valorPrevidenciaBase = deveReceberAgora ? valorPrevidencia : 0;
            const valorIRBase = deveReceberAgora ? valorIR : 0;

            let valorCessoesBeneficiario = 0;
            const cessoesBeneficiarioCalculadas = [];
            const cessoesBeneficiarioFinais = [];

            for (const cessao of cessoesBeneficiario) {
                // Valor bruto da cess√£o
                const valorBrutoCessao = deveReceberAgora ? (valorBeneficiarioBruto * cessao.percentual) : 0;
                valorCessoesBeneficiario += valorBrutoCessao;
                
                const cessaoCalculada = {
                    tipo: cessao.tipo,
                    cedente: cessao.cedente,
                    cessionario: cessao.cessionario,
                    percentual: cessao.percentual,
                    valorBruto: valorBrutoCessao,
                    ...(isPreferenciasParcial && {
                        valorSaldoDevedor: valortotattSemAdvogados * cessao.percentual,
                        observacao: 'Aguarda pagamento - sem direito √† prefer√™ncia'
                    })
                };
                
                const previdenciaCessao = valorPrevidenciaBase * cessao.percentual;
                const irCessao = valorIRBase * cessao.percentual;
                
                const cessaoFinal = {
                    ...cessaoCalculada,
                    previdenciaCessao,
                    irCessao,
                    valorLiquido: valorBrutoCessao - previdenciaCessao - irCessao
                };
                
                cessoesBeneficiarioCalculadas.push(cessaoCalculada);
                cessoesBeneficiarioFinais.push(cessaoFinal);
            }

            let valorBeneficiarioAposCessoes, valorPrevidenciaBeneficiario, valorIRBeneficiario;

            if (isPreferenciasParcial) {
                // PREFER√äNCIA PARCIAL: benefici√°rio limitado pelo teto
                const parteBeneficiarioNaDividaTotal = valortotattSemAdvogados * percentualBeneficiarioFinal;
                valorBeneficiarioAposCessoes = Math.min(parteBeneficiarioNaDividaTotal, valorBeneficiarioBruto);
                valorPrevidenciaBeneficiario = valorPrevidencia;
                valorIRBeneficiario = valorIR;
            } else {
                valorBeneficiarioAposCessoes = valorBeneficiarioBruto * percentualBeneficiarioFinal;
                valorPrevidenciaBeneficiario = valorPrevidencia * percentualBeneficiarioFinal;
                valorIRBeneficiario = valorIR * percentualBeneficiarioFinal;
            }

            const valorBeneficiarioFinal = valorBeneficiarioAposCessoes - valorPrevidenciaBeneficiario - valorIRBeneficiario;

            return {
                valorBeneficiarioBruto,
                valorCessoesBeneficiario,
                cessoesBeneficiarioCalculadas,
                percentualBeneficiarioFinal,
                valorBeneficiarioAposCessoes,
                valorPrevidenciaBeneficiario,
                valorIRBeneficiario,
                valorBeneficiarioFinal,
                cessoesBeneficiarioFinais
            };
        }

        // ====================================
        // Honorarios Contratual
        // ====================================

        function calcularHonorarios(dados, valorBase, valortotatt, totaisPorTipo = null) {
            if (!totaisPorTipo || totaisPorTipo.contratual <= 0) {
                return { honorarios: [], valorHonorarioTotal: 0 };
            }
            
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            
            const proporcaoContratual = totaisPorTipo.contratual / totaisPorTipo.total;
            const valorBaseContratual = valorBase * proporcaoContratual;
            
            let valorHonorarioTotal = 0;
            
            const honorarios = dados.advogados.map(adv => {
                const valorBrutoTotal = valorBaseContratual * adv.percentual;
                valorHonorarioTotal += valorBrutoTotal;
                
                // Filtrar cess√µes deste advogado
                const cessaoAdv = dados.cessoes?.filter(c => 
                    c.tipo === 'cessaoAdv' && c.cedente === adv.nome
                ) || [];
                
                const percentualCessionarioAdv = cessaoAdv.reduce((sum, c) => sum + c.percentual, 0);
                
                let valorBrutoAdvogado, valorBrutoCessionario, percentualAdvogado;
                
                if (percentualCessionarioAdv >= 1.0) {
                    // Cess√£o de 100%: todo honor√°rio vai para cession√°rio
                    valorBrutoAdvogado = 0;
                    valorBrutoCessionario = valorBrutoTotal;
                    percentualAdvogado = 0;
                } else {
                    // Cess√£o parcial: calcular sobre o precat√≥rio
                    percentualAdvogado = Math.max(0, adv.percentual - percentualCessionarioAdv);
                    valorBrutoAdvogado = valorBaseContratual * percentualAdvogado;
                    valorBrutoCessionario = valorBaseContratual * percentualCessionarioAdv;
                }
                
                const valorParaIRAdvogado = isAcordo 
                    ? valorBrutoAdvogado * (1 - percentualDesagio)
                    : valorBrutoAdvogado;
                
                const valorParaIRCessionario = isAcordo
                    ? valorBrutoCessionario * (1 - percentualDesagio)
                    : valorBrutoCessionario;
                
                const calcularIRPessoa = (valor) => {
                    if (!adv.incidenciaIR || valor <= 0) return 0;
                    return adv.tipo === 'PF' ? calcularIR(valor) : valor * 0.015;
                };
                
                const irAdvogado = calcularIRPessoa(valorParaIRAdvogado);
                const irCessionarioAdv = calcularIRPessoa(valorParaIRCessionario);
                
                const valorLiquidoAdvogado = valorBrutoAdvogado - irAdvogado;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioAdv;
                
                const cessionarios = cessaoAdv.map(cessao => {
                    const valorBrutoCessao = percentualCessionarioAdv >= 1.0
                        ? valorBrutoTotal * cessao.percentual
                        : valorBaseContratual * cessao.percentual;
                    
                    const valorParaIRCessao = isAcordo
                        ? valorBrutoCessao * (1 - percentualDesagio)
                        : valorBrutoCessao;
                    
                    const irCessao = adv.incidenciaIR
                        ? (adv.tipo === 'PF' ? calcularIR(valorParaIRCessao) : valorParaIRCessao * 0.015)
                        : 0;
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });
                
                return {
                    ...adv,
                    valorBruto: valorBrutoTotal,
                    ir: irAdvogado + irCessionarioAdv,
                    valorLiquido: valorLiquidoAdvogado + valorLiquidoCessionario,
                    percentualAdvogado,
                    valorBrutoAdvogado,
                    irAdvogado,
                    valorLiquidoAdvogado,
                    percentualCessionarioAdv,
                    valorBrutoCessionario,
                    irCessionarioAdv,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesAdv: cessaoAdv
                };
            });
            
            return { honorarios, valorHonorarioTotal };
        }

        // ====================================
        // Honorarios Sucumbencial
        // ====================================

        function calcularHonorariosSucumbenciais(dados, valorTotalDivida, totaisPorTipo = null) {
            const resultadoVazio = { 
                honorarios: [], 
                valorHonorarioTotal: 0,
                valorBaseSucumbencial: 0,
                temHonorariosSucumbenciais: false
            };
            
            if (!dados.honorarioSucumbencial?.advogados?.length) return resultadoVazio;
            
            let valorBaseSucumbencial = totaisPorTipo?.sucumbencial || 0;
            if (valorBaseSucumbencial <= 0) return resultadoVazio;
            
            const percentualTotalSucumbencial = dados.honorarioSucumbencial.advogados.reduce((sum, adv) => {
                return adv.tipoHonorario === 'percentual' ? sum + adv.percentual : sum;
            }, 0);
            
            // Ajustar base se for c√°lculo parcial
            if (dados.tipoCalculo === 'parcial') {
                const valorTotalSucumbencial = valorBaseSucumbencial * percentualTotalSucumbencial;
                
                if (dados.somenteHonorarioSucumbencial) {
                    if (dados.saldoParcial < valorTotalSucumbencial) {
                        const fatorAjuste = dados.saldoParcial / valorTotalSucumbencial;
                        valorBaseSucumbencial = valorBaseSucumbencial * fatorAjuste;
                    }
                } else {
                    const valoresFiltrados = dados.valoresPrincipais?.filter(item => 
                        item.tipoUsoHonorario === 'sucumbencial' || item.tipoUsoHonorario === 'ambos'
                    ) || [];
                    
                    const valorOriginalSucumbencial = valoresFiltrados.reduce((sum, v) => 
                        sum + v.valorPrincipal + v.valorJuros, 0
                    );
                    
                    const valorOriginalTotal = dados.valoresPrincipais.reduce((sum, v) => 
                        sum + v.valorPrincipal + v.valorJuros, 0
                    );
                    
                    const proporcaoVerbaSucumbencial = valorOriginalSucumbencial / valorOriginalTotal;
                    const valorPrecatorioComSucumbencial = valorTotalDivida * proporcaoVerbaSucumbencial;
                    
                    const totalGeral = valorPrecatorioComSucumbencial + valorTotalSucumbencial;
                    if (dados.saldoParcial >= totalGeral) {
                        valorBaseSucumbencial = valorBaseSucumbencial;
                    } else {
                        const proporcaoSucumbencial = valorTotalSucumbencial / totalGeral;
                        const valorParcialSucumbencial = dados.saldoParcial * proporcaoSucumbencial;
                        
                        const fatorAjuste = valorParcialSucumbencial / valorTotalSucumbencial;
                        valorBaseSucumbencial = valorBaseSucumbencial * fatorAjuste;
                    }
                }
            }
            
            const isAcordo = dados.tipoCalculo === 'acordo';
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const tetoPreferencia = dados.tetoPreferencia || 0;
            const percentualDesagio = dados.percentualAcordo || 0;
            
            let valorHonorarioTotal = 0;
            
            const honorarios = dados.honorarioSucumbencial.advogados.map(adv => {
                const valorBrutoTotal = adv.tipoHonorario === 'percentual'
                    ? valorBaseSucumbencial * adv.percentual
                    : valorBaseSucumbencial;
                
                const cessaoAdv = dados.cessoes?.filter(c => 
                    c.tipo === 'cessaoAdvSuc' && c.cedente === adv.nome
                ) || [];
                
                const percentualCessionarioAdv = cessaoAdv.reduce((sum, c) => sum + c.percentual, 0);
                const percentualAdvogado = Math.max(0, 1 - percentualCessionarioAdv);
                
                const valorAdvogadoAposCessoes = valorBrutoTotal * percentualAdvogado;
                const valorCessionariosTotal = valorBrutoTotal * percentualCessionarioAdv;
                
                let valorFinalAdvogado, valorFinalCessionarios;
                
                if (isPreferencia && adv.preferencia) {
                    const honorarioCompletoNecessario = valorAdvogadoAposCessoes + valorCessionariosTotal;
                    
                    if (tetoPreferencia >= honorarioCompletoNecessario) {
                        valorFinalAdvogado = valorAdvogadoAposCessoes;
                        valorFinalCessionarios = valorCessionariosTotal;
                    } else {
                        valorFinalAdvogado = Math.min(valorAdvogadoAposCessoes, tetoPreferencia);
                        valorFinalCessionarios = 0;
                    }
                } else {
                    valorFinalAdvogado = valorAdvogadoAposCessoes;
                    valorFinalCessionarios = valorCessionariosTotal;
                }
                
                const valorFinalHonorario = valorFinalAdvogado + valorFinalCessionarios;
                
                const valorAdvogadoAposDesagio = isAcordo
                    ? valorFinalAdvogado * (1 - percentualDesagio)
                    : valorFinalAdvogado;
                
                const valorCessionariosAposDesagio = isAcordo
                    ? valorFinalCessionarios * (1 - percentualDesagio)
                    : valorFinalCessionarios;
                
                const calcularIRPessoa = (valor) => {
                    if (!adv.incidenciaIR || valor <= 0) return 0;
                    return adv.tipo === 'PF' ? calcularIR(valor) : valor * 0.015;
                };
                
                const irAdvogado = calcularIRPessoa(valorAdvogadoAposDesagio);
                const irCessionarioAdv = calcularIRPessoa(valorCessionariosAposDesagio);
                
                const valorLiquidoAdvogado = valorAdvogadoAposDesagio - irAdvogado;
                const valorLiquidoCessionario = valorCessionariosAposDesagio - irCessionarioAdv;
                
                const cessionarios = cessaoAdv.map(cessao => {
                    const valorBrutoCessao = valorFinalHonorario * cessao.percentual;
                    const valorAposDesagio = isAcordo
                        ? valorBrutoCessao * (1 - percentualDesagio)
                        : valorBrutoCessao;
                    
                    const irCessao = adv.incidenciaIR
                        ? (adv.tipo === 'PF' ? calcularIR(valorAposDesagio) : valorAposDesagio * 0.015)
                        : 0;
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        valorAposDesagio,
                        ir: irCessao,
                        valorLiquido: valorAposDesagio - irCessao
                    };
                });
                
                valorHonorarioTotal += valorFinalHonorario;
                
                const honorarioCompletoNecessario = valorAdvogadoAposCessoes + valorCessionariosTotal;
                
                return {
                    ...adv,
                    valorBruto: valorFinalHonorario,
                    ir: irAdvogado + irCessionarioAdv,
                    valorLiquido: valorLiquidoAdvogado + valorLiquidoCessionario,
                    percentualAdvogado,
                    valorBrutoAdvogado: valorFinalAdvogado,
                    valorAdvogadoAposDesagio,
                    irAdvogado,
                    valorLiquidoAdvogado,
                    percentualCessionarioAdv,
                    valorBrutoCessionario: valorFinalCessionarios,
                    valorCessionarioAposDesagio: valorCessionariosAposDesagio,
                    irCessionarioAdv,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesAdv: cessaoAdv,
                    temPreferencia: isPreferencia && adv.preferencia,
                    foiLimitadoPorPreferencia: isPreferencia && adv.preferencia && (tetoPreferencia < honorarioCompletoNecessario),
                    temCessoes: cessaoAdv.length > 0
                };
            });
            
            return { 
                honorarios, 
                valorHonorarioTotal,
                valorBaseSucumbencial,
                temHonorariosSucumbenciais: true
            };
        }

        // ====================================
        // SINDICATOS
        // ====================================

        function calcularSindicatos(dados, valorBase, valortotatt) {
            const isAcordo = dados.tipoCalculo === 'acordo';
            const percentualDesagio = dados.percentualAcordo || 0;
            const isPreferencia = dados.tipoCalculo === 'preferencia';
            const isParcial = dados.tipoCalculo === 'parcial';

            const calcularIRSindicato = (valor, tributacao, aliquotaPersonalizada = 0) => {
                if (tributacao === 'nao') return 0;
                if (tributacao === 'lei') return valor * 0.03;
                if (tributacao === 'fixa') return valor * aliquotaPersonalizada;
                return 0;
            };

            let valorSindicatoTotal = 0;
            
            const sindicatos = dados.sindicatos.map(sind => {
                const percentualTotalSindicato = sind.percentual;
                
                const valorBaseCalculo = isParcial ? valorBase : valortotatt;
                const valorBrutoTotal = valorBaseCalculo * percentualTotalSindicato;
                
                const cessaoSind = dados.cessoes?.filter(cessao => 
                    cessao.tipo === 'cessaoSindicato' && cessao.cedente === sind.nome
                ) || [];
                
                let percentualCessionarioSind = cessaoSind.reduce((total, cessao) => total + cessao.percentual, 0);
                const percentualSindicato = Math.max(0, percentualTotalSindicato - percentualCessionarioSind);

                const valorBrutoSindicato = valorBrutoTotal * percentualSindicato; 
                const valorBrutoCessionario = valorBrutoTotal * percentualCessionarioSind; 

                let valorParaIRSindicato = isAcordo ? valorBrutoSindicato * (1 - percentualDesagio) : valorBrutoSindicato;
                let valorParaIRCessionario = isAcordo ? valorBrutoCessionario * (1 - percentualDesagio) : valorBrutoCessionario;
                
                let irSindicato = calcularIRSindicato(valorParaIRSindicato, sind.tributacao, sind.aliquotaTributacao);
                let irCessionarioSind = calcularIRSindicato(valorParaIRCessionario, sind.tributacao, sind.aliquotaTributacao);
                
                const valorLiquidoSindicato = valorBrutoSindicato - irSindicato;
                const valorLiquidoCessionario = valorBrutoCessionario - irCessionarioSind;

                const cessionarios = cessaoSind.map(cessao => {
                    const valorBrutoCessao = valorBrutoTotal * cessao.percentual; 
                    let valorParaIRCessao = isAcordo ? valorBrutoCessao * (1 - percentualDesagio) : valorBrutoCessao;
                    
                    let irCessao = calcularIRSindicato(valorParaIRCessao, sind.tributacao, sind.aliquotaTributacao);
                    
                    return {
                        nome: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: valorBrutoCessao,
                        ir: irCessao,
                        valorLiquido: valorBrutoCessao - irCessao
                    };
                });

                if (!isPreferencia) {
                    valorSindicatoTotal += valorBrutoTotal;
                }

                return {
                    ...sind,
                    valorBruto: valorBrutoTotal,
                    ir: irSindicato + irCessionarioSind,
                    valorLiquido: valorLiquidoSindicato + valorLiquidoCessionario,
                    
                    // Dados do sindicato
                    percentualSindicato,
                    valorBrutoSindicato,
                    irSindicato,
                    valorLiquidoSindicato,
                    
                    // Dados totais dos cession√°rios
                    percentualCessionarioSind,
                    valorBrutoCessionario,
                    irCessionarioSind,
                    valorLiquidoCessionario,
                    cessionarios,
                    cessoesSind: cessaoSind,
                    
                    // Flag de controle
                    podeReceber: !isPreferencia
                };
            });

            return { 
                sindicatos, 
                valorSindicatoTotal
            };
        }

        // ====================================
        // HERDEIROS
        // ====================================

        function calcularTotaisParaHerdeiros(dados, valortotatt, percentualprinc, percentualjur,totaisPorTipo = null) {
            const dadosOrdem = { ...dados, tipoCalculo: 'ordem' };
            return calcularGlobal(dadosOrdem, valortotatt, percentualprinc, percentualjur,totaisPorTipo);
        }

        function calcularHerdeiros(dados, valortotatt, valorprincatt, valorjurosatt, detalhamento, totaisPorTipo = null) {
            if (!dados.herdeiros?.length) return [];
            
            const percentualprinc = valorprincatt / valortotatt;
            const percentualjur = valorjurosatt / valortotatt;
            const detalhamentoTotal = calcularTotaisParaHerdeiros(dados, valortotatt, percentualprinc, percentualjur, totaisPorTipo);
            
            const contexto = {
                percentualprinc,
                percentualjur,
                percentualBeneficiarioFinal: detalhamentoTotal.percentualBeneficiarioFinal,
                valorDisponivelParaHerdeiros: valortotatt * detalhamentoTotal.percentualBeneficiarioFinal,
                isPreferencia: dados.tipoCalculo === 'preferencia',
                isParcial: dados.tipoCalculo === 'parcial',
                temTributacaoIR: dados.valoresPrincipais?.some(item => item.tributacao?.ir) || false,
                rraTotal: dados.valoresPrincipais?.reduce((sum, item) => sum + (item.tributacao?.rra || 0), 0) || 0
            };
            
            return dados.herdeiros.map((herdeiro, index) => {
                const percentualHerdeiro = herdeiro.percentual;
                const valorTotalHerdeiro = valortotatt * percentualHerdeiro;
                
                // Cess√µes do benefici√°rio principal
                const valorHerdeiroPoscessaoBeneficiario = contexto.valorDisponivelParaHerdeiros * percentualHerdeiro;
                
                // Cess√µes do pr√≥prio herdeiro
                const cessoesHerdeiro = dados.cessoes?.filter(c => 
                    c.tipo === 'cessaoHerdeiro' && c.cedente === herdeiro.nome
                ) || [];
                
                const percentualCedido = cessoesHerdeiro.reduce((sum, c) => sum + c.percentual, 0);
                const valorAposCessoesHerdeiro = valorHerdeiroPoscessaoBeneficiario * (1.0 - percentualCedido);
                
                // Valor base conforme tipo de c√°lculo
                let valorBaseHerdeiro;
                if (dados.tipoCalculo === 'preferencia' && dados.natureza === 'alimentar' && herdeiro.temPreferencia) {
                    valorBaseHerdeiro = Math.min(valorAposCessoesHerdeiro, dados.tetoPreferencia);
                } else if (contexto.isParcial) {
                    valorBaseHerdeiro = valorAposCessoesHerdeiro * (dados.saldoParcial / valortotatt);
                } else {
                    valorBaseHerdeiro = valorAposCessoesHerdeiro;
                }
                
                const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBaseHerdeiro < valorTotalHerdeiro;
                
                // Composi√ß√£o inicial
                const { principal, juros, rra } = calcularComposicaoInicialHerdeiro(
                    dados, valorBaseHerdeiro, valorTotalHerdeiro, percentualHerdeiro, contexto
                );
                
                // Honor√°rios e Sindicatos
                const { honorarios, valorHonorarioTotal } = calcularHonorarios(dados, valorBaseHerdeiro, valorTotalHerdeiro, totaisPorTipo);
                const { sindicatos, valorSindicatoTotal } = calcularSindicatos(dados, valorBaseHerdeiro, valorTotalHerdeiro);
                const valorSindicatoParaDescontar = contexto.isPreferencia ? 0 : valorSindicatoTotal;
                const valorBruto = valorBaseHerdeiro - valorHonorarioTotal - valorSindicatoParaDescontar;
                
                // Rec√°lculo para prefer√™ncia parcial e parcial
                let principalFinal = principal;
                let jurosFinal = juros;
                let rraFinal = rra;
                
                if (isPreferenciaParcial || contexto.isParcial) {
                    const recalculo = recalcularPrincipalJurosRRAHerdeiro(
                        dados, valorBaseHerdeiro, valorTotalHerdeiro, percentualHerdeiro, 
                        isPreferenciaParcial, contexto
                    );
                    principalFinal = recalculo.principal;
                    jurosFinal = recalculo.juros ?? jurosFinal;
                    rraFinal = recalculo.rra;
                }
                
                // Tributos
                const previdencia = calcularPrevidenciaIsolada(dados, principalFinal, rraFinal);
                const ir = calcularIRIsolado(dados, valorTotalHerdeiro, valorBaseHerdeiro, principalFinal, previdencia.valorPrevidencia, rraFinal);
                
                // Cess√µes finais
                const cessoes = calcularCessoesHerdeiro(
                    dados, herdeiro, valorBaseHerdeiro, valorTotalHerdeiro,
                    valorHonorarioTotal, valorSindicatoParaDescontar,
                    previdencia.valorPrevidencia, ir.valorIR
                );
                
                // Prefer√™ncia parcial - saldo devedor
                let valorRecebePorPreferencia = cessoes.valorHerdeiroLiquido;
                let valorSaldoDevedor = 0;
                
                if (isPreferenciaParcial) {
                    valorRecebePorPreferencia = valorBaseHerdeiro - 
                        (cessoes.valorPrevidenciaHerdeiroFinal + cessoes.valorIRHerdeiroFinal + valorHonorarioTotal);
                    valorSaldoDevedor = valorHerdeiroPoscessaoBeneficiario - valorBaseHerdeiro;
                }
                
                // Valores originais
                const valorOriginal = {
                    valorTotal: valorTotalHerdeiro,
                    principal: valorprincatt * percentualHerdeiro,
                    juros: valorjurosatt * percentualHerdeiro,
                    rra: contexto.rraTotal !== 0 ? arredondarRRA(contexto.rraTotal * percentualHerdeiro) : 0
                };
                
                return {
                    ...herdeiro,
                    indice: index,
                    valorTotalOriginal: valorOriginal.valorTotal,
                    principalOriginal: valorOriginal.principal,
                    jurosOriginal: valorOriginal.juros,
                    rrapagamentoOriginal: valorOriginal.rra,
                    valorTotal: valorBaseHerdeiro,
                    principal: principalFinal,
                    jurosBase: jurosFinal,
                    rrapagamento: rraFinal,
                    rraComDesagio: ir.rraComDesagio,
                    honorarios,
                    valorHonorarioTotal,
                    sindicatos,
                    valorSindicatoTotal,
                    valorPrevidencia: previdencia.valorPrevidencia,
                    aliquotaEfetiva: previdencia.aliquotaEfetiva,
                    valorDesagioPrevidencia: previdencia.valorDesagioPrevidencia,
                    percentualDesagioPrevidencia: previdencia.percentualDesagioPrevidencia,
                    valorIR: ir.valorIR,
                    aliquotaIR: ir.aliquotaIR,
                    baseIRHonora: ir.baseIRHonora,
                    baseIRSindi: ir.baseIRSindi,
                    baseIRPrev: ir.baseIRPrev,
                    baseIRRRA: ir.baseIRRRA,
                    valorIRUnitario: ir.valorIRUnitario,
                    principalComDesagio: ir.principalComDesagio,
                    percentualDesagioIR: ir.percentualDesagioIR,
                    valorPrevidenciaFinal: cessoes.valorPrevidenciaHerdeiroFinal,
                    valorIRFinal: cessoes.valorIRHerdeiroFinal,
                    percentualBeneficiarioFinal: detalhamentoTotal.percentualBeneficiarioFinal,
                    valorAposCessoesBeneficiario: valorHerdeiroPoscessaoBeneficiario,
                    cessoesHerdeiro: cessoes.cessoesHerdeiroFinais,
                    valorCessoesHerdeiro: cessoes.valorCessoesHerdeiro,
                    percentualHerdeiroFinal: cessoes.percentualHerdeiroFinal,
                    valorBruto,
                    valorFinalAposCessoes: cessoes.valorHerdeiroAposCessoes,
                    valorLiquido: cessoes.valorHerdeiroLiquido,
                    isPreferenciaParcial,
                    valorRecebePorPreferencia,
                    valorSaldoDevedor,
                    temCessoes: cessoesHerdeiro.length > 0,
                    temCessoesBeneficiario: detalhamentoTotal.percentualBeneficiarioFinal < 1.0
                };
            });
        }

        // ====================================
        // FUN√á√ïES AUXILIARES HERDEIROS
        // ====================================

        function calcularComposicaoInicialHerdeiro(dados, valorBase, valorTotal, percentualHerdeiro, ctx) {
            let principal, juros;
            
            if (ctx.temTributacaoIR && dados.tributacaoIR) {
                principal = valorBase * (dados.tributacaoIR.percentuais.principalTributado / 100);
                juros = valorBase * (dados.tributacaoIR.percentuais.jurosTributado / 100);
            } else {
                principal = valorBase * ctx.percentualprinc;
                juros = valorBase * ctx.percentualjur;
            }
            
            // RRA: proporcional ao percentual do herdeiro
            let rra;
            if (ctx.isParcial) {
                const proporcao = valorBase / valorTotal;
                rra = ctx.rraTotal !== 0 ? arredondarRRA(ctx.rraTotal * percentualHerdeiro * proporcao) : 0;
            } else {
                rra = ctx.rraTotal !== 0 ? arredondarRRA(ctx.rraTotal * percentualHerdeiro) : 0;
            }
            
            return { principal, juros, rra };
        }

        function recalcularPrincipalJurosRRAHerdeiro(dados, valorBase, valorTotal, percentualHerdeiro, isPreferenciaParcial, ctx) {
            let principal, juros, rra;
            
            if (isPreferenciaParcial) {
                if (ctx.temTributacaoIR && dados.tributacaoIR) {
                    principal = valorBase * (dados.tributacaoIR.percentuais.principalTributado / 100);
                } else {
                    principal = valorBase * ctx.percentualprinc;
                }
                
                const proporcao = valorBase / valorTotal;
                rra = ctx.rraTotal !== 0 ? arredondarRRA(ctx.rraTotal * percentualHerdeiro * proporcao) : 0;
                juros = undefined;
                
            } else if (ctx.isParcial) {
                const proporcao = valorBase / valorTotal;
                
                if (ctx.temTributacaoIR && dados.tributacaoIR) {
                    principal = dados.tributacaoIR.principalTributado * percentualHerdeiro * proporcao;
                    juros = dados.tributacaoIR.jurosTributado * percentualHerdeiro * proporcao;
                } else {
                    principal = valorBase * ctx.percentualprinc;
                    juros = valorBase * ctx.percentualjur;
                }
                
                rra = ctx.rraTotal !== 0 ? arredondarRRA(ctx.rraTotal * percentualHerdeiro * proporcao) : 0;
            }
            
            return { principal, juros, rra };
        }

        // ====================================
        // CESSOES HERDEIROS
        // ====================================

        function calcularCessoesHerdeiro(dados, herdeiro, valorBaseHerdeiro, valorTotalHerdeiro, valorHonorarioTotal, valorSindicatoParaDescontar, valorPrevidenciaHerdeiro, valorIRHerdeiro) {
            const valorHerdeiroBruto = valorBaseHerdeiro - valorHonorarioTotal - valorSindicatoParaDescontar;
            const cessoesHerdeiro = dados.cessoes?.filter(c => 
                c.tipo === 'cessaoherdeiro' && c.cedente === herdeiro.nome
            ) || [];
            
            if (cessoesHerdeiro.length === 0) {
                return {
                    valorHerdeiroBruto,
                    valorCessoesHerdeiro: 0,
                    cessoesHerdeiroCalculadas: [],
                    percentualHerdeiroFinal: 1.0,
                    valorHerdeiroAposCessoes: valorHerdeiroBruto,
                    valorPrevidenciaHerdeiroFinal: valorPrevidenciaHerdeiro,
                    valorIRHerdeiroFinal: valorIRHerdeiro,
                    valorHerdeiroLiquido: valorHerdeiroBruto - valorPrevidenciaHerdeiro - valorIRHerdeiro,
                    cessoesHerdeiroFinais: []
                };
            }
            
            const totalPercentualCessoes = cessoesHerdeiro.reduce((sum, c) => sum + c.percentual, 0);
            const percentualHerdeiroFinal = 1.0 - totalPercentualCessoes;
            const isPreferenciaParcial = dados.tipoCalculo === 'preferencia' && valorBaseHerdeiro < valorTotalHerdeiro;
            
            const percentualAdvogados = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            const valorTotalSemAdvogados = valorTotalHerdeiro * (1 - percentualAdvogados);
            
            let valorCessoesHerdeiro = 0;
            const cessoesHerdeiroCalculadas = [];
            const cessoesHerdeiroFinais = [];
            
            if (isPreferenciaParcial) {
                // PREFER√äNCIA PARCIAL: cession√°rios n√£o recebem agora
                const parteHerdeiroNaDividaTotal = valorTotalSemAdvogados * percentualHerdeiroFinal;
                const maxQueHerdeiroPodeReceber = Math.min(parteHerdeiroNaDividaTotal, valorHerdeiroBruto);
                
                for (const cessao of cessoesHerdeiro) {
                    const parteCessionarioNaDividaTotal = valorTotalSemAdvogados * cessao.percentual;
                    
                    const cessaoCalculada = {
                        tipo: cessao.tipo,
                        cedente: cessao.cedente,
                        cessionario: cessao.cessionario,
                        percentual: cessao.percentual,
                        valorBruto: 0,
                        valorSaldoDevedor: parteCessionarioNaDividaTotal,
                        observacao: 'Aguarda pagamento - sem direito √† prefer√™ncia'
                    };
                    
                    const cessaoFinal = {
                        ...cessaoCalculada,
                        previdenciaCessao: 0,
                        irCessao: 0,
                        valorLiquido: 0
                    };
                    
                    cessoesHerdeiroCalculadas.push(cessaoCalculada);
                    cessoesHerdeiroFinais.push(cessaoFinal);
                }
                
                return {
                    valorHerdeiroBruto,
                    valorCessoesHerdeiro: 0,
                    cessoesHerdeiroCalculadas,
                    percentualHerdeiroFinal,
                    valorHerdeiroAposCessoes: maxQueHerdeiroPodeReceber,
                    valorPrevidenciaHerdeiroFinal: valorPrevidenciaHerdeiro,
                    valorIRHerdeiroFinal: valorIRHerdeiro,
                    valorHerdeiroLiquido: maxQueHerdeiroPodeReceber - valorPrevidenciaHerdeiro - valorIRHerdeiro,
                    cessoesHerdeiroFinais
                };
            }
            
            // ORDEM CRONOL√ìGICA OU PARCIAL: distribui√ß√£o proporcional
            for (const cessao of cessoesHerdeiro) {
                const valorBrutoCessao = valorHerdeiroBruto * cessao.percentual;
                valorCessoesHerdeiro += valorBrutoCessao;
                
                const cessaoCalculada = {
                    tipo: cessao.tipo,
                    cedente: cessao.cedente,
                    cessionario: cessao.cessionario,
                    percentual: cessao.percentual,
                    valorBruto: valorBrutoCessao
                };
                
                const previdenciaCessao = valorPrevidenciaHerdeiro * cessao.percentual;
                const irCessao = valorIRHerdeiro * cessao.percentual;
                
                const cessaoFinal = {
                    ...cessaoCalculada,
                    previdenciaCessao,
                    irCessao,
                    valorLiquido: valorBrutoCessao - previdenciaCessao - irCessao
                };
                
                cessoesHerdeiroCalculadas.push(cessaoCalculada);
                cessoesHerdeiroFinais.push(cessaoFinal);
            }
            
            return {
                valorHerdeiroBruto,
                valorCessoesHerdeiro,
                cessoesHerdeiroCalculadas,
                percentualHerdeiroFinal,
                valorHerdeiroAposCessoes: valorHerdeiroBruto * percentualHerdeiroFinal,
                valorPrevidenciaHerdeiroFinal: valorPrevidenciaHerdeiro * percentualHerdeiroFinal,
                valorIRHerdeiroFinal: valorIRHerdeiro * percentualHerdeiroFinal,
                valorHerdeiroLiquido: (valorHerdeiroBruto * percentualHerdeiroFinal) - 
                                    (valorPrevidenciaHerdeiro * percentualHerdeiroFinal) - 
                                    (valorIRHerdeiro * percentualHerdeiroFinal),
                cessoesHerdeiroFinais
            };
        }

        // ====================================
        // PAGAMENTOS - Ajustes 
        // ====================================

        function calcularSaldoFinalComPagamentos(resultados, pagamentosCalculados, dados) {
            if (!pagamentosCalculados?.length) return null;
            
            // 1. Mapear pagamentos por benefici√°rio
            const pagamentosPorBeneficiario = {};
            pagamentosCalculados.forEach(pag => {
                if (!pagamentosPorBeneficiario[pag.beneficiario]) {
                    pagamentosPorBeneficiario[pag.beneficiario] = { totalPago: 0 };
                }
                pagamentosPorBeneficiario[pag.beneficiario].totalPago += pag.valorAtualizado.total;
            });
            // 2. Estrutura de saldos finais
            const saldosFinais = {
                beneficiarioPrincipal: null,
                advogados: [],
                advogadosSucumbenciais: [],
                sindicatos: [],
                herdeiros: [],
                cessionarios: [],
                totalGeralBruto: 0,
                totalGeralOriginal: 0
            };
            
            // 3. Identificar cess√µes de 100%
            const cessoes100 = identificarCessoes100(resultados);
            
            // 4. Calcular saldos de cada grupo
            calcularSaldosBeneficiarioOuHerdeiros(resultados, dados, pagamentosPorBeneficiario, saldosFinais);
            calcularSaldosAdvogados(resultados.honorarios, pagamentosPorBeneficiario, cessoes100.advogados, saldosFinais, 'advogados');
            calcularSaldosAdvogados(resultados.honorariosSucumbenciais?.honorarios, pagamentosPorBeneficiario, cessoes100.advogadosSucumbenciais, saldosFinais, 'advogadosSucumbenciais');
            calcularSaldosSindicatos(resultados, pagamentosPorBeneficiario, cessoes100.sindicatos, saldosFinais);
            calcularSaldosCessionarios(resultados, pagamentosPorBeneficiario, cessoes100, saldosFinais,dados);
            
            // 5. Calcular totais e tributos finais
            calcularTotaisETributos(resultados, dados, saldosFinais);
            
            return saldosFinais;
        }

        // ====================================
        // FUN√á√ïES AUXILIARES
        // ====================================

        function identificarCessoes100(resultados) {
            const cessoes100 = {
                advogados: {},
                advogadosSucumbenciais: {},
                sindicatos: {},
                beneficiarioPrincipal: false
            };
            
            // Advogados
            resultados.honorarios?.forEach(adv => {
                if (adv.cessionarios?.length > 0) {
                    const percentualCedido = adv.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                    if (percentualCedido >= 1.0) {
                        cessoes100.advogados[adv.nome] = adv.cessionarios;
                    }
                }
            });
            
            // Advogados Sucumbenciais
            resultados.honorariosSucumbenciais?.honorarios?.forEach(advSuc => {
                if (advSuc.cessionarios?.length > 0) {
                    const percentualCedido = advSuc.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                    if (percentualCedido >= 1.0) {
                        cessoes100.advogadosSucumbenciais[advSuc.nome] = advSuc.cessionarios;
                    }
                }
            });
            
            // Sindicatos
            resultados.sindicatos?.forEach(sind => {
                if (sind.cessionarios?.length > 0) {
                    const percentualCedido = sind.cessionarios.reduce((sum, c) => sum + c.percentual, 0);
                    if (percentualCedido >= 1.0) {
                        cessoes100.sindicatos[sind.nome] = sind.cessionarios;
                    }
                }
            });
            
            // Benefici√°rio Principal
            if (resultados.cessoesBeneficiarioFinais?.length > 0) {
                const percentualCedido = resultados.cessoesBeneficiarioFinais.reduce((sum, c) => sum + c.percentual, 0);
                cessoes100.beneficiarioPrincipal = percentualCedido >= 1.0;
            }
            
            return cessoes100;
        }

        function calcularSaldosBeneficiarioOuHerdeiros(resultados, dados, pagamentosPorBeneficiario, saldosFinais) {
            const nomeBeneficiario = dados.beneficiario;
            const pagamentoBeneficiario = pagamentosPorBeneficiario[nomeBeneficiario]?.totalPago || 0;
            
            if (resultados.temHerdeiros && resultados.herdeiros?.length > 0) {
                // COM HERDEIROS
                resultados.herdeiros.forEach(herdeiro => {
                    const percentualCedido = herdeiro.cessoesHerdeiro?.reduce((sum, c) => sum + c.percentual, 0) || 0;
                    const cedeu100 = percentualCedido >= 1.0;
                    if (cedeu100) {
                        return;
                    }
                    const pagamentoDireto = pagamentosPorBeneficiario[herdeiro.nome]?.totalPago || 0;
                    const pagamentoDoBeneficiario = pagamentoBeneficiario * herdeiro.percentual;
                    const totalPagamento = pagamentoDireto + pagamentoDoBeneficiario;
                    
                    const valorBruto = herdeiro.valorBruto || 0;
                    const saldo = valorBruto - totalPagamento;
                    
                    saldosFinais.herdeiros.push({
                        nome: herdeiro.nome,
                        valorBruto,
                        pagamento: totalPagamento,
                        pagamentoDireto,
                        pagamentoDoBeneficiario,
                        saldo
                    });
                    
                    saldosFinais.totalGeralBruto += saldo;
                    saldosFinais.totalGeralOriginal += valorBruto;
                });
            } else {
                // SEM HERDEIROS
                if (resultados.valorBeneficiarioAposCessoes > 0) {
                    const valorBruto = resultados.valorBeneficiarioAposCessoes;
                    const saldo = valorBruto - pagamentoBeneficiario;
                    
                    saldosFinais.beneficiarioPrincipal = {
                        nome: nomeBeneficiario,
                        valorBruto,
                        pagamento: pagamentoBeneficiario,
                        saldo
                    };
                    
                    saldosFinais.totalGeralBruto += saldo;
                    saldosFinais.totalGeralOriginal += valorBruto;
                }
            }
        }

        function calcularSaldosAdvogados(advogados, pagamentosPorBeneficiario, cessoes100, saldosFinais, chave) {
            if (!advogados?.length) return;
            
            advogados.forEach(adv => {
                // Se cess√£o √© 100%, n√£o mostrar advogado
                if (cessoes100[adv.nome]) return;
                
                const pagamentoDireto = pagamentosPorBeneficiario[adv.nome]?.totalPago || 0;
                const valorBruto = adv.valorBrutoAdvogado || adv.valorBruto || 0;
                const saldo = valorBruto - pagamentoDireto;
                
                saldosFinais[chave].push({
                    nome: adv.nome,
                    tipo: adv.tipo,
                    valorBruto,
                    pagamento: pagamentoDireto,
                    saldo
                });
                
                saldosFinais.totalGeralBruto += saldo;
                saldosFinais.totalGeralOriginal += valorBruto;
            });
        }

        function calcularSaldosSindicatos(resultados, pagamentosPorBeneficiario, cessoes100, saldosFinais) {
            if (!resultados.sindicatos?.length) return;
            
            resultados.sindicatos.forEach(sind => {
                // Se cess√£o √© 100%, n√£o mostrar sindicato
                if (cessoes100[sind.nome]) return;
                
                const pagamentoDireto = pagamentosPorBeneficiario[sind.nome]?.totalPago || 0;
                const valorBruto = sind.valorBrutoSindicato || 0;
                const saldo = valorBruto - pagamentoDireto;
                
                saldosFinais.sindicatos.push({
                    nome: sind.nome,
                    valorBruto,
                    pagamento: pagamentoDireto,
                    saldo
                });
                
                saldosFinais.totalGeralBruto += saldo;
                saldosFinais.totalGeralOriginal += valorBruto;
            });
        }

        function calcularSaldosCessionarios(resultados, pagamentosPorBeneficiario, cessoes100, saldosFinais,dados) {  
            const nomeBeneficiario = resultados.beneficiario || dados?.beneficiario || '';
            const pagamentoBeneficiario = pagamentosPorBeneficiario[nomeBeneficiario]?.totalPago || 0;
            
            // Cession√°rios do Benefici√°rio Principal
            if (resultados.cessoesBeneficiarioFinais?.length > 0) {
                resultados.cessoesBeneficiarioFinais.forEach(cess => {
                    const pagamentoDireto = pagamentosPorBeneficiario[cess.cessionario]?.totalPago || 0;
                    let pagamentoTotal = pagamentoDireto;
                    
                    if (cessoes100.beneficiarioPrincipal) {
                        const pagamentoDoCedente = pagamentoBeneficiario * cess.percentual;  
                        pagamentoTotal += pagamentoDoCedente;
                    } 
                    const valorBruto = cess.valorBruto || 0;
                    const saldo = valorBruto - pagamentoTotal;
                    
                    saldosFinais.cessionarios.push({
                        nome: cess.cessionario,
                        tipo: 'Cession√°rio do Benefici√°rio',
                        valorBruto,
                        pagamento: pagamentoTotal,
                        pagamentoDireto,
                        saldo
                    });
                    
                    saldosFinais.totalGeralBruto += saldo;
                    saldosFinais.totalGeralOriginal += valorBruto;
                });
            }

            if (resultados.herdeiros?.length > 0) {                
                resultados.herdeiros.forEach(herdeiro => {
                    if (herdeiro.cessoesHerdeiro?.length > 0) {  
                        const pagamentoHerdeiro = pagamentosPorBeneficiario[herdeiro.nome]?.totalPago || 0;
                        
                        const percentualCedidoHerdeiro = herdeiro.cessoesHerdeiro.reduce((sum, c) => sum + c.percentual, 0); 
                        const cedeu100 = percentualCedidoHerdeiro >= 1.0;
                        
                        const valorBrutoHerdeiro = herdeiro.valorBruto || 0;
                        
                        herdeiro.cessoesHerdeiro.forEach(cess => { 
                            const pagamentoDireto = pagamentosPorBeneficiario[cess.cessionario]?.totalPago || 0;
                            let pagamentoTotal = pagamentoDireto;
                            
                            let valorBruto = cess.valorBruto || 0;
                            
                            if (cedeu100) {
                                valorBruto = valorBrutoHerdeiro * cess.percentual;
                                const pagamentoDoHerdeiro = pagamentoHerdeiro * cess.percentual;
                                pagamentoTotal += pagamentoDoHerdeiro;
                            }

                            const saldo = valorBruto - pagamentoTotal;
                            
                            saldosFinais.cessionarios.push({
                                nome: cess.cessionario,
                                cedente: herdeiro.nome,
                                tipo: 'Cession√°rio de Herdeiro',
                                valorBruto,
                                pagamento: pagamentoTotal,
                                pagamentoDireto,  
                                saldo
                            });
                            
                            saldosFinais.totalGeralBruto += saldo;
                            saldosFinais.totalGeralOriginal += valorBruto;
                        });
                    } 
                });
            }
            
            // Cession√°rios de Advogados, Advogados Sucumbenciais e Sindicatos
            processarCessionariosDeCedentes(resultados.honorarios, pagamentosPorBeneficiario, cessoes100.advogados, saldosFinais, 'Cession√°rio de Advogado');
            processarCessionariosDeCedentes(resultados.honorariosSucumbenciais?.honorarios, pagamentosPorBeneficiario, cessoes100.advogadosSucumbenciais, saldosFinais, 'Cession√°rio de Adv. Sucumbencial');
            processarCessionariosDeCedentes(resultados.sindicatos, pagamentosPorBeneficiario, cessoes100.sindicatos, saldosFinais, 'Cession√°rio de Sindicato');
        }

        function processarCessionariosDeCedentes(cedentes, pagamentosPorBeneficiario, cessoes100, saldosFinais, tipoCessionario) {
            if (!cedentes?.length) return;
            
            cedentes.forEach(cedente => {
                if (!cedente.cessionarios?.length) return;
                
                const pagamentoCedente = pagamentosPorBeneficiario[cedente.nome]?.totalPago || 0;
                const cedeu100 = cessoes100[cedente.nome];
                
                cedente.cessionarios.forEach(cess => {
                    const pagamentoDireto = pagamentosPorBeneficiario[cess.nome]?.totalPago || 0;
                    let pagamentoTotal = pagamentoDireto;
                    
                    if (cedeu100) {
                        pagamentoTotal += pagamentoCedente * cess.percentual;
                    }
                    
                    const valorBruto = cess.valorBruto || 0;
                    const saldo = valorBruto - pagamentoTotal;
                    
                    saldosFinais.cessionarios.push({
                        nome: cess.nome,
                        cedente: cedente.nome,
                        tipo: tipoCessionario,
                        valorBruto,
                        pagamento: pagamentoTotal,
                        pagamentoDireto,
                        saldo
                    });
                    
                    saldosFinais.totalGeralBruto += saldo;
                    saldosFinais.totalGeralOriginal += valorBruto;
                });
            });
        }

        function calcularTotaisETributos(resultados, dados, saldosFinais) {
            let totalSemHonSuc = saldosFinais.totalGeralBruto;
            
            if (saldosFinais.advogadosSucumbenciais?.length > 0) {
                totalSemHonSuc -= saldosFinais.advogadosSucumbenciais.reduce((sum, adv) => sum + adv.saldo, 0);
            }
            
            if (saldosFinais.cessionarios?.length > 0) {
                totalSemHonSuc -= saldosFinais.cessionarios
                    .filter(c => c.tipo === 'Cession√°rio de Adv. Sucumbencial')
                    .reduce((sum, c) => sum + c.saldo, 0);
            }
            
            saldosFinais.totalSemHonorariosSucumbenciais = totalSemHonSuc;
            
            let totalOriginalSemHonSuc = saldosFinais.totalGeralOriginal;
            
            if (saldosFinais.advogadosSucumbenciais?.length > 0) {
                totalOriginalSemHonSuc -= saldosFinais.advogadosSucumbenciais.reduce((sum, adv) => sum + adv.valorBruto, 0);
            }
            
            if (saldosFinais.cessionarios?.length > 0) {
                totalOriginalSemHonSuc -= saldosFinais.cessionarios
                    .filter(c => c.tipo === 'Cession√°rio de Adv. Sucumbencial')
                    .reduce((sum, c) => sum + c.valorBruto, 0);
            }
            
            const principalOriginal = resultados.principal || (resultados.valortotatt * (resultados.percentualprinc || 0.5));
            const jurosOriginal = (resultados.valortotatt || 0) - principalOriginal;
            
            const valorPago = totalOriginalSemHonSuc - totalSemHonSuc;
            
            if (valorPago > 0 && totalOriginalSemHonSuc > 0) {
                const percentualPago = valorPago / totalOriginalSemHonSuc;
                const principalPago = principalOriginal * percentualPago;
                const jurosPago = jurosOriginal * percentualPago;
                
                saldosFinais.principalTotal = principalOriginal - principalPago;
                saldosFinais.jurosTotal = jurosOriginal - jurosPago;
            } else {
                saldosFinais.principalTotal = totalSemHonSuc * (resultados.percentualprinc || 0.5);
                saldosFinais.jurosTotal = totalSemHonSuc * (resultados.percentualjur || 0.5);
            }
            
            const rraOriginal = resultados.rrapagamento || resultados.rraTotal || 0;
            const proporcao = totalOriginalSemHonSuc > 0 ? (totalSemHonSuc / totalOriginalSemHonSuc) : 0;
            saldosFinais.rraOriginal = rraOriginal;
            saldosFinais.rraAjustado = rraOriginal > 0 ? Math.max(1, arredondarRRA(proporcao * rraOriginal)) : 0;
            
            // Previd√™ncia
            const resultadoPrev = calcularPrevidenciaIsolada(dados, saldosFinais.principalTotal, saldosFinais.rraAjustado);
            Object.assign(saldosFinais, {
                previdenciaTotal: resultadoPrev.valorPrevidencia,
                aliquotaEfetiva: resultadoPrev.aliquotaEfetiva,
                valorDesagioPrevidencia: resultadoPrev.valorDesagioPrevidencia,
                percentualDesagioPrevidencia: resultadoPrev.percentualDesagioPrevidencia
            });
            
            // IR
            const resultadoIR = calcularIRIsolado(dados, totalSemHonSuc, totalSemHonSuc, saldosFinais.principalTotal, saldosFinais.previdenciaTotal, saldosFinais.rraAjustado);
            Object.assign(saldosFinais, {
                irTotal: resultadoIR.valorIR,
                aliquotaIR: resultadoIR.aliquotaIR,
                baseIRHonora: resultadoIR.baseIRHonora,
                baseIRSindi: resultadoIR.baseIRSindi,
                baseIRPrev: resultadoIR.baseIRPrev,
                baseIRRRA: resultadoIR.baseIRRRA,
                valorIRUnitario: resultadoIR.valorIRUnitario,
                principalComDesagio: resultadoIR.principalComDesagio,
                percentualDesagioIR: resultadoIR.percentualDesagioIR,
                rraComDesagio: resultadoIR.rraComDesagio
            });
            
            saldosFinais.totalLiquido = totalSemHonSuc - saldosFinais.previdenciaTotal - saldosFinais.irTotal;
        }

        // ====================================
        // AJUSTAR EXIBICAO COM PAGAMENTOS
        // ====================================

        function ajustarResultadosComPagamentos(resultados, dados) {
            if (!resultados.saldosFinais) return resultados;
            
            const saldos = resultados.saldosFinais;
            const resultadosAjustados = JSON.parse(JSON.stringify(resultados));
            
            if (saldos.totalGeralBruto <= 0) return resultadosAjustados;
            
            const totalParaCalculo = saldos.totalSemHonorariosSucumbenciais || saldos.totalGeralBruto;
            
            // Ajustar valores globais
            Object.assign(resultadosAjustados, {
                principal: saldos.principalTotal,
                valorBase: totalParaCalculo,
                valortotatt: totalParaCalculo,
                rrapagamento: saldos.rraAjustado || saldos.rraOriginal,
                valorPrevidencia: saldos.previdenciaTotal,
                aliquotaEfetiva: saldos.aliquotaEfetiva,
                valorDesagioPrevidencia: saldos.valorDesagioPrevidencia,
                percentualDesagioPrevidencia: saldos.percentualDesagioPrevidencia,
                valorIR: saldos.irTotal,
                aliquotaIR: saldos.aliquotaIR,
                baseIRHonora: saldos.baseIRHonora,
                baseIRSindi: saldos.baseIRSindi,
                baseIRPrev: saldos.baseIRPrev,
                baseIRRRA: saldos.baseIRRRA,
                valorIRUnitario: saldos.valorIRUnitario,
                principalComDesagio: saldos.principalComDesagio,
                percentualDesagioIR: saldos.percentualDesagioIR,
                rraComDesagio: saldos.rraComDesagio
            });
            
            // Ajustar Benefici√°rio Principal
            if (saldos.beneficiarioPrincipal?.saldo > 0) {
                resultadosAjustados.valorBeneficiarioAposCessoes = saldos.beneficiarioPrincipal.saldo;
                resultadosAjustados.valorPrevidenciaBeneficiario = saldos.previdenciaTotal;
                resultadosAjustados.valorIRBeneficiario = saldos.irTotal;
                resultadosAjustados.valorBeneficiarioFinal = saldos.beneficiarioPrincipal.saldo - 
                    resultadosAjustados.valorPrevidenciaBeneficiario - resultadosAjustados.valorIRBeneficiario;
            }
            
            // Ajustar Advogados, Advogados Sucumbenciais, Sindicatos
            ajustarGrupoComIR(resultadosAjustados, 'honorarios', saldos.advogados, calcularIRAdvogado);
            ajustarGrupoComIR(resultadosAjustados.honorariosSucumbenciais, 'honorarios', saldos.advogadosSucumbenciais, calcularIRAdvogado);
            ajustarGrupoComIR(resultadosAjustados, 'sindicatos', saldos.sindicatos, calcularIRSindicato);
            
            // Ajustar Herdeiros
            ajustarHerdeiros(resultadosAjustados, saldos, dados, resultados);
            
            // Ajustar Cession√°rios
            ajustarCessionarios(resultadosAjustados, saldos, dados, resultados);
            
            return resultadosAjustados;
        }

        function calcularIRAdvogado(item, saldo) {
            if (!item.incidenciaIR || saldo <= 0) return 0;
            return item.tipo === 'PF' ? calcularIR(saldo) : saldo * 0.015;
        }

        function calcularIRSindicato(item, saldo) {
            if (item.tipoTributacao === 'pj') return saldo * 0.015;
            if (item.aliquotaFixaIR) return saldo * item.aliquotaFixaIR;
            return saldo * 0.015;
        }

        function ajustarGrupoComIR(container, chave, saldos, calcularIRFn) {
            if (!saldos?.length || !container?.[chave]) return;
            
            container[chave] = container[chave].map(item => {
                const saldo = saldos.find(s => s.nome === item.nome);
                if (!saldo || saldo.saldo <= 0) return item;
                
                const novoIR = calcularIRFn(item, saldo.saldo);
                
                return {
                    ...item,
                    valorBrutoAdvogado: saldo.saldo,
                    valorBrutoSindicato: saldo.saldo,
                    irAdvogado: novoIR,
                    irSindicato: novoIR,
                    valorLiquidoAdvogado: saldo.saldo - novoIR,
                    valorLiquidoSindicato: saldo.saldo - novoIR
                };
            });
        }

        function ajustarHerdeiros(resultadosAjustados, saldos, dados, resultados) {
            if (!saldos.herdeiros?.length || !resultadosAjustados.herdeiros) return;
            
            const temIR = dados.valoresPrincipais?.some(item => item.tributacao?.ir);
            
            resultadosAjustados.herdeiros = resultadosAjustados.herdeiros.map((herd, index) => {
                const saldo = saldos.herdeiros[index];
                if (!saldo || saldo.saldo <= 0) return herd;
                
                const proporcao = saldo.saldo / saldo.valorBruto;
                const herdAjustado = {
                    ...herd,
                    principal: herd.principal * proporcao,
                    valorTotal: saldo.saldo,
                    valorBruto: saldo.saldo,
                    valorLiquido: herd.valorLiquido ? herd.valorLiquido * proporcao : saldo.saldo
                };
                
                // Recalcular Previd√™ncia
                if (dados.valoresPrincipais?.some(item => item.tributacao?.previdencia)) {
                    const resultadoPrev = calcularPrevidenciaIsolada(dados, herdAjustado.principal, herd.rrapagamento);
                    Object.assign(herdAjustado, {
                        valorPrevidencia: resultadoPrev.valorPrevidencia,
                        aliquotaEfetiva: resultadoPrev.aliquotaEfetiva,
                        valorDesagioPrevidencia: resultadoPrev.valorDesagioPrevidencia,
                        percentualDesagioPrevidencia: resultadoPrev.percentualDesagioPrevidencia
                    });
                }
                
                // Recalcular IR
                if (temIR && herd.rrapagamento !== 0) {
                    const resultadoIR = calcularIRIsolado(dados, herdAjustado.valorTotal, herdAjustado.valorTotal, 
                        herdAjustado.principal, herdAjustado.valorPrevidencia, herd.rrapagamento);
                    Object.assign(herdAjustado, {
                        valorIR: resultadoIR.valorIR,
                        aliquotaIR: resultadoIR.aliquotaIR,
                        baseIRHonora: resultadoIR.baseIRHonora,
                        baseIRSindi: resultadoIR.baseIRSindi,
                        baseIRPrev: resultadoIR.baseIRPrev,
                        baseIRRRA: resultadoIR.baseIRRRA,
                        valorIRUnitario: resultadoIR.valorIRUnitario
                    });
                }
                
                return herdAjustado;
            });
        }

        function ajustarCessionarios(resultadosAjustados, saldos, dados, resultados) {
            if (!saldos.cessionarios?.length) return;
            
            const temIR = dados.valoresPrincipais?.some(item => item.tributacao?.ir);
            
            // Cession√°rios do Benefici√°rio
            if (resultadosAjustados.cessoesBeneficiarioFinais) {
                resultadosAjustados.cessoesBeneficiarioFinais = ajustarCessionariosBeneficiario(
                    resultadosAjustados.cessoesBeneficiarioFinais, 
                    saldos.cessionarios, 
                    dados, 
                    resultados,
                    temIR,
                    saldos
                );
            }
            
            // Cession√°rios de outros grupos
            ajustarCessionariosDeGrupo(resultadosAjustados, 'honorarios', saldos.cessionarios, 'Advogado', calcularIRAdvogado);
            ajustarCessionariosDeGrupo(resultadosAjustados.honorariosSucumbenciais, 'honorarios', saldos.cessionarios, 'Adv. Sucumbencial', calcularIRAdvogado);
            ajustarCessionariosDeGrupo(resultadosAjustados, 'sindicatos', saldos.cessionarios, 'Sindicato', calcularIRSindicato);
            ajustarCessionariosHerdeiros(resultadosAjustados, saldos.cessionarios, dados, temIR);
        }

        function ajustarCessionariosBeneficiario(cessionarios, saldosCessionarios, dados, resultados, temIR, saldos) {
            return cessionarios.map(cess => {
                const saldoCess = saldosCessionarios.find(c => 
                    c.nome === cess.cessionario && c.tipo === 'Cession√°rio do Benefici√°rio'
                );
                
                if (!saldoCess || saldoCess.saldo <= 0) return cess;
                
                const percentualCessao = cess.percentual || 0;
                const cedeu100 = percentualCessao >= 1.0;
                
                let previdenciaCess, novoIR;
                
                if (cedeu100) {
                    previdenciaCess = saldos.previdenciaTotal || resultados.valorPrevidencia || 0;  // ‚¨ÖÔ∏è USAR 'saldos'
            
                    // IR tamb√©m direto
                    if (temIR) {
                        novoIR = saldos.irTotal || resultados.valorIR || 0;
                    } else {
                        novoIR = 0;
                    }
                } else {
                    const valorBrutoBeneficiario = resultados.valorBeneficiarioBruto || resultados.valortotatt || 0;
                    const principalBeneficiario = resultados.principal || 0;
                    
                    const proporcaoPrincipal = valorBrutoBeneficiario > 0 
                        ? principalBeneficiario / valorBrutoBeneficiario 
                        : 0.5;
                    
                    const principalCess = saldoCess.saldo * proporcaoPrincipal;
                    const rraCess = saldos.rraAjustado || resultados.rrapagamento || 0;
                    
                    const resultadoPrev = calcularPrevidenciaIsolada(dados, principalCess, rraCess);
                    previdenciaCess = resultadoPrev.valorPrevidencia;
                    
                    if (temIR && rraCess !== 0) {
                        const resultadoIR = calcularIRIsolado(dados, saldoCess.saldo, saldoCess.saldo, 
                            principalCess, previdenciaCess, rraCess);
                        novoIR = resultadoIR.valorIR;
                    } else {
                        novoIR = 0;
                    }
                }
                
                return {
                    ...cess,
                    valorBruto: saldoCess.saldo,
                    previdenciaCessao: previdenciaCess,
                    irCessao: novoIR,
                    valorLiquido: saldoCess.saldo - previdenciaCess - novoIR
                };
            });
        }

        function ajustarCessionariosDeGrupo(container, chave, saldosCessionarios, tipoGrupo, calcularIRFn) {
            if (!container?.[chave]) return;
            
            container[chave] = container[chave].map(item => {
                if (!item.cessionarios?.length) return item;
                
                return {
                    ...item,
                    cessionarios: item.cessionarios.map(cess => {
                        const saldoCess = saldosCessionarios.find(c => 
                            c.nome === cess.nome && c.cedente === item.nome && c.tipo.includes(tipoGrupo)
                        );
                        
                        if (!saldoCess || saldoCess.saldo <= 0) return cess;
                        
                        const novoIR = calcularIRFn(item, saldoCess.saldo);
                        
                        return {
                            ...cess,
                            valorBruto: saldoCess.saldo,
                            ir: novoIR,
                            valorLiquido: saldoCess.saldo - novoIR
                        };
                    })
                };
            });
        }

        function ajustarCessionariosHerdeiros(resultadosAjustados, saldosCessionarios, dados, temIR) {
            if (!resultadosAjustados.herdeiros) return;
            
            resultadosAjustados.herdeiros = resultadosAjustados.herdeiros.map(herd => {
                if (!herd.cessoesHerdeiro?.length) return herd;
                
                return {
                    ...herd,
                    cessoesHerdeiro: herd.cessoesHerdeiro.map(cess => {
                        const saldoCess = saldosCessionarios.find(c => 
                            c.nome === cess.cessionario && c.cedente === herd.nome && c.tipo === 'Cession√°rio de Herdeiro'
                        );
                        
                        if (!saldoCess || saldoCess.saldo <= 0) return cess;
                        
                        const proporcaoPrincipal = herd.principal / herd.valorBruto;  
                        const principalCess = saldoCess.saldo * proporcaoPrincipal;
                        const rraCess = herd.rrapagamento || 0;
                        
                        const resultadoPrev = calcularPrevidenciaIsolada(dados, principalCess, rraCess);
                        let novoIR = 0;
                        
                        if (temIR && rraCess !== 0) {
                            const resultadoIR = calcularIRIsolado(dados, saldoCess.saldo, saldoCess.saldo, 
                                principalCess, resultadoPrev.valorPrevidencia, rraCess);
                            novoIR = resultadoIR.valorIR;
                        }
                        
                        return {
                            ...cess,
                            valorBruto: saldoCess.saldo,
                            previdenciaCessao: resultadoPrev.valorPrevidencia,
                            irCessao: novoIR,
                            valorLiquido: saldoCess.saldo - resultadoPrev.valorPrevidencia - novoIR
                        };
                    })
                };
            });
        }

        // ====================================
        // IR
        // ====================================

        function calcularIRIsolado(dados, valortotatt, valorBase, principalBase, valorPrevidencia, rrapagamentoRecalculado) {
            const resultadoVazio = {
                valorIR: 0,
                aliquotaIR: 0,
                baseIRHonora: 0,
                baseIRSindi: 0,
                baseIRPrev: 0,
                principalComDesagio: 0,
                percentualDesagioIR: 0,
                rraComDesagio: 0,
                baseIRRRA: 0,
                valorIRUnitario: 0
            };
            
            const temIR = dados.valoresPrincipais?.some(item => item.tributacao?.ir === true);
            
            // Early return - sem IR ou sem RRA (PF)
            if (!temIR || (dados.tipoBeneficiario !== 'pj' && rrapagamentoRecalculado === 0)) {
                return resultadoVazio;
            }
            
            const percentualTotalAdv = dados.advogados.reduce((sum, adv) => sum + adv.percentual, 0);
            const percentualTotalSind = dados.tipoCalculo === 'preferencia' ? 0 : 
                dados.sindicatos.reduce((sum, sind) => sum + sind.percentual, 0);
            
            // PESSOA JUR√çDICA
            if (dados.natureza === 'comum' && dados.tipoBeneficiario === 'pj') {
                const baseIRPJ = valortotatt * (1 - percentualTotalAdv - percentualTotalSind);
                let valorIR = baseIRPJ * 0.03;
                const percentualDesagio = dados.percentualAcordo || 0;
                
                if (dados.tipoCalculo === 'acordo') {
                    valorIR = valorIR * (1 - percentualDesagio);
                }
                
                return {
                    ...resultadoVazio,
                    valorIR,
                    aliquotaIR: 0.03,
                    valorIRUnitario: valorIR,
                    percentualDesagioIR: percentualDesagio,
                    baseIRHonora: 1,
                    baseIRSindi: 1,
                    baseIRPrev: 1,
                    baseIRRRA: 1
                };
            }
            
            // PESSOA F√çSICA
            const baseIRHonora = principalBase - (principalBase * percentualTotalAdv);
            const baseIRSindi = baseIRHonora - (principalBase * percentualTotalSind);
            
            // Aplicar des√°gio se for acordo
            const percentualDesagioIR = dados.percentualAcordo || 0;
            const principalComDesagio = dados.tipoCalculo === 'acordo' 
                ? baseIRSindi * (1 - percentualDesagioIR)
                : baseIRSindi;
            
            const rraComDesagio = rrapagamentoRecalculado > 0 ? Math.max(1, rrapagamentoRecalculado) : 0;
            const baseIRPrev = principalComDesagio - valorPrevidencia;
            const baseIRRRA = baseIRPrev / rraComDesagio;
            
            const valorIRUnitario = calcularIR(baseIRRRA);
            const valorIR = valorIRUnitario * rraComDesagio;
            const aliquotaIR = obterAliquotaIR(baseIRRRA);
            
            return {
                valorIR,
                aliquotaIR,
                baseIRHonora,
                baseIRSindi,
                baseIRPrev,
                principalComDesagio,
                percentualDesagioIR,
                rraComDesagio,
                baseIRRRA,
                valorIRUnitario
            };
        }

        function calcularIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return (valorBruto * 0.075) - 182.16;
            else if (valorBruto <= 3751.05) return (valorBruto * 0.15) - 394.16;
            else if (valorBruto <= 4664.68) return (valorBruto * 0.225) - 675.49;
            else return (valorBruto * 0.275) - 908.73;
        }

        function obterAliquotaIR(valorBruto) {
            if (valorBruto <= 2428.80) return 0;
            else if (valorBruto <= 2826.65) return 0.075;
            else if (valorBruto <= 3751.05) return 0.15;
            else if (valorBruto <= 4664.68) return 0.225;
            else return 0.275;
        }

        /**
         * Arredondamento espec√≠fico para RRA conforme legisla√ß√£o
         * Regras:
         * - < 5: mant√©m a 1¬™ casa decimal
         * - > 5: adiciona 1 √† 1¬™ casa decimal  
         * - = 5: analisa a 3¬™ casa decimal:
         *   - 3¬™ casa entre 0-4: mant√©m a 1¬™ casa decimal
         *   - 3¬™ casa entre 5-9: adiciona 1 √† 1¬™ casa decimal
         */
        function arredondarRRA(valor) {
            if (typeof valor !== 'number' || isNaN(valor)) {
                return 0;
            }
            // Converter para string para analisar d√≠gito por d√≠gito
            const valorStr = valor.toFixed(3); // Garantir 3 casas decimais
            const partes = valorStr.split('.');
            
            if (partes.length !== 2) {
                return Math.round(valor * 10) / 10; // Fallback para arredondamento normal
            }
            
            const parteInteira = partes[0];
            const parteDecimal = partes[1].padEnd(3, '0'); // Garantir 3 d√≠gitos decimais
            
            const primeiraDecimal = parseInt(parteDecimal[0]);
            const segundaDecimal = parseInt(parteDecimal[1]);
            const terceiraDecimal = parseInt(parteDecimal[2]);
            
            let novaParteDecimal = primeiraDecimal;
            
            if (segundaDecimal < 5) {
                // Regra I: menor que 5, mant√©m a 1¬™ casa decimal
                novaParteDecimal = primeiraDecimal;
            } else if (segundaDecimal > 5) {
                // Regra II: maior que 5, adiciona 1 √† 1¬™ casa decimal
                novaParteDecimal = primeiraDecimal + 1;
            } else if (segundaDecimal === 5) {
                // Regra III: igual a 5, analisar a 3¬™ casa decimal
                if (terceiraDecimal >= 0 && terceiraDecimal <= 4) {
                    // III.a: 3¬™ casa entre 0-4, mant√©m a 1¬™ casa decimal
                    novaParteDecimal = primeiraDecimal;
                } else if (terceiraDecimal >= 5 && terceiraDecimal <= 9) {
                    // III.b: 3¬™ casa entre 5-9, adiciona 1 √† 1¬™ casa decimal
                    novaParteDecimal = primeiraDecimal + 1;
                }
            }
            // Tratar caso onde a soma ultrapassa 9
            if (novaParteDecimal >= 10) {
                const novaParteInteira = parseInt(parteInteira) + 1;
                novaParteDecimal = novaParteDecimal - 10;
                return parseFloat(`${novaParteInteira}.${novaParteDecimal}`);
            }
            
            return parseFloat(`${parteInteira}.${novaParteDecimal}`);
        }

        // ====================================
        // PREVIDENCIA
        // ====================================

        function calcularPrevidenciaIsolada(dados, principalBase, rrapagamento) {
            const resultadoVazio = {
                valorPrevidencia: 0,
                aliquotaEfetiva: 0,
                valorDesagioPrevidencia: 0,
                percentualDesagioPrevidencia: 0
            };
            
            // PJ n√£o tem previd√™ncia
            if (dados.tipoBeneficiario === 'pj') return resultadoVazio;
            
            const deveCalcularPrevidencia = dados.incidenciaPrevidencia || 
                dados.valoresPrincipais?.some(item => item.tributacao?.previdencia);
            
            if (!deveCalcularPrevidencia) return resultadoVazio;

            const itemComPrevidencia = dados.valoresPrincipais?.find(item => item.tributacao?.previdencia);
            const tipoPrevidencia = itemComPrevidencia?.tributacao.tipoPrevidencia || dados.tipoPrevidencia || 'inss';
            const aliquotaFixa = itemComPrevidencia?.tributacao.aliquotaFixa || dados.aliquotaFixa || 0;

            let valorPrevidencia, aliquotaEfetiva;

            if (tipoPrevidencia === 'fixa') {
                valorPrevidencia = principalBase * aliquotaFixa;
                aliquotaEfetiva = aliquotaFixa;
            } else {
                const base = rrapagamento === 0 ? principalBase : principalBase / rrapagamento;
                const resultadoINSS = calcularINSS(base);
                valorPrevidencia = resultadoINSS * (rrapagamento || 1);
                aliquotaEfetiva = base > 0 ? resultadoINSS / base : 0;
            }

            let valorDesagioPrevidencia = 0;
            let percentualDesagioPrevidencia = 0;

            if (dados.tipoCalculo === 'acordo') {
                percentualDesagioPrevidencia = dados.percentualAcordo || 0;
                valorDesagioPrevidencia = valorPrevidencia * percentualDesagioPrevidencia;
                valorPrevidencia = valorPrevidencia - valorDesagioPrevidencia;
            }
            
            return {
                valorPrevidencia,
                aliquotaEfetiva,
                valorDesagioPrevidencia,
                percentualDesagioPrevidencia
            };
        }

        function calcularINSS(base) {
            if (base <= 1518.00) return base * 0.075;
            else if (base <= 2793.88) return 1518 * 0.075 + (base - 1518) * 0.09;
            else if (base <= 4190.83) return 1518 * 0.075 + 1275.88 * 0.09 + (base - 2793.88) * 0.12;
            else if (base <= 8157.41) return 1518 * 0.075 + 1275.88 * 0.09 + 1396.95 * 0.12 + (base - 4190.83) * 0.14;
            else return 951.63; // Teto
        }

        //Modelo Sindifaz - um processo padr√£o com varias cessoes
        function configurarSindiFaz() {
            if (!confirm("Configurar dados padr√£o do SindiFaz?")) return;
            try {
            const dados = {
                advogados: [
                    ["FURTADO COELHO ADVOGADOS ASSOCIADOS", "PJ", 0.16],
                    ["FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "PF", 0.06],
                    ["ADAUTO FORTES ADVOGADOS ASSOCIADOS", "PJ", 0.02666667],
                    ["JUAREZ CHAVES DE AZEVEDO JUNIOR - SOCIEDADE INDIVIDUAL DE ADVOCACIA", "PJ", 0.013333333]
                ],
                cessoes: [
                    ["cessaoAdv", "FURTADO COELHO ADVOGADOS ASSOCIADOS", "LAGUZ I FIDC NP", 0.02],
                    ["cessaoAdv", "FURTADO COELHO ADVOGADOS ASSOCIADOS", "DOMUS OCTANTE I FIDC LTDA", 0.02],
                    ["cessaoAdv", "ADAUTO FORTES ADVOGADOS ASSOCIADOS", "LAGUZ I FIDC NP", 0.0063],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "LAGUZ I FIDC NP", 0.01],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "REAG LEGAL CLAIMS FIDC NP", 0.01],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "FLAVIA CEOLIN LOPES PIANA", 0.00444],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "FJ CONSULTORIA LTDA", 0.001653],
                    ["cessaoAdv", "FRANCINETTI DA ROCHA RIBEIRO DE LIRA", "ISA MARIA LEME OPPENHEIMER BORGES", 0.003907],
                    ["cessaoSindicato", "Sindifaz", "TABARE FIDC NP", 0.5],
                    ["cessaoSindicato", "Sindifaz", "ZEFIROS I FIDC NP", 0.5]
                ]
            };
            
            preencherSindiFaz(dados);
            alert("‚úÖ SindiFaz configurado!");
                
            } catch (error) {
                alert("‚ùå Erro ao configurar.");
            }
        }

        function preencherSindiFaz(dados) {
            const definir = (id, valor) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = valor;
                    el.dispatchEvent(new Event('change'));
                }
            };
            
            // 1. Advogados
            definir('quantAdvogados', dados.advogados.length);
            setTimeout(() => {
                dados.advogados.forEach(([nome, tipo, perc], i) => {
                    definir(`advNome${i}`, nome);
                    definir(`advTipo${i}`, tipo);
                    definir(`advPercentual${i}`, perc);
                });
            }, 100);
            
            // 2. Sindicato
            definir('quantSindicatos', 1);
            setTimeout(() => {
                definir('sindNome0', 'Sindifaz');
                definir('sindPercentual0', 0.01);
                definir('sindTrib0', 'nao');
            }, 200);
            
            // 3. Cess√µes
            definir('quantCessoes', dados.cessoes.length);
            setTimeout(() => {
                dados.cessoes.forEach(([tipo, cedente, cessionario, perc], i) => {
                    definir(`cessaoTipo${i}`, tipo);
                    setTimeout(() => {
                        definir(`cedenteNome${i}`, cedente);
                        definir(`cessionarioNome${i}`, cessionario);
                        definir(`cessaoPercentual${i}`, perc);
                    }, 50);
                });
            }, 300);
            
            // 4. Configura√ß√µes padr√£o
            setTimeout(() => {
                definir('natureza', 'alimentar');
                definir('incidenciaIR', 'sim');
                definir('incidenciaPrevidencia', 'sim');

                setTimeout(() => {
                    definir('tipoPrevidencia', 'fixa');
                    definir('aliquotaFixa', 0.08); 
                }, 100);
            }, 400);
        }

        //  CARREGAMENTO AUTOM√ÅTICO DE DADOS
        let dadosProcessos = new Map(); 
        let csvCarregado = false;

        async function carregarCSVDoServidor() {
            try {
                const response = await fetch('/tabelas/dados.csv');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivo CSV');
                }
                
                const texto = await response.text();
                
                const linhas = texto.split('\n');
                
                const cabecalho = linhas[0].split(';').map(c => c.trim());
                
                dadosProcessos.clear();
                
                
                for (let i = 1; i < linhas.length; i++) {
                    if (!linhas[i].trim()) continue; 
                    
                    const valores = linhas[i].split(';');
                    
                    if (valores.length < 9) continue;
                    
                    const processo = {
                        numero: valores[0]?.trim() || '',
                        orcamento: valores[1]?.trim() || '',
                        exequente: valores[2]?.trim() || '',
                        executado: valores[3]?.trim() || '',
                        dataCalculo: valores[4]?.trim() || '',
                        natureza: valores[5]?.trim() || '',
                        rra: valores[6]?.trim() || '',
                        principal: valores[7]?.trim() || '',
                        juros: valores[8]?.trim() || ''
                    };
                    
                    if (processo.numero) {
                        dadosProcessos.set(processo.numero, processo);
                    }
                }
                
                csvCarregado = true;
                
                const statusDiv = document.getElementById('statusCarregamento');
                if (statusDiv) {
                    statusDiv.innerHTML = `‚úÖ Base de dados carregada: ${dadosProcessos.size} processos dispon√≠veis`;
                    statusDiv.style.color = '#28a745';
                }
                
                localStorage.setItem('dadosProcessos', JSON.stringify([...dadosProcessos]));
                localStorage.setItem('dataCarregamento', new Date().toISOString());
                
                return true;
            } catch (erro) {
                console.error('‚ùå Erro ao carregar CSV:', erro);
                
                const cacheLocal = localStorage.getItem('dadosProcessos');
                if (cacheLocal) {
                    dadosProcessos = new Map(JSON.parse(cacheLocal));
                    console.log('üì¶ Dados carregados do cache local');
                    csvCarregado = true;
                    
                    const statusDiv = document.getElementById('statusCarregamento');
                    if (statusDiv) {
                        statusDiv.innerHTML = `üì¶ Usando cache local: ${dadosProcessos.size} processos`;
                        statusDiv.style.color = '#ffc107';
                    }
                    return true;
                }
                
                const statusDiv = document.getElementById('statusCarregamento');
                if (statusDiv) {
                    statusDiv.innerHTML = '‚ùå Erro ao carregar base de dados';
                    statusDiv.style.color = '#dc3545';
                }
                
                return false;
            }
        }

        function converterDataParaInput(dataStr) {
            if (!dataStr) return '';
            
            dataStr = dataStr.trim();
            
            if (dataStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dataStr;
            }
            
            const partes = dataStr.split('/');
            if (partes.length === 3) {
                const dia = partes[0].padStart(2, '0');
                const mes = partes[1].padStart(2, '0');
                const ano = partes[2];
                return `${ano}-${mes}-${dia}`;
            }
            
            return '';
        }

        function converterNumero(valorStr) {
            if (!valorStr) return '';
            
            valorStr = valorStr.trim();
            
            if (valorStr === '') return '';
            
            const numeroConvertido = valorStr
                .replace(/\./g, '')  // Remove pontos
                .replace(',', '.');   // Troca v√≠rgula por ponto
            
            return numeroConvertido;
        }

        function buscarDadosProcesso() {
            const numeroProcesso = document.getElementById('numprocesso').value.trim();
            
            if (!numeroProcesso) {
                alert('‚ö†Ô∏è Digite o n√∫mero do processo!');
                return false;
            }
            
            if (!csvCarregado || dadosProcessos.size === 0) {
                alert('‚ö†Ô∏è Base de dados ainda n√£o foi carregada. Aguarde um momento e tente novamente.');
                return false;
            }
            
            const dados = dadosProcessos.get(numeroProcesso);
            
            if (!dados) {
                alert('‚ùå Processo n√£o encontrado na base de dados!\n\nProcurado: ' + numeroProcesso);
                return false;
            }
        
            // Benefici√°rio (Exequente)
            if (dados.exequente) {
                document.getElementById('beneficiario').value = dados.exequente;
            }
            
            // Devedor (Executado)
            if (dados.executado) {
                document.getElementById('credor').value = dados.executado;
            }
            
            // Natureza 
            if (dados.natureza) {
                const naturezaValue = dados.natureza.toLowerCase();
                const selectNatureza = document.getElementById('natureza');
                
                if (naturezaValue === 'comum' || naturezaValue === 'alimentar') {
                    selectNatureza.value = naturezaValue;
                    selectNatureza.dispatchEvent(new Event('change'));
                }
            }
            
            // Ano do Or√ßamento
            if (dados.orcamento) {
                document.getElementById('anoOrcamento').value = dados.orcamento;
            }
            
            // Data Base 
            if (dados.dataCalculo) {
                const dataConvertida = converterDataParaInput(dados.dataCalculo);
                if (dataConvertida) {
                    const campoDataBase = document.getElementById('dataBase');
                    campoDataBase.value = dataConvertida;
                    campoDataBase.dispatchEvent(new Event('change'));
                }
            }
            
            // Valor Principal
            if (dados.principal) {
                const valorConvertido = converterNumero(dados.principal);
                if (valorConvertido) {
                    document.getElementById('valorPrincipal').value = valorConvertido;
                }
            }
            
            // Valor dos Juros
            if (dados.juros) {
                const valorConvertido = converterNumero(dados.juros);
                if (valorConvertido) {
                    document.getElementById('valorJuros').value = valorConvertido;
                }
            }
            
            // RRA
            if (dados.rra) {
                const rraConvertido = converterNumero(dados.rra);
                if (rraConvertido) {
                    document.getElementById('rra').value = rraConvertido;
                } else {
                    // Se o campo RRA est√° vazio no CSV, mant√©m 0
                    document.getElementById('rra').value = '0';
                }
            }
            
            alert('‚úÖ Dados do processo carregados com sucesso!');
            return true;
        }

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ Carregando base de dados de processos...');
            await carregarCSVDoServidor();
        });

        setInterval(async function() {
            console.log('üîÑ Atualizando base de dados...');
            await carregarCSVDoServidor();
        }, 1800000); // 30 minutos em milissegundos

        document.addEventListener('DOMContentLoaded', function() {
            const campoProcesso = document.getElementById('numprocesso');
            if (campoProcesso) {
                campoProcesso.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        buscarDadosProcesso();
                    }
                });
            }
        });

    </script>
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-icon">‚öñÔ∏è</div>
            
            <div class="copyright-text">
                ¬© <span class="developer-name">Gabriel de Jesus Silva</span>
            </div>
            
            <div class="subtitle">Sistema de Precat√≥rios</div>
            
            <div class="divider"></div>
            
            <div class="footer-meta">
                2025 ‚Ä¢ PreCalc v2.2
            </div>
        </div>
    </footer>
</body>
</html>